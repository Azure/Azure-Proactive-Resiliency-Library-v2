{
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workbookDisplayName": {
      "type": "string",
      "defaultValue": "Azure Validation Workbook v0.2.1",
      "metadata": {
        "description": "The friendly name for the workbook that is used in the Gallery or Saved List.  This name must be unique within a resource group."
      }
    },
    "workbookType": {
      "type": "string",
      "defaultValue": "workbook",
      "metadata": {
        "description": "The gallery that the workbook will been shown under. Supported values include workbook, tsg, etc. Usually, this is 'workbook'"
      }
    },
    "workbookSourceId": {
      "type": "string",
      "defaultValue": "Azure Monitor",
      "metadata": {
        "description": "The id of resource instance to which the workbook will be associated"
      }
    },
      "enableTelemetry": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "This parameter is used to trck deployment telemetry info. Enabled by default"
      }
    },
    "workbookId": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "metadata": {
        "description": "The unique guid for this workbook instance"
      }
    }
  },
  "resources": [
    {
      "name": "[parameters('workbookId')]",
      "type": "microsoft.insights/workbooks",
      "location": "[resourceGroup().location]",
      "apiVersion": "2022-04-01",
      "dependsOn": [],
      "kind": "shared",
      "properties": {
        "displayName": "[parameters('workbookDisplayName')]",
        "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"51aa3a9b-14e0-4c22-a60d-abdbf8813f00\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Subscription\",\"type\":6,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"includeAll\":false,\"showDefault\":false},\"timeContext\":{\"durationMs\":86400000},\"defaultValue\":\"value::all\",\"label\":\" Subscription\",\"value\":[\"value::all\"]},{\"id\":\"f342a111-002a-47fd-807f-0d4ccac0618a\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"ResourceGroup\",\"label\":\"Resource Group\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"resources\\r\\n| distinct resourceGroup\",\"crossComponentResources\":[\"{Subscription}\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"defaultValue\":\"value::all\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"id\":\"d6776ffe-e4f6-4c08-8f9e-a2fe2b3b6634\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TagName\",\"type\":2,\"query\":\"Resources\\r\\n| where tags != '' and tags != '[]'\\r\\n| mvexpand tags\\r\\n| extend tagName = tostring(bag_keys(tags)[0])\\r\\n| distinct tagName\\r\\n| sort by tagName asc\",\"crossComponentResources\":[\"{Subscription}\"],\"typeSettings\":{\"additionalResourceOptions\":[]},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"value\":null,\"label\":\"Tag Name\"},{\"id\":\"f73dc4a1-ef8b-45c5-a30b-a11bb077a3cc\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TagValue\",\"type\":2,\"query\":\"Resources\\r\\n| mvexpand tags\\r\\n| extend tagName = tostring(bag_keys(tags)[0])\\r\\n| extend tagValue = tostring(tags[tagName])\\r\\n| where tags != '' and tags != '[]' and tostring(bag_keys(tags)[0]) == '{TagName}'\\r\\n| distinct tagValue\\r\\n| sort by tagValue asc\",\"crossComponentResources\":[\"{Subscription}\"],\"typeSettings\":{\"additionalResourceOptions\":[]},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"value\":null,\"label\":\"Tag Value\"}],\"style\":\"pills\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},\"name\":\"parameters - Filters\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"e7320c70-1ffa-4e0a-9ab8-54b064317722\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"ZonalRegions\",\"type\":9,\"description\":\"Regions that support availability zones\",\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"jsonData\":\"[\\r\\n  \\\"australiaeast\\\",\\r\\n  \\\"brazilsouth\\\",\\r\\n  \\\"canadacentral\\\",\\r\\n  \\\"centralindia\\\",\\r\\n  \\\"centralus\\\",\\r\\n  \\\"eastasia\\\",\\r\\n  \\\"eastus\\\",\\r\\n  \\\"eastus2\\\",\\r\\n  \\\"francecentral\\\",\\r\\n  \\\"germanywestcentral\\\",\\r\\n  \\\"israelcentral\\\",\\r\\n  \\\"italynorth\\\",\\r\\n  \\\"japaneast\\\",\\r\\n  \\\"japanwest\\\",\\r\\n  \\\"koreacentral\\\",\\r\\n  \\\"mexicocentral\\\",\\r\\n  \\\"newzealandnorth\\\",\\r\\n  \\\"northeurope\\\",\\r\\n  \\\"norwayeast\\\",\\r\\n  \\\"polandcentral\\\",\\r\\n  \\\"qatarcentral\\\",\\r\\n  \\\"southafricanorth\\\",\\r\\n  \\\"southcentralus\\\",\\r\\n  \\\"southeastasia\\\",\\r\\n  \\\"spaincentral\\\",\\r\\n  \\\"swedencentral\\\",\\r\\n  \\\"switzerlandnorth\\\",\\r\\n  \\\"uaenorth\\\",\\r\\n  \\\"uksouth\\\",\\r\\n  \\\"westeurope\\\",\\r\\n  \\\"westus2\\\",\\r\\n  \\\"westus3\\\",\\r\\n  \\\"usgovvirginia\\\",\\r\\n  \\\"chinanorth3\\\"\\r\\n]\",\"timeContext\":{\"durationMs\":86400000},\"value\":[\"australiaeast\",\"brazilsouth\",\"canadacentral\",\"centralindia\",\"centralus\",\"eastasia\",\"eastus\",\"eastus2\",\"francecentral\",\"germanywestcentral\",\"israelcentral\",\"italynorth\",\"japaneast\",\"japanwest\",\"koreacentral\",\"mexicocentral\",\"newzealandnorth\",\"northeurope\",\"norwayeast\",\"polandcentral\",\"qatarcentral\",\"southafricanorth\",\"southcentralus\",\"southeastasia\",\"spaincentral\",\"swedencentral\",\"switzerlandnorth\",\"uaenorth\",\"uksouth\",\"westeurope\",\"westus2\",\"westus3\",\"usgovvirginia\",\"chinanorth3\"]},{\"id\":\"ff0022fe-9804-41bc-be1d-224e96e651fd\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"ZonalOnlyResources\",\"type\":9,\"description\":\"List of zonal resources\",\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"jsonData\":\"[\\r\\n  \\\"microsoft.containerinstance/containergroups\\\",\\r\\n  \\\"microsoft.compute/hostgroups\\\",\\r\\n  \\\"microsoft.hdinsight/clusterpools\\\",\\r\\n  \\\"microsoft.storagecache/caches\\\",\\r\\n  \\\"microsoft.network/natgateways\\\",\\r\\n  \\\"microsoft.netapp/netappaccounts\\\",\\r\\n  \\\"microsoft.recoveryservices/vaults\\\",\\r\\n  \\\"microsoft.compute/virtualmachines\\\",\\r\\n  \\\"microsoft.connectedvmwarevsphere/clusters\\\"\\r\\n]\\r\\n\",\"value\":[\"microsoft.containerinstance/containergroups\",\"microsoft.compute/hostgroups\",\"microsoft.hdinsight/clusterpools\",\"microsoft.storagecache/caches\",\"microsoft.network/natgateways\",\"microsoft.netapp/netappaccounts\",\"microsoft.recoveryservices/vaults\",\"microsoft.compute/virtualmachines\",\"microsoft.connectedvmwarevsphere/clusters\"]}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"isVisible\",\"comparison\":\"isEqualTo\",\"value\":\"true\"},\"name\":\"parameters - ZonalRegions\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"{Subscription}\"],\"parameters\":[{\"id\":\"14bb128f-5b3f-421a-9cf7-b9ad71ece3f8\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"CheckforVPNGateways\",\"type\":1,\"isRequired\":true,\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'Microsoft.Network/virtualNetworkGateways'\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend skuName = tostring(properties.sku.name)\\r\\n| extend skuTier = tostring(properties.sku.tier)\\r\\n| extend gatewayType = tostring(properties.gatewayType)\\r\\n| extend zoneRedundant = iif(skuName contains 'AZ' or skuTier contains 'AZ', true, false)\\r\\n| where zoneRedundant == false\\r\\n| join kind = innerunique (\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n    | distinct id\\r\\n)\\r\\n    on id\\r\\n| summarize VPNGWCount = count()\\r\\n| extend HasNonZonalVPNGateways = iff(VPNGWCount > 0, \\\"Yes\\\", \\\"No\\\")\\r\\n| project HasNonZonalVPNGateways\",\"crossComponentResources\":[\"{Subscription}\"],\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"}],\"style\":\"pills\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},\"conditionalVisibility\":{\"parameterName\":\"AlwaysHidden\",\"comparison\":\"isEqualTo\",\"value\":\"yes\"},\"name\":\"paramCheckVPNGateways\"},{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"tabs\",\"links\":[{\"id\":\"ca40468d-4518-43bf-ac6e-0a11d7331e12\",\"cellValue\":\"SelectedTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Overview\",\"subTarget\":\"Overview\",\"style\":\"link\"},{\"id\":\"26b3c7ef-1a00-4a3f-a773-677f00db9343\",\"cellValue\":\"SelectedTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Backup checks \",\"subTarget\":\"BCDR\",\"style\":\"link\"},{\"id\":\"7486aa22-b0c2-492c-aa11-35d1f674736f\",\"cellValue\":\"SelectedTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Security checks\",\"subTarget\":\"Security\",\"style\":\"link\"},{\"id\":\"3e67632d-fed6-40ad-8037-6f654a83e536\",\"cellValue\":\"SelectedTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Monitor checks\",\"subTarget\":\"Monitor\",\"style\":\"link\"},{\"id\":\"f280fc2a-f42a-42a4-ad4b-be37ab3e8b48\",\"cellValue\":\"SelectedTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Resiliency Zone Adoption checks\",\"subTarget\":\"zoneAdoption\",\"style\":\"link\"}]},\"name\":\"links - MainTabs\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"{Subscription}\"],\"parameters\":[{\"id\":\"8e9c9c8f-585e-4702-8b86-be9087a22b8c\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"workbookLatestVersion\",\"type\":1,\"isRequired\":true,\"query\":\"{\\\"version\\\":\\\"CustomEndpoint/1.0\\\",\\\"data\\\":null,\\\"headers\\\":[],\\\"method\\\":\\\"GET\\\",\\\"url\\\":\\\"https://azcatnogm6rpxecvg.thankfuldesert-01f69afa.eastus.azurecontainerapps.io/api/version\\\",\\\"contentType\\\":\\\"text/plain\\\",\\\"urlParams\\\":[],\\\"transformers\\\":[{\\\"type\\\":\\\"jsonpath\\\",\\\"settings\\\":{\\\"columns\\\":[{\\\"path\\\":\\\"WorkbookVersion\\\",\\\"columnid\\\":\\\"WorkbookVersion\\\"},{\\\"path\\\":\\\"timestamp\\\",\\\"columnid\\\":\\\"timestamp\\\"}]}}]}\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":10},{\"id\":\"32df451b-da37-4271-8a5e-7bd51471eb20\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"workbookCurrentVersion\",\"type\":1,\"isRequired\":true,\"query\":\"{\\\"version\\\":\\\"1.0.0\\\",\\\"content\\\":\\\"{\\\\r\\\\n  \\\\\\\"WorkbookVersion\\\\\\\": \\\\\\\"0.2\\\\\\\",\\\\r\\\\n  \\\\\\\"LastUpdateDate\\\\\\\": \\\\\\\"September2025\\\\\\\"\\\\r\\\\n}\\\",\\\"transformers\\\":null}\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":8},{\"id\":\"46cdcfb3-6ee4-4da0-8d9c-9b6d35e36696\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"CheckVersion\",\"type\":1,\"isRequired\":true,\"query\":\"resources\\r\\n| take 1\\r\\n| extend workbookCurrentVersion = todouble({workbookCurrentVersion})\\r\\n| extend workbookLatestVersion = todouble({workbookLatestVersion})\\r\\n| extend UpdateStatus = iff(workbookLatestVersion > workbookCurrentVersion, \\\"Needs Update\\\", \\\"No Update needed\\\")\\r\\n| extend CurrentVersion = workbookCurrentVersion\\r\\n| extend LatestVersion = workbookLatestVersion\\r\\n| project UpdateStatus, CurrentVersion, LatestVersion\\r\\n\",\"crossComponentResources\":[\"{Subscription}\"],\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"}],\"style\":\"pills\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},\"conditionalVisibility\":{\"parameterName\":\"AlwaysHidden\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"parameters CheckWorkbookVersion\"},{\"type\":1,\"content\":{\"json\":\"You are not running the latest version of the workbook. [Click here]() to deploy the latest version.\",\"style\":\"warning\"},\"conditionalVisibility\":{\"parameterName\":\"CheckVersion\",\"comparison\":\"isEqualTo\",\"value\":\"Needs Update\"},\"name\":\"TextNeedsUpdate\"},{\"type\":1,\"content\":{\"json\":\"You are running the latest version of the workbook.\",\"style\":\"info\"},\"conditionalVisibility\":{\"parameterName\":\"CheckVersion\",\"comparison\":\"isEqualTo\",\"value\":\"No Update needed\"},\"name\":\"TextLatestVersion\"},{\"type\":1,\"content\":{\"json\":\"You are not running the latest version of the workbook. Visit [this link](https://github.com/Azure/Azure-Proactive-Resiliency-Library-v2/tree/arclares-workbook/tools) to deploy the latest version.\",\"style\":\"info\"},\"conditionalVisibility\":{\"parameterName\":\"CheckVersion\",\"comparison\":\"isEqualTo\",\"value\":\"Needs Update\"},\"name\":\"TextLatestVersion-Outdated\"}]},\"name\":\"groupCheckVersion\"},{\"type\":1,\"content\":{\"json\":\"# Welcome to the Azure Validation Workbook\"},\"name\":\"Welcome\"},{\"type\":1,\"content\":{\"json\":\"### Reference: [Microsoft Azure Well-Architected Framework - Reliability, Security, and Operational Excellence](https://learn.microsoft.com/en-us/azure/architecture/framework/)\",\"style\":\"upsell\"},\"name\":\"Reference\"},{\"type\":1,\"content\":{\"json\":\"The Azure Validation Workbook provides a comprehensive assessment of your Azure environment, focusing on best practices for resiliency, business continuity and disaster recovery (BCDR), security, and monitoring. It is designed to help you quickly identify gaps, review recommendations, and track remediation progress across your subscriptions and resource groups.\\r\\n\\r\\n## Workbook Objectives\\r\\n\\r\\n* Evaluate your Azure resources against Microsoft best practices for reliability, security, and operational excellence.\\r\\n* Surface actionable insights and recommendations to improve your cloud posture.\\r\\n* Enable filtering by subscription, resource group, and tags for targeted analysis.\\r\\n* Support export of findings for offline review and reporting.\\r\\n\\r\\n> **Note:** This workbook is intended as a guidance tool. Remediation actions should be reviewed and implemented according to your organizationâ€™s policies and priorities.\"},\"name\":\"Objective\"},{\"type\":1,\"content\":{\"json\":\"Indicates an implemented recommendation that results in an environment aligned with Azure best practices for resiliency, security, and monitoring.\",\"style\":\"success\"},\"customWidth\":\"50\",\"name\":\"Greenlight\",\"styleSettings\":{\"margin\":\"10px\",\"showBorder\":true}},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"c8cb9a10-249f-4aff-b71e-cc565dfdde0b\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"enableSummaryOfRecommendations\",\"label\":\"Enable summary of recommendations\",\"type\":10,\"isRequired\":true,\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"jsonData\":\"[\\r\\n    {\\r\\n    \\\"value\\\" : \\\"Yes\\\",\\r\\n    \\\"label\\\" : \\\"Yes\\\"\\r\\n    },\\r\\n    {\\r\\n    \\\"value\\\" : \\\"No\\\",\\r\\n    \\\"label\\\" : \\\"No\\\",\\r\\n    \\\"selected\\\" : true\\r\\n    }\\r\\n]\",\"timeContext\":{\"durationMs\":86400000}}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"param-enableallqueryexport\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Summary of Recommendations\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"appgw-param-group\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"AppGWperhour\",\"type\":1,\"value\":\"0.125\",\"typeSettings\":{\"parameterType\":1}},{\"id\":\"capacity-unit-param\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"CapacityUnitperhour\",\"type\":1,\"value\":\"0.008\",\"typeSettings\":{\"parameterType\":1}},{\"id\":\"outbound-data-param\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"OutboundDataTransferGb\",\"type\":1,\"value\":\"1000\",\"typeSettings\":{\"parameterType\":1}},{\"id\":\"pip-hour-param\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"PIPPerHour\",\"type\":1,\"value\":\"0.005\",\"typeSettings\":{\"parameterType\":1}},{\"id\":\"s2s-tunnels-param\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"s2stunnels\",\"type\":1,\"value\":\"1\",\"typeSettings\":{\"parameterType\":1}},{\"id\":\"p2s-connections-param\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"P2SConnections\",\"type\":1,\"value\":\"0\",\"typeSettings\":{\"parameterType\":1}},{\"id\":\"network-rules-param\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"NetworkRules\",\"type\":1,\"value\":\"1\",\"typeSettings\":{\"parameterType\":1}},{\"id\":\"data-processed-param\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"DataProcessedGb\",\"type\":1,\"value\":\"1000\",\"typeSettings\":{\"parameterType\":1}},{\"id\":\"standard-hdd-price-param\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"standardHddPricePerGB\",\"type\":1,\"value\":\"0.0255\",\"typeSettings\":{\"parameterType\":1}},{\"id\":\"standard-ssd-price-param\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"standardSsdPricePerGB\",\"type\":1,\"value\":\"0.050\",\"typeSettings\":{\"parameterType\":1}},{\"id\":\"premium-ssd-price-param\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"premiumSsdPricePerGB\",\"type\":1,\"value\":\"0.138\",\"typeSettings\":{\"parameterType\":1}},{\"id\":\"standard-ssd-zrs-price-param\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"standardSsdZrsPricePerGB\",\"type\":1,\"value\":\"0.0625\",\"typeSettings\":{\"parameterType\":1}},{\"id\":\"premium-zrs-price-param\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"premiumZrsPricePerGB\",\"type\":1,\"value\":\"0.184\",\"typeSettings\":{\"parameterType\":1}},{\"id\":\"apim-developer-price-param\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"apimDeveloperPrice\",\"type\":1,\"value\":\"0.0\",\"typeSettings\":{\"parameterType\":1}},{\"id\":\"apim-basic-unit-price-param\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"apimBasicUnitPrice\",\"type\":1,\"value\":\"0.2055\",\"typeSettings\":{\"parameterType\":1}},{\"id\":\"apim-standard-unit-price-param\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"apimStandardUnitPrice\",\"type\":1,\"value\":\"0.8495\",\"typeSettings\":{\"parameterType\":1}},{\"id\":\"apim-premium-unit-price-param\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"apimPremiumUnitPrice\",\"type\":1,\"value\":\"3.4247\",\"typeSettings\":{\"parameterType\":1}},{\"id\":\"p0v4-price-param\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"p0v4Price\",\"type\":1,\"value\":\"53.29\",\"typeSettings\":{\"parameterType\":1}},{\"id\":\"p1v4-price-param\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"p1v4Price\",\"type\":1,\"value\":\"106.58\",\"typeSettings\":{\"parameterType\":1}},{\"id\":\"p2v4-price-param\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"p2v4Price\",\"type\":1,\"value\":\"213.16\",\"typeSettings\":{\"parameterType\":1}},{\"id\":\"vpngw1az-price-param\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"vpnGw1AzPrice\",\"type\":1,\"value\":\"153.30\",\"typeSettings\":{\"parameterType\":1}},{\"id\":\"vpngw2az-price-param\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"vpnGw2AzPrice\",\"type\":1,\"value\":\"394.20\",\"typeSettings\":{\"parameterType\":1}},{\"id\":\"data-transfer-tier1-param\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"dataTransferTier1Price\",\"type\":1,\"value\":\"0.04\",\"typeSettings\":{\"parameterType\":1}},{\"id\":\"data-transfer-tier2-param\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"dataTransferTier2Price\",\"type\":1,\"value\":\"0.08\",\"typeSettings\":{\"parameterType\":1}},{\"id\":\"data-transfer-tier3-param\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"dataTransferTier3Price\",\"type\":1,\"value\":\"0.04\",\"typeSettings\":{\"parameterType\":1}},{\"id\":\"data-transfer-tier4-param\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"dataTransferTier4Price\",\"type\":1,\"value\":\"0.065\",\"typeSettings\":{\"parameterType\":1}},{\"version\":\"KqlParameterItem/1.0\",\"name\":\"s2stunnels\",\"type\":1,\"value\":\"5\",\"typeSettings\":{\"parameterType\":1},\"id\":\"dfc7e295-230f-471b-8fc9-45ef9fd08d23\"},{\"version\":\"KqlParameterItem/1.0\",\"name\":\"P2SConnections\",\"type\":1,\"value\":\"50\",\"typeSettings\":{\"parameterType\":1},\"id\":\"28058896-d006-4547-98fb-294aafd51af8\"},{\"id\":\"basic-b1-price-param\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"basicB1Price\",\"type\":1,\"value\":\"0.018\",\"typeSettings\":{\"parameterType\":1}},{\"id\":\"basic-b2-price-param\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"basicB2Price\",\"type\":1,\"value\":\"0.036\",\"typeSettings\":{\"parameterType\":1}},{\"id\":\"basic-b3-price-param\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"basicB3Price\",\"type\":1,\"value\":\"0.073\",\"typeSettings\":{\"parameterType\":1}},{\"id\":\"standard-s1-price-param\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"standardS1Price\",\"type\":1,\"value\":\"0.100\",\"typeSettings\":{\"parameterType\":1}},{\"id\":\"standard-s2-price-param\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"standardS2Price\",\"type\":1,\"value\":\"0.200\",\"typeSettings\":{\"parameterType\":1}},{\"id\":\"standard-s3-price-param\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"standardS3Price\",\"type\":1,\"value\":\"0.400\",\"typeSettings\":{\"parameterType\":1}},{\"id\":\"premium-p1-price-param\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"premiumP1Price\",\"type\":1,\"value\":\"0.146\",\"typeSettings\":{\"parameterType\":1}},{\"id\":\"premium-p2-price-param\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"premiumP2Price\",\"type\":1,\"value\":\"0.292\",\"typeSettings\":{\"parameterType\":1}},{\"id\":\"premium-p3-price-param\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"premiumP3Price\",\"type\":1,\"value\":\"0.584\",\"typeSettings\":{\"parameterType\":1}},{\"id\":\"p1mv4-price-param\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"p1mv4Price\",\"type\":1,\"value\":\"213.16\",\"typeSettings\":{\"parameterType\":1}},{\"id\":\"p2mv4-price-param\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"p2mv4Price\",\"type\":1,\"value\":\"426.32\",\"typeSettings\":{\"parameterType\":1}},{\"id\":\"p3v4-price-param\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"p3v4Price\",\"type\":1,\"value\":\"426.32\",\"typeSettings\":{\"parameterType\":1}},{\"id\":\"p3mv4-price-param\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"p3mv4Price\",\"type\":1,\"value\":\"852.64\",\"typeSettings\":{\"parameterType\":1}},{\"id\":\"p4mv4-price-param\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"p4mv4Price\",\"type\":1,\"value\":\"1705.28\",\"typeSettings\":{\"parameterType\":1}},{\"id\":\"p5mv4-price-param\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"p5mv4Price\",\"type\":1,\"value\":\"3410.56\",\"typeSettings\":{\"parameterType\":1}},{\"id\":\"storage-price-gb-month-param\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"storagePricePerGbMonth\",\"type\":1,\"value\":\"0.028\",\"typeSettings\":{\"parameterType\":1}},{\"id\":\"change-rate-daily-param\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"changeRateDaily\",\"type\":1,\"value\":\"1\",\"typeSettings\":{\"parameterType\":1}},{\"id\":\"backup-agent-cost-param\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"backupAgentCost\",\"type\":1,\"value\":\"10\",\"typeSettings\":{\"parameterType\":1}},{\"id\":\"snapshot-retention-param\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"snapshotRetention\",\"type\":1,\"value\":\"3\",\"typeSettings\":{\"parameterType\":1}},{\"id\":\"snapshot-price-param\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"snapshotPrice\",\"type\":1,\"value\":\"0.144\",\"typeSettings\":{\"parameterType\":1}},{\"id\":\"defender-server-agent-param\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"defenderforServeragent\",\"type\":1,\"value\":\"14.6\",\"typeSettings\":{\"parameterType\":1}}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"AlwaysHidden\",\"comparison\":\"isEqualTo\",\"value\":\"yes\"},\"name\":\"cost-parameters\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"// Zone Adoption Export - All Recommendations\\r\\n(\\r\\n    resources\\r\\n    | where resourceGroup in ({ResourceGroup}) and location in~ ({ZonalRegions}) and type in~ (\\r\\n        'Microsoft.Compute/virtualmachines',\\r\\n        'Microsoft.Compute/disks',\\r\\n        'microsoft.network/azurefirewalls',\\r\\n        'microsoft.network/applicationGateways',\\r\\n        'Microsoft.Network/publicIPAddresses',\\r\\n        'microsoft.network/virtualnetworkgateways',\\r\\n        'microsoft.network/bastionhosts',\\r\\n        'microsoft.network/loadbalancers',\\r\\n        'microsoft.sql/servers/databases',\\r\\n        'microsoft.cache/redis',\\r\\n        'microsoft.dbformysql/flexibleservers',\\r\\n        'microsoft.dbforpostgresql/flexibleservers',\\r\\n        'Microsoft.Storage/StorageAccounts',\\r\\n        'Microsoft.NetApp/netAppAccounts/capacityPools/volumes',\\r\\n        'microsoft.compute/virtualmachinescalesets',\\r\\n        'microsoft.apimanagement/service',\\r\\n        'microsoft.servicebus/namespaces',\\r\\n        'microsoft.eventhub/namespaces',\\r\\n        'microsoft.web/serverfarms',\\r\\n        'microsoft.containerregistry/registries',\\r\\n        'microsoft.app/managedenvironments',\\r\\n        'microsoft.recoveryservices/vaults'\\r\\n    )\\r\\n    | extend ZoneConfigured = case(\\r\\n        type =~ 'Microsoft.Compute/virtualmachines', not(isnull(zones) or array_length(zones) == 0),\\r\\n        type =~ 'Microsoft.Compute/disks', tostring(sku.name) in ('Premium_ZRS', 'StandardSSD_ZRS'),\\r\\n        type =~ 'microsoft.network/azurefirewalls', array_length(coalesce(todynamic(zones), dynamic([]))) >= 2,\\r\\n        type =~ 'microsoft.network/applicationGateways', array_length(coalesce(todynamic(zones), dynamic([]))) >= 2,\\r\\n        type =~ 'Microsoft.Network/publicIPAddresses', array_length(coalesce(todynamic(zones), dynamic([]))) >= 2,\\r\\n        type =~ 'microsoft.network/virtualnetworkgateways', tostring(properties.sku.tier) contains 'AZ',\\r\\n        type =~ 'microsoft.network/bastionhosts', array_length(coalesce(todynamic(zones), dynamic([]))) >= 2,\\r\\n        type =~ 'microsoft.network/loadbalancers', tolower(tostring(sku.name)) != 'basic' and array_length(coalesce(todynamic(zones), dynamic([]))) >= 2,\\r\\n        type =~ 'microsoft.sql/servers/databases', name != 'master' and tobool(properties.zoneRedundant),\\r\\n        type =~ 'microsoft.cache/redis', not(properties.zonalAllocationPolicy != 'Automatic' and (array_length(coalesce(todynamic(zones), dynamic([]))) <= 1 or isnull(zones))),\\r\\n        type =~ 'microsoft.dbformysql/flexibleservers', tostring(properties.highAvailability.mode) == 'ZoneRedundant',\\r\\n        type =~ 'microsoft.dbforpostgresql/flexibleservers', tostring(properties.highAvailability.mode) == 'ZoneRedundant',\\r\\n        type =~ 'Microsoft.Storage/StorageAccounts', tostring(sku.name) endswith_cs 'ZRS',\\r\\n        type =~ 'Microsoft.NetApp/netAppAccounts/capacityPools/volumes', array_length(coalesce(todynamic(zones), dynamic([]))) > 1,\\r\\n        type =~ 'microsoft.compute/virtualmachinescalesets', not(tags has \\\"aks-managed-orchestrator\\\" or name startswith \\\"aks-\\\") and not(isnull(zones) or array_length(zones) <= 1),\\r\\n        type =~ 'microsoft.apimanagement/service', not(isnull(zones) or array_length(zones) <= 1),\\r\\n        type =~ 'microsoft.servicebus/namespaces', not(iff(tobool(properties.zoneRedundant) == true, true, false) == false),\\r\\n        type =~ 'microsoft.eventhub/namespaces', not(tostring(properties.zoneRedundant) == \\\"false\\\"),\\r\\n        type =~ 'microsoft.web/serverfarms', tostring(sku.name) != \\\"Y1\\\" and (tobool(properties.zoneRedundant) == false or (tostring(sku.tier) in~ ('PremiumV2', 'PremiumV3', 'PremiumV4', 'Isolated', 'IsolatedV2') and (isnull(properties.supportsZoneRedundancy) or not(tobool(properties.supportsZoneRedundancy))))),\\r\\n        type =~ 'microsoft.containerregistry/registries', not(location in~ ({ZonalRegions})),\\r\\n        type =~ 'microsoft.app/managedenvironments', not(tobool(properties.zoneRedundant)),\\r\\n        type =~ 'microsoft.recoveryservices/vaults', not(tostring(properties.storageModelType) == \\\"ZoneRedundant\\\" or tostring(properties.storageType) == \\\"ZoneRedundant\\\"),\\r\\n        false\\r\\n    )\\r\\n    | where not(ZoneConfigured)\\r\\n    | extend Recommendation = case(\\r\\n        type =~ 'Microsoft.Compute/virtualmachines', 'Deploy VMs across Availability Zones',\\r\\n        type =~ 'Microsoft.Compute/disks', 'Use Azure Disks with Zone Redundant Storage',\\r\\n        type =~ 'microsoft.network/applicationGateways', 'Enable multi-zone Application Gateway',\\r\\n        type =~ 'microsoft.network/azurefirewalls', 'Deploy Azure Firewall across multiple availability zones',\\r\\n        type =~ 'Microsoft.Storage/StorageAccounts', 'Move to ZRS/GZRS storage',\\r\\n        type =~ 'microsoft.web/serverfarms', case(\\r\\n            tostring(sku.tier) in~ ('Free', 'Shared', 'Basic', 'Standard') or (tostring(sku.tier) == 'Premium' and not(tostring(sku.name) contains 'v')), 'Enable zone redundancy on App Service Plan',\\r\\n            toint(sku.capacity) < 2, 'Enable zone redundancy on App Service Plan',\\r\\n            'Enable zone redundancy on App Service Plan'\\r\\n        ),\\r\\n        type =~ 'microsoft.containerservice/managedclusters', 'Use multi-zone AKS node pools',\\r\\n        type =~ 'microsoft.containerregistry/registries', 'Enable ACR zone redundancy',\\r\\n        type =~ 'microsoft.apimanagement/service', case(\\r\\n            tostring(sku.name) == 'Premium', 'Enable multi-zone API Management',\\r\\n            'Enable multi-zone API Management'\\r\\n        ),\\r\\n        type =~ 'microsoft.servicebus/namespaces', 'Enable Service Bus zone redundancy',\\r\\n        type =~ 'microsoft.eventhub/namespaces', case(\\r\\n            tostring(sku.tier) in ('Standard', 'Premium', 'Dedicated'), 'Enable Event Hub zone redundancy',\\r\\n            'Enable Event Hub zone redundancy'\\r\\n        ),\\r\\n        type =~ 'microsoft.cache/redis', 'Enable Redis zone redundancy',\\r\\n        type =~ 'microsoft.dbformysql/flexibleservers', 'Enable MySQL zone-redundant HA',\\r\\n        type =~ 'microsoft.dbforpostgresql/flexibleservers', 'Enable PostgreSQL zone-redundant HA',\\r\\n        type =~ 'microsoft.documentdb/databaseaccounts', 'Enable Cosmos DB zone redundancy',\\r\\n        type =~ 'microsoft.network/loadbalancers', 'Use zone-redundant Standard Load Balancer',\\r\\n        type =~ 'microsoft.network/virtualnetworkgateways', 'Use AZ SKU Virtual Network Gateway',\\r\\n        type =~ 'microsoft.network/publicipaddresses', 'Create / convert to zone-redundant Public IP',\\r\\n        type =~ 'microsoft.network/bastionhosts', 'Deploy Bastion host across zones',\\r\\n        type =~ 'Microsoft.NetApp/netAppAccounts/capacityPools/volumes', 'Review ANF multi-zone deployment',\\r\\n        type =~ 'microsoft.app/managedenvironments', 'Enable Container Apps env zone redundancy',\\r\\n        type =~ 'microsoft.compute/virtualmachinescalesets', 'Distribute VM Scale Set across zones',\\r\\n        type =~ 'microsoft.recoveryservices/vaults', 'Enable zone-redundant storage (ZRS) for Recovery Services Vault',\\r\\n        ''\\r\\n    )\\r\\n    | where isnotempty(Recommendation)\\r\\n    // Cost calculations for all services including yellow and red categories\\r\\n    | extend EstimatedMonthlyCost = case(\\r\\n        // Green Light Services (ðŸŸ¢ Cost Est.)\\r\\n        // Azure Firewall - No additional cost for zone redundancy\\r\\n        type =~ 'microsoft.network/azurefirewalls', \\\"$0.00\\\",\\r\\n        // Application Gateway - Complex pricing with tiered data transfer costs\\r\\n        type =~ 'microsoft.network/applicationGateways', \\r\\n            strcat(\\\"$\\\", tostring(round(\\r\\n                (todouble({AppGWperhour}) * 730) + \\r\\n                (todouble({CapacityUnitperhour}) * 730) + \\r\\n                // Exact 5-tier data transfer calculation from original workbook\\r\\n                case(\\r\\n                    todouble({OutboundDataTransferGb}) <= 100, 0.0,  // First 100 GB free\\r\\n                    todouble({OutboundDataTransferGb}) <= 10340, (todouble({OutboundDataTransferGb}) - 100) * todouble({dataTransferTier1Price}),  // Next 10 TB at $0.04/GB\\r\\n                    todouble({OutboundDataTransferGb}) <= 51440, ((10340 - 100) * todouble({dataTransferTier1Price})) + ((todouble({OutboundDataTransferGb}) - 10340) * todouble({dataTransferTier2Price})),  // Next 40 TB at $0.08/GB\\r\\n                    todouble({OutboundDataTransferGb}) <= 153840, ((10340 - 100) * todouble({dataTransferTier1Price})) + ((51440 - 10340) * todouble({dataTransferTier2Price})) + ((todouble({OutboundDataTransferGb}) - 51440) * todouble({dataTransferTier3Price})),  // Next 100 TB at $0.04/GB\\r\\n                    // Over 153840 GB: First 100GB free + Next 10TB at tier1 + Next 40TB at tier2 + Next 100TB at tier3 + remainder at tier4\\r\\n                    ((10340 - 100) * todouble({dataTransferTier1Price})) + ((51440 - 10340) * todouble({dataTransferTier2Price})) + ((153840 - 51440) * todouble({dataTransferTier3Price})) + ((todouble({OutboundDataTransferGb}) - 153840) * todouble({dataTransferTier4Price}))  // Next 350 TB at $0.065/GB\\r\\n                ), 2))),\\r\\n        // Public IP Addresses\\r\\n        type =~ 'Microsoft.Network/publicIPAddresses', strcat(\\\"$\\\", tostring(round(todouble({PIPPerHour}) * 730, 2))),\\r\\n        // VPN Gateway - Complex SKU-based pricing\\r\\n        type =~ 'microsoft.network/virtualnetworkgateways',\\r\\n            case(\\r\\n                // Already AZ SKUs - no upgrade needed\\r\\n                tostring(properties.sku.name) contains 'AZ', \\\"$0.00\\\",\\r\\n                // Calculate complex cost for non-AZ SKUs\\r\\n                strcat(\\\"$\\\", tostring(round(\\r\\n                    // Base gateway cost based on equivalent AZ SKU\\r\\n                    case(\\r\\n                        tostring(properties.sku.name) in~ ('Basic', 'Standard', 'HighPerformance', 'VpnGw1'), 153.30,  // VpnGw1AZ\\r\\n                        tostring(properties.sku.name) =~ 'VpnGw2', 394.20,  // VpnGw2AZ\\r\\n                        tostring(properties.sku.name) =~ 'VpnGw3', 1007.40, // VpnGw3AZ\\r\\n                        tostring(properties.sku.name) =~ 'VpnGw4', 1686.30, // VpnGw4AZ\\r\\n                        tostring(properties.sku.name) =~ 'VpnGw5', 2934.60, // VpnGw5AZ\\r\\n                        153.30  // Default to VpnGw1AZ\\r\\n                    ) +\\r\\n                    // Additional S2S tunnel costs\\r\\n                    case(\\r\\n                        todouble({s2stunnels}) <= 10, 0.0,  // First 10 included\\r\\n                        tostring(properties.sku.name) in~ ('Basic', 'Standard', 'HighPerformance', 'VpnGw1', 'VpnGw2', 'VpnGw3') and todouble({s2stunnels}) <= 30, \\r\\n                            (todouble({s2stunnels}) - 10) * 0.015 * 730,  // 11-30 tunnels\\r\\n                        tostring(properties.sku.name) in~ ('VpnGw4', 'VpnGw5') and todouble({s2stunnels}) <= 100, \\r\\n                            (todouble({s2stunnels}) - 10) * 0.015 * 730,  // 11-100 tunnels\\r\\n                        0.0  // Over limit\\r\\n                    ) +\\r\\n                    // Additional P2S connection costs\\r\\n                    case(\\r\\n                        todouble({P2SConnections}) <= 128, 0.0,  // First 128 included\\r\\n                        (todouble({P2SConnections}) - 128) * 0.01 * 730  // Additional at $0.01/hour\\r\\n                    ), 2)))\\r\\n            ),\\r\\n        // Bastion Hosts - No additional cost for zone redundancy\\r\\n        type =~ 'microsoft.network/bastionhosts', \\\"$0.00\\\",\\r\\n        // Load Balancers - Exact tiered pricing calculation from original workbook\\r\\n        type =~ 'microsoft.network/loadbalancers', \\r\\n            strcat(\\\"$\\\", tostring(round(\\r\\n                // Tiered network rules pricing exactly matching original workbook\\r\\n                case(\\r\\n                    todouble({NetworkRules}) <= 5, todouble({NetworkRules}) * 0.025 * 730,  // First 5 rules at $0.025/hour\\r\\n                    (5 * 0.025 * 730) + ((todouble({NetworkRules}) - 5) * 0.01 * 730)  // First 5 + additional at $0.01/hour\\r\\n                ) + \\r\\n                // Data processing cost\\r\\n                (todouble({DataProcessedGb}) * 0.005), 2))),\\r\\n        // Managed Disks - Price difference calculation\\r\\n        type =~ 'Microsoft.Compute/disks', \\r\\n            case(\\r\\n                tostring(sku.name) == \\\"Premium_LRS\\\", strcat(\\\"$\\\", tostring(round((todouble({premiumZrsPricePerGB}) - todouble({premiumSsdPricePerGB})) * toint(properties.diskSizeGB), 2))),\\r\\n                tostring(sku.name) == \\\"StandardSSD_LRS\\\", strcat(\\\"$\\\", tostring(round((todouble({standardSsdZrsPricePerGB}) - todouble({standardSsdPricePerGB})) * toint(properties.diskSizeGB), 2))),\\r\\n                tostring(sku.name) == \\\"Standard_LRS\\\", strcat(\\\"$\\\", tostring(round((todouble({standardSsdZrsPricePerGB}) - todouble({standardHddPricePerGB})) * toint(properties.diskSizeGB), 2))),\\r\\n                \\\"$0.00\\\"\\r\\n            ),\\r\\n        // API Management - No additional cost for zone redundancy feature\\r\\n        type =~ 'microsoft.apimanagement/service', \\\"$0.00\\\",\\r\\n        // Service Bus - No additional cost\\r\\n        type =~ 'microsoft.servicebus/namespaces', \\\"$0.00\\\",\\r\\n        // Event Hub - No additional cost\\r\\n        type =~ 'microsoft.eventhub/namespaces', \\\"$0.00\\\",\\r\\n        // App Service Plans - No additional cost for zone redundancy feature\\r\\n        type =~ 'microsoft.web/serverfarms', \\\"$0.00\\\",\\r\\n        // Container Apps - No additional cost for zone redundancy feature\\r\\n        type =~ 'microsoft.app/managedenvironments', \\\"$0.00\\\",\\r\\n        // VM Scale Sets - No additional cost for rebalancing\\r\\n        type =~ 'microsoft.compute/virtualmachinescalesets', \\\"$0.00\\\",\\r\\n        \\r\\n        // Yellow Services (ðŸŸ¡ Cost Impact) - Percentage-based estimates\\r\\n        // Virtual Machines - 100-200% increase: Deploy 2-3 instances across zones instead of single instance\\r\\n        type =~ 'Microsoft.Compute/virtualmachines', \\\"100-200% increase: Deploy 2-3 instances across zones instead of single instance\\\",\\r\\n        // AKS - Minimal network cost increase only, no compute cost change\\r\\n        type =~ 'microsoft.containerservice/managedclusters', \\\"Minimal network cost increase - no compute cost change\\\",\\r\\n        // MySQL Flexible Servers - Zone-redundant HA typically 100% increase\\r\\n        type =~ 'microsoft.dbformysql/flexibleservers', \\\"100% increase\\\",\\r\\n        \\r\\n        // Red Services (ðŸ”´ No Cost Est.) - Complex pricing models\\r\\n        // Redis Cache - Complex pricing based on tier and throughput\\r\\n        type =~ 'microsoft.cache/redis', \\\"Complex pricing - see Azure calculator\\\",\\r\\n        // PostgreSQL Flexible Servers - Variable based on configuration\\r\\n        type =~ 'microsoft.dbforpostgresql/flexibleservers', \\\"Variable - depends on configuration\\\",\\r\\n        // NetApp Files - Complex multi-tier pricing\\r\\n        type =~ 'Microsoft.NetApp/netAppAccounts/capacityPools/volumes', \\\"Complex capacity-based pricing\\\",\\r\\n        \\r\\n        // Storage Accounts - Direct to Storage tab for detailed cost breakdown\\r\\n        type =~ 'Microsoft.Storage/StorageAccounts', \\\"Cannot be aggregated, check the Storage tab\\\",\\r\\n        // Container Registry - Zone redundancy enabled automatically at no additional cost\\r\\n        type =~ 'microsoft.containerregistry/registries', \\\"$0.00\\\",\\r\\n        // Recovery Services Vaults - ZRS may have minimal storage cost difference\\r\\n        type =~ 'microsoft.recoveryservices/vaults', \\\"Minimal cost increase for ZRS backup storage - see Azure calculator\\\",\\r\\n        \\r\\n        // All other services\\r\\n        \\\"NA\\\"\\r\\n    )\\r\\n    | extend CostImpactCategory = case(\\r\\n        type =~ 'Microsoft.Compute/virtualmachines', 'ðŸŸ¡ Cost Impact',\\r\\n        type =~ 'Microsoft.Compute/disks', 'ðŸŸ¢ Cost Est.',\\r\\n        type =~ 'microsoft.network/applicationGateways', 'ðŸŸ¢ Cost Est.',\\r\\n        type =~ 'microsoft.network/azurefirewalls', 'ðŸŸ¢ No additional cost',\\r\\n        type =~ 'Microsoft.Storage/StorageAccounts', 'ðŸŸ¢ Cost Est.',\\r\\n        type =~ 'microsoft.web/serverfarms', 'ðŸŸ¢ No additional cost',\\r\\n        type =~ 'microsoft.containerservice/managedclusters', 'ðŸŸ¡ Cost Impact',\\r\\n        type =~ 'microsoft.containerregistry/registries', 'ðŸŸ¢ No additional cost',\\r\\n        type =~ 'microsoft.apimanagement/service', 'ðŸŸ¢ No additional cost',\\r\\n        type =~ 'microsoft.servicebus/namespaces', 'ðŸŸ¢ No additional cost',\\r\\n        type =~ 'microsoft.eventhub/namespaces', 'ðŸŸ¢ No additional cost',\\r\\n        type =~ 'microsoft.cache/redis', 'ðŸ”´ No Cost Est.',\\r\\n        type =~ 'microsoft.dbformysql/flexibleservers', 'ðŸŸ¡ Cost Impact',\\r\\n        type =~ 'microsoft.dbforpostgresql/flexibleservers', 'ðŸ”´ No Cost Est.',\\r\\n        type =~ 'microsoft.documentdb/databaseaccounts', 'ðŸŸ¡ Cost Impact',\\r\\n        type =~ 'microsoft.network/loadbalancers', 'ðŸŸ¢ Cost Est.',\\r\\n        type =~ 'microsoft.network/virtualnetworkgateways', 'ðŸŸ¢ Cost Est.',\\r\\n        type =~ 'microsoft.network/publicipaddresses', 'ðŸŸ¢ Cost Est.',\\r\\n        type =~ 'microsoft.network/bastionhosts', 'ðŸŸ¢ No additional cost',\\r\\n        type =~ 'Microsoft.NetApp/netAppAccounts/capacityPools/volumes', 'ðŸ”´ No Cost Est.',\\r\\n        type =~ 'microsoft.app/managedenvironments', 'ï¿½ No additional cost',\\r\\n        type =~ 'microsoft.compute/virtualmachinescalesets', 'ðŸŸ¢ No additional cost',\\r\\n        type =~ 'microsoft.recoveryservices/vaults', 'ðŸŸ¡ Cost Impact',\\r\\n        'ðŸ” Review Required'\\r\\n    )\\r\\n    | extend ImplementationImpact = case(\\r\\n        type =~ 'Microsoft.Compute/virtualmachines', 'Medium',\\r\\n        type =~ 'Microsoft.Compute/disks', 'Low',\\r\\n        type =~ 'microsoft.network/applicationGateways', 'High',\\r\\n        type =~ 'microsoft.network/azurefirewalls', 'High',\\r\\n        type =~ 'Microsoft.Storage/StorageAccounts', 'Medium',\\r\\n        type =~ 'microsoft.web/serverfarms', case(\\r\\n            tostring(sku.tier) in~ ('Free', 'Shared', 'Basic', 'Standard') or (tostring(sku.tier) == 'Premium' and not(tostring(sku.name) contains 'v')), 'High',  // Requires tier upgrade\\r\\n            toint(sku.capacity) < 2, 'Medium',  // Instance increase needed\\r\\n            'Medium'  // Zone configuration only\\r\\n        ),\\r\\n        type =~ 'microsoft.containerservice/managedclusters', 'Low',\\r\\n        type =~ 'microsoft.containerregistry/registries', 'High',\\r\\n        type =~ 'microsoft.apimanagement/service', case(\\r\\n            tostring(sku.name) == 'Premium', 'Medium',\\r\\n            'High'\\r\\n        ),\\r\\n        type =~ 'microsoft.servicebus/namespaces', 'High',  // Automatic migration by Microsoft\\r\\n        type =~ 'microsoft.eventhub/namespaces', case(\\r\\n            tostring(sku.tier) in ('Standard', 'Premium', 'Dedicated'), 'None',\\r\\n            'Medium'\\r\\n        ),\\r\\n        type =~ 'microsoft.cache/redis', 'Medium',\\r\\n        type =~ 'microsoft.dbformysql/flexibleservers', 'Medium',\\r\\n        type =~ 'microsoft.dbforpostgresql/flexibleservers', 'Medium',\\r\\n        type =~ 'microsoft.documentdb/databaseaccounts', 'Low',\\r\\n        type =~ 'microsoft.network/loadbalancers', 'Medium',\\r\\n        type =~ 'microsoft.network/virtualnetworkgateways', 'High',\\r\\n        type =~ 'microsoft.network/publicipaddresses', 'High',\\r\\n        type =~ 'microsoft.network/bastionhosts', 'High',\\r\\n        type =~ 'Microsoft.NetApp/netAppAccounts/capacityPools/volumes', 'Medium',\\r\\n        type =~ 'microsoft.app/managedenvironments', 'High',\\r\\n        type =~ 'microsoft.compute/virtualmachinescalesets', 'Medium',\\r\\n        type =~ 'microsoft.recoveryservices/vaults', 'High',\\r\\n        'Medium'\\r\\n    )\\r\\n    | extend ImplementationComplexity = case(\\r\\n        type =~ 'Microsoft.Compute/virtualmachines', 'Medium',\\r\\n        type =~ 'Microsoft.Compute/disks', 'Low',\\r\\n        type =~ 'microsoft.network/applicationGateways', 'High',\\r\\n        type =~ 'microsoft.network/azurefirewalls', 'High',\\r\\n        type =~ 'Microsoft.Storage/StorageAccounts', 'Medium',\\r\\n        type =~ 'microsoft.web/serverfarms', case(\\r\\n            tostring(sku.tier) in~ ('Free', 'Shared', 'Basic', 'Standard') or (tostring(sku.tier) == 'Premium' and not(tostring(sku.name) contains 'v')), 'High',  // Requires tier upgrade\\r\\n            'Medium'  // Zone configuration and instance management\\r\\n        ),\\r\\n        type =~ 'microsoft.containerservice/managedclusters', 'Medium',\\r\\n        type =~ 'microsoft.containerregistry/registries', 'High',\\r\\n        type =~ 'microsoft.apimanagement/service', case(\\r\\n            tostring(sku.name) == 'Premium', 'Medium',\\r\\n            'High'\\r\\n        ),\\r\\n        type =~ 'microsoft.servicebus/namespaces', 'Low',  // Automatic migration by Microsoft\\r\\n        type =~ 'microsoft.eventhub/namespaces', case(\\r\\n            tostring(sku.tier) in ('Standard', 'Premium', 'Dedicated'), 'None',\\r\\n            'Medium'\\r\\n        ),\\r\\n        type =~ 'microsoft.cache/redis', 'Medium',\\r\\n        type =~ 'microsoft.dbformysql/flexibleservers', 'Medium',\\r\\n        type =~ 'microsoft.dbforpostgresql/flexibleservers', 'Medium',\\r\\n        type =~ 'microsoft.documentdb/databaseaccounts', 'Low',\\r\\n        type =~ 'microsoft.network/loadbalancers', 'Medium',\\r\\n        type =~ 'microsoft.network/virtualnetworkgateways', 'Medium',\\r\\n        type =~ 'microsoft.network/publicipaddresses', 'Low',\\r\\n        type =~ 'microsoft.network/bastionhosts', 'High',\\r\\n        type =~ 'Microsoft.NetApp/netAppAccounts/capacityPools/volumes', 'Medium',\\r\\n        type =~ 'microsoft.app/managedenvironments', 'Low',\\r\\n        type =~ 'microsoft.compute/virtualmachinescalesets', 'Medium',\\r\\n        type =~ 'microsoft.recoveryservices/vaults', 'High',\\r\\n        'Medium'\\r\\n    )\\r\\n    | extend Category = case(\\r\\n        type =~ 'Microsoft.Compute/virtualmachines', 'Zone Adoption Checks',\\r\\n        type =~ 'Microsoft.Compute/disks', 'Zone Adoption Checks',\\r\\n        type =~ 'microsoft.network/applicationGateways', 'Zone Adoption Checks',\\r\\n        type =~ 'microsoft.network/azurefirewalls', 'Zone Adoption Checks',\\r\\n        type =~ 'Microsoft.Storage/StorageAccounts', 'Zone Adoption Checks',\\r\\n        type =~ 'microsoft.web/serverfarms', 'Zone Adoption Checks',\\r\\n        type =~ 'microsoft.containerservice/managedclusters', 'Zone Adoption Checks',\\r\\n        type =~ 'microsoft.containerregistry/registries', 'Zone Adoption Checks',\\r\\n        type =~ 'microsoft.apimanagement/service', 'Zone Adoption Checks',\\r\\n        type =~ 'microsoft.servicebus/namespaces', 'Zone Adoption Checks',\\r\\n        type =~ 'microsoft.eventhub/namespaces', 'Zone Adoption Checks',\\r\\n        type =~ 'microsoft.cache/redis', 'Zone Adoption Checks',\\r\\n        type =~ 'microsoft.dbformysql/flexibleservers', 'Zone Adoption Checks',\\r\\n        type =~ 'microsoft.dbforpostgresql/flexibleservers', 'Zone Adoption Checks',\\r\\n        type =~ 'microsoft.documentdb/databaseaccounts', 'Zone Adoption Checks',\\r\\n        type =~ 'microsoft.network/loadbalancers', 'Zone Adoption Checks',\\r\\n        type =~ 'microsoft.network/virtualnetworkgateways', 'Zone Adoption Checks',\\r\\n        type =~ 'microsoft.network/publicipaddresses', 'Zone Adoption Checks',\\r\\n        type =~ 'microsoft.network/bastionhosts', 'Zone Adoption Checks',\\r\\n        type =~ 'Microsoft.NetApp/netAppAccounts/capacityPools/volumes', 'Zone Adoption Checks',\\r\\n        type =~ 'microsoft.app/managedenvironments', 'Zone Adoption Checks',\\r\\n        type =~ 'microsoft.compute/virtualmachinescalesets', 'Zone Adoption Checks',\\r\\n        type =~ 'microsoft.recoveryservices/vaults', 'Zone Adoption Checks',\\r\\n        'Zone Adoption Checks'\\r\\n    )\\r\\n    | project \\r\\n        Category,\\r\\n        ResourceName=name,\\r\\n        ResourceType=type,\\r\\n        ResourceGroup=resourceGroup,\\r\\n        Location=location,\\r\\n        SubscriptionId=subscriptionId,\\r\\n        Recommendation,\\r\\n        CostImpactCategory,\\r\\n        EstimatedMonthlyCost,\\r\\n        ImplementationImpact,\\r\\n        ImplementationComplexity,\\r\\n        ZoneConfigured,\\r\\n        ResourceId=id\\r\\n)\\r\\n| union (\\r\\n    // Cosmos DB - Complex cost calculation matching original workbook exactly\\r\\n    resources\\r\\n    | where resourceGroup in ({ResourceGroup}) and location in~ ({ZonalRegions}) and type =~ 'microsoft.documentdb/databaseaccounts'\\r\\n    | extend \\r\\n        multiRegionWrites = tobool(properties.enableMultipleWriteLocations),\\r\\n        regionCount = array_length(properties.locations),\\r\\n        capabilities = tostring(properties.capabilities),\\r\\n        isServerless = tostring(properties.capabilities) contains \\\"EnableServerless\\\",\\r\\n        hasAutoscale = tostring(properties.capabilities) contains \\\"EnableAutoscale\\\" or tostring(properties.capabilities) contains \\\"autoscale\\\"\\r\\n    | mv-expand loc = properties.locations\\r\\n    | extend z = tobool(loc.isZoneRedundant)\\r\\n    | summarize ZoneConfigured = max(z) by id, type, name, resourceGroup, location, subscriptionId, multiRegionWrites, regionCount, capabilities, isServerless, hasAutoscale\\r\\n    | where not(ZoneConfigured)\\r\\n    | extend \\r\\n        accountType = case(\\r\\n            multiRegionWrites and regionCount > 1, \\\"Multi-region write\\\",\\r\\n            regionCount > 1, \\\"Multi-region read\\\",\\r\\n            \\\"Single-region\\\"\\r\\n        ),\\r\\n        // Exact cost impact calculation from original workbook\\r\\n        costImpactDescription = case(\\r\\n            multiRegionWrites, \\\"No additional cost - Multi-region write accounts have no billing impact\\\",\\r\\n            isServerless, \\\"25% increase in request units (RU) consumption\\\",\\r\\n            hasAutoscale, \\\"25% increase in provisioned RU/s - FREE for autoscale resources\\\",\\r\\n            \\\"25% increase in provisioned RU/s (1.25x multiplier)\\\"\\r\\n        ),\\r\\n        costCategory = case(\\r\\n            multiRegionWrites or hasAutoscale, 'ðŸŸ¢ Cost Est.',  // No cost impact or free\\r\\n            'ðŸŸ¡ Cost Impact'  // 25% increase\\r\\n        ),\\r\\n        dollarCost = case(\\r\\n            multiRegionWrites, \\\"$0.00\\\",  // No additional cost\\r\\n            hasAutoscale, \\\"$0.00\\\",  // Free for autoscale\\r\\n            \\\"Variable: 25% increase in RU/s costs\\\"\\r\\n        )\\r\\n    | extend \\r\\n        Recommendation = 'Enable Cosmos DB zone redundancy',\\r\\n        CostImpactCategory = costCategory,\\r\\n        EstimatedMonthlyCost = costImpactDescription,\\r\\n        ImplementationImpact = case(\\r\\n            multiRegionWrites or hasAutoscale, 'Low',  // No cost impact\\r\\n            'Medium'  // 25% increase\\r\\n        ),\\r\\n        ImplementationComplexity = 'Low'  // Configuration change only\\r\\n    | extend Category = 'Zone Adoption Checks'\\r\\n    | project \\r\\n        Category,\\r\\n        ResourceName=name,\\r\\n        ResourceType=type,\\r\\n        ResourceGroup=resourceGroup,\\r\\n        Location=location,\\r\\n        SubscriptionId=subscriptionId,\\r\\n        Recommendation,\\r\\n        CostImpactCategory,\\r\\n        EstimatedMonthlyCost,\\r\\n        ImplementationImpact,\\r\\n        ImplementationComplexity,\\r\\n        ZoneConfigured,\\r\\n        ResourceId=id\\r\\n)\\r\\n| union (\\r\\n    // AKS Special Case\\r\\n    resources\\r\\n    | where resourceGroup in ({ResourceGroup}) and location in~ ({ZonalRegions}) and type =~ 'microsoft.containerservice/managedclusters'\\r\\n    | mv-expand pool = properties.agentPoolProfiles\\r\\n    | extend z = array_length(coalesce(pool.availabilityZones, dynamic([]))) > 1\\r\\n    | summarize ZoneConfigured = max(z) by id, type, name, resourceGroup, location, subscriptionId\\r\\n    | where not(ZoneConfigured)\\r\\n    | extend \\r\\n        Recommendation = 'Configure node pools across multiple availability zones',\\r\\n        CostImpactCategory = 'ï¿½ Cost Impact',\\r\\n        EstimatedMonthlyCost = 'Minimal network cost increase - no compute cost change',\\r\\n        ImplementationImpact = 'Low',\\r\\n        ImplementationComplexity = 'Medium'\\r\\n    | extend Category = 'Zone Adoption Checks'\\r\\n    | project \\r\\n        Category,\\r\\n        ResourceName=name,\\r\\n        ResourceType=type,\\r\\n        ResourceGroup=resourceGroup,\\r\\n        Location=location,\\r\\n        SubscriptionId=subscriptionId,\\r\\n        Recommendation,\\r\\n        CostImpactCategory,\\r\\n        EstimatedMonthlyCost,\\r\\n        ImplementationImpact,\\r\\n        ImplementationComplexity,\\r\\n        ZoneConfigured,\\r\\n        ResourceId=id\\r\\n)\\r\\n| union (\\r\\n    // Azure Backup Services - VM Backup Protection with Cost Calculation\\r\\n    resources\\r\\n    | where type =~ 'microsoft.compute/virtualmachines'\\r\\n        and resourceGroup in ({ResourceGroup})\\r\\n    | project \\r\\n        VMName = name, \\r\\n        ResourceGroup = resourceGroup, \\r\\n        Location = location, \\r\\n        VMId = tolower(id), \\r\\n        subscriptionId\\r\\n    // Join with managed disks to get disk size\\r\\n    | join kind=leftouter (\\r\\n        resources\\r\\n        | where type =~ 'microsoft.compute/disks'\\r\\n        | project DiskId = id, VMId = tolower(managedBy), DiskSizeGB = tostring(properties.diskSizeGB)\\r\\n    ) on $left.VMId == $right.VMId\\r\\n    // Join with Recovery Services to check backup status\\r\\n    | join kind=leftouter (\\r\\n        recoveryservicesresources\\r\\n        | where type =~ 'microsoft.recoveryservices/vaults/backupfabrics/protectioncontainers/protecteditems'\\r\\n        | where properties.protectedItemType =~ 'Microsoft.Compute/virtualMachines'\\r\\n        | extend sourceResourceId = tolower(tostring(properties.sourceResourceId))\\r\\n        | where isnotempty(sourceResourceId)\\r\\n        | distinct sourceResourceId\\r\\n    ) on $left.VMId == $right.sourceResourceId\\r\\n    | extend BackupStatus = iff(isempty(sourceResourceId), \\\"Not Protected\\\", \\\"Protected\\\")\\r\\n    | where BackupStatus == \\\"Not Protected\\\"\\r\\n    // Cost calculation\\r\\n    | extend totalDiskGb       = todouble(DiskSizeGB),\\r\\n             changeRateMonthly = todouble({changeRateDaily}) / 100.0,   // % of data change per day\\r\\n             agentCost         = todouble({backupAgentCost})      // fixed backup agent cost\\r\\n    | extend storageUsedGb     = totalDiskGb + totalDiskGb * (changeRateMonthly * 30)  // monthly churn\\r\\n    | extend SnapshotStorageGb = (totalDiskGb * changeRateMonthly) * {snapshotRetention}\\r\\n    | extend CostPerGB         = todouble({storagePricePerGbMonth})\\r\\n    | extend SnapshotCostPerGB = todouble({snapshotPrice})\\r\\n    // Cost components\\r\\n    | extend CostperBackup     = storageUsedGb * CostPerGB\\r\\n    | extend CostperSnapshot   = SnapshotStorageGb * SnapshotCostPerGB\\r\\n    | extend EstimatedMonthlyBackupCost = CostperBackup + CostperSnapshot + agentCost\\r\\n    // Final output\\r\\n    | extend \\r\\n        Recommendation = \\\"Enable VM Backup\\\",\\r\\n        ImplementationImpact = \\\"High\\\",\\r\\n        ImplementationComplexity = \\\"Low\\\",\\r\\n        CostImpactCategory = 'ðŸŸ¢ Cost Est.',\\r\\n        ZoneConfigured = false\\r\\n    | extend Category = 'BCDR'\\r\\n    | project \\r\\n        Category,\\r\\n        ResourceName=VMName,\\r\\n        ResourceType='microsoft.compute/virtualmachines/backup',\\r\\n        ResourceGroup,\\r\\n        Location,\\r\\n        SubscriptionId=subscriptionId,\\r\\n        Recommendation,\\r\\n        CostImpactCategory,\\r\\n        EstimatedMonthlyCost=strcat(\\\"$\\\", tostring(round(EstimatedMonthlyBackupCost, 2))),\\r\\n        ImplementationImpact,\\r\\n        ImplementationComplexity,\\r\\n        ZoneConfigured,\\r\\n        ResourceId=VMId\\r\\n)\\r\\n| union (\\r\\n    // Monitor - Azure Monitor Agent Check\\r\\n    resources\\r\\n    | where type =~ 'microsoft.compute/virtualmachines'\\r\\n        and resourceGroup in ({ResourceGroup})\\r\\n    | project vmId = tolower(id), vmName = name, subscriptionId, resourceGroup, location, type\\r\\n    | join kind=leftouter (\\r\\n        resources\\r\\n        | where type =~ 'microsoft.compute/virtualmachines/extensions'\\r\\n        | where name =~ 'AzureMonitorWindowsAgent' or name =~ 'AzureMonitorLinuxAgent'\\r\\n        | extend vmId = tolower(split(id, '/extensions/')[0])\\r\\n        | project vmId, hasAMA = true\\r\\n    ) on vmId\\r\\n    | extend hasAMA = iff(isnull(hasAMA), false, true)\\r\\n    | where hasAMA == false\\r\\n    | extend \\r\\n        Recommendation = \\\"Install Azure Monitor Agent\\\",\\r\\n        CostImpactCategory = 'ðŸŸ¢ No additional cost',\\r\\n        EstimatedMonthlyCost = \\\"$0.00\\\",\\r\\n        ImplementationImpact = \\\"High\\\",\\r\\n        ImplementationComplexity = \\\"Low\\\",\\r\\n        ZoneConfigured = false\\r\\n    | extend Category = 'Monitor'\\r\\n    | project \\r\\n        Category,\\r\\n        ResourceName=vmName,\\r\\n        ResourceType=type,\\r\\n        ResourceGroup=resourceGroup,\\r\\n        Location=location,\\r\\n        SubscriptionId=subscriptionId,\\r\\n        Recommendation,\\r\\n        CostImpactCategory,\\r\\n        EstimatedMonthlyCost,\\r\\n        ImplementationImpact,\\r\\n        ImplementationComplexity,\\r\\n        ZoneConfigured,\\r\\n        ResourceId=vmId\\r\\n)\\r\\n| extend NumericCost = case(\\r\\n    // Extract numeric values from cost strings that start with $\\r\\n    EstimatedMonthlyCost startswith \\\"$\\\" and not(EstimatedMonthlyCost contains \\\"increase\\\" or EstimatedMonthlyCost contains \\\"N/A\\\" or EstimatedMonthlyCost contains \\\"Complex\\\" or EstimatedMonthlyCost contains \\\"Variable\\\" or EstimatedMonthlyCost contains \\\"Minimal\\\"),\\r\\n        todouble(replace(@\\\"\\\\$\\\", \\\"\\\", EstimatedMonthlyCost)),\\r\\n    // For non-numeric costs, set to 0 for aggregation purposes\\r\\n    0.0\\r\\n)\\r\\n| summarize \\r\\n    ImpactedResourceCount = count(),\\r\\n    TotalEstimatedMonthlyCost = sum(NumericCost),\\r\\n    CostType = case(\\r\\n        sum(NumericCost) > 0, \\\"Calculable\\\",\\r\\n        any(EstimatedMonthlyCost) contains \\\"increase\\\", \\\"Percentage Impact\\\",\\r\\n        any(EstimatedMonthlyCost) contains \\\"Complex\\\", \\\"Complex Pricing\\\",\\r\\n        any(EstimatedMonthlyCost) contains \\\"Variable\\\", \\\"Variable Pricing\\\",\\r\\n        any(EstimatedMonthlyCost) contains \\\"N/A\\\", \\\"Not Applicable\\\",\\r\\n        \\\"Mixed\\\"\\r\\n    ),\\r\\n    SampleCostDescription = any(EstimatedMonthlyCost),\\r\\n    ImplementationImpact = any(ImplementationImpact),\\r\\n    ImplementationComplexity = any(ImplementationComplexity),\\r\\n    CostImpactCategory = any(CostImpactCategory)\\r\\nby Recommendation, Category\\r\\n| extend FormattedTotalCost = case(\\r\\n    TotalEstimatedMonthlyCost > 0, strcat(\\\"$\\\", tostring(round(TotalEstimatedMonthlyCost, 2))),\\r\\n    CostType == \\\"Percentage Impact\\\", SampleCostDescription,\\r\\n    CostType == \\\"Complex Pricing\\\", \\\"See Azure Calculator\\\",\\r\\n    CostType == \\\"Variable Pricing\\\", \\\"Variable - depends on configuration\\\",\\r\\n    CostType == \\\"Not Applicable\\\", \\\"N/A\\\",\\r\\n    // For services showing \\\"$0.00\\\" cost, show that instead of \\\"Can't be estimated\\\"\\r\\n    SampleCostDescription == \\\"$0.00\\\", \\\"$0.00\\\",\\r\\n    \\\"Can't be estimated\\\"\\r\\n)\\r\\n| project \\r\\n    Category,\\r\\n    Recommendation,\\r\\n    ImpactedResourceCount,\\r\\n    EstimatedCost=FormattedTotalCost,\\r\\n    ImplementationImpact,\\r\\n    ImplementationComplexity\\r\\n| order by Category asc, Recommendation asc, ImpactedResourceCount desc, EstimatedCost asc, ImplementationImpact asc, ImplementationComplexity asc\",\"size\":0,\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"ImplementationComplexity\",\"formatter\":5}],\"rowLimit\":10000,\"filter\":true,\"sortBy\":[{\"itemKey\":\"Category\",\"sortOrder\":1}]},\"sortBy\":[{\"itemKey\":\"Category\",\"sortOrder\":1}]},\"conditionalVisibility\":{\"parameterName\":\"AlwaysHidden\",\"comparison\":\"isEqualTo\",\"value\":\"True\"},\"name\":\"querySummaryOfRecs\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"// Cost Summary by Category\\r\\n// This query summarizes the estimated monthly cost by main category (Zone Adoption, BCDR, Security, Monitor)\\r\\n\\r\\n(\\r\\n    // Zone Adoption Checks\\r\\n    resources\\r\\n    | where resourceGroup in ({ResourceGroup}) and location in~ ({ZonalRegions}) and type in~ (\\r\\n        'Microsoft.Compute/virtualmachines',\\r\\n        'Microsoft.Compute/disks',\\r\\n        'microsoft.network/azurefirewalls',\\r\\n        'microsoft.network/applicationGateways',\\r\\n        'Microsoft.Network/publicIPAddresses',\\r\\n        'microsoft.network/virtualnetworkgateways',\\r\\n        'microsoft.network/bastionhosts',\\r\\n        'microsoft.network/loadbalancers',\\r\\n        'microsoft.sql/servers/databases',\\r\\n        'microsoft.cache/redis',\\r\\n        'microsoft.dbformysql/flexibleservers',\\r\\n        'microsoft.dbforpostgresql/flexibleservers',\\r\\n        'Microsoft.Storage/StorageAccounts',\\r\\n        'Microsoft.NetApp/netAppAccounts/capacityPools/volumes',\\r\\n        'microsoft.compute/virtualmachinescalesets',\\r\\n        'microsoft.apimanagement/service',\\r\\n        'microsoft.servicebus/namespaces',\\r\\n        'microsoft.eventhub/namespaces',\\r\\n        'microsoft.web/serverfarms',\\r\\n        'microsoft.containerregistry/registries',\\r\\n        'microsoft.app/managedenvironments',\\r\\n        'microsoft.recoveryservices/vaults'\\r\\n    )\\r\\n    | extend ZoneConfigured = case(\\r\\n        type =~ 'Microsoft.Compute/virtualmachines', not(isnull(zones) or array_length(zones) == 0),\\r\\n        type =~ 'Microsoft.Compute/disks', tostring(sku.name) in ('Premium_ZRS', 'StandardSSD_ZRS'),\\r\\n        type =~ 'microsoft.network/azurefirewalls', array_length(coalesce(todynamic(zones), dynamic([]))) >= 2,\\r\\n        type =~ 'microsoft.network/applicationGateways', array_length(coalesce(todynamic(zones), dynamic([]))) >= 2,\\r\\n        type =~ 'Microsoft.Network/publicIPAddresses', array_length(coalesce(todynamic(zones), dynamic([]))) >= 2,\\r\\n        type =~ 'microsoft.network/virtualnetworkgateways', tostring(properties.sku.tier) contains 'AZ',\\r\\n        type =~ 'microsoft.network/bastionhosts', array_length(coalesce(todynamic(zones), dynamic([]))) >= 2,\\r\\n        type =~ 'microsoft.network/loadbalancers', tolower(tostring(sku.name)) != 'basic' and array_length(coalesce(todynamic(zones), dynamic([]))) >= 2,\\r\\n        type =~ 'microsoft.sql/servers/databases', name != 'master' and tobool(properties.zoneRedundant),\\r\\n        type =~ 'microsoft.cache/redis', not(properties.zonalAllocationPolicy != 'Automatic' and (array_length(coalesce(todynamic(zones), dynamic([]))) <= 1 or isnull(zones))),\\r\\n        type =~ 'microsoft.dbformysql/flexibleservers', tostring(properties.highAvailability.mode) == 'ZoneRedundant',\\r\\n        type =~ 'microsoft.dbforpostgresql/flexibleservers', tostring(properties.highAvailability.mode) == 'ZoneRedundant',\\r\\n        type =~ 'Microsoft.Storage/StorageAccounts', tostring(sku.name) endswith_cs 'ZRS',\\r\\n        type =~ 'Microsoft.NetApp/netAppAccounts/capacityPools/volumes', array_length(coalesce(todynamic(zones), dynamic([]))) > 1,\\r\\n        type =~ 'microsoft.compute/virtualmachinescalesets', not(tags has \\\"aks-managed-orchestrator\\\" or name startswith \\\"aks-\\\") and not(isnull(zones) or array_length(zones) <= 1),\\r\\n        type =~ 'microsoft.apimanagement/service', not(isnull(zones) or array_length(zones) <= 1),\\r\\n        type =~ 'microsoft.servicebus/namespaces', not(iff(tobool(properties.zoneRedundant) == true, true, false) == false),\\r\\n        type =~ 'microsoft.eventhub/namespaces', not(tostring(properties.zoneRedundant) == \\\"false\\\"),\\r\\n        type =~ 'microsoft.web/serverfarms', tostring(sku.name) != \\\"Y1\\\" and (tobool(properties.zoneRedundant) == false or (tostring(sku.tier) in~ ('PremiumV2', 'PremiumV3', 'PremiumV4', 'Isolated', 'IsolatedV2') and (isnull(properties.supportsZoneRedundancy) or not(tobool(properties.supportsZoneRedundancy))))),\\r\\n        type =~ 'microsoft.containerregistry/registries', not(location in~ ({ZonalRegions})),\\r\\n        type =~ 'microsoft.app/managedenvironments', not(tobool(properties.zoneRedundant)),\\r\\n        type =~ 'microsoft.recoveryservices/vaults', not(tostring(properties.storageModelType) == \\\"ZoneRedundant\\\" or tostring(properties.storageType) == \\\"ZoneRedundant\\\"),\\r\\n        false\\r\\n    )\\r\\n    | where not(ZoneConfigured)\\r\\n    | extend Category = 'Zone Adoption Checks'\\r\\n    | extend CostImpactCategory = case(\\r\\n        type =~ 'Microsoft.Compute/virtualmachines', 'ðŸŸ¡ Cost Impact',\\r\\n        type =~ 'Microsoft.Compute/disks', 'ðŸŸ¢ Cost Est.',\\r\\n        type =~ 'microsoft.network/applicationGateways', 'ðŸŸ¢ Cost Est.',\\r\\n        type =~ 'microsoft.network/azurefirewalls', 'ðŸŸ¢ No additional cost',\\r\\n        type =~ 'Microsoft.Storage/StorageAccounts', 'ðŸŸ¢ Cost Est.',\\r\\n        type =~ 'microsoft.web/serverfarms', 'ðŸŸ¢ No additional cost',\\r\\n        type =~ 'microsoft.containerservice/managedclusters', 'ðŸŸ¡ Cost Impact',\\r\\n        type =~ 'microsoft.containerregistry/registries', 'ðŸŸ¢ No additional cost',\\r\\n        type =~ 'microsoft.apimanagement/service', 'ðŸŸ¢ No additional cost',\\r\\n        type =~ 'microsoft.servicebus/namespaces', 'ðŸŸ¢ No additional cost',\\r\\n        type =~ 'microsoft.eventhub/namespaces', 'ðŸŸ¢ No additional cost',\\r\\n        type =~ 'microsoft.cache/redis', 'ðŸ”´ No Cost Est.',\\r\\n        type =~ 'microsoft.dbformysql/flexibleservers', 'ðŸŸ¡ Cost Impact',\\r\\n        type =~ 'microsoft.dbforpostgresql/flexibleservers', 'ðŸ”´ No Cost Est.',\\r\\n        type =~ 'microsoft.network/loadbalancers', 'ðŸŸ¢ Cost Est.',\\r\\n        type =~ 'microsoft.network/virtualnetworkgateways', 'ðŸŸ¢ Cost Est.',\\r\\n        type =~ 'microsoft.network/publicipaddresses', 'ðŸŸ¢ Cost Est.',\\r\\n        type =~ 'microsoft.network/bastionhosts', 'ðŸŸ¢ No additional cost',\\r\\n        type =~ 'Microsoft.NetApp/netAppAccounts/capacityPools/volumes', 'ðŸ”´ No Cost Est.',\\r\\n        type =~ 'microsoft.app/managedenvironments', 'ðŸŸ¢ No additional cost',\\r\\n        type =~ 'microsoft.compute/virtualmachinescalesets', 'ðŸŸ¢ No additional cost',\\r\\n        type =~ 'microsoft.recoveryservices/vaults', 'ðŸŸ¡ Cost Impact',\\r\\n        'ðŸ” Review Required'\\r\\n    )\\r\\n    | extend EstimatedMonthlyCost = case(\\r\\n        type =~ 'microsoft.network/azurefirewalls', \\\"$0.00\\\",\\r\\n        type =~ 'microsoft.network/applicationGateways', \\r\\n            strcat(\\\"$\\\", tostring(round(\\r\\n                (todouble({AppGWperhour}) * 730) + \\r\\n                (todouble({CapacityUnitperhour}) * 730) + \\r\\n                case(\\r\\n                    todouble({OutboundDataTransferGb}) <= 100, 0.0,\\r\\n                    todouble({OutboundDataTransferGb}) <= 10340, (todouble({OutboundDataTransferGb}) - 100) * todouble({dataTransferTier1Price}),\\r\\n                    todouble({OutboundDataTransferGb}) <= 51440, ((10340 - 100) * todouble({dataTransferTier1Price})) + ((todouble({OutboundDataTransferGb}) - 10340) * todouble({dataTransferTier2Price})),\\r\\n                    todouble({OutboundDataTransferGb}) <= 153840, ((10340 - 100) * todouble({dataTransferTier1Price})) + ((51440 - 10340) * todouble({dataTransferTier2Price})) + ((todouble({OutboundDataTransferGb}) - 51440) * todouble({dataTransferTier3Price})),\\r\\n                    ((10340 - 100) * todouble({dataTransferTier1Price})) + ((51440 - 10340) * todouble({dataTransferTier2Price})) + ((153840 - 51440) * todouble({dataTransferTier3Price})) + ((todouble({OutboundDataTransferGb}) - 153840) * todouble({dataTransferTier4Price}))\\r\\n                ), 2))),\\r\\n        type =~ 'Microsoft.Network/publicIPAddresses', strcat(\\\"$\\\", tostring(round(todouble({PIPPerHour}) * 730, 2))),\\r\\n        type =~ 'microsoft.network/virtualnetworkgateways',\\r\\n            case(\\r\\n                tostring(properties.sku.name) contains 'AZ', \\\"$0.00\\\",\\r\\n                strcat(\\\"$\\\", tostring(round(\\r\\n                    case(\\r\\n                        tostring(properties.sku.name) in~ ('Basic', 'Standard', 'HighPerformance', 'VpnGw1'), 153.30,\\r\\n                        tostring(properties.sku.name) =~ 'VpnGw2', 394.20,\\r\\n                        tostring(properties.sku.name) =~ 'VpnGw3', 1007.40,\\r\\n                        tostring(properties.sku.name) =~ 'VpnGw4', 1686.30,\\r\\n                        tostring(properties.sku.name) =~ 'VpnGw5', 2934.60,\\r\\n                        153.30\\r\\n                    ) +\\r\\n                    case(\\r\\n                        todouble({s2stunnels}) <= 10, 0.0,\\r\\n                        tostring(properties.sku.name) in~ ('Basic', 'Standard', 'HighPerformance', 'VpnGw1', 'VpnGw2', 'VpnGw3') and todouble({s2stunnels}) <= 30, \\r\\n                            (todouble({s2stunnels}) - 10) * 0.015 * 730,\\r\\n                        tostring(properties.sku.name) in~ ('VpnGw4', 'VpnGw5') and todouble({s2stunnels}) <= 100, \\r\\n                            (todouble({s2stunnels}) - 10) * 0.015 * 730,\\r\\n                        0.0\\r\\n                    ) +\\r\\n                    case(\\r\\n                        todouble({P2SConnections}) <= 128, 0.0,\\r\\n                        (todouble({P2SConnections}) - 128) * 0.01 * 730\\r\\n                    ), 2)))\\r\\n            ),\\r\\n        type =~ 'microsoft.network/bastionhosts', \\\"$0.00\\\",\\r\\n        type =~ 'microsoft.network/loadbalancers', \\r\\n            strcat(\\\"$\\\", tostring(round(\\r\\n                case(\\r\\n                    todouble({NetworkRules}) <= 5, todouble({NetworkRules}) * 0.025 * 730,\\r\\n                    (5 * 0.025 * 730) + ((todouble({NetworkRules}) - 5) * 0.01 * 730)\\r\\n                ) + \\r\\n                (todouble({DataProcessedGb}) * 0.005), 2))),\\r\\n        type =~ 'Microsoft.Compute/disks', \\r\\n            case(\\r\\n                tostring(sku.name) == \\\"Premium_LRS\\\", strcat(\\\"$\\\", tostring(round((todouble({premiumZrsPricePerGB}) - todouble({premiumSsdPricePerGB})) * toint(properties.diskSizeGB), 2))),\\r\\n                tostring(sku.name) == \\\"StandardSSD_LRS\\\", strcat(\\\"$\\\", tostring(round((todouble({standardSsdZrsPricePerGB}) - todouble({standardSsdPricePerGB})) * toint(properties.diskSizeGB), 2))),\\r\\n                tostring(sku.name) == \\\"Standard_LRS\\\", strcat(\\\"$\\\", tostring(round((todouble({standardSsdZrsPricePerGB}) - todouble({standardHddPricePerGB})) * toint(properties.diskSizeGB), 2))),\\r\\n                \\\"$0.00\\\"\\r\\n            ),\\r\\n        type =~ 'microsoft.apimanagement/service', \\\"$0.00\\\",\\r\\n        type =~ 'microsoft.servicebus/namespaces', \\\"$0.00\\\",\\r\\n        type =~ 'microsoft.eventhub/namespaces', \\\"$0.00\\\",\\r\\n        type =~ 'microsoft.web/serverfarms', \\\"$0.00\\\",\\r\\n        type =~ 'microsoft.app/managedenvironments', \\\"$0.00\\\",\\r\\n        type =~ 'microsoft.compute/virtualmachinescalesets', \\\"$0.00\\\",\\r\\n        type =~ 'Microsoft.Compute/virtualmachines', \\\"100-200% increase\\\",\\r\\n        type =~ 'microsoft.containerservice/managedclusters', \\\"Minimal network cost increase\\\",\\r\\n        type =~ 'microsoft.dbformysql/flexibleservers', \\\"100% increase\\\",\\r\\n        type =~ 'microsoft.cache/redis', \\\"Complex pricing\\\",\\r\\n        type =~ 'microsoft.dbforpostgresql/flexibleservers', \\\"Variable\\\",\\r\\n        type =~ 'Microsoft.NetApp/netAppAccounts/capacityPools/volumes', \\\"Complex pricing\\\",\\r\\n        type =~ 'Microsoft.Storage/StorageAccounts', \\\"NA\\\",\\r\\n        type =~ 'microsoft.containerregistry/registries', \\\"$0.00\\\",\\r\\n        type =~ 'microsoft.recoveryservices/vaults', \\\"Minimal increase\\\",\\r\\n        \\\"NA\\\"\\r\\n    )\\r\\n    | project Category, EstimatedMonthlyCost, type\\r\\n)\\r\\n| union (\\r\\n    // BCDR - VM Backup Protection\\r\\n    resources\\r\\n    | where type =~ 'microsoft.compute/virtualmachines'\\r\\n        and resourceGroup in ({ResourceGroup})\\r\\n    | project \\r\\n        VMId = tolower(id), \\r\\n        type\\r\\n    | join kind=leftouter (\\r\\n        resources\\r\\n        | where type =~ 'microsoft.compute/disks'\\r\\n        | project DiskId = id, VMId = tolower(managedBy), DiskSizeGB = tostring(properties.diskSizeGB)\\r\\n    ) on $left.VMId == $right.VMId\\r\\n    | join kind=leftouter (\\r\\n        recoveryservicesresources\\r\\n        | where type =~ 'microsoft.recoveryservices/vaults/backupfabrics/protectioncontainers/protecteditems'\\r\\n        | where properties.protectedItemType =~ 'Microsoft.Compute/virtualMachines'\\r\\n        | extend sourceResourceId = tolower(tostring(properties.sourceResourceId))\\r\\n        | where isnotempty(sourceResourceId)\\r\\n        | distinct sourceResourceId\\r\\n    ) on $left.VMId == $right.sourceResourceId\\r\\n    | extend BackupStatus = iff(isempty(sourceResourceId), \\\"Not Protected\\\", \\\"Protected\\\")\\r\\n    | where BackupStatus == \\\"Not Protected\\\"\\r\\n    | extend totalDiskGb       = todouble(DiskSizeGB),\\r\\n             changeRateMonthly = todouble({changeRateDaily}) / 100.0,\\r\\n             agentCost         = todouble({backupAgentCost})\\r\\n    | extend storageUsedGb     = totalDiskGb + totalDiskGb * (changeRateMonthly * 30)\\r\\n    | extend SnapshotStorageGb = (totalDiskGb * changeRateMonthly) * {snapshotRetention}\\r\\n    | extend CostPerGB         = todouble({storagePricePerGbMonth})\\r\\n    | extend SnapshotCostPerGB = todouble({snapshotPrice})\\r\\n    | extend CostperBackup     = storageUsedGb * CostPerGB\\r\\n    | extend CostperSnapshot   = SnapshotStorageGb * SnapshotCostPerGB\\r\\n    | extend EstimatedMonthlyBackupCost = CostperBackup + CostperSnapshot + agentCost\\r\\n    | extend Category = 'BCDR'\\r\\n    | extend EstimatedMonthlyCost = strcat(\\\"$\\\", tostring(round(EstimatedMonthlyBackupCost, 2)))\\r\\n    | project Category, EstimatedMonthlyCost, type\\r\\n)\\r\\n| union (\\r\\n    // Security - Defender for Cloud\\r\\n    resources\\r\\n    | where type =~ 'microsoft.compute/virtualmachines'\\r\\n        and resourceGroup in ({ResourceGroup})\\r\\n    | extend vmIdLower = tolower(id)\\r\\n    | project vmIdLower, type\\r\\n    | join kind=leftouter (\\r\\n        resources\\r\\n        | where type =~ 'microsoft.compute/virtualmachines/extensions'\\r\\n        | where tolower(name) has \\\"mde.windows\\\"\\r\\n            or tolower(tostring(properties.type)) == \\\"mde.windows\\\"\\r\\n            or tolower(tostring(properties.publisher)) == \\\"microsoft.azure.azuredefenderforservers\\\"\\r\\n        | where tolower(tostring(properties.provisioningState)) == \\\"succeeded\\\"\\r\\n        | extend vmIdLower = tolower(tostring(split(id, \\\"/extensions/\\\")[0]))\\r\\n        | project vmIdLower\\r\\n        | distinct vmIdLower\\r\\n    ) on vmIdLower\\r\\n    | where isempty(vmIdLower1)\\r\\n    | extend AgentCost = todouble({defenderforServeragent})\\r\\n    | extend Category = 'Security'\\r\\n    | extend EstimatedMonthlyCost = strcat(\\\"$\\\", tostring(round(AgentCost, 2)))\\r\\n    | project Category, EstimatedMonthlyCost, type\\r\\n)\\r\\n| extend NumericCost = case(\\r\\n    EstimatedMonthlyCost startswith \\\"$\\\" and not(EstimatedMonthlyCost contains \\\"increase\\\" or EstimatedMonthlyCost contains \\\"N/A\\\" or EstimatedMonthlyCost contains \\\"Complex\\\" or EstimatedMonthlyCost contains \\\"Variable\\\" or EstimatedMonthlyCost contains \\\"Minimal\\\"),\\r\\n        todouble(replace(@\\\"\\\\$\\\", \\\"\\\", EstimatedMonthlyCost)),\\r\\n    0.0\\r\\n)\\r\\n| summarize \\r\\n    ResourceCount = count(),\\r\\n    TotalEstimatedCost = sum(NumericCost),\\r\\n    EstimableResources = countif(NumericCost > 0),\\r\\n    NonEstimableResources = countif(NumericCost == 0)\\r\\nby Category\\r\\n| extend FormattedCost = case(\\r\\n    TotalEstimatedCost > 0, strcat(\\\"$\\\", tostring(round(TotalEstimatedCost, 2))),\\r\\n    \\\"Not calculable\\\"\\r\\n)\\r\\n| project \\r\\n    Category,\\r\\n    ResourceCount,\\r\\n    EstimableResources,\\r\\n    NonEstimableResources,\\r\\n    TotalEstimatedMonthlyCost = FormattedCost\\r\\n| order by Category asc\\r\\n\",\"size\":0,\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"ImplementationComplexity\",\"formatter\":5}],\"filter\":true},\"sortBy\":[]},\"conditionalVisibility\":{\"parameterName\":\"AlwaysHidden\",\"comparison\":\"isEqualTo\",\"value\":\"true\"},\"name\":\"queryZoneAdoptionExport - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where type =~ 'microsoft.compute/virtualmachines'\\r\\n    and resourceGroup in ({ResourceGroup})\\r\\n| extend vmId = tolower(id)\\r\\n| join kind=leftouter (\\r\\n    securityresources\\r\\n    | where type == \\\"microsoft.security/assessments\\\"\\r\\n    | where properties.resourceDetails.ResourceType =~ \\\"microsoft.compute/virtualmachines\\\"\\r\\n    | extend vmId = tolower(tostring(properties.resourceDetails.Id))\\r\\n    | summarize hasAssessments = count() by vmId\\r\\n) on vmId\\r\\n| where isempty(hasAssessments)\\r\\n// Cost calculation\\r\\n| extend AgentCost = todouble({defenderforServeragent})\\r\\n| extend \\r\\n    Recommendation = \\\"Enable Defender for Cloud on VM\\\",\\r\\n    ImplementationImpact = \\\"High\\\",\\r\\n    ImplementationComplexity = \\\"Low\\\",\\r\\n    CostImpactCategory = 'ðŸŸ¢ Cost Est.',\\r\\n    ZoneConfigured = false\\r\\n| extend Category = 'Security'\\r\\n| project \\r\\n    Category,\\r\\n    ResourceName=name,\\r\\n    ResourceType='microsoft.compute/virtualmachines/defender',\\r\\n    ResourceGroup=resourceGroup,\\r\\n    Location=location,\\r\\n    SubscriptionId=subscriptionId,\\r\\n    Recommendation,\\r\\n    CostImpactCategory,\\r\\n    EstimatedMonthlyCost=strcat(\\\"$\\\", tostring(round(AgentCost, 2))),\\r\\n    ImplementationImpact,\\r\\n    ImplementationComplexity,\\r\\n    ZoneConfigured,\\r\\n    ResourceId=vmId\\r\\n// Aggregate results by recommendation\\r\\n| extend NumericCost = case(\\r\\n    EstimatedMonthlyCost startswith \\\"$\\\" and not(EstimatedMonthlyCost contains \\\"increase\\\" or EstimatedMonthlyCost contains \\\"N/A\\\" or EstimatedMonthlyCost contains \\\"Complex\\\" or EstimatedMonthlyCost contains \\\"Variable\\\" or EstimatedMonthlyCost contains \\\"Minimal\\\"),\\r\\n        todouble(replace(@\\\"\\\\$\\\", \\\"\\\", EstimatedMonthlyCost)),\\r\\n    0.0\\r\\n)\\r\\n| summarize \\r\\n    ImpactedResourceCount = count(),\\r\\n    TotalEstimatedMonthlyCost = sum(NumericCost),\\r\\n    CostType = case(\\r\\n        sum(NumericCost) > 0, \\\"Calculable\\\",\\r\\n        any(EstimatedMonthlyCost) contains \\\"increase\\\", \\\"Percentage Impact\\\",\\r\\n        any(EstimatedMonthlyCost) contains \\\"Complex\\\", \\\"Complex Pricing\\\",\\r\\n        any(EstimatedMonthlyCost) contains \\\"Variable\\\", \\\"Variable Pricing\\\",\\r\\n        any(EstimatedMonthlyCost) contains \\\"N/A\\\", \\\"Not Applicable\\\",\\r\\n        \\\"Mixed\\\"\\r\\n    ),\\r\\n    SampleCostDescription = any(EstimatedMonthlyCost),\\r\\n    ImplementationImpact = any(ImplementationImpact),\\r\\n    ImplementationComplexity = any(ImplementationComplexity),\\r\\n    CostImpactCategory = any(CostImpactCategory)\\r\\nby Recommendation, Category\\r\\n| extend FormattedTotalCost = case(\\r\\n    TotalEstimatedMonthlyCost > 0, strcat(\\\"$\\\", tostring(round(TotalEstimatedMonthlyCost, 2))),\\r\\n    CostType == \\\"Percentage Impact\\\", SampleCostDescription,\\r\\n    CostType == \\\"Complex Pricing\\\", \\\"See Azure Calculator\\\",\\r\\n    CostType == \\\"Variable Pricing\\\", \\\"Variable - depends on configuration\\\",\\r\\n    CostType == \\\"Not Applicable\\\", \\\"N/A\\\",\\r\\n    SampleCostDescription == \\\"$0.00\\\", \\\"$0.00\\\",\\r\\n    \\\"Can't be estimated\\\"\\r\\n)\\r\\n| project \\r\\n    Category,\\r\\n    Recommendation,\\r\\n    ImpactedResourceCount,\\r\\n    EstimatedCost=FormattedTotalCost,\\r\\n    ImplementationImpact,\\r\\n    ImplementationComplexity\\r\\n| order by Category asc, Recommendation asc, ImpactedResourceCount desc, EstimatedCost asc, ImplementationImpact asc, ImplementationComplexity asc\\r\\n\",\"size\":0,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"]},\"conditionalVisibility\":{\"parameterName\":\"AlwaysHidden\",\"comparison\":\"isEqualTo\",\"value\":\"true\"},\"name\":\"SecurityQuery\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"{\\\"version\\\":\\\"Merge/1.0\\\",\\\"merges\\\":[{\\\"id\\\":\\\"6e647884-5cd3-4e21-86bb-544231f740db\\\",\\\"mergeType\\\":\\\"union\\\",\\\"leftTable\\\":\\\"querySummaryOfRecs\\\",\\\"rightTable\\\":\\\"SecurityQuery\\\"}],\\\"projectRename\\\":[{\\\"originalName\\\":\\\"[querySummaryOfRecs].Category\\\",\\\"mergedName\\\":\\\"Category\\\",\\\"fromId\\\":\\\"6e647884-5cd3-4e21-86bb-544231f740db\\\"},{\\\"originalName\\\":\\\"[querySummaryOfRecs].Recommendation\\\",\\\"mergedName\\\":\\\"Recommendation\\\",\\\"fromId\\\":\\\"6e647884-5cd3-4e21-86bb-544231f740db\\\"},{\\\"originalName\\\":\\\"[querySummaryOfRecs].ImpactedResourceCount\\\",\\\"mergedName\\\":\\\"ImpactedResourceCount\\\",\\\"fromId\\\":\\\"6e647884-5cd3-4e21-86bb-544231f740db\\\"},{\\\"originalName\\\":\\\"[querySummaryOfRecs].EstimatedCost\\\",\\\"mergedName\\\":\\\"EstimatedCost\\\",\\\"fromId\\\":\\\"6e647884-5cd3-4e21-86bb-544231f740db\\\"},{\\\"originalName\\\":\\\"[querySummaryOfRecs].ImplementationImpact\\\",\\\"mergedName\\\":\\\"ImplementationImpact\\\",\\\"fromId\\\":\\\"6e647884-5cd3-4e21-86bb-544231f740db\\\"},{\\\"originalName\\\":\\\"[querySummaryOfRecs].ImplementationComplexity\\\",\\\"mergedName\\\":\\\"ImplementationComplexity\\\",\\\"fromId\\\":\\\"6e647884-5cd3-4e21-86bb-544231f740db\\\"},{\\\"originalName\\\":\\\"Category\\\",\\\"mergedName\\\":\\\"Category\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"Recommendation\\\",\\\"mergedName\\\":\\\"Recommendation\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"ImpactedResourceCount\\\",\\\"mergedName\\\":\\\"ImpactedResourceCount\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"EstimatedCost\\\",\\\"mergedName\\\":\\\"EstimatedCost\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"ImplementationImpact\\\",\\\"mergedName\\\":\\\"ImplementationImpact\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"ImplementationComplexity\\\",\\\"mergedName\\\":\\\"ImplementationComplexity\\\",\\\"fromId\\\":\\\"unknown\\\"}]}\",\"size\":0,\"queryType\":7,\"gridSettings\":{\"sortBy\":[{\"itemKey\":\"Category\",\"sortOrder\":1}]},\"sortBy\":[{\"itemKey\":\"Category\",\"sortOrder\":1}]},\"showPin\":false,\"name\":\"SummaryofCosts\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"// Grand Total Cost Summary\\r\\n// This query calculates the total estimated monthly cost across all categories (Zone Adoption, BCDR, Security)\\r\\n\\r\\n(\\r\\n    // Zone Adoption Checks\\r\\n    resources\\r\\n    | where resourceGroup in ({ResourceGroup}) and location in~ ({ZonalRegions}) and type in~ (\\r\\n        'Microsoft.Compute/virtualmachines',\\r\\n        'Microsoft.Compute/disks',\\r\\n        'microsoft.network/azurefirewalls',\\r\\n        'microsoft.network/applicationGateways',\\r\\n        'Microsoft.Network/publicIPAddresses',\\r\\n        'microsoft.network/virtualnetworkgateways',\\r\\n        'microsoft.network/bastionhosts',\\r\\n        'microsoft.network/loadbalancers',\\r\\n        'microsoft.sql/servers/databases',\\r\\n        'microsoft.cache/redis',\\r\\n        'microsoft.dbformysql/flexibleservers',\\r\\n        'microsoft.dbforpostgresql/flexibleservers',\\r\\n        'Microsoft.Storage/StorageAccounts',\\r\\n        'Microsoft.NetApp/netAppAccounts/capacityPools/volumes',\\r\\n        'microsoft.compute/virtualmachinescalesets',\\r\\n        'microsoft.apimanagement/service',\\r\\n        'microsoft.servicebus/namespaces',\\r\\n        'microsoft.eventhub/namespaces',\\r\\n        'microsoft.web/serverfarms',\\r\\n        'microsoft.containerregistry/registries',\\r\\n        'microsoft.app/managedenvironments',\\r\\n        'microsoft.recoveryservices/vaults'\\r\\n    )\\r\\n    | extend ZoneConfigured = case(\\r\\n        type =~ 'Microsoft.Compute/virtualmachines', not(isnull(zones) or array_length(zones) == 0),\\r\\n        type =~ 'Microsoft.Compute/disks', tostring(sku.name) in ('Premium_ZRS', 'StandardSSD_ZRS'),\\r\\n        type =~ 'microsoft.network/azurefirewalls', array_length(coalesce(todynamic(zones), dynamic([]))) >= 2,\\r\\n        type =~ 'microsoft.network/applicationGateways', array_length(coalesce(todynamic(zones), dynamic([]))) >= 2,\\r\\n        type =~ 'Microsoft.Network/publicIPAddresses', array_length(coalesce(todynamic(zones), dynamic([]))) >= 2,\\r\\n        type =~ 'microsoft.network/virtualnetworkgateways', tostring(properties.sku.tier) contains 'AZ',\\r\\n        type =~ 'microsoft.network/bastionhosts', array_length(coalesce(todynamic(zones), dynamic([]))) >= 2,\\r\\n        type =~ 'microsoft.network/loadbalancers', tolower(tostring(sku.name)) != 'basic' and array_length(coalesce(todynamic(zones), dynamic([]))) >= 2,\\r\\n        type =~ 'microsoft.sql/servers/databases', name != 'master' and tobool(properties.zoneRedundant),\\r\\n        type =~ 'microsoft.cache/redis', not(properties.zonalAllocationPolicy != 'Automatic' and (array_length(coalesce(todynamic(zones), dynamic([]))) <= 1 or isnull(zones))),\\r\\n        type =~ 'microsoft.dbformysql/flexibleservers', tostring(properties.highAvailability.mode) == 'ZoneRedundant',\\r\\n        type =~ 'microsoft.dbforpostgresql/flexibleservers', tostring(properties.highAvailability.mode) == 'ZoneRedundant',\\r\\n        type =~ 'Microsoft.Storage/StorageAccounts', tostring(sku.name) endswith_cs 'ZRS',\\r\\n        type =~ 'Microsoft.NetApp/netAppAccounts/capacityPools/volumes', array_length(coalesce(todynamic(zones), dynamic([]))) > 1,\\r\\n        type =~ 'microsoft.compute/virtualmachinescalesets', not(tags has \\\"aks-managed-orchestrator\\\" or name startswith \\\"aks-\\\") and not(isnull(zones) or array_length(zones) <= 1),\\r\\n        type =~ 'microsoft.apimanagement/service', not(isnull(zones) or array_length(zones) <= 1),\\r\\n        type =~ 'microsoft.servicebus/namespaces', not(iff(tobool(properties.zoneRedundant) == true, true, false) == false),\\r\\n        type =~ 'microsoft.eventhub/namespaces', not(tostring(properties.zoneRedundant) == \\\"false\\\"),\\r\\n        type =~ 'microsoft.web/serverfarms', tostring(sku.name) != \\\"Y1\\\" and (tobool(properties.zoneRedundant) == false or (tostring(sku.tier) in~ ('PremiumV2', 'PremiumV3', 'PremiumV4', 'Isolated', 'IsolatedV2') and (isnull(properties.supportsZoneRedundancy) or not(tobool(properties.supportsZoneRedundancy))))),\\r\\n        type =~ 'microsoft.containerregistry/registries', not(location in~ ({ZonalRegions})),\\r\\n        type =~ 'microsoft.app/managedenvironments', not(tobool(properties.zoneRedundant)),\\r\\n        type =~ 'microsoft.recoveryservices/vaults', not(tostring(properties.storageModelType) == \\\"ZoneRedundant\\\" or tostring(properties.storageType) == \\\"ZoneRedundant\\\"),\\r\\n        false\\r\\n    )\\r\\n    | where not(ZoneConfigured)\\r\\n    | extend EstimatedMonthlyCost = case(\\r\\n        type =~ 'microsoft.network/azurefirewalls', \\\"$0.00\\\",\\r\\n        type =~ 'microsoft.network/applicationGateways', \\r\\n            strcat(\\\"$\\\", tostring(round(\\r\\n                (todouble({AppGWperhour}) * 730) + \\r\\n                (todouble({CapacityUnitperhour}) * 730) + \\r\\n                case(\\r\\n                    todouble({OutboundDataTransferGb}) <= 100, 0.0,\\r\\n                    todouble({OutboundDataTransferGb}) <= 10340, (todouble({OutboundDataTransferGb}) - 100) * todouble({dataTransferTier1Price}),\\r\\n                    todouble({OutboundDataTransferGb}) <= 51440, ((10340 - 100) * todouble({dataTransferTier1Price})) + ((todouble({OutboundDataTransferGb}) - 10340) * todouble({dataTransferTier2Price})),\\r\\n                    todouble({OutboundDataTransferGb}) <= 153840, ((10340 - 100) * todouble({dataTransferTier1Price})) + ((51440 - 10340) * todouble({dataTransferTier2Price})) + ((todouble({OutboundDataTransferGb}) - 51440) * todouble({dataTransferTier3Price})),\\r\\n                    ((10340 - 100) * todouble({dataTransferTier1Price})) + ((51440 - 10340) * todouble({dataTransferTier2Price})) + ((153840 - 51440) * todouble({dataTransferTier3Price})) + ((todouble({OutboundDataTransferGb}) - 153840) * todouble({dataTransferTier4Price}))\\r\\n                ), 2))),\\r\\n        type =~ 'Microsoft.Network/publicIPAddresses', strcat(\\\"$\\\", tostring(round(todouble({PIPPerHour}) * 730, 2))),\\r\\n        type =~ 'microsoft.network/virtualnetworkgateways',\\r\\n            case(\\r\\n                tostring(properties.sku.name) contains 'AZ', \\\"$0.00\\\",\\r\\n                strcat(\\\"$\\\", tostring(round(\\r\\n                    case(\\r\\n                        tostring(properties.sku.name) in~ ('Basic', 'Standard', 'HighPerformance', 'VpnGw1'), 153.30,\\r\\n                        tostring(properties.sku.name) =~ 'VpnGw2', 394.20,\\r\\n                        tostring(properties.sku.name) =~ 'VpnGw3', 1007.40,\\r\\n                        tostring(properties.sku.name) =~ 'VpnGw4', 1686.30,\\r\\n                        tostring(properties.sku.name) =~ 'VpnGw5', 2934.60,\\r\\n                        153.30\\r\\n                    ) +\\r\\n                    case(\\r\\n                        todouble({s2stunnels}) <= 10, 0.0,\\r\\n                        tostring(properties.sku.name) in~ ('Basic', 'Standard', 'HighPerformance', 'VpnGw1', 'VpnGw2', 'VpnGw3') and todouble({s2stunnels}) <= 30, \\r\\n                            (todouble({s2stunnels}) - 10) * 0.015 * 730,\\r\\n                        tostring(properties.sku.name) in~ ('VpnGw4', 'VpnGw5') and todouble({s2stunnels}) <= 100, \\r\\n                            (todouble({s2stunnels}) - 10) * 0.015 * 730,\\r\\n                        0.0\\r\\n                    ) +\\r\\n                    case(\\r\\n                        todouble({P2SConnections}) <= 128, 0.0,\\r\\n                        (todouble({P2SConnections}) - 128) * 0.01 * 730\\r\\n                    ), 2)))\\r\\n            ),\\r\\n        type =~ 'microsoft.network/bastionhosts', \\\"$0.00\\\",\\r\\n        type =~ 'microsoft.network/loadbalancers', \\r\\n            strcat(\\\"$\\\", tostring(round(\\r\\n                case(\\r\\n                    todouble({NetworkRules}) <= 5, todouble({NetworkRules}) * 0.025 * 730,\\r\\n                    (5 * 0.025 * 730) + ((todouble({NetworkRules}) - 5) * 0.01 * 730)\\r\\n                ) + \\r\\n                (todouble({DataProcessedGb}) * 0.005), 2))),\\r\\n        type =~ 'Microsoft.Compute/disks', \\r\\n            case(\\r\\n                tostring(sku.name) == \\\"Premium_LRS\\\", strcat(\\\"$\\\", tostring(round((todouble({premiumZrsPricePerGB}) - todouble({premiumSsdPricePerGB})) * toint(properties.diskSizeGB), 2))),\\r\\n                tostring(sku.name) == \\\"StandardSSD_LRS\\\", strcat(\\\"$\\\", tostring(round((todouble({standardSsdZrsPricePerGB}) - todouble({standardSsdPricePerGB})) * toint(properties.diskSizeGB), 2))),\\r\\n                tostring(sku.name) == \\\"Standard_LRS\\\", strcat(\\\"$\\\", tostring(round((todouble({standardSsdZrsPricePerGB}) - todouble({standardHddPricePerGB})) * toint(properties.diskSizeGB), 2))),\\r\\n                \\\"$0.00\\\"\\r\\n            ),\\r\\n        type =~ 'microsoft.apimanagement/service', \\\"$0.00\\\",\\r\\n        type =~ 'microsoft.servicebus/namespaces', \\\"$0.00\\\",\\r\\n        type =~ 'microsoft.eventhub/namespaces', \\\"$0.00\\\",\\r\\n        type =~ 'microsoft.web/serverfarms', \\\"$0.00\\\",\\r\\n        type =~ 'microsoft.app/managedenvironments', \\\"$0.00\\\",\\r\\n        type =~ 'microsoft.compute/virtualmachinescalesets', \\\"$0.00\\\",\\r\\n        type =~ 'Microsoft.Compute/virtualmachines', \\\"100-200% increase\\\",\\r\\n        type =~ 'microsoft.containerservice/managedclusters', \\\"Minimal network cost increase\\\",\\r\\n        type =~ 'microsoft.dbformysql/flexibleservers', \\\"100% increase\\\",\\r\\n        type =~ 'microsoft.cache/redis', \\\"Complex pricing\\\",\\r\\n        type =~ 'microsoft.dbforpostgresql/flexibleservers', \\\"Variable\\\",\\r\\n        type =~ 'Microsoft.NetApp/netAppAccounts/capacityPools/volumes', \\\"Complex pricing\\\",\\r\\n        type =~ 'Microsoft.Storage/StorageAccounts', \\\"NA\\\",\\r\\n        type =~ 'microsoft.containerregistry/registries', \\\"$0.00\\\",\\r\\n        type =~ 'microsoft.recoveryservices/vaults', \\\"Minimal increase\\\",\\r\\n        \\\"NA\\\"\\r\\n    )\\r\\n    | project EstimatedMonthlyCost, type\\r\\n)\\r\\n| union (\\r\\n    // BCDR - VM Backup Protection\\r\\n    resources\\r\\n    | where type =~ 'microsoft.compute/virtualmachines'\\r\\n        and resourceGroup in ({ResourceGroup})\\r\\n    | project \\r\\n        VMId = tolower(id), \\r\\n        type\\r\\n    | join kind=leftouter (\\r\\n        resources\\r\\n        | where type =~ 'microsoft.compute/disks'\\r\\n        | project DiskId = id, VMId = tolower(managedBy), DiskSizeGB = tostring(properties.diskSizeGB)\\r\\n    ) on $left.VMId == $right.VMId\\r\\n    | join kind=leftouter (\\r\\n        recoveryservicesresources\\r\\n        | where type =~ 'microsoft.recoveryservices/vaults/backupfabrics/protectioncontainers/protecteditems'\\r\\n        | where properties.protectedItemType =~ 'Microsoft.Compute/virtualMachines'\\r\\n        | extend sourceResourceId = tolower(tostring(properties.sourceResourceId))\\r\\n        | where isnotempty(sourceResourceId)\\r\\n        | distinct sourceResourceId\\r\\n    ) on $left.VMId == $right.sourceResourceId\\r\\n    | extend BackupStatus = iff(isempty(sourceResourceId), \\\"Not Protected\\\", \\\"Protected\\\")\\r\\n    | where BackupStatus == \\\"Not Protected\\\"\\r\\n    | extend totalDiskGb       = todouble(DiskSizeGB),\\r\\n             changeRateMonthly = todouble({changeRateDaily}) / 100.0,\\r\\n             agentCost         = todouble({backupAgentCost})\\r\\n    | extend storageUsedGb     = totalDiskGb + totalDiskGb * (changeRateMonthly * 30)\\r\\n    | extend SnapshotStorageGb = (totalDiskGb * changeRateMonthly) * {snapshotRetention}\\r\\n    | extend CostPerGB         = todouble({storagePricePerGbMonth})\\r\\n    | extend SnapshotCostPerGB = todouble({snapshotPrice})\\r\\n    | extend CostperBackup     = storageUsedGb * CostPerGB\\r\\n    | extend CostperSnapshot   = SnapshotStorageGb * SnapshotCostPerGB\\r\\n    | extend EstimatedMonthlyBackupCost = CostperBackup + CostperSnapshot + agentCost\\r\\n    | extend EstimatedMonthlyCost = strcat(\\\"$\\\", tostring(round(EstimatedMonthlyBackupCost, 2)))\\r\\n    | project EstimatedMonthlyCost, type\\r\\n)\\r\\n| union (\\r\\n    // Security - Defender for Cloud\\r\\n    resources\\r\\n    | where type =~ 'microsoft.compute/virtualmachines'\\r\\n        and resourceGroup in ({ResourceGroup})\\r\\n    | extend vmIdLower = tolower(id)\\r\\n    | project vmIdLower, type\\r\\n    | join kind=leftouter (\\r\\n        resources\\r\\n        | where type =~ 'microsoft.compute/virtualmachines/extensions'\\r\\n        | where tolower(name) has \\\"mde.windows\\\"\\r\\n            or tolower(tostring(properties.type)) == \\\"mde.windows\\\"\\r\\n            or tolower(tostring(properties.publisher)) == \\\"microsoft.azure.azuredefenderforservers\\\"\\r\\n        | where tolower(tostring(properties.provisioningState)) == \\\"succeeded\\\"\\r\\n        | extend vmIdLower = tolower(tostring(split(id, \\\"/extensions/\\\")[0]))\\r\\n        | project vmIdLower\\r\\n        | distinct vmIdLower\\r\\n    ) on vmIdLower\\r\\n    | where isempty(vmIdLower1)\\r\\n    | extend AgentCost = todouble({defenderforServeragent})\\r\\n    | extend EstimatedMonthlyCost = strcat(\\\"$\\\", tostring(round(AgentCost, 2)))\\r\\n    | project EstimatedMonthlyCost, type\\r\\n)\\r\\n| extend NumericCost = case(\\r\\n    EstimatedMonthlyCost startswith \\\"$\\\" and not(EstimatedMonthlyCost contains \\\"increase\\\" or EstimatedMonthlyCost contains \\\"N/A\\\" or EstimatedMonthlyCost contains \\\"Complex\\\" or EstimatedMonthlyCost contains \\\"Variable\\\" or EstimatedMonthlyCost contains \\\"Minimal\\\"),\\r\\n        todouble(replace(@\\\"\\\\$\\\", \\\"\\\", EstimatedMonthlyCost)),\\r\\n    0.0\\r\\n)\\r\\n| summarize \\r\\nTotalResources = strcat(count(), \\\" impacted resources\\\"),\\r\\n    ResourcesWithCalculableCost = countif(NumericCost > 0),\\r\\n    ResourcesWithNonCalculableCost = countif(NumericCost == 0),\\r\\n    GrandTotalMonthlyCost = sum(NumericCost)\\r\\n| extend\\r\\nTotalImpactedResources= \\\"Grand total\\\",\\r\\nImpactedResources = \\\"Impacted resources\\\"\\r\\n| project \\r\\n    TotalResources,\\r\\n    TotalImpactedResources,\\r\\n    ImpactedResources,\\r\\n    ResourcesWithCalculableCost,\\r\\n    ResourcesWithNonCalculableCost,\\r\\n    GrandTotalMonthlyCost = strcat(\\\"$\\\", tostring(round(GrandTotalMonthlyCost, 2)))\\r\\n\",\"size\":0,\"title\":\"Grand total\",\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"visualization\":\"tiles\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"ImplementationComplexity\",\"formatter\":5}],\"filter\":true},\"sortBy\":[],\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"TotalImpactedResources\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"GrandTotalMonthlyCost\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":2,\"maximumSignificantDigits\":3}}},\"secondaryContent\":{\"columnMatch\":\"TotalResources\"},\"showBorder\":false,\"size\":\"full\"}},\"name\":\"queryZoneAdoptionExport -GrandTotal\"}]},\"conditionalVisibility\":{\"parameterName\":\"enableSummaryOfRecommendations\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"summaryofRecommendations\"}]},\"conditionalVisibility\":{\"parameterName\":\"SelectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Overview\"},\"name\":\"Welcome\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Zone Adoption\",\"items\":[{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"tabs\",\"links\":[{\"id\":\"ca40468d-4518-43bf-ac6e-0a11d7331e12\",\"cellValue\":\"SelectedSubTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Overview\",\"subTarget\":\"Overview\",\"style\":\"link\"},{\"id\":\"f280fc2a-f42a-42a4-ad4b-be37ab3e8b48\",\"cellValue\":\"SelectedSubTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Details\",\"subTarget\":\"Details\",\"style\":\"link\"}]},\"name\":\"links - zoneSubTab\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Zone Overview\",\"items\":[{\"type\":1,\"content\":{\"json\":\"# Availability Zones\\r\\n## Availability Zone Best Practice Checks\\r\\nThis section reviews your Azure resources for alignment with Availability Zone best practices. Recommendations focus on deploying resources across multiple zones to enhance resiliency and minimize the impact of zone-level failures. Implementing these recommendations helps ensure high availability and business continuity for your critical workloads.\",\"style\":\"upsell\"},\"name\":\"text - AvailabilityZone\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"(\\r\\n    // Subquery to find all non-compliant resources and their details\\r\\n    (\\r\\n        // Sub-subquery to analyze all resources and determine their zone status\\r\\n        resources\\r\\n        | where resourceGroup in ({ResourceGroup}) and location in~ ({ZonalRegions}) and type in~ ('Microsoft.Compute/virtualMachines','Microsoft.Compute/disks','microsoft.network/azurefirewalls','microsoft.network/applicationGateways','Microsoft.Network/publicIPAddresses','microsoft.network/virtualnetworkgateways','microsoft.network/bastionhosts','microsoft.network/loadbalancers','microsoft.sql/servers/databases','microsoft.cache/redis','microsoft.dbformysql/flexibleservers','microsoft.dbforpostgresql/flexibleservers','Microsoft.Storage/StorageAccounts','Microsoft.NetApp/netAppAccounts/capacityPools/volumes','microsoft.compute/virtualmachinescalesets','microsoft.apimanagement/service','microsoft.servicebus/namespaces','microsoft.eventhub/namespaces','microsoft.web/serverfarms','microsoft.containerregistry/registries','microsoft.app/managedenvironments')\\r\\n        | extend ZoneConfigured = case(\\r\\n            type =~ 'Microsoft.Compute/virtualMachines', array_length(coalesce(todynamic(zones), dynamic([]))) > 0,\\r\\n            type =~ 'Microsoft.Compute/disks', (tostring(sku.name) has_cs 'ZRS') or array_length(coalesce(todynamic(zones), dynamic([]))) > 0,\\r\\n            type =~ 'microsoft.network/azurefirewalls', array_length(coalesce(todynamic(zones), dynamic([]))) >= 2,\\r\\n            type =~ 'microsoft.network/applicationGateways', array_length(coalesce(todynamic(zones), dynamic([]))) >= 2,\\r\\n            type =~ 'Microsoft.Network/publicIPAddresses', array_length(coalesce(todynamic(zones), dynamic([]))) >= 2,\\r\\n            type =~ 'microsoft.network/virtualnetworkgateways', tostring(properties.sku.tier) contains 'AZ',\\r\\n            type =~ 'microsoft.network/bastionhosts', array_length(coalesce(todynamic(zones), dynamic([]))) >= 2,\\r\\n            type =~ 'microsoft.network/loadbalancers', tolower(tostring(sku.name)) != 'basic' and array_length(coalesce(todynamic(zones), dynamic([]))) >= 2,\\r\\n            type =~ 'microsoft.sql/servers/databases', tobool(properties.zoneRedundant),\\r\\n            type =~ 'microsoft.cache/redis', not(properties.zonalAllocationPolicy != 'Automatic' and (isnull(zones) or array_length(coalesce(todynamic(zones), dynamic([]))) <= 1)),\\r\\n            type =~ 'microsoft.dbformysql/flexibleservers', tostring(properties.highAvailability.mode) == 'ZoneRedundant',\\r\\n            type =~ 'microsoft.dbforpostgresql/flexibleservers', tostring(properties.highAvailability.mode) == 'ZoneRedundant',\\r\\n            type =~ 'Microsoft.Storage/StorageAccounts', tostring(sku.name) endswith_cs 'ZRS',\\r\\n            type =~ 'Microsoft.NetApp/netAppAccounts/capacityPools/volumes', array_length(coalesce(todynamic(zones), dynamic([]))) > 1,\\r\\n            type =~ 'microsoft.compute/virtualmachinescalesets', array_length(coalesce(todynamic(zones), dynamic([]))) > 1,\\r\\n            type =~ 'microsoft.apimanagement/service', array_length(coalesce(todynamic(zones), dynamic([]))) > 1,\\r\\n            type =~ 'microsoft.servicebus/namespaces', tobool(properties.zoneRedundant),\\r\\n            type =~ 'microsoft.eventhub/namespaces', tobool(properties.zoneRedundant),\\r\\n            type =~ 'microsoft.web/serverfarms', tobool(properties.zoneRedundant),\\r\\n            type =~ 'microsoft.containerregistry/registries', tostring(properties.zoneRedundancy) =~ 'Enabled',\\r\\n            type =~ 'microsoft.app/managedenvironments', tostring(properties.zoneRedundant) !~ 'false',\\r\\n            false)\\r\\n        | project id, type, ZoneConfigured\\r\\n    )\\r\\n    | union (\\r\\n        resources\\r\\n        | where resourceGroup in ({ResourceGroup}) and location in~ ({ZonalRegions}) and type =~ 'microsoft.documentdb/databaseaccounts'\\r\\n        | mv-expand loc = properties.locations | extend z = tobool(loc.isZoneRedundant) | summarize ZoneConfigured = max(z) by id, type\\r\\n    )\\r\\n    | union (\\r\\n        resources\\r\\n        | where resourceGroup in ({ResourceGroup}) and location in~ ({ZonalRegions}) and type =~ 'microsoft.containerservice/managedclusters'\\r\\n        | mv-expand pool = properties.agentPoolProfiles | extend z = array_length(coalesce(pool.availabilityZones, dynamic([]))) > 1 | summarize ZoneConfigured = max(z) by id, type\\r\\n    )\\r\\n    | where not(ZoneConfigured)\\r\\n    | extend Recommendation = case(\\r\\n        type =~ 'Microsoft.Compute/virtualmachines', 'Deploy VMs across Availability Zones',\\r\\n        type =~ 'Microsoft.Compute/disks', 'Use Azure Disks with Zone Redundant Storage',\\r\\n        type =~ 'microsoft.network/applicationGateways', 'Enable multi-zone Application Gateway',\\r\\n        type =~ 'microsoft.network/azurefirewalls', 'Deploy Azure Firewall across multiple availability zones',\\r\\n        type =~ 'Microsoft.Storage/StorageAccounts', 'Move to ZRS/GZRS storage',\\r\\n        type =~ 'microsoft.web/serverfarms', 'Enable zone redundancy on App Service Plan',\\r\\n        type =~ 'microsoft.containerservice/managedclusters', 'Use multi-zone AKS node pools',\\r\\n        type =~ 'microsoft.containerregistry/registries', 'Enable ACR zone redundancy',\\r\\n        type =~ 'microsoft.apimanagement/service', 'Enable multi-zone API Management',\\r\\n        type =~ 'microsoft.servicebus/namespaces', 'Enable Service Bus zone redundancy',\\r\\n        type =~ 'microsoft.eventhub/namespaces', 'Enable Event Hub zone redundancy',\\r\\n        type =~ 'microsoft.cache/redis', 'Enable Redis zone redundancy',\\r\\n        type =~ 'microsoft.dbformysql/flexibleservers', 'Enable MySQL zone-redundant HA',\\r\\n        type =~ 'microsoft.dbforpostgresql/flexibleservers', 'Enable PostgreSQL zone-redundant HA',\\r\\n        type =~ 'microsoft.documentdb/databaseaccounts', 'Enable Cosmos DB zone redundancy',\\r\\n        type =~ 'microsoft.network/loadbalancers', 'Use zone-redundant Standard Load Balancer',\\r\\n        type =~ 'microsoft.network/virtualnetworkgateways', 'Use AZ SKU Virtual Network Gateway',\\r\\n        type =~ 'microsoft.network/publicipaddresses', 'Create / convert to zone-redundant Public IP',\\r\\n        type =~ 'microsoft.network/bastionhosts', 'Deploy Bastion host across zones',\\r\\n        type =~ 'Microsoft.NetApp/netAppAccounts/capacityPools/volumes', 'Review ANF multi-zone deployment',\\r\\n        type =~ 'microsoft.app/managedenvironments', 'Enable Container Apps env zone redundancy',\\r\\n        type =~ 'microsoft.compute/virtualmachinescalesets', 'Distribute VM Scale Set across zones',\\r\\n        '')\\r\\n    | extend\\r\\n        ImplementationImpact = case(Recommendation == 'Deploy VMs across Availability Zones', 'High', Recommendation == 'Use Azure Disks with Zone Redundant Storage', 'Medium', Recommendation == 'Enable multi-zone Application Gateway', 'Medium', Recommendation == 'Deploy Azure Firewall across multiple availability zones', 'Medium', Recommendation == 'Move to ZRS/GZRS storage', 'Low', Recommendation == 'Enable zone redundancy on App Service Plan', 'Low', Recommendation == 'Use multi-zone AKS node pools', 'Medium', Recommendation == 'Enable ACR zone redundancy', 'Low', Recommendation == 'Enable Service Bus zone redundancy', 'Medium', Recommendation == 'Enable Event Hub zone redundancy', 'Medium', Recommendation == 'Enable Redis zone redundancy', 'Medium', Recommendation == 'Enable MySQL zone-redundant HA', 'Medium', Recommendation == 'Enable PostgreSQL zone-redundant HA', 'Medium', Recommendation == 'Enable Cosmos DB zone redundancy', 'Medium', Recommendation == 'Use zone-redundant Standard Load Balancer', 'Low', Recommendation == 'Use AZ SKU Virtual Network Gateway', 'Medium', Recommendation == 'Create / convert to zone-redundant Public IP', 'Low', Recommendation == 'Deploy Bastion host across zones', 'Low', Recommendation == 'Review ANF multi-zone deployment', 'Medium', Recommendation == 'Enable Container Apps env zone redundancy', 'Low', Recommendation == 'Distribute VM Scale Set across zones', 'Medium', ''),\\r\\n        ImplementationComplexity = case(Recommendation == 'Deploy VMs across Availability Zones', 'Low', Recommendation == 'Use Azure Disks with Zone Redundant Storage', 'Medium', Recommendation == 'Enable multi-zone Application Gateway', 'Medium', Recommendation == 'Deploy Azure Firewall across multiple availability zones', 'Medium', Recommendation == 'Move to ZRS/GZRS storage', 'Low', Recommendation == 'Enable zone redundancy on App Service Plan', 'Low', Recommendation == 'Use multi-zone AKS node pools', 'Medium', Recommendation == 'Enable ACR zone redundancy', 'Low', Recommendation == 'Enable Service Bus zone redundancy', 'Medium', Recommendation == 'Enable Event Hub zone redundancy', 'Medium', Recommendation == 'Enable Redis zone redundancy', 'Medium', Recommendation == 'Enable MySQL zone-redundant HA', 'Medium', Recommendation == 'Enable PostgreSQL zone-redundant HA', 'Medium', Recommendation == 'Enable Cosmos DB zone redundancy', 'Medium', Recommendation == 'Use zone-redundant Standard Load Balancer', 'Low', Recommendation == 'Use AZ SKU Virtual Network Gateway', 'Medium', Recommendation == 'Create / convert to zone-redundant Public IP', 'Low', Recommendation == 'Deploy Bastion host across zones', 'Low', Recommendation == 'Review ANF multi-zone deployment', 'Medium', Recommendation == 'Enable Container Apps env zone redundancy', 'Low', Recommendation == 'Distribute VM Scale Set across zones', 'Medium', ''),\\r\\n        RecommendationId = case(Recommendation == 'Deploy VMs across Availability Zones', '2bd0be95-a825-6f47-a8c6-3db1fb5eb387', Recommendation == 'Use Azure Disks with Zone Redundant Storage', 'fa0cf4f5-0b21-47b7-89a9-ee936f193ce1', Recommendation == 'Enable multi-zone Application Gateway', '5c488377-be3e-4365-92e8-09d1e8d9038c', Recommendation == 'Deploy Azure Firewall across multiple availability zones', 'e82f5b61-b0f8-48e7-8e18-5aa1f57bff81', Recommendation == 'Move to ZRS/GZRS storage', 'e6c7e1cc-2f47-264d-aa50-1da421314472', Recommendation == 'Enable zone redundancy on App Service Plan', '88cb90c2-3b99-814b-9820-821a63f600dd', Recommendation == 'Use multi-zone AKS node pools', '9f3263db-b9c0-43bb-8523-6800f9f50793', Recommendation == 'Enable ACR zone redundancy', '63491f70-22e4-3b4a-8b0c-845450e46fac', Recommendation == 'Enable Service Bus zone redundancy', '9dff9f9b-1e61-4fbf-9168-c0432240c53b', Recommendation == 'Enable Event Hub zone redundancy', '0f1bfad1-1f47-44dd-a858-71cc2610b9d4', Recommendation == 'Enable Redis zone redundancy', '5a44bd30-ae6a-4b81-9b68-dc3a8ffca4d8', Recommendation == 'Enable MySQL zone-redundant HA', '88856605-53d8-4bbd-a75b-4a7b14939d32', Recommendation == 'Enable PostgreSQL zone-redundant HA', '80b4e93c-4500-4fbd-bd6f-3ec245f72be9', Recommendation == 'Enable Cosmos DB zone redundancy', '921631f6-ed59-49a5-94c1-f0f3ececa580', Recommendation == 'Use zone-redundant Standard Load Balancer', '332e07de-da0d-4ee7-b1c4-ca9016005e1d', Recommendation == 'Use AZ SKU Virtual Network Gateway', '1afa00b3-bb4c-496d-99e5-b7bda59a057c', Recommendation == 'Create / convert to zone-redundant Public IP', 'c63b81fb-7afc-894c-a840-91bb8a8dcfaf', Recommendation == 'Deploy Bastion host across zones', 'c9b0c6f6-1f64-4b4b-8165-00770b295dd7', Recommendation == 'Review ANF multi-zone deployment', '47d100a5-7f85-5742-967a-67eb5081240a', Recommendation == 'Enable Container Apps env zone redundancy', '8dbcd94b-0948-4df3-b608-1946726c3abf', Recommendation == 'Distribute VM Scale Set across zones', '1422c567-782c-7148-ac7c-5fc14cf45adc', '')\\r\\n    | where isnotempty(Recommendation)\\r\\n    | project id, type, Recommendation, RecommendationId, ImplementationImpact, ImplementationComplexity\\r\\n)\\r\\n| join kind=leftouter (\\r\\n    // Subquery to get the total count of all relevant resources by type\\r\\n    resources\\r\\n    | where resourceGroup in ({ResourceGroup}) and location in~ ({ZonalRegions}) and type in~ ('Microsoft.Compute/virtualMachines','Microsoft.Compute/disks','microsoft.network/azurefirewalls','microsoft.network/applicationGateways','Microsoft.Network/publicIPAddresses','microsoft.network/virtualnetworkgateways','microsoft.network/bastionhosts','microsoft.network/loadbalancers','microsoft.sql/servers/databases','microsoft.cache/redis','microsoft.dbformysql/flexibleservers','microsoft.dbforpostgresql/flexibleservers','Microsoft.Storage/StorageAccounts','Microsoft.NetApp/netAppAccounts/capacityPools/volumes','microsoft.compute/virtualmachinescalesets','microsoft.apimanagement/service','microsoft.servicebus/namespaces','microsoft.eventhub/namespaces','microsoft.web/serverfarms','microsoft.containerregistry/registries','microsoft.app/managedenvironments','microsoft.documentdb/databaseaccounts','microsoft.containerservice/managedclusters')\\r\\n    | summarize Total = count() by type\\r\\n) on type\\r\\n| summarize ImpactedCount = count() by RecommendationId, type, Recommendation, ImplementationImpact, ImplementationComplexity, Total\\r\\n| extend ImpactedResources = strcat(ImpactedCount, '/', Total)\\r\\n| project Recommendation, type, ImpactedResources, ImplementationImpact, ImplementationComplexity,RecommendationId\\r\\n| order by RecommendationId\",\"size\":0,\"title\":\"Recommendation by Impact\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"visualization\":\"tiles\",\"sortBy\":[],\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"Recommendation\"},\"subtitleContent\":{\"columnMatch\":\"type\"},\"leftContent\":{\"columnMatch\":\"ImpactedResources\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"tooltipFormat\":{\"tooltip\":\"Number of impacted resources / Total resources\"}},\"secondaryContent\":{\"columnMatch\":\"RecommendationId\"},\"showBorder\":true,\"size\":\"auto\",\"styleSettings\":{\"borderStyle\":\"rounded\"}}},\"name\":\"visualImplementationImpact-Zone\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"(\\r\\n    // Subquery to find all non-compliant resources and their details\\r\\n    (\\r\\n        // Sub-subquery to analyze all resources and determine their zone status\\r\\n        resources\\r\\n        | where resourceGroup in ({ResourceGroup}) and location in~ ({ZonalRegions}) and type in~ ('Microsoft.Compute/virtualMachines','Microsoft.Compute/disks','microsoft.network/azurefirewalls','microsoft.network/applicationGateways','Microsoft.Network/publicIPAddresses','microsoft.network/virtualnetworkgateways','microsoft.network/bastionhosts','microsoft.network/loadbalancers','microsoft.sql/servers/databases','microsoft.cache/redis','microsoft.dbformysql/flexibleservers','microsoft.dbforpostgresql/flexibleservers','Microsoft.Storage/StorageAccounts','Microsoft.NetApp/netAppAccounts/capacityPools/volumes','microsoft.compute/virtualmachinescalesets','microsoft.apimanagement/service','microsoft.servicebus/namespaces','microsoft.eventhub/namespaces','microsoft.web/serverfarms','microsoft.containerregistry/registries','microsoft.app/managedenvironments')\\r\\n        | extend ZoneConfigured = case(\\r\\n            type =~ 'Microsoft.Compute/virtualMachines', array_length(coalesce(todynamic(zones), dynamic([]))) > 0,\\r\\n            type =~ 'Microsoft.Compute/disks', (tostring(sku.name) has_cs 'ZRS') or array_length(coalesce(todynamic(zones), dynamic([]))) > 0,\\r\\n            type =~ 'microsoft.network/azurefirewalls', array_length(coalesce(todynamic(zones), dynamic([]))) >= 2,\\r\\n            type =~ 'microsoft.network/applicationGateways', array_length(coalesce(todynamic(zones), dynamic([]))) >= 2,\\r\\n            type =~ 'Microsoft.Network/publicIPAddresses', array_length(coalesce(todynamic(zones), dynamic([]))) >= 2,\\r\\n            type =~ 'microsoft.network/virtualnetworkgateways', tostring(properties.sku.tier) contains 'AZ',\\r\\n            type =~ 'microsoft.network/bastionhosts', array_length(coalesce(todynamic(zones), dynamic([]))) >= 2,\\r\\n            type =~ 'microsoft.network/loadbalancers', tolower(tostring(sku.name)) != 'basic' and array_length(coalesce(todynamic(zones), dynamic([]))) >= 2,\\r\\n            type =~ 'microsoft.sql/servers/databases', tobool(properties.zoneRedundant),\\r\\n            type =~ 'microsoft.cache/redis', not(properties.zonalAllocationPolicy != 'Automatic' and (isnull(zones) or array_length(coalesce(todynamic(zones), dynamic([]))) <= 1)),\\r\\n            type =~ 'microsoft.dbformysql/flexibleservers', tostring(properties.highAvailability.mode) == 'ZoneRedundant',\\r\\n            type =~ 'microsoft.dbforpostgresql/flexibleservers', tostring(properties.highAvailability.mode) == 'ZoneRedundant',\\r\\n            type =~ 'Microsoft.Storage/StorageAccounts', tostring(sku.name) endswith_cs 'ZRS',\\r\\n            type =~ 'Microsoft.NetApp/netAppAccounts/capacityPools/volumes', array_length(coalesce(todynamic(zones), dynamic([]))) > 1,\\r\\n            type =~ 'microsoft.compute/virtualmachinescalesets', array_length(coalesce(todynamic(zones), dynamic([]))) > 1,\\r\\n            type =~ 'microsoft.apimanagement/service', array_length(coalesce(todynamic(zones), dynamic([]))) > 1,\\r\\n            type =~ 'microsoft.servicebus/namespaces', tobool(properties.zoneRedundant),\\r\\n            type =~ 'microsoft.eventhub/namespaces', tobool(properties.zoneRedundant),\\r\\n            type =~ 'microsoft.web/serverfarms', tobool(properties.zoneRedundant),\\r\\n            type =~ 'microsoft.containerregistry/registries', tostring(properties.zoneRedundancy) =~ 'Enabled',\\r\\n            type =~ 'microsoft.app/managedenvironments', tostring(properties.zoneRedundant) !~ 'false',\\r\\n            false)\\r\\n        | project id, type, ZoneConfigured\\r\\n    )\\r\\n    | union (\\r\\n        resources\\r\\n        | where resourceGroup in ({ResourceGroup}) and location in~ ({ZonalRegions}) and type =~ 'microsoft.documentdb/databaseaccounts'\\r\\n        | mv-expand loc = properties.locations | extend z = tobool(loc.isZoneRedundant) | summarize ZoneConfigured = max(z) by id, type\\r\\n    )\\r\\n    | union (\\r\\n        resources\\r\\n        | where resourceGroup in ({ResourceGroup}) and location in~ ({ZonalRegions}) and type =~ 'microsoft.containerservice/managedclusters'\\r\\n        | mv-expand pool = properties.agentPoolProfiles | extend z = array_length(coalesce(pool.availabilityZones, dynamic([]))) > 1 | summarize ZoneConfigured = max(z) by id, type\\r\\n    )\\r\\n    | where not(ZoneConfigured)\\r\\n    | extend Recommendation = case(\\r\\n        type =~ 'Microsoft.Compute/virtualmachines', 'Deploy VMs across Availability Zones',\\r\\n        type =~ 'Microsoft.Compute/disks', 'Use Azure Disks with Zone Redundant Storage',\\r\\n        type =~ 'microsoft.network/applicationGateways', 'Enable multi-zone Application Gateway',\\r\\n        type =~ 'microsoft.network/azurefirewalls', 'Deploy Azure Firewall across multiple availability zones',\\r\\n        type =~ 'Microsoft.Storage/StorageAccounts', 'Move to ZRS/GZRS storage',\\r\\n        type =~ 'microsoft.web/serverfarms', 'Enable zone redundancy on App Service Plan',\\r\\n        type =~ 'microsoft.containerservice/managedclusters', 'Use multi-zone AKS node pools',\\r\\n        type =~ 'microsoft.containerregistry/registries', 'Enable ACR zone redundancy',\\r\\n        type =~ 'microsoft.apimanagement/service', 'Enable multi-zone API Management',\\r\\n        type =~ 'microsoft.servicebus/namespaces', 'Enable Service Bus zone redundancy',\\r\\n        type =~ 'microsoft.eventhub/namespaces', 'Enable Event Hub zone redundancy',\\r\\n        type =~ 'microsoft.cache/redis', 'Enable Redis zone redundancy',\\r\\n        type =~ 'microsoft.dbformysql/flexibleservers', 'Enable MySQL zone-redundant HA',\\r\\n        type =~ 'microsoft.dbforpostgresql/flexibleservers', 'Enable PostgreSQL zone-redundant HA',\\r\\n        type =~ 'microsoft.documentdb/databaseaccounts', 'Enable Cosmos DB zone redundancy',\\r\\n        type =~ 'microsoft.network/loadbalancers', 'Use zone-redundant Standard Load Balancer',\\r\\n        type =~ 'microsoft.network/virtualnetworkgateways', 'Use AZ SKU Virtual Network Gateway',\\r\\n        type =~ 'microsoft.network/publicipaddresses', 'Create / convert to zone-redundant Public IP',\\r\\n        type =~ 'microsoft.network/bastionhosts', 'Deploy Bastion host across zones',\\r\\n        type =~ 'Microsoft.NetApp/netAppAccounts/capacityPools/volumes', 'Review ANF multi-zone deployment',\\r\\n        type =~ 'microsoft.app/managedenvironments', 'Enable Container Apps env zone redundancy',\\r\\n        type =~ 'microsoft.compute/virtualmachinescalesets', 'Distribute VM Scale Set across zones',\\r\\n        '')\\r\\n    | extend\\r\\n        ImplementationImpact = case(Recommendation == 'Deploy VMs across Availability Zones', 'High', Recommendation == 'Use Azure Disks with Zone Redundant Storage', 'Medium', Recommendation == 'Enable multi-zone Application Gateway', 'Medium', Recommendation == 'Deploy Azure Firewall across multiple availability zones', 'Medium', Recommendation == 'Move to ZRS/GZRS storage', 'Low', Recommendation == 'Enable zone redundancy on App Service Plan', 'Low', Recommendation == 'Use multi-zone AKS node pools', 'Medium', Recommendation == 'Enable ACR zone redundancy', 'Low', Recommendation == 'Enable Service Bus zone redundancy', 'Medium', Recommendation == 'Enable Event Hub zone redundancy', 'Medium', Recommendation == 'Enable Redis zone redundancy', 'Medium', Recommendation == 'Enable MySQL zone-redundant HA', 'Medium', Recommendation == 'Enable PostgreSQL zone-redundant HA', 'Medium', Recommendation == 'Enable Cosmos DB zone redundancy', 'Medium', Recommendation == 'Use zone-redundant Standard Load Balancer', 'Low', Recommendation == 'Use AZ SKU Virtual Network Gateway', 'Medium', Recommendation == 'Create / convert to zone-redundant Public IP', 'Low', Recommendation == 'Deploy Bastion host across zones', 'Low', Recommendation == 'Review ANF multi-zone deployment', 'Medium', Recommendation == 'Enable Container Apps env zone redundancy', 'Low', Recommendation == 'Distribute VM Scale Set across zones', 'Medium', ''),\\r\\n        ImplementationComplexity = case(Recommendation == 'Deploy VMs across Availability Zones', 'Low', Recommendation == 'Use Azure Disks with Zone Redundant Storage', 'Medium', Recommendation == 'Enable multi-zone Application Gateway', 'Medium', Recommendation == 'Deploy Azure Firewall across multiple availability zones', 'Medium', Recommendation == 'Move to ZRS/GZRS storage', 'Low', Recommendation == 'Enable zone redundancy on App Service Plan', 'Low', Recommendation == 'Use multi-zone AKS node pools', 'Medium', Recommendation == 'Enable ACR zone redundancy', 'Low', Recommendation == 'Enable Service Bus zone redundancy', 'Medium', Recommendation == 'Enable Event Hub zone redundancy', 'Medium', Recommendation == 'Enable Redis zone redundancy', 'Medium', Recommendation == 'Enable MySQL zone-redundant HA', 'Medium', Recommendation == 'Enable PostgreSQL zone-redundant HA', 'Medium', Recommendation == 'Enable Cosmos DB zone redundancy', 'Medium', Recommendation == 'Use zone-redundant Standard Load Balancer', 'Low', Recommendation == 'Use AZ SKU Virtual Network Gateway', 'Medium', Recommendation == 'Create / convert to zone-redundant Public IP', 'Low', Recommendation == 'Deploy Bastion host across zones', 'Low', Recommendation == 'Review ANF multi-zone deployment', 'Medium', Recommendation == 'Enable Container Apps env zone redundancy', 'Low', Recommendation == 'Distribute VM Scale Set across zones', 'Medium', ''),\\r\\n        RecommendationId = case(Recommendation == 'Deploy VMs across Availability Zones', '2bd0be95-a825-6f47-a8c6-3db1fb5eb387', Recommendation == 'Use Azure Disks with Zone Redundant Storage', 'fa0cf4f5-0b21-47b7-89a9-ee936f193ce1', Recommendation == 'Enable multi-zone Application Gateway', '5c488377-be3e-4365-92e8-09d1e8d9038c', Recommendation == 'Deploy Azure Firewall across multiple availability zones', 'e82f5b61-b0f8-48e7-8e18-5aa1f57bff81', Recommendation == 'Move to ZRS/GZRS storage', 'e6c7e1cc-2f47-264d-aa50-1da421314472', Recommendation == 'Enable zone redundancy on App Service Plan', '88cb90c2-3b99-814b-9820-821a63f600dd', Recommendation == 'Use multi-zone AKS node pools', '9f3263db-b9c0-43bb-8523-6800f9f50793', Recommendation == 'Enable ACR zone redundancy', '63491f70-22e4-3b4a-8b0c-845450e46fac', Recommendation == 'Enable Service Bus zone redundancy', '9dff9f9b-1e61-4fbf-9168-c0432240c53b', Recommendation == 'Enable Event Hub zone redundancy', '0f1bfad1-1f47-44dd-a858-71cc2610b9d4', Recommendation == 'Enable Redis zone redundancy', '5a44bd30-ae6a-4b81-9b68-dc3a8ffca4d8', Recommendation == 'Enable MySQL zone-redundant HA', '88856605-53d8-4bbd-a75b-4a7b14939d32', Recommendation == 'Enable PostgreSQL zone-redundant HA', '80b4e93c-4500-4fbd-bd6f-3ec245f72be9', Recommendation == 'Enable Cosmos DB zone redundancy', '921631f6-ed59-49a5-94c1-f0f3ececa580', Recommendation == 'Use zone-redundant Standard Load Balancer', '332e07de-da0d-4ee7-b1c4-ca9016005e1d', Recommendation == 'Use AZ SKU Virtual Network Gateway', '1afa00b3-bb4c-496d-99e5-b7bda59a057c', Recommendation == 'Create / convert to zone-redundant Public IP', 'c63b81fb-7afc-894c-a840-91bb8a8dcfaf', Recommendation == 'Deploy Bastion host across zones', 'c9b0c6f6-1f64-4b4b-8165-00770b295dd7', Recommendation == 'Review ANF multi-zone deployment', '47d100a5-7f85-5742-967a-67eb5081240a', Recommendation == 'Enable Container Apps env zone redundancy', '8dbcd94b-0948-4df3-b608-1946726c3abf', Recommendation == 'Distribute VM Scale Set across zones', '1422c567-782c-7148-ac7c-5fc14cf45adc', '')\\r\\n    | where isnotempty(Recommendation)\\r\\n    | project id, type, Recommendation, RecommendationId, ImplementationImpact, ImplementationComplexity\\r\\n)\\r\\n| join kind=leftouter (\\r\\n    // Subquery to get the total count of all relevant resources by type\\r\\n    resources\\r\\n    | where resourceGroup in ({ResourceGroup}) and location in~ ({ZonalRegions}) and type in~ ('Microsoft.Compute/virtualMachines','Microsoft.Compute/disks','microsoft.network/azurefirewalls','microsoft.network/applicationGateways','Microsoft.Network/publicIPAddresses','microsoft.network/virtualnetworkgateways','microsoft.network/bastionhosts','microsoft.network/loadbalancers','microsoft.sql/servers/databases','microsoft.cache/redis','microsoft.dbformysql/flexibleservers','microsoft.dbforpostgresql/flexibleservers','Microsoft.Storage/StorageAccounts','Microsoft.NetApp/netAppAccounts/capacityPools/volumes','microsoft.compute/virtualmachinescalesets','microsoft.apimanagement/service','microsoft.servicebus/namespaces','microsoft.eventhub/namespaces','microsoft.web/serverfarms','microsoft.containerregistry/registries','microsoft.app/managedenvironments','microsoft.documentdb/databaseaccounts','microsoft.containerservice/managedclusters')\\r\\n    | summarize Total = count() by type\\r\\n) on type\\r\\n| summarize ImpactedCount = count() by RecommendationId, type, Recommendation, ImplementationImpact, ImplementationComplexity, Total\\r\\n| extend ImpactedResources = strcat(ImpactedCount, '/', Total)\\r\\n| project Recommendation, type, ImpactedResources, ImplementationImpact, ImplementationComplexity,RecommendationId\\r\\n| order by RecommendationId\",\"size\":0,\"showAnalytics\":true,\"title\":\"Multi zone recommendations\",\"showRefreshButton\":true,\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"sortBy\":[{\"itemKey\":\"ImplementationComplexity\",\"sortOrder\":1}]},\"sortBy\":[{\"itemKey\":\"ImplementationComplexity\",\"sortOrder\":1}]},\"name\":\"Executive insights-zone\"}]},\"conditionalVisibility\":{\"parameterName\":\"SelectedSubTab\",\"comparison\":\"isEqualTo\",\"value\":\"Overview\"},\"name\":\"groupZoneOverview\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"# Workload Availability Zones Coverage Details\\r\\n\\r\\n>NOTE: You will find detailed insights into your scoped workloads specific configuration relating to Availability Zones. \",\"style\":\"upsell\"},\"name\":\"text - 6\"},{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"tabs\",\"links\":[{\"id\":\"b95af288-2738-4afa-87b9-eed0f729f3fe\",\"cellValue\":\"selectedDetailsTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Network Services\",\"subTarget\":\"network\",\"style\":\"link\"},{\"id\":\"847aefe6-be4a-4033-85e0-c74ab570ad1e\",\"cellValue\":\"selectedDetailsTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Data Services\",\"subTarget\":\"Data\",\"style\":\"link\"},{\"id\":\"499fa94f-a180-4cbb-8a77-79a43a965d0e\",\"cellValue\":\"selectedDetailsTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Storage Services\",\"subTarget\":\"storage\",\"style\":\"link\"},{\"id\":\"866bc76f-c9f2-4bec-a5a1-7893fd298179\",\"cellValue\":\"selectedDetailsTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Compute Services\",\"subTarget\":\"compute\",\"preText\":\"Compute\",\"style\":\"link\"},{\"id\":\"ac71eb6a-a601-4d10-a6ae-7a5a0cecc4da\",\"cellValue\":\"selectedDetailsTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Integration Services\",\"subTarget\":\"integrationServices\",\"style\":\"link\"},{\"id\":\"f7fe5554-b6cd-41e1-ba69-6b480ea4db15\",\"cellValue\":\"selectedDetailsTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"App Services\",\"subTarget\":\"app\",\"style\":\"link\"},{\"id\":\"6bb1d5e2-1063-49c5-943a-f61f94e98271\",\"cellValue\":\"selectedDetailsTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Container Services\",\"subTarget\":\"containerServices\",\"style\":\"link\"}]},\"name\":\"links - 4\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Azure Networking Services Availability Zone Coverage\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"{Subscription}\"],\"parameters\":[{\"id\":\"14bb128f-5b3f-421a-9cf7-b9ad71ece3f6\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"CheckforPublicIPs\",\"type\":1,\"isRequired\":true,\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'Microsoft.Network/publicIPAddresses'\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend locations = properties.locations\\r\\n| extend zones = zones\\r\\n| extend zoneRedundant = iif(array_length(zones) >= 2, true, false)\\r\\n//| where zoneRedundant == false\\r\\n| join kind = innerunique (\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n)\\r\\n    on id\\r\\n| summarize PublicIPCount = count()\\r\\n| extend HasNonZonalPublicIPs = iff(PublicIPCount > 0, \\\"Yes\\\", \\\"No\\\")\\r\\n| project HasNonZonalPublicIPs\",\"crossComponentResources\":[\"{Subscription}\"],\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"version\":\"KqlParameterItem/1.0\",\"name\":\"CheckForAppG\",\"type\":1,\"isRequired\":true,\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ \\\"microsoft.network/applicationGateways\\\"\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend locations=properties.locations\\r\\n| extend zoneRedundant = iif(array_length(zones) >= 2, \\\"true\\\", \\\"false\\\")\\r\\n//| where zoneRedundant == \\\"false\\\"\\r\\n| join kind = innerunique( //Tag filter\\r\\nresources\\r\\n| extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n| extend replaced_tags = parse_json(replaced_tags)\\r\\n| mv-expand replaced_tags\\r\\n| extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n| extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId=id\\r\\n| where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n)\\r\\non id\\r\\n| summarize AppGWCount = count()\\r\\n| extend HasNonZonalAppGW = iff(AppGWCount > 0, \\\"Yes\\\", \\\"No\\\")\\r\\n| project HasNonZonalAppGW\",\"crossComponentResources\":[\"{Subscription}\"],\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"id\":\"e3840b2b-7a2c-4f62-82d4-9fd03c2593b6\"},{\"version\":\"KqlParameterItem/1.0\",\"name\":\"CheckforLB\",\"type\":1,\"isRequired\":true,\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ \\\"microsoft.network/loadbalancers\\\" and tolower(sku.name) != 'basic'\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend locations = properties.locations\\r\\n| extend zones = zones\\r\\n| extend zoneRedundant = iif(array_length(zones) >= 2, \\\"true\\\", \\\"false\\\")\\r\\n//| where zoneRedundant == \\\"false\\\"\\r\\n| join kind = innerunique( //Tag filter\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId=id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n    | distinct id  // Add this line to deduplicate before join\\r\\n    )\\r\\n    on id\\r\\n| summarize LBCount = count()\\r\\n| extend HasNonZonalAppGW = iff(LBCount > 0, \\\"Yes\\\", \\\"No\\\")\\r\\n| project HasNonZonalAppGW\",\"crossComponentResources\":[\"{Subscription}\"],\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"id\":\"254e8fad-3f80-4164-8d2c-4733d9d03f75\"},{\"version\":\"KqlParameterItem/1.0\",\"name\":\"CheckforVPNGW\",\"type\":1,\"isRequired\":true,\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'Microsoft.Network/virtualNetworkGateways'\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend skuName = tostring(properties.sku.name)\\r\\n| extend skuTier = tostring(properties.sku.tier)\\r\\n| extend gatewayType = tostring(properties.gatewayType)\\r\\n| extend zoneRedundant = iif(skuName contains 'AZ' or skuTier contains 'AZ', true, false)\\r\\n//| where zoneRedundant == false\\r\\n| join kind = innerunique (\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n    | distinct id\\r\\n)\\r\\n    on id\\r\\n| summarize VPNGWCount = count()\\r\\n| extend HasNonZonalVPNGateways = iff(VPNGWCount > 0, \\\"Yes\\\", \\\"No\\\")\\r\\n| project HasNonZonalVPNGateways\",\"crossComponentResources\":[\"{Subscription}\"],\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"id\":\"50b153e7-f61d-42ff-b35e-5abd5f531097\"},{\"version\":\"KqlParameterItem/1.0\",\"name\":\"CheckforFw\",\"type\":1,\"isRequired\":true,\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'microsoft.network/azurefirewalls'\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend zoneCount = array_length(zones)\\r\\n| extend zoneRedundant = case(\\r\\n    isnull(zones) or zoneCount <= 1, false,\\r\\n    true\\r\\n)\\r\\n//| where zoneRedundant == false\\r\\n| join kind = innerunique (\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n)\\r\\n    on id\\r\\n| summarize FirewallCount = count()\\r\\n| extend HasNonZonalFirewall = iff(FirewallCount > 0, \\\"Yes\\\", \\\"No\\\")\\r\\n| project HasNonZonalFirewall\",\"crossComponentResources\":[\"{Subscription}\"],\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"id\":\"66e5520e-0c9d-49e5-88b0-fed0c76fdc3f\"},{\"version\":\"KqlParameterItem/1.0\",\"name\":\"CheckforBastion\",\"type\":1,\"isRequired\":true,\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'microsoft.network/bastionhosts'\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend zoneCount = array_length(zones)\\r\\n| extend zoneRedundant = case(\\r\\n    isnull(zones) or zoneCount <= 1, false,\\r\\n    true\\r\\n)\\r\\n//| where zoneRedundant == false\\r\\n| join kind = innerunique (\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n)\\r\\n    on id\\r\\n| summarize BastionCount = count()\\r\\n| extend HasNonZonalBastion = iff(BastionCount > 0, \\\"Yes\\\", \\\"No\\\")\\r\\n| project HasNonZonalBastion\",\"crossComponentResources\":[\"{Subscription}\"],\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"id\":\"979ff079-9010-4abf-8470-2bf9d90393ec\"}],\"style\":\"pills\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},\"conditionalVisibility\":{\"parameterName\":\"AlwaysHidden\",\"comparison\":\"isEqualTo\",\"value\":\"yes\"},\"name\":\"paramCheckNetworkAzResources\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Azure Firewalls ðŸŸ¢ [Cost Est.]\",\"items\":[{\"type\":1,\"content\":{\"json\":\"**Note:** Cost based on East US rates (Sep 2025). Zone redundancy available at no additional cost but requires redeployment. For detailed pricing, see [Azure Pricing Calculator](https://azure.microsoft.com/pricing/calculator/).\",\"style\":\"upsell\"},\"name\":\"text - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'microsoft.network/azurefirewalls'\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend zoneCount = array_length(zones)\\r\\n| extend zoneRedundant = case(\\r\\n    isnull(zones) or zoneCount <= 1, false,\\r\\n    true\\r\\n)\\r\\n| extend skuName = tostring(sku.name)\\r\\n| extend skuTier = tostring(sku.tier)\\r\\n| where zoneRedundant == false  // Only non-zone-redundant instances\\r\\n| join kind = innerunique (\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n)\\r\\n    on id\\r\\n| extend \\r\\n    Recommendation = \\\"Redeploy firewall with zone redundancy enabled (no additional cost)\\\",\\r\\n    ImplementationImpact = \\\"High\\\",\\r\\n    ImplementationComplexity = \\\"High\\\",\\r\\n    CostImpact = \\\"None\\\",\\r\\n    additionalMonthlyCost = 0.0\\r\\n| project \\r\\n    name, \\r\\n    zoneCount,\\r\\n    tostring(zones),\\r\\n    resourceGroup, \\r\\n    Recommendation, \\r\\n    ImplementationImpact, \\r\\n    ImplementationComplexity, \\r\\n        additionalMonthlyCost,\\r\\n    location, \\r\\n    subscriptionId\",\"size\":0,\"noDataMessage\":\"All Azure Firewalls have availabilty zones configured\",\"noDataMessageStyle\":3,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"zoneRedundant\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"true\",\"representation\":\"success\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"failed\",\"text\":\"{0}{1}\"}]}}]}},\"name\":\"query-azFW\"}]},\"conditionalVisibility\":{\"parameterName\":\"CheckforFw\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"groupFirewall\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Application GatewaysðŸŸ¢ [Cost Est.]\",\"items\":[{\"type\":1,\"content\":{\"json\":\"**Cost Estimate:** Monthly Application Gateway cost (Gateway + Capacity Units + Data Transfer) based on East US pay-as-you-go rates, September 2025. Assumes $0.125/hr Gateway, $0.008/hr Capacity Units, 1TB/month data transfer. For precise costs, see the [Azure Pricing Calculator](https://azure.microsoft.com/en-us/pricing/calculator/).\",\"style\":\"upsell\"},\"name\":\"text - 3\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"understand-cost-calc-yesno\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"understandCostCalculations\",\"label\":\"Show APP GW calculation details?\",\"type\":2,\"isRequired\":true,\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"jsonData\":\"[\\r\\n    {\\r\\n    \\\"value\\\" : \\\"Yes\\\",\\r\\n    \\\"label\\\" : \\\"Yes\\\"\\r\\n    },\\r\\n    {\\r\\n    \\\"value\\\" : \\\"No\\\",\\r\\n    \\\"label\\\" : \\\"No\\\",\\r\\n    \\\"selected\\\" : true\\r\\n    }\\r\\n]\",\"value\":\"Yes\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"Show Cost Calculation Details\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"a1a1ed79-dd3e-4c78-bde6-2427b0606874\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"AppGWperhour\",\"label\":\"App Gateway per hour\",\"type\":1,\"timeContext\":{\"durationMs\":86400000},\"value\":\"0.20\"},{\"version\":\"KqlParameterItem/1.0\",\"name\":\"CapacityUnitperhour\",\"type\":1,\"timeContext\":{\"durationMs\":86400000},\"label\":\"Capacity unit per hour\",\"id\":\"6c68dc7d-6b7e-4629-8595-978cf44a14fb\",\"value\":\"0.008\"},{\"version\":\"KqlParameterItem/1.0\",\"name\":\"OutboundDataTransferGb\",\"type\":1,\"timeContext\":{\"durationMs\":86400000},\"value\":\"101\",\"id\":\"865b9bac-a29a-49ab-816f-bcfbcc03456c\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"understandCostCalculations\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"param-AppGWPrice\"},{\"type\":1,\"content\":{\"json\":\"### How Application Gateway Cost is Calculated\\r\\n\\r\\n**Monthly Cost Formula:**\\r\\n- **Gateway Hours:** Application Gateway cost per hour Ã— 730 hours\\r\\n- **Capacity Units:** Capacity Unit cost per hour Ã— 730 hours  \\r\\n- **Data Transfer:** Tiered pricing based on monthly outbound data transfer\\r\\n\\r\\n**Data Transfer Pricing Tiers:**\\r\\n- First 100 GB: Free\\r\\n- Next 10 TB: $0.04 per GB\\r\\n- Next 40 TB: $0.08 per GB\\r\\n- Next 100 TB: $0.04 per GB\\r\\n- Next 350 TB: $0.065 per GB\\r\\n\\r\\n**Default Assumptions:**\\r\\n- Application Gateway: $0.125/hour\\r\\n- Capacity Unit: $0.008/hour\\r\\n- Outbound Data Transfer: 1,000 GB/month\\r\\n- Pricing based on North America/Europe regions (September 2025)\\r\\n\\r\\nYou can adjust these parameters above to match your specific usage patterns and get a more accurate cost estimate.\",\"style\":\"info\"},\"conditionalVisibility\":{\"parameterName\":\"UdnerstandCostCalculations\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"text-appgwcosts\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ \\\"microsoft.network/applicationGateways\\\"\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend locations = properties.locations\\r\\n| extend zoneRedundant = iif(array_length(zones) >= 2, \\\"true\\\", \\\"false\\\")\\r\\n| where zoneRedundant == \\\"false\\\"\\r\\n| join kind = innerunique( //Tag filter\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId=id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n    )\\r\\n    on id\\r\\n// Cost calculation for outbound data transfer with tiered pricing\\r\\n| extend outboundDataGB = todouble({OutboundDataTransferGb})\\r\\n| extend dataTransferCost = case(\\r\\n    outboundDataGB <= 100, 0.0,  // First 100 GB free\\r\\n    outboundDataGB <= 10340, (outboundDataGB - 100) * 0.04,  // Next 10 TB at $0.04/GB\\r\\n    outboundDataGB <= 51440, ((10340 - 100) * 0.04) + ((outboundDataGB - 10340) * 0.08),  // Next 40 TB at $0.08/GB\\r\\n    outboundDataGB <= 153840, ((10340 - 100) * 0.04) + ((51440 - 10340) * 0.08) + ((outboundDataGB - 51440) * 0.04),  // Next 100 TB at $0.04/GB\\r\\n    ((10340 - 100) * 0.04) + ((51440 - 10340) * 0.08) + ((153840 - 51440) * 0.04) + ((outboundDataGB - 153840) * 0.065)  // Next 350 TB at $0.065/GB\\r\\n)\\r\\n// Total cost calculation\\r\\n| extend EstimatedMonthlyCost = (todouble({AppGWperhour}) * 730) + (todouble({CapacityUnitperhour}) * 730) + dataTransferCost\\r\\n| extend \\r\\n    Recommendation = \\\"Enable Application Gateway Zone Redundancy\\\",\\r\\n    ImplementationImpact = \\\"High\\\",\\r\\n    ImplementationComplexity = \\\"Medium\\\"\\r\\n| project Recommendation, name, location, EstimatedMonthlyCost, dataTransferCost, resourceGroup, \\r\\n         ImplementationImpact, ImplementationComplexity, subscriptionId, zoneRedundant\\r\\n| sort by name asc\",\"size\":0,\"noDataMessage\":\"All Application Gateways have availability zones configured\",\"noDataMessageStyle\":3,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"zoneRedundant\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"true\",\"representation\":\"success\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"failed\",\"text\":\"{0}{1}\"}]}}]}},\"name\":\"query-app-gateways\"}]},\"name\":\"groupAppGateway\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Azure Public IPsðŸŸ¢ [Cost Est.]\",\"items\":[{\"type\":1,\"content\":{\"json\":\"> **Note:** Cost estimation is based on a Standard Public IP address, using pay-as-you-go pricing for East US as of September 2025. For more precise estimates (including other SKUs and configurations), please visit the [Azure Pricing Calculator](https://azure.microsoft.com/pricing/calculator/).\",\"style\":\"upsell\"},\"name\":\"text - public-ip\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"understand-cost-calc-yesno\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"understandCostCalculations\",\"label\":\"Show PublicIp cost calculation details?\",\"type\":2,\"isRequired\":true,\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"jsonData\":\"[\\r\\n    {\\r\\n    \\\"value\\\" : \\\"Yes\\\",\\r\\n    \\\"label\\\" : \\\"Yes\\\"\\r\\n    },\\r\\n    {\\r\\n    \\\"value\\\" : \\\"No\\\",\\r\\n    \\\"label\\\" : \\\"No\\\",\\r\\n    \\\"selected\\\" : true\\r\\n    }\\r\\n]\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"Show Cost Calculation Details\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"a1a1ed79-dd3e-4c78-bde6-2427b0606874\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"PIPPerHour\",\"label\":\"Price Public IP per hour\",\"type\":1,\"timeContext\":{\"durationMs\":86400000},\"value\":\"0.005\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"understandCostCalculations\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"param-PIPPrice\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ \\\"Microsoft.Network/publicIPAddresses\\\"\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend locations = properties.locations\\r\\n| extend zones = zones\\r\\n| extend zoneRedundant = iif(array_length(zones) >= 2, \\\"true\\\", \\\"false\\\")\\r\\n| where zoneRedundant == \\\"false\\\"\\r\\n| join kind = innerunique( //Tag filter\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId=id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n    )\\r\\n    on id\\r\\n| extend \\r\\n    ImplementationImpact = \\\"High\\\",\\r\\n    ImplementationComplexity = \\\"Low\\\",\\r\\n    EstimatedCost = todouble({PIPPerHour}) * 730\\r\\n| distinct id,name,zoneRedundant,ImplementationImpact,ImplementationComplexity,EstimatedCost,resourceGroup,subscriptionId,location\",\"size\":0,\"noDataMessage\":\"All Azure Public IPs have availability zones configured\",\"noDataMessageStyle\":3,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"zoneRedundant\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"false\",\"representation\":\"failed\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"success\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"EstimatedCost\",\"formatter\":0,\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\"}}}]}},\"name\":\"query-publicIPs\"}]},\"conditionalVisibility\":{\"parameterName\":\"CheckforPublicIPs\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"groupPublicIp\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Azure Virtual Network GatewaysðŸŸ¢ [Cost Est.]\",\"items\":[{\"type\":1,\"content\":{\"json\":\"**Cost Estimate:** Monthly VPN Gateway upgrade cost to equivalent AZ SKU based on East US rates, September 2025. Assumes 5 S2S tunnels, 50 P2S connections. For precise costs, see the [Azure Pricing Calculator](https://azure.microsoft.com/en-us/pricing/calculator/).\",\"style\":\"upsell\"},\"name\":\"text - 3\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"understand-cost-calc-yesno\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"understandCostCalculations\",\"label\":\"Show VPN Gateway cost calculation details?\",\"type\":2,\"isRequired\":true,\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"jsonData\":\"[\\r\\n    {\\r\\n    \\\"value\\\" : \\\"Yes\\\",\\r\\n    \\\"label\\\" : \\\"Yes\\\"\\r\\n    },\\r\\n    {\\r\\n    \\\"value\\\" : \\\"No\\\",\\r\\n    \\\"label\\\" : \\\"No\\\",\\r\\n    \\\"selected\\\" : true\\r\\n    }\\r\\n]\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"Show Cost Calculation Details\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"265124d1-abff-4c14-ae87-56bae2ec3aaf\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"s2stunnels\",\"label\":\"Number of Site-to-Site Tunnels\",\"type\":1,\"timeContext\":{\"durationMs\":86400000},\"value\":\"5\"},{\"version\":\"KqlParameterItem/1.0\",\"name\":\"P2SConnections\",\"label\":\"Number of Point-to-Site Connections\",\"type\":1,\"timeContext\":{\"durationMs\":86400000},\"value\":\"50\",\"id\":\"eb065df2-ab87-43cb-a65b-8e354f861f3e\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"understandCostCalculations\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"parameters - 1\"},{\"type\":1,\"content\":{\"json\":\"### How VPN Gateway Cost is Calculated\\r\\n\\r\\n**Monthly Cost Formula:**\\r\\n- **Base Gateway Cost:** Fixed monthly cost based on AZ SKU tier\\r\\n- **Additional S2S Tunnels:** $0.015/hour for tunnels beyond included limit\\r\\n- **Additional P2S Connections:** $0.01/hour for connections beyond 128\\r\\n\\r\\n**SKU Mapping & Base Costs:**\\r\\n- Basic/Standard â†’ VpnGw1AZ: $153.30/month\\r\\n- VpnGw1 â†’ VpnGw1AZ: $153.30/month  \\r\\n- VpnGw2 â†’ VpnGw2AZ: $394.20/month\\r\\n- VpnGw3 â†’ VpnGw3AZ: $1,007.40/month\\r\\n- VpnGw4 â†’ VpnGw4AZ: $1,686.30/month\\r\\n- VpnGw5 â†’ VpnGw5AZ: $2,934.60/month\\r\\n\\r\\n**Included Limits:**\\r\\n- **S2S Tunnels:** First 10 included (VpnGw1-3AZ), first 10 included (VpnGw4-5AZ supports up to 100)\\r\\n- **P2S Connections:** First 128 included for all SKUs\\r\\n\\r\\n**Calculation Example:**\\r\\n- VpnGw2AZ base cost: $394.20/month\\r\\n- 5 S2S tunnels: Free (within 10 limit)\\r\\n- 50 P2S connections: Free (within 128 limit)  \\r\\n- Total monthly cost: $394.20\\r\\n\\r\\n**Default Assumptions:**\\r\\n- S2S Tunnels: 5 tunnels\\r\\n- P2S Connections: 50 connections\\r\\n- East US pricing (September 2025)\\r\\n\\r\\nYou can adjust these parameters above to match your specific gateway configuration.\",\"style\":\"info\"},\"conditionalVisibility\":{\"parameterName\":\"understandCostCalculations\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"text - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ \\\"microsoft.network/virtualnetworkgateways\\\"\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend skuName = tostring(properties.sku.name)\\r\\n| extend skuTier = tostring(properties.sku.tier)\\r\\n| extend skuCapacity = toint(properties.sku.capacity)\\r\\n| extend gatewayType = tostring(properties.gatewayType)\\r\\n| extend locations = properties.locations\\r\\n| extend zoneRedundant = iif(skuName contains 'AZ' or skuTier contains 'AZ', \\\"true\\\", \\\"false\\\")\\r\\n| where zoneRedundant == \\\"false\\\"\\r\\n| join kind = innerunique( //Tag filter\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId=id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n    | distinct id\\r\\n    )\\r\\n    on id\\r\\n// Map current SKU to equivalent AZ SKU and calculate costs\\r\\n| extend equivalentAZSku = case(\\r\\n    skuName =~ \\\"VpnGw1\\\" or skuTier =~ \\\"VpnGw1\\\", \\\"VpnGw1AZ\\\",\\r\\n    skuName =~ \\\"VpnGw2\\\" or skuTier =~ \\\"VpnGw2\\\", \\\"VpnGw2AZ\\\", \\r\\n    skuName =~ \\\"VpnGw3\\\" or skuTier =~ \\\"VpnGw3\\\", \\\"VpnGw3AZ\\\",\\r\\n    skuName =~ \\\"VpnGw4\\\" or skuTier =~ \\\"VpnGw4\\\", \\\"VpnGw4AZ\\\",\\r\\n    skuName =~ \\\"VpnGw5\\\" or skuTier =~ \\\"VpnGw5\\\", \\\"VpnGw5AZ\\\",\\r\\n    skuName =~ \\\"Standard\\\" or skuTier =~ \\\"Standard\\\", \\\"VpnGw1AZ\\\",  // Map Standard to VpnGw1AZ\\r\\n    skuName =~ \\\"Basic\\\" or skuTier =~ \\\"Basic\\\", \\\"VpnGw1AZ\\\",      // Map Basic to VpnGw1AZ\\r\\n    \\\"VpnGw1AZ\\\"  // Default fallback\\r\\n)\\r\\n// Base gateway monthly costs\\r\\n| extend baseGatewayCost = case(\\r\\n    equivalentAZSku =~ \\\"VpnGw1AZ\\\", 153.30,\\r\\n    equivalentAZSku =~ \\\"VpnGw2AZ\\\", 394.20,\\r\\n    equivalentAZSku =~ \\\"VpnGw3AZ\\\", 1007.40,\\r\\n    equivalentAZSku =~ \\\"VpnGw4AZ\\\", 1686.30,\\r\\n    equivalentAZSku =~ \\\"VpnGw5AZ\\\", 2934.60,\\r\\n    153.30  // Default to VpnGw1AZ cost\\r\\n)\\r\\n// Calculate additional tunnel costs (S2S)\\r\\n| extend s2sTunnels = todouble({s2stunnels})\\r\\n| extend s2sTunnelCost = case(\\r\\n    s2sTunnels <= 10, 0.0,  // First 10 included\\r\\n    equivalentAZSku in~ (\\\"VpnGw1AZ\\\", \\\"VpnGw2AZ\\\", \\\"VpnGw3AZ\\\") and s2sTunnels <= 30, (s2sTunnels - 10) * 0.015 * 730,  // 11-30 tunnels\\r\\n    equivalentAZSku in~ (\\\"VpnGw4AZ\\\", \\\"VpnGw5AZ\\\") and s2sTunnels <= 100, (s2sTunnels - 10) * 0.015 * 730,  // 11-100 tunnels\\r\\n    0.0  // Over limit or other cases\\r\\n)\\r\\n// Calculate additional connection costs (P2S)\\r\\n| extend p2sConnections = todouble({P2SConnections})\\r\\n| extend p2sConnectionCost = case(\\r\\n    p2sConnections <= 128, 0.0,  // First 128 included\\r\\n    (p2sConnections - 128) * 0.01 * 730  // Additional connections at $0.01/hour\\r\\n)\\r\\n// Total estimated monthly cost\\r\\n| extend EstimatedMonthlyCost = baseGatewayCost + s2sTunnelCost + p2sConnectionCost\\r\\n| extend \\r\\n    Recommendation = strcat(\\\"Upgrade to \\\", equivalentAZSku, \\\" for Zone Redundancy\\\"),\\r\\n    ImplementationImpact = \\\"High\\\",\\r\\n    ImplementationComplexity = \\\"High\\\"\\r\\n| project name,  resourceGroup,skuName, zoneRedundant,Recommendation, ImplementationImpact, ImplementationComplexity, equivalentAZSku, location, \\r\\n         EstimatedMonthlyCost, baseGatewayCost, s2sTunnelCost, p2sConnectionCost,\\r\\n         subscriptionId \\r\\n| sort by name asc\",\"size\":0,\"noDataMessage\":\"All Azure Virtual Network Gateways have availability zones configured\",\"noDataMessageStyle\":3,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"zoneRedundant\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"false\",\"representation\":\"failed\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"success\",\"text\":\"{0}{1}\"}]}}],\"rowLimit\":1000,\"filter\":true,\"labelSettings\":[{\"columnId\":\"skuName\",\"label\":\"Current SKU\"}]}},\"name\":\"query-virtual-network-gateway-zones\"}]},\"conditionalVisibility\":{\"parameterName\":\"CheckforVPNGW\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"groups2svpn\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Azure Bastion HostsðŸŸ¢ [Cost Est.]\",\"items\":[{\"type\":1,\"content\":{\"json\":\"**Note:** Cost based on East US rates (Sep 2025). Zone redundancy available at no additional cost but requires redeployment. For detailed pricing, see [Azure Pricing Calculator](https://azure.microsoft.com/pricing/calculator/).\",\"style\":\"upsell\"},\"name\":\"text - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'microsoft.network/bastionhosts'\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend zoneCount = array_length(zones)\\r\\n| extend zoneRedundant = case(\\r\\n    isnull(zones) or zoneCount <= 1, false,\\r\\n    true\\r\\n)\\r\\n| extend skuName = tostring(sku.name)\\r\\n| where zoneRedundant == false  // Only non-zone-redundant instances\\r\\n| join kind = innerunique (\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n)\\r\\n    on id\\r\\n| extend \\r\\n    Recommendation = \\\"Redeploy Bastion with zone redundancy enabled (no additional cost)\\\",\\r\\n    ImplementationImpact = \\\"High\\\",\\r\\n    ImplementationComplexity = \\\"Medium\\\",\\r\\n    CostImpact = \\\"None\\\",\\r\\n    additionalMonthlyCost = 0.0\\r\\n| project \\r\\n    name, \\r\\n    skuName,\\r\\n    zoneCount,\\r\\n    tostring(zones),\\r\\n    resourceGroup, \\r\\n        Recommendation, \\r\\n    ImplementationImpact, \\r\\n    ImplementationComplexity, \\r\\n    CostImpact,\\r\\n    location, \\r\\n    subscriptionId\",\"size\":0,\"noDataMessage\":\"All Azure Bastion Hosts have availability zones configured\",\"noDataMessageStyle\":3,\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"zoneRedundant\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"false\",\"representation\":\"failed\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"success\",\"text\":\"{0}{1}\"}]}}],\"rowLimit\":1000}},\"name\":\"query-bastion-zone-details\"}]},\"conditionalVisibility\":{\"parameterName\":\"CheckforBastion\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"groupBastion\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Azure Standard Load BalancerðŸŸ¢ [Cost Est.]\",\"items\":[{\"type\":1,\"content\":{\"json\":\"**Cost Estimate:** Monthly Load Balancer cost (Rules + Data Processing) based on East US Regional Tier rates, September 2025. Assumes 5 rules, 1TB/month data processing. For precise costs, see the [Azure Pricing Calculator](https://azure.microsoft.com/en-us/pricing/calculator/).\",\"style\":\"upsell\"},\"name\":\"text - 4\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"understand-cost-calc-yesno\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"understandCostCalculations\",\"label\":\"Show Load Balancer cost calculation details?\",\"type\":2,\"isRequired\":true,\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"jsonData\":\"[\\r\\n    {\\r\\n    \\\"value\\\" : \\\"Yes\\\",\\r\\n    \\\"label\\\" : \\\"Yes\\\"\\r\\n    },\\r\\n    {\\r\\n    \\\"value\\\" : \\\"No\\\",\\r\\n    \\\"label\\\" : \\\"No\\\",\\r\\n    \\\"selected\\\" : true\\r\\n    }\\r\\n]\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"Show Cost Calculation Details\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"a1a1ed79-dd3e-4c78-bde6-2427b0606874\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"NetworkRules\",\"label\":\"Number of rules configured\",\"type\":1,\"timeContext\":{\"durationMs\":86400000},\"value\":\"1\"},{\"version\":\"KqlParameterItem/1.0\",\"name\":\"DataProcessedGb\",\"type\":1,\"timeContext\":{\"durationMs\":86400000},\"value\":\"1000\",\"label\":\"Amount of data processed in GB\",\"id\":\"1816b0b4-55eb-4c0e-a855-143ad394a343\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"understandCostCalculations\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"param-LBPrice\"},{\"type\":1,\"content\":{\"json\":\"### How Load Balancer Cost is Calculated\\r\\n\\r\\n**Monthly Cost Formula:**\\r\\n- **Network Rules:** Tiered pricing based on number of rules\\r\\n- **Data Processing:** $0.005 per GB of processed data\\r\\n\\r\\n**Network Rules Pricing Tiers:**\\r\\n- First 5 rules: $0.025/hour each\\r\\n- Additional rules: $0.01/hour each\\r\\n- Inbound NAT rules: Free\\r\\n\\r\\n**Calculation Example:**\\r\\n- 8 rules = (5 Ã— $0.025 Ã— 730) + (3 Ã— $0.01 Ã— 730) = $91.25 + $21.90 = $113.15/month\\r\\n- 1,000 GB data processing = 1,000 Ã— $0.005 = $5.00/month\\r\\n- Total monthly cost = $113.15 + $5.00 = $118.15\\r\\n\\r\\n**Default Assumptions:**\\r\\n- Network Rules: 5 rules\\r\\n- Data Processed: 1,000 GB/month\\r\\n- Regional Tier pricing (East US, September 2025)\\r\\n\\r\\nYou can adjust these parameters above to match your specific load balancer configuration and get a more accurate cost estimate.\",\"style\":\"info\"},\"conditionalVisibility\":{\"parameterName\":\"understandCostCalculations\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"text - 3\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ \\\"microsoft.network/loadbalancers\\\" and tolower(sku.name) != 'basic'\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend locations = properties.locations\\r\\n| extend zones = zones\\r\\n| extend zoneRedundant = iif(array_length(zones) >= 2, \\\"true\\\", \\\"false\\\")\\r\\n| where zoneRedundant == \\\"false\\\"\\r\\n| join kind = innerunique( //Tag filter\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId=id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n    | distinct id  // Add this line to deduplicate before join\\r\\n    )\\r\\n    on id\\r\\n// Cost calculation for Load Balancer rules with tiered pricing\\r\\n| extend networkRules = todouble({NetworkRules})\\r\\n| extend dataProcessedGB = todouble({DataProcessedGb})\\r\\n| extend rulesCost = case(\\r\\n    networkRules <= 5, networkRules * 0.025 * 730,  // First 5 rules at $0.025/hour\\r\\n    (5 * 0.025 * 730) + ((networkRules - 5) * 0.01 * 730)  // First 5 + additional at $0.01/hour\\r\\n)\\r\\n| extend dataProcessingCost = dataProcessedGB * 0.005  // $0.005 per GB\\r\\n| extend EstimatedMonthlyCost = rulesCost + dataProcessingCost\\r\\n| extend \\r\\n    Recommendation = \\\"Enable Load Balancer Zone Redundancy\\\",\\r\\n    ImplementationImpact = \\\"High\\\",\\r\\n    ImplementationComplexity = \\\"Medium\\\"\\r\\n| project Recommendation, name, location, zoneRedundant, EstimatedMonthlyCost, rulesCost, dataProcessingCost, \\r\\n         resourceGroup, ImplementationImpact, ImplementationComplexity, subscriptionId\\r\\n| sort by name asc\",\"size\":0,\"noDataMessage\":\"All Azure Standard Load Balanacers have availability zones configured\",\"noDataMessageStyle\":3,\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"zoneRedundant\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"false\",\"representation\":\"failed\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"success\",\"text\":\"{0}{1}\"}]}}],\"rowLimit\":1000}},\"name\":\"query-load-balancer-zone-details\"}]},\"conditionalVisibility\":{\"parameterName\":\"CheckforLB\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"groupLoadBalancer\"}]},\"conditionalVisibility\":{\"parameterName\":\"selectedDetailsTab\",\"comparison\":\"isEqualTo\",\"value\":\"network\"},\"name\":\"group-networking-details\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Data Service Availability Zone Coverage\",\"items\":[{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'microsoft.dbforpostgresql/flexibleservers'\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend \\r\\n    highAvailabilityMode = tostring(properties.highAvailability.mode),\\r\\n    skuName = tostring(sku.name),\\r\\n    skuTier = tostring(sku.tier),\\r\\n    storageSizeGB = toint(properties.storage.storageSizeGB),\\r\\n    postgresVersion = strcat(tostring(properties.version), \\\".\\\", tostring(properties.minorVersion))\\r\\n| extend \\r\\n    supportsZoneRedundancy = case(\\r\\n        skuTier =~ 'Burstable', false,  // Burstable tier doesn't support zone redundancy\\r\\n        true  // General Purpose and Memory Optimized support it\\r\\n    )\\r\\n| extend \\r\\n    zoneRedundant = case(\\r\\n        highAvailabilityMode != \\\"ZoneRedundant\\\", false, true \\r\\n    )\\r\\n| where zoneRedundant == false  // Only non-zone-redundant servers\\r\\n| extend \\r\\n    recommendation = case(\\r\\n        not(supportsZoneRedundancy), strcat(\\\"Upgrade from Burstable tier to General Purpose or Memory Optimized for zone redundancy support (Current: \\\", skuTier, \\\")\\\"),\\r\\n        \\\"Enable zone-redundant high availability\\\"\\r\\n    ),\\r\\n    minimumUpgradeTarget = case(\\r\\n        not(supportsZoneRedundancy), \\\"General Purpose or Memory Optimized tier\\\",\\r\\n        \\\"Current tier with zone redundancy enabled\\\"\\r\\n    )\\r\\n| join kind = innerunique( //Tag filter\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId=id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n    )\\r\\n    on id\\r\\n| extend \\r\\n    Recommendation = recommendation,\\r\\n    ImplementationImpact = case(\\r\\n        not(supportsZoneRedundancy), 'High',  // Requires tier upgrade\\r\\n        'High'  // Zone redundancy has performance/cost impact but unknown amount\\r\\n    ),\\r\\n    ImplementationComplexity = case(\\r\\n        not(supportsZoneRedundancy), 'Medium',  // Tier upgrade complexity\\r\\n        'Low'  // Configuration change\\r\\n    )\\r\\n| project \\r\\n    PostgreSQLServerName = name,\\r\\n    CurrentSKU = skuName,\\r\\n    SKUTier = skuTier,\\r\\n    StorageSizeGB = storageSizeGB,\\r\\n    SupportsZoneRedundancy = supportsZoneRedundancy,\\r\\n    ResourceGroup = resourceGroup,\\r\\n    Recommendation,\\r\\n    ImplementationImpact,\\r\\n    ImplementationComplexity,\\r\\n    PostgreSQLVersion = postgresVersion,\\r\\n    CurrentHAMode = highAvailabilityMode,\\r\\n    MinimumUpgradeTarget = minimumUpgradeTarget,\\r\\n    Location = location,\\r\\n    SubscriptionId = subscriptionId\\r\\n| sort by PostgreSQLServerName asc\",\"size\":0,\"title\":\"Azure Database for PostgreSQL - Flexible Server [ðŸ”´No Cost Est.]\",\"noDataMessage\":\"All Azure Database for PostgreSQL - Flexible Server instances have availability zones configured\",\"noDataMessageStyle\":3,\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"pinnedZone\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"4\",\"text\":\"\"}]}},{\"columnMatch\":\"zoneRedundant\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"4\",\"text\":\"\"}]}}],\"rowLimit\":1000},\"sortBy\":[]},\"name\":\"query-dbforpostgresql-zones-details\"},{\"type\":1,\"content\":{\"json\":\"**Note:** Zone redundancy costs vary by workload, SKU type, and region due to synchronous replication overhead. Use [Azure Pricing Calculator](https://azure.microsoft.com/en-us/pricing/calculator/) for accurate cost projections based on your specific configuration.\",\"style\":\"info\"},\"name\":\"text-postgresql-cost-disclaimer\"}]},\"conditionalVisibility\":{\"parameterName\":\"CheckforPostgres\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"groupPostgres\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"{Subscription}\"],\"parameters\":[{\"id\":\"14bb128f-5b3f-421a-9cf7-b9ad71ece3f6\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"CheckforSQLServer\",\"type\":1,\"isRequired\":true,\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'microsoft.sql/servers/databases'\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| where name != 'master'  // Exclude system databases\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend zoneRedundant = tobool(properties.zoneRedundant)\\r\\n//| where zoneRedundant == false  // Only non-zone-redundant databases\\r\\n| join kind = innerunique (\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n)\\r\\n    on id\\r\\n| summarize SQLDatabaseCount = count()\\r\\n| extend HasNonZonalSQLDatabases = iff(SQLDatabaseCount > 0, \\\"Yes\\\", \\\"No\\\")\\r\\n| project HasNonZonalSQLDatabases\",\"crossComponentResources\":[\"{Subscription}\"],\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"id\":\"8da6b29c-a9cd-4b1c-91e0-4402873a06bc\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"CheckforCosmosDB\",\"type\":1,\"isRequired\":true,\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'microsoft.documentdb/databaseaccounts'\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend locations=properties.locations\\r\\n| mv-expand cosmosLocation = locations\\r\\n| extend zones=cosmosLocation.isZoneRedundant\\r\\n| extend zoneRedundant = case(\\r\\n    not(zones), false, true \\r\\n  )\\r\\n//| where zoneRedundant == false  // Only non-zone-redundant accounts\\r\\n| join kind = innerunique (\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n)\\r\\n    on id\\r\\n| summarize CosmosDBCount = count()\\r\\n| extend HasNonZonalCosmosDB = iff(CosmosDBCount > 0, \\\"Yes\\\", \\\"No\\\")\\r\\n| project HasNonZonalCosmosDB\",\"crossComponentResources\":[\"{Subscription}\"],\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"id\":\"d9a47d4a-e881-4743-acb7-92f64005b4b2\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"CheckforMySQL\",\"type\":1,\"isRequired\":true,\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'microsoft.dbformysql/flexibleservers'\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend \\r\\n    highAvailabilityMode = tostring(properties.highAvailability.mode)\\r\\n| extend \\r\\n    zoneRedundant = case(\\r\\n        highAvailabilityMode != \\\"ZoneRedundant\\\", false, true \\r\\n    )\\r\\n//| where zoneRedundant == false  // Only non-zone-redundant servers\\r\\n| join kind = innerunique (\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n)\\r\\n    on id\\r\\n| summarize MySQLServerCount = count()\\r\\n| extend HasNonZonalMySQL = iff(MySQLServerCount > 0, \\\"Yes\\\", \\\"No\\\")\\r\\n| project HasNonZonalMySQL\",\"crossComponentResources\":[\"{Subscription}\"],\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"id\":\"c1d043fb-f5cb-4697-bade-f7292dfbdee2\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"CheckforRediss\",\"type\":1,\"isRequired\":true,\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'microsoft.cache/redis'\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend \\r\\n    currentZoneRedundant = case(\\r\\n        properties.zonalAllocationPolicy != \\\"Automatic\\\" and (array_length(zones) <= 1 or isnull(zones)), false, \\r\\n        true \\r\\n    )\\r\\n//| where currentZoneRedundant == false  // Only non-zone-redundant instances\\r\\n| join kind = innerunique (\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n)\\r\\n    on id\\r\\n| summarize RedisCacheCount = count()\\r\\n| extend HasNonZonalRedisCache = iff(RedisCacheCount > 0, \\\"Yes\\\", \\\"No\\\")\\r\\n| project HasNonZonalRedisCache\",\"crossComponentResources\":[\"{Subscription}\"],\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"version\":\"KqlParameterItem/1.0\",\"name\":\"CheckforPostgres\",\"type\":1,\"isRequired\":true,\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'microsoft.dbforpostgresql/flexibleservers'\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend \\r\\n    highAvailabilityMode = tostring(properties.highAvailability.mode)\\r\\n| extend \\r\\n    zoneRedundant = case(\\r\\n        highAvailabilityMode != \\\"ZoneRedundant\\\", false, true \\r\\n    )\\r\\n//| where zoneRedundant == false  // Only non-zone-redundant servers\\r\\n| join kind = innerunique (\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n)\\r\\n    on id\\r\\n| summarize PostgreSQLServerCount = count()\\r\\n| extend HasNonZonalPostgreSQL = iff(PostgreSQLServerCount > 0, \\\"Yes\\\", \\\"No\\\")\\r\\n| project HasNonZonalPostgreSQL\",\"crossComponentResources\":[\"{Subscription}\"],\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"id\":\"31f2a30a-a2ff-4cf5-a745-059057cf1d92\"}],\"style\":\"pills\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},\"conditionalVisibility\":{\"parameterName\":\"AlwaysHidden\",\"comparison\":\"isEqualTo\",\"value\":\"yes\"},\"name\":\"paramCheckDBAzResources\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Azure SQL Server [ðŸ”´No Cost Est.]\",\"items\":[{\"type\":1,\"content\":{\"json\":\"**Note:** Cost estimates for SQL Database tier upgrades are not provided due to variable pricing models and regional differences. Use the [Azure Pricing Calculator](https://azure.microsoft.com/en-us/pricing/calculator/) for accurate cost projections based on your specific configuration and location.\",\"style\":\"upsell\"},\"name\":\"text-sql-cost-disclaimer\"},{\"type\":1,\"content\":{\"json\":\"## Cost Estimation Disclaimer\\n\\n**Note:** Cost estimates for SQL Database tier upgrades are not included in this analysis due to the complexity and variability of pricing factors:\\n\\nâ€¢ **Variable Pricing Models**: SQL Database pricing varies significantly between DTU and vCore models, with different rates for compute, storage, and backup resources\\nâ€¢ **Regional Price Differences**: Costs vary substantially across Azure regions and may change based on your specific location\\nâ€¢ **Custom Configurations**: Actual costs depend on storage size, backup retention policies, read replicas, and other configuration options\\nâ€¢ **Promotional Pricing**: Microsoft frequently offers reserved instance discounts, hybrid benefits, and other cost optimization programs that affect final pricing\\nâ€¢ **Dynamic Scaling**: Many deployments use auto-scaling features that make cost prediction highly variable\\n\\n**For Accurate Cost Estimates:**\\n\\nUse the [Azure Pricing Calculator](https://azure.microsoft.com/en-us/pricing/calculator/) to estimate upgrade costs based on your specific requirements:\\n\\n1. Select **Databases** â†’ **Azure SQL Database**\\n2. Configure your current database specifications\\n3. Compare with the recommended zone-redundant tier\\n4. Factor in your region, storage needs, and backup requirements\\n\\n**Alternative:** Consider using [Azure Cost Management](https://portal.azure.com/#view/Microsoft_Azure_CostManagement) to analyze your current SQL Database spending patterns and project upgrade costs based on historical usage.\"},\"conditionalVisibility\":{\"parameterName\":\"Alwayshidden\",\"comparison\":\"isEqualTo\",\"value\":\"true\"},\"name\":\"text-sql-cost-disclaimer\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'microsoft.sql/servers/databases'\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| where name != 'master'  // Exclude system databases\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend zoneRedundant = tobool(properties.zoneRedundant)\\r\\n| where not(zoneRedundant)  // Only non-zone-redundant databases\\r\\n| extend \\r\\n    skuName = tostring(sku.name),\\r\\n    skuTier = tostring(sku.tier),\\r\\n    skuCapacity = toint(sku.capacity),\\r\\n    currentServiceObjective = tostring(properties.currentServiceObjectiveName)\\r\\n| extend \\r\\n    purchaseModel = case(\\r\\n        skuTier in~ ('Basic', 'Standard', 'Premium'), 'DTU',\\r\\n        skuTier in~ ('GeneralPurpose', 'BusinessCritical', 'Hyperscale'), 'vCore',\\r\\n        'Unknown'\\r\\n    )\\r\\n| extend \\r\\n    currentlySupportsZones = case(\\r\\n        // Based on official documentation\\r\\n        skuTier =~ 'Basic', false,\\r\\n        skuTier =~ 'Standard', false,  \\r\\n        skuTier =~ 'Premium', true,\\r\\n        skuTier =~ 'GeneralPurpose', true,\\r\\n        skuTier =~ 'BusinessCritical', true,\\r\\n        skuTier =~ 'Hyperscale', true,\\r\\n        false\\r\\n    )\\r\\n| extend \\r\\n    recommendedAction = case(\\r\\n        currentlySupportsZones, 'Enable zone redundancy on current tier',\\r\\n        skuTier =~ 'Basic', 'Upgrade to Premium P1 (DTU) or GP_Gen5_2 (vCore) for zone redundancy',\\r\\n        skuTier =~ 'Standard', 'Upgrade to Premium P1 (DTU) or GP_Gen5_2 (vCore) for zone redundancy',\\r\\n        'Enable zone redundancy'  // For tiers that already support it\\r\\n    ),\\r\\n    minimumUpgradeTarget = case(\\r\\n        currentlySupportsZones, 'Current tier with zone redundancy enabled',\\r\\n        skuTier =~ 'Basic', 'Premium P1 (DTU) or General Purpose 2 vCore',\\r\\n        skuTier =~ 'Standard', 'Premium P1 (DTU) or General Purpose 2 vCore', \\r\\n        'Current tier with zone redundancy'\\r\\n    )\\r\\n| join kind = innerunique( //Tag filter\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId=id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n    )\\r\\n    on id\\r\\n| extend \\r\\n    Recommendation = recommendedAction,\\r\\n    ImplementationImpact = case(\\r\\n        currentlySupportsZones, 'Medium',  // Just enabling zone redundancy\\r\\n        'High'  // Requires tier upgrade\\r\\n    ),\\r\\n    ImplementationComplexity = case(\\r\\n        currentlySupportsZones, 'Low',   // Simple configuration change\\r\\n        'Medium'  // Requires tier change and potential downtime\\r\\n    )\\r\\n| extend estimatedCost=\\\"NaN\\\"\\r\\n| project \\r\\n    DatabaseName = name, \\r\\n    Recommendation, \\r\\n    ResourceGroup = resourceGroup, \\r\\n    ImplementationImpact, \\r\\n    ImplementationComplexity, \\r\\n    Location = location, \\r\\n    CurrentTier = skuTier,\\r\\n    CurrentSKU = skuName,\\r\\n    SKUCapacity = skuCapacity,\\r\\n    PurchaseModel = purchaseModel,\\r\\n    MinimumUpgradeTarget = minimumUpgradeTarget,\\r\\n    estimatedCost,    \\r\\n    SubscriptionId = subscriptionId  \\r\\n| sort by DatabaseName asc\",\"size\":0,\"noDataMessage\":\"All Azure SQL Servers have availability zones configured\",\"noDataMessageStyle\":3,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"zoneRedundant\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"failed\",\"text\":\"{0}{1}\"}]}}]}},\"name\":\"query-az-sql-zones-details\"}]},\"conditionalVisibility\":{\"parameterName\":\"CheckforSQLServer\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"groupSQLServer\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Azure Cosmos DB [ðŸŸ¡Cost Impact]\",\"items\":[{\"type\":1,\"content\":{\"json\":\"**Note:** Cosmos DB availability zone costs: Multi-region write accounts have no additional cost. Single-region accounts have 1.25x RU/s multiplier (free for autoscale) or 1.25x RU consumption (serverless). Use [Azure Pricing Calculator](https://azure.microsoft.com/en-us/pricing/calculator/) for precise cost estimates.\",\"style\":\"upsell\"},\"name\":\"text-cosmos-cost-disclaimer\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'microsoft.documentdb/databaseaccounts'\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend locations=properties.locations\\r\\n| mv-expand cosmosLocation = locations\\r\\n| extend zones=cosmosLocation.isZoneRedundant\\r\\n| extend zoneRedundant = case(\\r\\n    not(zones), false, true \\r\\n  )\\r\\n| where zoneRedundant == false  // Only non-zone-redundant accounts\\r\\n| extend \\r\\n    multiRegionWrites = tobool(properties.enableMultipleWriteLocations),\\r\\n    regionCount = array_length(properties.locations),\\r\\n    consistencyLevel = tostring(properties.consistencyPolicy.defaultConsistencyLevel),\\r\\n    // Extract SKU information\\r\\n    skuName = tostring(sku.name),\\r\\n    skuTier = tostring(sku.tier),\\r\\n    // Extract capabilities first\\r\\n    capabilities = tostring(properties.capabilities),\\r\\n    // Extract backup policy for additional context\\r\\n    backupPolicy = tostring(properties.backupPolicy.type)\\r\\n| extend \\r\\n    // Now use capabilities variable to detect modes\\r\\n    isServerless = capabilities contains \\\"EnableServerless\\\",\\r\\n    hasAutoscale = capabilities contains \\\"EnableAutoscale\\\" or capabilities contains \\\"autoscale\\\"\\r\\n| extend \\r\\n    capacityMode = case(\\r\\n        isServerless, \\\"Serverless\\\",\\r\\n        hasAutoscale, \\\"Provisioned (Autoscale)\\\",\\r\\n        \\\"Provisioned (Manual)\\\"\\r\\n    ),\\r\\n    accountType = case(\\r\\n        multiRegionWrites and regionCount > 1, \\\"Multi-region write\\\",\\r\\n        regionCount > 1, \\\"Multi-region read\\\",\\r\\n        \\\"Single-region\\\"\\r\\n    )\\r\\n| extend \\r\\n    costImpact = case(\\r\\n        multiRegionWrites, \\\"No additional cost - Multi-region write accounts have no billing impact\\\",\\r\\n        isServerless, \\\"25% increase in request units (RU) consumption\\\",\\r\\n        hasAutoscale, \\\"25% increase in provisioned RU/s - FREE for autoscale resources\\\",\\r\\n        \\\"25% increase in provisioned RU/s (1.25x multiplier)\\\"\\r\\n    ),\\r\\n    costMultiplier = case(\\r\\n        multiRegionWrites, \\\"1.0x (No impact)\\\",\\r\\n        isServerless, \\\"1.25x RU\\\",\\r\\n        hasAutoscale, \\\"1.0x (Free for autoscale)\\\",\\r\\n        \\\"1.25x RU/s\\\"\\r\\n    ),\\r\\n    recommendedAction = case(\\r\\n        multiRegionWrites, \\\"Enable availability zones (no cost impact)\\\",\\r\\n        isServerless, \\\"Enable availability zones (25% RU consumption increase)\\\",\\r\\n        hasAutoscale, \\\"Enable availability zones (FREE - no cost impact for autoscale)\\\",\\r\\n        \\\"Enable availability zones (25% RU/s increase) - Consider autoscale to avoid cost\\\"\\r\\n    )\\r\\n| join kind = innerunique( //Tag filter\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId=id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n    )\\r\\n    on id\\r\\n| extend \\r\\n    Recommendation = recommendedAction,\\r\\n    ImplementationImpact = case(\\r\\n        multiRegionWrites or hasAutoscale, 'High',  // No cost impact\\r\\n        isServerless, 'High',  // 25% RU increase\\r\\n        'High'  // 25% RU/s increase\\r\\n    ),\\r\\n    ImplementationComplexity = 'Low'  // Configuration change only\\r\\n| project \\r\\n    CosmosDBAccount = name,\\r\\n    AccountType = accountType,\\r\\n    ResourceGroup = resourceGroup,\\r\\n    CapacityMode = capacityMode,\\r\\n    Recommendation,\\r\\n    ImplementationImpact,\\r\\n    ImplementationComplexity,\\r\\n    MultiRegionWrites = multiRegionWrites,\\r\\n    RegionCount = regionCount,\\r\\n    CostMultiplier = costMultiplier,\\r\\n    CostImpactDescription = costImpact,\\r\\n    Location = location,\\r\\n    SubscriptionId = subscriptionId\\r\\n| distinct *\\r\\n| sort by CosmosDBAccount asc\",\"size\":0,\"noDataMessage\":\"All Azure Cosmos DB instances have availability zones configured\",\"noDataMessageStyle\":3,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"pinnedZone\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"4\",\"text\":\"\"}]}},{\"columnMatch\":\"zoneRedundant\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"4\",\"text\":\"\"}]}}],\"rowLimit\":1000},\"sortBy\":[]},\"name\":\"query-documentdb-zones-details\"}]},\"conditionalVisibility\":{\"parameterName\":\"CheckforCosmosDB\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"groupCosmosDB\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Azure Cache for Redis[ðŸ”´No Cost Est.]\",\"items\":[{\"type\":1,\"content\":{\"json\":\"**Note:** Zone redundancy costs vary significantly based on replica configuration, data transfer usage, and clustering setup. Use [Azure Pricing Calculator](https://azure.microsoft.com/en-us/pricing/calculator/) for accurate cost projections based on your specific cache configuration.\",\"style\":\"upsell\"},\"name\":\"text-redis-cost-disclaimer\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'microsoft.cache/redis'\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend \\r\\n    skuName = tostring(properties.sku.name),\\r\\n    skuFamily = tostring(properties.sku.family),\\r\\n    skuCapacity = toint(properties.sku.capacity),\\r\\n    redisVersion = tostring(properties.redisVersion)\\r\\n| extend \\r\\n    supportsZoneRedundancy = case(\\r\\n        skuName in~ ('Basic', 'Standard'), false,\\r\\n        skuName in~ ('Premium', 'Enterprise', 'EnterpriseFlash'), true,\\r\\n        false  // Default for unknown SKUs\\r\\n    )\\r\\n| extend \\r\\n    currentZoneRedundant = case(\\r\\n        properties.zonalAllocationPolicy != \\\"Automatic\\\" and (array_length(zones) <= 1 or isnull(zones)), false, \\r\\n        true \\r\\n    )\\r\\n| extend \\r\\n    recommendation = case(\\r\\n        not(supportsZoneRedundancy), strcat(\\\"Upgrade to Premium SKU or higher for zone redundancy support (Current: \\\", skuName, \\\" C\\\", skuCapacity, \\\")\\\"),\\r\\n        currentZoneRedundant, \\\"Already zone redundant\\\",\\r\\n        \\\"Enable zone redundancy on current SKU\\\"\\r\\n    ),\\r\\n    minimumUpgradeTarget = case(\\r\\n        not(supportsZoneRedundancy), \\\"Premium P1 (or higher)\\\",\\r\\n        \\\"Current SKU with zone redundancy enabled\\\"\\r\\n    )\\r\\n| where not(currentZoneRedundant)  // Only show non-zone-redundant instances\\r\\n| join kind = innerunique( //Tag filter\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId=id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n    )\\r\\n    on id\\r\\n| extend \\r\\n    Recommendation = recommendation,\\r\\n    ImplementationImpact = case(\\r\\n        not(supportsZoneRedundancy), 'High',  // Requires SKU upgrade\\r\\n        'High'  // Just enable zone redundancy\\r\\n    ),\\r\\n    ImplementationComplexity = case(\\r\\n        not(supportsZoneRedundancy), 'Medium',  // SKU upgrade complexity\\r\\n        'Low'  // Configuration change\\r\\n    )\\r\\n| project \\r\\n    RedisCacheName = name,\\r\\n    CurrentSKU = strcat(skuName, \\\" \\\", skuFamily, skuCapacity),\\r\\n    RedisVersion = redisVersion,\\r\\n    SupportsZoneRedundancy = supportsZoneRedundancy,\\r\\n    MinimumUpgradeTarget = minimumUpgradeTarget,\\r\\n    CurrentZones = tostring(zones),\\r\\n    ResourceGroup = resourceGroup,\\r\\n    Recommendation,\\r\\n    ImplementationImpact,\\r\\n    ImplementationComplexity,\\r\\n    Location = location,\\r\\n    SubscriptionId = subscriptionId\\r\\n| sort by RedisCacheName asc\",\"size\":0,\"noDataMessage\":\"All Azure Cache for Redis instances have availability zones configured\",\"noDataMessageStyle\":3,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"SupportsZoneRedundancy\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"3\",\"text\":\"No\"}]}},{\"columnMatch\":\"pinnedZone\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"4\",\"text\":\"\"}]}},{\"columnMatch\":\"zoneRedundant\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"4\",\"text\":\"\"}]}}],\"rowLimit\":1000},\"sortBy\":[]},\"name\":\"query-cache-zones-details\"}]},\"conditionalVisibility\":{\"parameterName\":\"CheckforRediss\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"groupCacheforRedis\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Azure Database for MySQL - Flexible Server [ðŸŸ¡Cost Impact]\",\"items\":[{\"type\":1,\"content\":{\"json\":\"**Note:** Zone-redundant HA doubles compute and storage costs (100% increase) plus potential backup storage. Use [Azure Pricing Calculator](https://azure.microsoft.com/en-us/pricing/calculator/) for precise cost estimates including backup storage.\",\"style\":\"upsell\"},\"name\":\"text-mysql-cost-disclaimer\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'microsoft.dbformysql/flexibleservers'\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend \\r\\n    highAvailabilityMode = tostring(properties.highAvailability.mode),\\r\\n    skuName = tostring(sku.name),\\r\\n    skuTier = tostring(sku.tier),\\r\\n    storageSizeGB = toint(properties.storage.storageSizeGB),\\r\\n    mysqlVersion = tostring(properties.version)\\r\\n| extend \\r\\n    zoneRedundant = case(\\r\\n        highAvailabilityMode != \\\"ZoneRedundant\\\", false, true \\r\\n    )\\r\\n| where zoneRedundant == false  // Only non-zone-redundant servers\\r\\n| extend \\r\\n    costImpact = \\\"100% increase (2x current cost) - Requires duplicate compute and storage for secondary replica\\\",\\r\\n    costMultiplier = \\\"2.0x (Double current cost)\\\",\\r\\n    recommendedAction = \\\"Enable zone-redundant high availability\\\"\\r\\n| join kind = innerunique( //Tag filter\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId=id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n    )\\r\\n    on id\\r\\n| extend \\r\\n    Recommendation = recommendedAction,\\r\\n    ImplementationImpact = 'High',  // 100% cost increase\\r\\n    ImplementationComplexity = 'High'  // Configuration change\\r\\n| project \\r\\n    MySQLServerName = name,\\r\\n    CurrentSKU = skuName,\\r\\n    SKUTier = skuTier,\\r\\n    StorageSizeGB = storageSizeGB,\\r\\n    CurrentHAMode = highAvailabilityMode,\\r\\n    ResourceGroup = resourceGroup,\\r\\n    Recommendation,\\r\\n    ImplementationImpact,\\r\\n    CostMultiplier = costMultiplier,\\r\\n    CostImpactDescription = costImpact,\\r\\n    ImplementationComplexity,\\r\\n    Location = location,\\r\\n    SubscriptionId = subscriptionId\\r\\n| sort by MySQLServerName asc\",\"size\":0,\"noDataMessage\":\"All Azure Database for MySQL - Flexible Server instances have availability zones configured\",\"noDataMessageStyle\":3,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"pinnedZone\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"4\",\"text\":\"\"}]}},{\"columnMatch\":\"zoneRedundant\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"4\",\"text\":\"\"}]}}],\"rowLimit\":1000},\"sortBy\":[]},\"name\":\"query-dbformysql-zones-details\"}]},\"name\":\"groupMySQL\"}]},\"conditionalVisibility\":{\"parameterName\":\"selectedDetailsTab\",\"comparison\":\"isEqualTo\",\"value\":\"Data\"},\"name\":\"group - Details-Data\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Storage Availability Zone Coverage\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"{Subscription}\"],\"parameters\":[{\"id\":\"14bb128f-5b3f-421a-9cf7-b9ad71ece3f6\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"CheckforStorageV2\",\"type\":1,\"isRequired\":true,\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'Microsoft.Storage/StorageAccounts'\\r\\n| where kind == \\\"StorageV2\\\"\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend locations = properties.locations\\r\\n| extend skuName = tostring(sku.name)\\r\\n| extend zoneRedundant = case(sku.name endswith_cs 'ZRS', true, false)\\r\\n| join kind = innerunique (\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n)\\r\\n    on id\\r\\n| summarize StorageV2Count = count()\\r\\n| extend HasStorageV2 = iff(StorageV2Count > 0, \\\"Yes\\\", \\\"No\\\")\\r\\n| project HasStorageV2\",\"crossComponentResources\":[\"{Subscription}\"],\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"version\":\"KqlParameterItem/1.0\",\"name\":\"CheckforStorageV1\",\"type\":1,\"isRequired\":true,\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'Microsoft.Storage/StorageAccounts'\\r\\n| where kind == \\\"Storage\\\"\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend locations = properties.locations\\r\\n| extend skuName = tostring(sku.name)\\r\\n| extend zoneRedundant = case(sku.name endswith_cs 'ZRS', true, false)\\r\\n| join kind = innerunique (\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n)\\r\\n    on id\\r\\n| distinct id, name, skuName, kind, zoneRedundant, resourceGroup, subscriptionId, location\\r\\n| summarize StorageV2Count = count()\\r\\n| extend HasStorageV2 = iff(StorageV2Count > 0, \\\"Yes\\\", \\\"No\\\")\\r\\n| project HasStorageV2\",\"crossComponentResources\":[\"{Subscription}\"],\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"id\":\"0710d49d-1324-4f3f-877f-863dfe589858\"},{\"version\":\"KqlParameterItem/1.0\",\"name\":\"CheckforStorageBlock\",\"type\":1,\"isRequired\":true,\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'Microsoft.Storage/StorageAccounts'\\r\\n| where kind == \\\"BlockBlobStorage\\\"\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend locations = properties.locations\\r\\n| extend skuName = tostring(sku.name)\\r\\n| extend zoneRedundant = case(sku.name endswith_cs 'ZRS', true, false)\\r\\n| join kind = innerunique (\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n)\\r\\n    on id\\r\\n| distinct id, name, skuName, kind, zoneRedundant, resourceGroup, subscriptionId, location\\r\\n| summarize StorageV2Count = count()\\r\\n| extend HasStorageV2 = iff(StorageV2Count > 0, \\\"Yes\\\", \\\"No\\\")\\r\\n| project HasStorageV2\",\"crossComponentResources\":[\"{Subscription}\"],\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"id\":\"1f1b0e11-e018-441e-8266-be3d879aaa80\"},{\"version\":\"KqlParameterItem/1.0\",\"name\":\"CheckforStorageFiles\",\"type\":1,\"isRequired\":true,\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'Microsoft.Storage/StorageAccounts'\\r\\n| where kind == \\\"FileStorage\\\"\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend locations = properties.locations\\r\\n| extend skuName = tostring(sku.name)\\r\\n| extend zoneRedundant = case(sku.name endswith_cs 'ZRS', true, false)\\r\\n//| where zoneRedudant = false\\r\\n| join kind = innerunique (\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n)\\r\\n    on id\\r\\n| distinct id, name, skuName, kind, zoneRedundant, resourceGroup, subscriptionId, location\\r\\n| summarize StorageV2Count = count()\\r\\n| extend HasStorageV2 = iff(StorageV2Count > 0, \\\"Yes\\\", \\\"No\\\")\\r\\n| project HasStorageV2\",\"crossComponentResources\":[\"{Subscription}\"],\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"id\":\"e9e033a0-8071-42a5-8be6-4b4a884b02f9\"}],\"style\":\"pills\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},\"conditionalVisibility\":{\"parameterName\":\"AlwaysHidden\",\"comparison\":\"isEqualTo\",\"value\":\"yes\"},\"name\":\"paramCheckResourceType\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Storage Account v2ðŸŸ¢ [Cost Est.]\",\"items\":[{\"type\":1,\"content\":{\"json\":\"> **Note:** Cost based on East US rates (Sep 2025). Storage cost only â€” excludes transactions/operations. For detailed pricing, see [Azure Pricing Calculator](https://azure.microsoft.com/pricing/calculator/).\\r\\n\",\"style\":\"upsell\"},\"name\":\"text - storage costs\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"understand-cost-calc-yesno\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"understandCostCalculations\",\"label\":\"Show Storage cost calculation details?\",\"type\":2,\"isRequired\":true,\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"jsonData\":\"[\\r\\n    {\\r\\n    \\\"value\\\" : \\\"Yes\\\",\\r\\n    \\\"label\\\" : \\\"Yes\\\"\\r\\n    },\\r\\n    {\\r\\n    \\\"value\\\" : \\\"No\\\",\\r\\n    \\\"label\\\" : \\\"No\\\",\\r\\n    \\\"selected\\\" : true\\r\\n    }\\r\\n]\",\"value\":\"Yes\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"Show Cost Calculation Details\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"a1a1ed79-dd3e-4c78-bde6-2427b0606874\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"storageV2GBCost\",\"label\":\"StorageV2 cost per GB\",\"type\":1,\"timeContext\":{\"durationMs\":86400000},\"value\":\"0.026\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"understandCostCalculations\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"param-SAIncrease\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'Microsoft.Storage/StorageAccounts'\\r\\n| where kind == \\\"StorageV2\\\"\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend locations = properties.locations\\r\\n| extend skuName = tostring(sku.name)\\r\\n| extend zoneRedundant = case(sku.name endswith_cs 'ZRS', true, false)\\r\\n| join kind = innerunique (\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n)\\r\\n    on id\\r\\n| distinct id, name, skuName, kind, zoneRedundant, resourceGroup, subscriptionId, location\",\"size\":0,\"title\":\"Azure Storage Accounts\",\"noDataMessage\":\"All Azure Storage Accounts are zone redundant\",\"noDataMessageStyle\":3,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"zoneRedundant\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"failed\",\"text\":\"{0}{1}\"}]}}]}},\"conditionalVisibility\":{\"parameterName\":\"alwayshidden\",\"comparison\":\"isEqualTo\",\"value\":\"true\"},\"name\":\"query-storageaccounts-GenV2-zones-details\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"{Subscription}\"],\"parameters\":[{\"id\":\"e94aafa3-c5d9-4523-89f0-4e87aa754511\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Resources\",\"label\":\"Storage accounts\",\"type\":5,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"resources\\n| where resourceGroup in ({ResourceGroup})\\n| where type =~ 'Microsoft.Storage/StorageAccounts'\\n| where kind == \\\"StorageV2\\\"\\n| where location in~ ({ZonalRegions:value})\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\n| extend locations = properties.locations\\n| extend skuName = tostring(sku.name)\\n| extend zoneRedundant = case(sku.name endswith_cs 'ZRS', true, false)\\n| join kind = innerunique (\\n    resources\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\n    | extend replaced_tags = parse_json(replaced_tags)\\n    | mv-expand replaced_tags\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\n)\\n    on id\\n//| extend Rank = row_number()\\n//| project value = id, label = id, selected = Rank <= 5\\n| distinct id, name, skuName, kind, zoneRedundant, resourceGroup, subscriptionId, location\\n\",\"crossComponentResources\":[\"{Subscription}\"],\"typeSettings\":{\"resourceTypeFilter\":{\"microsoft.storage/storageaccounts\":true},\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"}],\"style\":\"above\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},\"conditionalVisibility\":{\"parameterName\":\"alwayshidden\",\"comparison\":\"isEqualTo\",\"value\":\"true\"},\"name\":\"paramSAGenV2\",\"styleSettings\":{\"margin\":\"15px 0 0 0\"}},{\"type\":10,\"content\":{\"chartId\":\"workbookdb19a8d8-91af-44ea-951d-5ffa133b2ebe\",\"version\":\"MetricsItem/2.0\",\"size\":3,\"chartType\":0,\"resourceType\":\"microsoft.storage/storageaccounts\",\"metricScope\":0,\"resourceParameter\":\"Resources\",\"resourceIds\":[\"{Resources}\"],\"timeContext\":{\"durationMs\":2592000000},\"metrics\":[{\"namespace\":\"microsoft.storage/storageaccounts\",\"metric\":\"microsoft.storage/storageaccounts-Capacity-UsedCapacity\",\"aggregation\":4}],\"title\":\"Storage Capacity\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"$gen_group\",\"formatter\":13,\"formatOptions\":{\"linkTarget\":\"Resource\",\"subTarget\":\"insights\",\"showIcon\":true}},{\"columnMatch\":\"Subscription\",\"formatter\":5},{\"columnMatch\":\"Name\",\"formatter\":5},{\"columnMatch\":\"microsoft.storage/storageaccounts-Capacity-UsedCapacity$|microsoft.storage/storageaccounts/blobservices-Capacity-BlobCapacity$|microsoft.storage/storageaccounts/fileservices-Capacity-FileCapacity$|microsoft.storage/storageaccounts/queueservices-Capacity-QueueCapacity$|microsoft.storage/storageaccounts/tableservices-Capacity-TableCapacity$\",\"formatter\":8,\"formatOptions\":{\"min\":0,\"palette\":\"blue\",\"linkTarget\":\"WorkbookTemplate\",\"workbookContext\":{\"componentIdSource\":\"column\",\"componentId\":\"Name\",\"resourceIdsSource\":\"column\",\"resourceIds\":\"Name\",\"templateIdSource\":\"static\",\"templateId\":\"Community-Workbooks/Individual Storage/Capacity\",\"typeSource\":\"static\",\"type\":\"workbook\",\"gallerySource\":\"static\",\"gallery\":\"microsoft.storage/storageaccounts\"}},\"numberFormat\":{\"unit\":2,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":1}}},{\"columnMatch\":\"microsoft.storage/storageaccounts-Capacity-UsedCapacity Timeline$|Account used capacity Timeline$\",\"formatter\":5},{\"columnMatch\":\"microsoft.storage/storageaccounts/blobservices-Capacity-BlobCapacity Timeline$|Blob capacity Timeline$\",\"formatter\":5},{\"columnMatch\":\"microsoft.storage/storageaccounts/fileservices-Capacity-FileCapacity Timeline$|File capacity Timeline$\",\"formatter\":5},{\"columnMatch\":\"microsoft.storage/storageaccounts/queueservices-Capacity-QueueCapacity Timeline$|Queue capacity Timeline$\",\"formatter\":5},{\"columnMatch\":\"microsoft.storage/storageaccounts/tableservices-Capacity-TableCapacity Timeline$|Table capacity Timeline$\",\"formatter\":5}],\"rowLimit\":10000,\"filter\":true,\"hierarchySettings\":{\"treeType\":1,\"groupBy\":[\"Subscription\"],\"expandTopLevel\":true,\"finalBy\":\"Name\"},\"sortBy\":[{\"itemKey\":\"$gen_heatmap_microsoft.storage/storageaccounts-Capacity-UsedCapacity$|microsoft.storage/storageaccounts/blobservices-Capacity-BlobCapacity$|microsoft.storage/storageaccounts/fileservices-Capacity-FileCapacity$|microsoft.storage/storageaccounts/queueservices-Capacity-QueueCapacity$|microsoft.storage/storageaccounts/tableservices-Capacity-TableCapacity$_3\",\"sortOrder\":2}],\"labelSettings\":[{\"columnId\":\"Subscription\",\"label\":\"Subscription\"},{\"columnId\":\"microsoft.storage/storageaccounts-Capacity-UsedCapacity\",\"label\":\"Account used capacity\"},{\"columnId\":\"microsoft.storage/storageaccounts-Capacity-UsedCapacity Timeline\",\"label\":\"Account used capacity timeline\"}]},\"sortBy\":[{\"itemKey\":\"$gen_heatmap_microsoft.storage/storageaccounts-Capacity-UsedCapacity$|microsoft.storage/storageaccounts/blobservices-Capacity-BlobCapacity$|microsoft.storage/storageaccounts/fileservices-Capacity-FileCapacity$|microsoft.storage/storageaccounts/queueservices-Capacity-QueueCapacity$|microsoft.storage/storageaccounts/tableservices-Capacity-TableCapacity$_3\",\"sortOrder\":2}],\"showExportToExcel\":true},\"conditionalVisibility\":{\"parameterName\":\"alwayshidden\",\"comparison\":\"isEqualTo\",\"value\":\"true\"},\"showPin\":true,\"name\":\"metricsGenV2-Capacity\",\"styleSettings\":{\"margin\":\"0 10px 0 10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"{\\\"version\\\":\\\"Merge/1.0\\\",\\\"merges\\\":[{\\\"id\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\",\\\"mergeType\\\":\\\"innerunique\\\",\\\"leftTable\\\":\\\"query-storageaccounts-GenV2-zones-details\\\",\\\"rightTable\\\":\\\"metricsGenV2-Capacity\\\",\\\"leftColumn\\\":\\\"id\\\",\\\"rightColumn\\\":\\\"Name\\\"}],\\\"projectRename\\\":[{\\\"originalName\\\":\\\"[query-storageaccounts-GenV2-zones-details].id\\\",\\\"mergedName\\\":\\\"id\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-GenV2-zones-details].name\\\",\\\"mergedName\\\":\\\"name\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-GenV2-zones-details].skuName\\\",\\\"mergedName\\\":\\\"skuName\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-GenV2-zones-details].kind\\\",\\\"mergedName\\\":\\\"kind\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-GenV2-zones-details].zoneRedundant\\\",\\\"mergedName\\\":\\\"zoneRedundant\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[metricsGenV2-Capacity].microsoft.storage/storageaccounts-Capacity-UsedCapacity\\\",\\\"mergedName\\\":\\\"Account used capacity(avg 30days)\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[Added column]\\\",\\\"mergedName\\\":\\\"New estimated montlhy cost\\\",\\\"fromId\\\":null,\\\"isNewItem\\\":true,\\\"newItemData\\\":[{\\\"criteriaContext\\\":{\\\"leftOperand\\\":\\\"id\\\",\\\"operator\\\":\\\"isNotNull\\\",\\\"rightValType\\\":\\\"column\\\",\\\"resultValType\\\":\\\"expression\\\",\\\"resultVal\\\":\\\"(([\\\\\\\"Account used capacity(avg 30days)\\\\\\\"]/ (1024^3))*{storageV2GBCost})\\\"}},{\\\"criteriaContext\\\":{\\\"operator\\\":\\\"Default\\\",\\\"rightValType\\\":\\\"column\\\",\\\"resultValType\\\":\\\"column\\\"}}]},{\\\"originalName\\\":\\\"[query-storageaccounts-GenV2-zones-details].resourceGroup\\\",\\\"mergedName\\\":\\\"resourceGroup\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-GenV2-zones-details].subscriptionId\\\",\\\"mergedName\\\":\\\"subscriptionId\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[query - combinedMetrics].Name\\\"},{\\\"originalName\\\":\\\"[query - combinedMetrics].Subscription\\\"},{\\\"originalName\\\":\\\"[metricsGenV2-Capacity].microsoft.storage/storageaccounts-Capacity-UsedCapacity Timeline\\\"},{\\\"originalName\\\":\\\"[metricsGenV2-Capacity].Name\\\"},{\\\"originalName\\\":\\\"[metricsGenV2-Capacity].Subscription\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-GenV2-zones-details].location\\\"}]}\",\"size\":0,\"queryType\":7,\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"zoneRedundant\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"3\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"Account used capacity(avg 30days)\",\"formatter\":0,\"numberFormat\":{\"unit\":2,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Estimated capacity costs\",\"formatter\":0,\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Estimated Storage Cost\",\"formatter\":0,\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\"}}}]}},\"showPin\":false,\"name\":\"query-BlobStoragewithCosts\"}]},\"conditionalVisibility\":{\"parameterName\":\"CheckforStorageV2\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"groupStorageAccount-v2\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Storage Account v1ðŸŸ¢ [Cost Est.]\",\"items\":[{\"type\":1,\"content\":{\"json\":\"> **Note:** Cost based on East US rates (Sep 2025). Storage cost only â€” excludes transactions/operations. For detailed pricing, see [Azure Pricing Calculator](https://azure.microsoft.com/pricing/calculator/).\\r\\n\",\"style\":\"upsell\"},\"name\":\"text - storage costs\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"understand-cost-calc-yesno\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"understandCostCalculations\",\"label\":\"Show Storage cost calculation details?\",\"type\":2,\"isRequired\":true,\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"jsonData\":\"[\\r\\n    {\\r\\n    \\\"value\\\" : \\\"Yes\\\",\\r\\n    \\\"label\\\" : \\\"Yes\\\"\\r\\n    },\\r\\n    {\\r\\n    \\\"value\\\" : \\\"No\\\",\\r\\n    \\\"label\\\" : \\\"No\\\",\\r\\n    \\\"selected\\\" : true\\r\\n    }\\r\\n]\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"Show Cost Calculation Details\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"a1a1ed79-dd3e-4c78-bde6-2427b0606874\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"storageV1GBCost\",\"label\":\"StorageV2 cost per GB\",\"type\":1,\"timeContext\":{\"durationMs\":86400000},\"value\":\"0.03\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"understandCostCalculations\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"param-SAIncrease\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'Microsoft.Storage/StorageAccounts'\\r\\n| where kind == \\\"Storage\\\"\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend locations = properties.locations\\r\\n| extend skuName = tostring(sku.name)\\r\\n| extend zoneRedundant = case(sku.name endswith_cs 'ZRS', true, false)\\r\\n| join kind = innerunique (\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n)\\r\\n    on id\\r\\n| distinct id, name, skuName, kind, zoneRedundant, resourceGroup, subscriptionId, location\",\"size\":0,\"title\":\"Azure Storage Accounts\",\"noDataMessage\":\"All Azure Storage Accounts are zone redundant\",\"noDataMessageStyle\":3,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"zoneRedundant\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"failed\",\"text\":\"{0}{1}\"}]}}]}},\"conditionalVisibility\":{\"parameterName\":\"alwayshidden\",\"comparison\":\"isEqualTo\",\"value\":\"true\"},\"name\":\"query-storageaccounts-GenV1-zones-details\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"{Subscription}\"],\"parameters\":[{\"id\":\"e94aafa3-c5d9-4523-89f0-4e87aa754511\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Resources\",\"label\":\"Storage accounts\",\"type\":5,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"resources\\n| where resourceGroup in ({ResourceGroup})\\n| where type =~ 'Microsoft.Storage/StorageAccounts'\\n| where kind == \\\"Storage\\\"\\n| where location in~ ({ZonalRegions:value})\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\n| extend locations = properties.locations\\n| extend skuName = tostring(sku.name)\\n| extend zoneRedundant = case(sku.name endswith_cs 'ZRS', true, false)\\n| join kind = innerunique (\\n    resources\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\n    | extend replaced_tags = parse_json(replaced_tags)\\n    | mv-expand replaced_tags\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\n)\\n    on id\\n| distinct id, name, skuName, kind, zoneRedundant, resourceGroup, subscriptionId, location\",\"crossComponentResources\":[\"{Subscription}\"],\"typeSettings\":{\"resourceTypeFilter\":{\"microsoft.storage/storageaccounts\":true},\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"}],\"style\":\"above\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},\"conditionalVisibility\":{\"parameterName\":\"alwayshidden\",\"comparison\":\"isEqualTo\",\"value\":\"true\"},\"name\":\"paramSAGenV1\",\"styleSettings\":{\"margin\":\"15px 0 0 0\"}},{\"type\":10,\"content\":{\"chartId\":\"workbookdb19a8d8-91af-44ea-951d-5ffa133b2ebe\",\"version\":\"MetricsItem/2.0\",\"size\":3,\"chartType\":0,\"resourceType\":\"microsoft.storage/storageaccounts\",\"metricScope\":0,\"resourceParameter\":\"Resources\",\"resourceIds\":[\"{Resources}\"],\"timeContext\":{\"durationMs\":2592000000},\"metrics\":[{\"namespace\":\"microsoft.storage/storageaccounts\",\"metric\":\"microsoft.storage/storageaccounts-Capacity-UsedCapacity\",\"aggregation\":4}],\"title\":\"Storage Capacity\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"$gen_group\",\"formatter\":13,\"formatOptions\":{\"linkTarget\":\"Resource\",\"subTarget\":\"insights\",\"showIcon\":true}},{\"columnMatch\":\"Subscription\",\"formatter\":5},{\"columnMatch\":\"Name\",\"formatter\":5},{\"columnMatch\":\"microsoft.storage/storageaccounts-Capacity-UsedCapacity$|microsoft.storage/storageaccounts/blobservices-Capacity-BlobCapacity$|microsoft.storage/storageaccounts/fileservices-Capacity-FileCapacity$|microsoft.storage/storageaccounts/queueservices-Capacity-QueueCapacity$|microsoft.storage/storageaccounts/tableservices-Capacity-TableCapacity$\",\"formatter\":8,\"formatOptions\":{\"min\":0,\"palette\":\"blue\",\"linkTarget\":\"WorkbookTemplate\",\"workbookContext\":{\"componentIdSource\":\"column\",\"componentId\":\"Name\",\"resourceIdsSource\":\"column\",\"resourceIds\":\"Name\",\"templateIdSource\":\"static\",\"templateId\":\"Community-Workbooks/Individual Storage/Capacity\",\"typeSource\":\"static\",\"type\":\"workbook\",\"gallerySource\":\"static\",\"gallery\":\"microsoft.storage/storageaccounts\"}},\"numberFormat\":{\"unit\":2,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":1}}},{\"columnMatch\":\"microsoft.storage/storageaccounts-Capacity-UsedCapacity Timeline$|Account used capacity Timeline$\",\"formatter\":5},{\"columnMatch\":\"microsoft.storage/storageaccounts/blobservices-Capacity-BlobCapacity Timeline$|Blob capacity Timeline$\",\"formatter\":5},{\"columnMatch\":\"microsoft.storage/storageaccounts/fileservices-Capacity-FileCapacity Timeline$|File capacity Timeline$\",\"formatter\":5},{\"columnMatch\":\"microsoft.storage/storageaccounts/queueservices-Capacity-QueueCapacity Timeline$|Queue capacity Timeline$\",\"formatter\":5},{\"columnMatch\":\"microsoft.storage/storageaccounts/tableservices-Capacity-TableCapacity Timeline$|Table capacity Timeline$\",\"formatter\":5}],\"rowLimit\":10000,\"filter\":true,\"hierarchySettings\":{\"treeType\":1,\"groupBy\":[\"Subscription\"],\"expandTopLevel\":true,\"finalBy\":\"Name\"},\"labelSettings\":[{\"columnId\":\"Subscription\",\"label\":\"Subscription\"},{\"columnId\":\"microsoft.storage/storageaccounts-Capacity-UsedCapacity\",\"label\":\"Account used capacity\"},{\"columnId\":\"microsoft.storage/storageaccounts-Capacity-UsedCapacity Timeline\",\"label\":\"Account used capacity timeline\"}]},\"sortBy\":[],\"showExportToExcel\":true},\"conditionalVisibility\":{\"parameterName\":\"alwayshidden\",\"comparison\":\"isEqualTo\",\"value\":\"true\"},\"showPin\":true,\"name\":\"metricsGenV1-Capacity\",\"styleSettings\":{\"margin\":\"0 10px 0 10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"{\\\"version\\\":\\\"Merge/1.0\\\",\\\"merges\\\":[{\\\"id\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\",\\\"mergeType\\\":\\\"innerunique\\\",\\\"leftTable\\\":\\\"query-storageaccounts-GenV1-zones-details\\\",\\\"rightTable\\\":\\\"metricsGenV1-Capacity\\\",\\\"leftColumn\\\":\\\"id\\\",\\\"rightColumn\\\":\\\"Name\\\"}],\\\"projectRename\\\":[{\\\"originalName\\\":\\\"[query-storageaccounts-GenV1-zones-details].id\\\",\\\"mergedName\\\":\\\"id\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-GenV1-zones-details].name\\\",\\\"mergedName\\\":\\\"name\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-GenV1-zones-details].skuName\\\",\\\"mergedName\\\":\\\"skuName\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-GenV1-zones-details].kind\\\",\\\"mergedName\\\":\\\"kind\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-GenV1-zones-details].zoneRedundant\\\",\\\"mergedName\\\":\\\"zoneRedundant\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[metricsGenV1-Capacity].microsoft.storage/storageaccounts-Capacity-UsedCapacity\\\",\\\"mergedName\\\":\\\"Account used capacity(avg 30 days)\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[Added column]\\\",\\\"mergedName\\\":\\\"New estimated capacity costs\\\",\\\"fromId\\\":null,\\\"isNewItem\\\":true,\\\"newItemData\\\":[{\\\"criteriaContext\\\":{\\\"leftOperand\\\":\\\"id\\\",\\\"operator\\\":\\\"isNotNull\\\",\\\"rightValType\\\":\\\"column\\\",\\\"resultValType\\\":\\\"expression\\\",\\\"resultVal\\\":\\\"(([\\\\\\\"Account used capacity(avg 30 days)\\\\\\\"]/ (1024^3))*{storageV1GBCost})\\\"}},{\\\"criteriaContext\\\":{\\\"operator\\\":\\\"Default\\\",\\\"rightValType\\\":\\\"column\\\",\\\"resultValType\\\":\\\"column\\\"}}]},{\\\"originalName\\\":\\\"[query-storageaccounts-GenV1-zones-details].resourceGroup\\\",\\\"mergedName\\\":\\\"resourceGroup\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-GenV1-zones-details].subscriptionId\\\",\\\"mergedName\\\":\\\"subscriptionId\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-GenV1-zones-details].location\\\",\\\"mergedName\\\":\\\"location\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[metricsGenV1-Capacity].Subscription\\\",\\\"mergedName\\\":\\\"Subscription\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[metricsGenV1-Capacity].Name\\\",\\\"mergedName\\\":\\\"Name\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[metricsGenV1-Capacity].microsoft.storage/storageaccounts-Capacity-UsedCapacity Timeline\\\",\\\"mergedName\\\":\\\"Account used capacity timeline\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[query - combinedMetrics].Name\\\"},{\\\"originalName\\\":\\\"[query - combinedMetrics].Subscription\\\"},{\\\"originalName\\\":\\\"[metricsGenV2-Capacity].microsoft.storage/storageaccounts-Capacity-UsedCapacity Timeline\\\"},{\\\"originalName\\\":\\\"[metricsGenV2-Capacity].Name\\\"},{\\\"originalName\\\":\\\"[metricsGenV2-Capacity].Subscription\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-GenV2-zones-details].location\\\"}]}\",\"size\":0,\"showExportToExcel\":true,\"queryType\":7,\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"zoneRedundant\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"3\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"Account used capacity(avg 30 days)\",\"formatter\":0,\"numberFormat\":{\"unit\":2,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"New estimated capacity costs\",\"formatter\":0,\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Estimated capacity costs\",\"formatter\":0,\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Account used capacity(avg 30days)\",\"formatter\":0,\"numberFormat\":{\"unit\":2,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Estimated Storage Cost\",\"formatter\":0,\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\"}}}]}},\"name\":\"query-Storagev1withCosts\"}]},\"conditionalVisibility\":{\"parameterName\":\"CheckforStorageV1\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"groupStorageAccount-v1\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Storage Account - Block blobðŸŸ¢ [Cost Est.]\",\"items\":[{\"type\":1,\"content\":{\"json\":\"> **Note:** Cost based on East US rates (Sep 2025). Storage cost only â€” excludes transactions/operations. For detailed pricing, see [Azure Pricing Calculator](https://azure.microsoft.com/pricing/calculator/).\\r\\n\",\"style\":\"upsell\"},\"name\":\"text - storage costs\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"understand-cost-calc-yesno\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"understandCostCalculations\",\"label\":\"Show Storage cost calculation details?\",\"type\":2,\"isRequired\":true,\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"jsonData\":\"[\\r\\n    {\\r\\n    \\\"value\\\" : \\\"Yes\\\",\\r\\n    \\\"label\\\" : \\\"Yes\\\"\\r\\n    },\\r\\n    {\\r\\n    \\\"value\\\" : \\\"No\\\",\\r\\n    \\\"label\\\" : \\\"No\\\",\\r\\n    \\\"selected\\\" : true\\r\\n    }\\r\\n]\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"Show Cost Calculation Details\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"a1a1ed79-dd3e-4c78-bde6-2427b0606874\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"storageBlockGBCost\",\"label\":\"Block Storage cost per GB\",\"type\":1,\"timeContext\":{\"durationMs\":86400000},\"value\":\"0.15\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"understandCostCalculations\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"param-SAIncrease\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'Microsoft.Storage/StorageAccounts'\\r\\n| where kind == \\\"BlockBlobStorage\\\"\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend locations = properties.locations\\r\\n| extend skuName = tostring(sku.name)\\r\\n| extend zoneRedundant = case(sku.name endswith_cs 'ZRS', true, false)\\r\\n| join kind = innerunique (\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n)\\r\\n    on id\\r\\n| distinct id, name, skuName, kind, zoneRedundant, resourceGroup, subscriptionId, location\",\"size\":0,\"title\":\"Azure Storage Accounts\",\"noDataMessage\":\"All Azure Storage Accounts are zone redundant\",\"noDataMessageStyle\":3,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"zoneRedundant\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"failed\",\"text\":\"{0}{1}\"}]}}]}},\"conditionalVisibility\":{\"parameterName\":\"alwayshidden\",\"comparison\":\"isEqualTo\",\"value\":\"true\"},\"name\":\"query-storageaccounts-Block-zones-details\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"{Subscription}\"],\"parameters\":[{\"id\":\"e94aafa3-c5d9-4523-89f0-4e87aa754511\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Resources\",\"label\":\"Storage accounts\",\"type\":5,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"resources\\n| where resourceGroup in ({ResourceGroup})\\n| where type =~ 'Microsoft.Storage/StorageAccounts'\\n| where kind == \\\"BlockBlobStorage\\\"\\n| where location in~ ({ZonalRegions:value})\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\n| extend locations = properties.locations\\n| extend skuName = tostring(sku.name)\\n| extend zoneRedundant = case(sku.name endswith_cs 'ZRS', true, false)\\n| join kind = innerunique (\\n    resources\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\n    | extend replaced_tags = parse_json(replaced_tags)\\n    | mv-expand replaced_tags\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\n)\\n    on id\\n| distinct id, name, skuName, kind, zoneRedundant, resourceGroup, subscriptionId, location\",\"crossComponentResources\":[\"{Subscription}\"],\"typeSettings\":{\"resourceTypeFilter\":{\"microsoft.storage/storageaccounts\":true},\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"}],\"style\":\"above\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},\"conditionalVisibility\":{\"parameterName\":\"alwayshidden\",\"comparison\":\"isEqualTo\",\"value\":\"true\"},\"name\":\"paramSAGenBlock\",\"styleSettings\":{\"margin\":\"15px 0 0 0\"}},{\"type\":10,\"content\":{\"chartId\":\"workbookdb19a8d8-91af-44ea-951d-5ffa133b2ebe\",\"version\":\"MetricsItem/2.0\",\"size\":3,\"chartType\":0,\"resourceType\":\"microsoft.storage/storageaccounts\",\"metricScope\":0,\"resourceParameter\":\"Resources\",\"resourceIds\":[\"{Resources}\"],\"timeContext\":{\"durationMs\":2592000000},\"metrics\":[{\"namespace\":\"microsoft.storage/storageaccounts\",\"metric\":\"microsoft.storage/storageaccounts-Capacity-UsedCapacity\",\"aggregation\":4}],\"title\":\"Storage Capacity\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"$gen_group\",\"formatter\":13,\"formatOptions\":{\"linkTarget\":\"Resource\",\"subTarget\":\"insights\",\"showIcon\":true}},{\"columnMatch\":\"Subscription\",\"formatter\":5},{\"columnMatch\":\"Name\",\"formatter\":5},{\"columnMatch\":\"microsoft.storage/storageaccounts-Capacity-UsedCapacity$|microsoft.storage/storageaccounts/blobservices-Capacity-BlobCapacity$|microsoft.storage/storageaccounts/fileservices-Capacity-FileCapacity$|microsoft.storage/storageaccounts/queueservices-Capacity-QueueCapacity$|microsoft.storage/storageaccounts/tableservices-Capacity-TableCapacity$\",\"formatter\":8,\"formatOptions\":{\"min\":0,\"palette\":\"blue\",\"linkTarget\":\"WorkbookTemplate\",\"workbookContext\":{\"componentIdSource\":\"column\",\"componentId\":\"Name\",\"resourceIdsSource\":\"column\",\"resourceIds\":\"Name\",\"templateIdSource\":\"static\",\"templateId\":\"Community-Workbooks/Individual Storage/Capacity\",\"typeSource\":\"static\",\"type\":\"workbook\",\"gallerySource\":\"static\",\"gallery\":\"microsoft.storage/storageaccounts\"}},\"numberFormat\":{\"unit\":2,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":1}}},{\"columnMatch\":\"microsoft.storage/storageaccounts-Capacity-UsedCapacity Timeline$|Account used capacity Timeline$\",\"formatter\":5},{\"columnMatch\":\"microsoft.storage/storageaccounts/blobservices-Capacity-BlobCapacity Timeline$|Blob capacity Timeline$\",\"formatter\":5},{\"columnMatch\":\"microsoft.storage/storageaccounts/fileservices-Capacity-FileCapacity Timeline$|File capacity Timeline$\",\"formatter\":5},{\"columnMatch\":\"microsoft.storage/storageaccounts/queueservices-Capacity-QueueCapacity Timeline$|Queue capacity Timeline$\",\"formatter\":5},{\"columnMatch\":\"microsoft.storage/storageaccounts/tableservices-Capacity-TableCapacity Timeline$|Table capacity Timeline$\",\"formatter\":5}],\"rowLimit\":10000,\"filter\":true,\"hierarchySettings\":{\"treeType\":1,\"groupBy\":[\"Subscription\"],\"expandTopLevel\":true,\"finalBy\":\"Name\"},\"sortBy\":[{\"itemKey\":\"$gen_heatmap_microsoft.storage/storageaccounts-Capacity-UsedCapacity$|microsoft.storage/storageaccounts/blobservices-Capacity-BlobCapacity$|microsoft.storage/storageaccounts/fileservices-Capacity-FileCapacity$|microsoft.storage/storageaccounts/queueservices-Capacity-QueueCapacity$|microsoft.storage/storageaccounts/tableservices-Capacity-TableCapacity$_3\",\"sortOrder\":2}],\"labelSettings\":[{\"columnId\":\"Subscription\",\"label\":\"Subscription\"},{\"columnId\":\"microsoft.storage/storageaccounts-Capacity-UsedCapacity\",\"label\":\"Account used capacity\"},{\"columnId\":\"microsoft.storage/storageaccounts-Capacity-UsedCapacity Timeline\",\"label\":\"Account used capacity timeline\"}]},\"sortBy\":[{\"itemKey\":\"$gen_heatmap_microsoft.storage/storageaccounts-Capacity-UsedCapacity$|microsoft.storage/storageaccounts/blobservices-Capacity-BlobCapacity$|microsoft.storage/storageaccounts/fileservices-Capacity-FileCapacity$|microsoft.storage/storageaccounts/queueservices-Capacity-QueueCapacity$|microsoft.storage/storageaccounts/tableservices-Capacity-TableCapacity$_3\",\"sortOrder\":2}],\"showExportToExcel\":true},\"conditionalVisibility\":{\"parameterName\":\"alwayshidden\",\"comparison\":\"isEqualTo\",\"value\":\"true\"},\"showPin\":true,\"name\":\"metricsBlock-Capacity\",\"styleSettings\":{\"margin\":\"0 10px 0 10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"{\\\"version\\\":\\\"Merge/1.0\\\",\\\"merges\\\":[{\\\"id\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\",\\\"mergeType\\\":\\\"innerunique\\\",\\\"leftTable\\\":\\\"query-storageaccounts-Block-zones-details\\\",\\\"rightTable\\\":\\\"metricsBlock-Capacity\\\",\\\"leftColumn\\\":\\\"id\\\",\\\"rightColumn\\\":\\\"Name\\\"}],\\\"projectRename\\\":[{\\\"originalName\\\":\\\"[query-storageaccounts-Block-zones-details].id\\\",\\\"mergedName\\\":\\\"id\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-Block-zones-details].name\\\",\\\"mergedName\\\":\\\"name\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-Block-zones-details].skuName\\\",\\\"mergedName\\\":\\\"skuName\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-Block-zones-details].kind\\\",\\\"mergedName\\\":\\\"kind\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[metricsBlock-Capacity].microsoft.storage/storageaccounts-Capacity-UsedCapacity\\\",\\\"mergedName\\\":\\\"Account used capacity(avg 30days)\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[Added column]\\\",\\\"mergedName\\\":\\\"New estimated cost\\\",\\\"fromId\\\":null,\\\"isNewItem\\\":true,\\\"newItemData\\\":[{\\\"criteriaContext\\\":{\\\"leftOperand\\\":\\\"id\\\",\\\"operator\\\":\\\"isNotNull\\\",\\\"rightValType\\\":\\\"column\\\",\\\"resultValType\\\":\\\"expression\\\",\\\"resultVal\\\":\\\"(([\\\\\\\"Account used capacity(avg 30days)\\\\\\\"]/ (1024^3))*{storageBlockGBCost})\\\"}},{\\\"criteriaContext\\\":{\\\"operator\\\":\\\"Default\\\",\\\"rightValType\\\":\\\"column\\\",\\\"resultValType\\\":\\\"column\\\"}}]},{\\\"originalName\\\":\\\"[query-storageaccounts-Block-zones-details].zoneRedundant\\\",\\\"mergedName\\\":\\\"zoneRedundant\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-Block-zones-details].resourceGroup\\\",\\\"mergedName\\\":\\\"resourceGroup\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-Block-zones-details].subscriptionId\\\",\\\"mergedName\\\":\\\"subscriptionId\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-Block-zones-details].location\\\",\\\"mergedName\\\":\\\"location\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[query - combinedMetrics].Name\\\"},{\\\"originalName\\\":\\\"[query - combinedMetrics].Subscription\\\"},{\\\"originalName\\\":\\\"[metricsGenV2-Capacity].microsoft.storage/storageaccounts-Capacity-UsedCapacity Timeline\\\"},{\\\"originalName\\\":\\\"[metricsGenV2-Capacity].Name\\\"},{\\\"originalName\\\":\\\"[metricsGenV2-Capacity].Subscription\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-GenV2-zones-details].location\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-GenV1-zones-details].id\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-GenV1-zones-details].name\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-GenV1-zones-details].skuName\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-GenV1-zones-details].kind\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-GenV1-zones-details].zoneRedundant\\\"},{\\\"originalName\\\":\\\"[metricsGenV1-Capacity].microsoft.storage/storageaccounts-Capacity-UsedCapacity\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-GenV1-zones-details].resourceGroup\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-GenV1-zones-details].subscriptionId\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-GenV1-zones-details].location\\\"},{\\\"originalName\\\":\\\"[metricsGenV1-Capacity].Subscription\\\"},{\\\"originalName\\\":\\\"[metricsGenV1-Capacity].Name\\\"},{\\\"originalName\\\":\\\"[metricsGenV1-Capacity].microsoft.storage/storageaccounts-Capacity-UsedCapacity Timeline\\\"},{\\\"originalName\\\":\\\"[metricsBlock-Capacity].microsoft.storage/storageaccounts-Capacity-UsedCapacity Timeline\\\"},{\\\"originalName\\\":\\\"[metricsBlock-Capacity].Subscription\\\"},{\\\"originalName\\\":\\\"[metricsBlock-Capacity].Name\\\"}]}\",\"size\":0,\"showExportToExcel\":true,\"queryType\":7,\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Account used capacity(avg 30days)\",\"formatter\":0,\"numberFormat\":{\"unit\":2,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"New estimated cost\",\"formatter\":0,\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"zoneRedundant\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"3\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"Account used capacity(avg 30 days)\",\"formatter\":0,\"numberFormat\":{\"unit\":2,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"New estimated capacity costs\",\"formatter\":0,\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Estimated capacity costs\",\"formatter\":0,\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Estimated Storage Cost\",\"formatter\":0,\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\"}}}]}},\"name\":\"query-StorageBlockwithCosts\"}]},\"conditionalVisibility\":{\"parameterName\":\"CheckforStorageBlock\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"groupStorageAccount-Block\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Storage Account - FilesðŸŸ¢ [Cost Est.]\",\"items\":[{\"type\":1,\"content\":{\"json\":\"> **Note:** Cost based on East US rates (Sep 2025). Storage cost only â€” excludes transactions/operations. For detailed pricing, see [Azure Pricing Calculator](https://azure.microsoft.com/pricing/calculator/).\\r\\n\",\"style\":\"upsell\"},\"name\":\"text - storage costs\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"understand-cost-calc-yesno\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"understandCostCalculations\",\"label\":\"Show Storage cost calculation details?\",\"type\":2,\"isRequired\":true,\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"jsonData\":\"[\\r\\n    {\\r\\n    \\\"value\\\" : \\\"Yes\\\",\\r\\n    \\\"label\\\" : \\\"Yes\\\"\\r\\n    },\\r\\n    {\\r\\n    \\\"value\\\" : \\\"No\\\",\\r\\n    \\\"label\\\" : \\\"No\\\",\\r\\n    \\\"selected\\\" : true\\r\\n    }\\r\\n]\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"Show Cost Calculation Details\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"a1a1ed79-dd3e-4c78-bde6-2427b0606874\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"storageFilesGBCost\",\"label\":\"Storage Files cost per GB\",\"type\":1,\"timeContext\":{\"durationMs\":86400000},\"value\":\"0.15\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"understandCostCalculations\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"param-SAIncrease\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'Microsoft.Storage/StorageAccounts'\\r\\n| where kind == \\\"FileStorage\\\"\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend locations = properties.locations\\r\\n| extend skuName = tostring(sku.name)\\r\\n| extend zoneRedundant = case(sku.name endswith_cs 'ZRS', true, false)\\r\\n//| where zoneRedudant = false\\r\\n| join kind = innerunique (\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n)\\r\\n    on id\\r\\n| distinct id, name, skuName, kind, zoneRedundant, resourceGroup, subscriptionId, location\",\"size\":0,\"title\":\"Azure Storage Accounts\",\"noDataMessage\":\"All Azure Storage Accounts are zone redundant\",\"noDataMessageStyle\":3,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"zoneRedundant\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"failed\",\"text\":\"{0}{1}\"}]}}]}},\"conditionalVisibility\":{\"parameterName\":\"alwayshidden\",\"comparison\":\"isEqualTo\",\"value\":\"true\"},\"name\":\"query-storageaccounts-Files-zones-details\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"{Subscription}\"],\"parameters\":[{\"id\":\"e94aafa3-c5d9-4523-89f0-4e87aa754511\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Resources\",\"label\":\"Storage accounts\",\"type\":5,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"resources\\n| where resourceGroup in ({ResourceGroup})\\n| where type =~ 'Microsoft.Storage/StorageAccounts'\\n| where kind == \\\"FileStorage\\\"\\n| where location in~ ({ZonalRegions:value})\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\n| extend locations = properties.locations\\n| extend skuName = tostring(sku.name)\\n| extend zoneRedundant = case(sku.name endswith_cs 'ZRS', true, false)\\n//| where zoneRedudant = false\\n| join kind = innerunique (\\n    resources\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\n    | extend replaced_tags = parse_json(replaced_tags)\\n    | mv-expand replaced_tags\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\n)\\n    on id\\n| distinct id, name, skuName, kind, zoneRedundant, resourceGroup, subscriptionId, location\",\"crossComponentResources\":[\"{Subscription}\"],\"typeSettings\":{\"resourceTypeFilter\":{\"microsoft.storage/storageaccounts\":true},\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"}],\"style\":\"above\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},\"conditionalVisibility\":{\"parameterName\":\"alwayshidden\",\"comparison\":\"isEqualTo\",\"value\":\"true\"},\"name\":\"paramSAFiles\",\"styleSettings\":{\"margin\":\"15px 0 0 0\"}},{\"type\":10,\"content\":{\"chartId\":\"workbookdb19a8d8-91af-44ea-951d-5ffa133b2ebe\",\"version\":\"MetricsItem/2.0\",\"size\":3,\"chartType\":0,\"resourceType\":\"microsoft.storage/storageaccounts\",\"metricScope\":0,\"resourceParameter\":\"Resources\",\"resourceIds\":[\"{Resources}\"],\"timeContext\":{\"durationMs\":2592000000},\"metrics\":[{\"namespace\":\"microsoft.storage/storageaccounts\",\"metric\":\"microsoft.storage/storageaccounts-Capacity-UsedCapacity\",\"aggregation\":4}],\"title\":\"Storage Capacity\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"$gen_group\",\"formatter\":13,\"formatOptions\":{\"linkTarget\":\"Resource\",\"subTarget\":\"insights\",\"showIcon\":true}},{\"columnMatch\":\"Subscription\",\"formatter\":5},{\"columnMatch\":\"Name\",\"formatter\":5},{\"columnMatch\":\"microsoft.storage/storageaccounts-Capacity-UsedCapacity$|microsoft.storage/storageaccounts/blobservices-Capacity-BlobCapacity$|microsoft.storage/storageaccounts/fileservices-Capacity-FileCapacity$|microsoft.storage/storageaccounts/queueservices-Capacity-QueueCapacity$|microsoft.storage/storageaccounts/tableservices-Capacity-TableCapacity$\",\"formatter\":8,\"formatOptions\":{\"min\":0,\"palette\":\"blue\",\"linkTarget\":\"WorkbookTemplate\",\"workbookContext\":{\"componentIdSource\":\"column\",\"componentId\":\"Name\",\"resourceIdsSource\":\"column\",\"resourceIds\":\"Name\",\"templateIdSource\":\"static\",\"templateId\":\"Community-Workbooks/Individual Storage/Capacity\",\"typeSource\":\"static\",\"type\":\"workbook\",\"gallerySource\":\"static\",\"gallery\":\"microsoft.storage/storageaccounts\"}},\"numberFormat\":{\"unit\":2,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":1}}},{\"columnMatch\":\"microsoft.storage/storageaccounts-Capacity-UsedCapacity Timeline$|Account used capacity Timeline$\",\"formatter\":5},{\"columnMatch\":\"microsoft.storage/storageaccounts/blobservices-Capacity-BlobCapacity Timeline$|Blob capacity Timeline$\",\"formatter\":5},{\"columnMatch\":\"microsoft.storage/storageaccounts/fileservices-Capacity-FileCapacity Timeline$|File capacity Timeline$\",\"formatter\":5},{\"columnMatch\":\"microsoft.storage/storageaccounts/queueservices-Capacity-QueueCapacity Timeline$|Queue capacity Timeline$\",\"formatter\":5},{\"columnMatch\":\"microsoft.storage/storageaccounts/tableservices-Capacity-TableCapacity Timeline$|Table capacity Timeline$\",\"formatter\":5}],\"rowLimit\":10000,\"filter\":true,\"hierarchySettings\":{\"treeType\":1,\"groupBy\":[\"Subscription\"],\"expandTopLevel\":true,\"finalBy\":\"Name\"},\"sortBy\":[{\"itemKey\":\"$gen_heatmap_microsoft.storage/storageaccounts-Capacity-UsedCapacity$|microsoft.storage/storageaccounts/blobservices-Capacity-BlobCapacity$|microsoft.storage/storageaccounts/fileservices-Capacity-FileCapacity$|microsoft.storage/storageaccounts/queueservices-Capacity-QueueCapacity$|microsoft.storage/storageaccounts/tableservices-Capacity-TableCapacity$_3\",\"sortOrder\":2}],\"labelSettings\":[{\"columnId\":\"Subscription\",\"label\":\"Subscription\"},{\"columnId\":\"microsoft.storage/storageaccounts-Capacity-UsedCapacity\",\"label\":\"Account used capacity\"},{\"columnId\":\"microsoft.storage/storageaccounts-Capacity-UsedCapacity Timeline\",\"label\":\"Account used capacity timeline\"}]},\"sortBy\":[{\"itemKey\":\"$gen_heatmap_microsoft.storage/storageaccounts-Capacity-UsedCapacity$|microsoft.storage/storageaccounts/blobservices-Capacity-BlobCapacity$|microsoft.storage/storageaccounts/fileservices-Capacity-FileCapacity$|microsoft.storage/storageaccounts/queueservices-Capacity-QueueCapacity$|microsoft.storage/storageaccounts/tableservices-Capacity-TableCapacity$_3\",\"sortOrder\":2}],\"showExportToExcel\":true},\"conditionalVisibility\":{\"parameterName\":\"alwayshidden\",\"comparison\":\"isEqualTo\",\"value\":\"true\"},\"showPin\":true,\"name\":\"metricsFiles-Capacity\",\"styleSettings\":{\"margin\":\"0 10px 0 10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"{\\\"version\\\":\\\"Merge/1.0\\\",\\\"merges\\\":[{\\\"id\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\",\\\"mergeType\\\":\\\"innerunique\\\",\\\"leftTable\\\":\\\"query-storageaccounts-Files-zones-details\\\",\\\"rightTable\\\":\\\"metricsFiles-Capacity\\\",\\\"leftColumn\\\":\\\"id\\\",\\\"rightColumn\\\":\\\"Name\\\"}],\\\"projectRename\\\":[{\\\"originalName\\\":\\\"[query-storageaccounts-Files-zones-details].id\\\",\\\"mergedName\\\":\\\"id\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-Files-zones-details].name\\\",\\\"mergedName\\\":\\\"name\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-Files-zones-details].skuName\\\",\\\"mergedName\\\":\\\"skuName\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-Files-zones-details].kind\\\",\\\"mergedName\\\":\\\"kind\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-Files-zones-details].zoneRedundant\\\",\\\"mergedName\\\":\\\"zoneRedundant\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[metricsFiles-Capacity].microsoft.storage/storageaccounts-Capacity-UsedCapacity\\\",\\\"mergedName\\\":\\\"Account used capacity(avg 30days)\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[Added column]\\\",\\\"mergedName\\\":\\\"New estimated storage cost\\\",\\\"fromId\\\":null,\\\"isNewItem\\\":true,\\\"newItemData\\\":[{\\\"criteriaContext\\\":{\\\"leftOperand\\\":\\\"id\\\",\\\"operator\\\":\\\"isNotNull\\\",\\\"rightValType\\\":\\\"column\\\",\\\"resultValType\\\":\\\"expression\\\",\\\"resultVal\\\":\\\"(([\\\\\\\"Account used capacity(avg 30days)\\\\\\\"]/ (1024^3))*{storageFilesGBCost})\\\"}},{\\\"criteriaContext\\\":{\\\"operator\\\":\\\"Default\\\",\\\"rightValType\\\":\\\"column\\\",\\\"resultValType\\\":\\\"column\\\"}}]},{\\\"originalName\\\":\\\"[query-storageaccounts-Files-zones-details].resourceGroup\\\",\\\"mergedName\\\":\\\"resourceGroup\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-Files-zones-details].subscriptionId\\\",\\\"mergedName\\\":\\\"subscriptionId\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-Files-zones-details].location\\\",\\\"mergedName\\\":\\\"location\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[metricsFiles-Capacity].Subscription\\\",\\\"mergedName\\\":\\\"Subscription\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[metricsFiles-Capacity].Name\\\",\\\"mergedName\\\":\\\"Name\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[metricsFiles-Capacity].microsoft.storage/storageaccounts-Capacity-UsedCapacity Timeline\\\",\\\"mergedName\\\":\\\"Account used capacity timeline\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"}]}\",\"size\":0,\"showExportToExcel\":true,\"queryType\":7,\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"zoneRedundant\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"3\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"Account used capacity(avg 30days)\",\"formatter\":0,\"numberFormat\":{\"unit\":2,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"New estimated storage cost\",\"formatter\":0,\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"New estimated cost\",\"formatter\":0,\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Account used capacity(avg 30 days)\",\"formatter\":0,\"numberFormat\":{\"unit\":2,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"New estimated capacity costs\",\"formatter\":0,\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Estimated capacity costs\",\"formatter\":0,\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Estimated Storage Cost\",\"formatter\":0,\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\"}}}]}},\"name\":\"query-StorageBlockwithCosts\"}]},\"name\":\"groupStorageAccount-Files\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ \\\"Microsoft.NetApp/netAppAccounts/capacityPools/volumes\\\"\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend locations=properties.locations\\r\\n| extend zoneRedundant = case(\\r\\n    isnull(zones) or array_length(zones) <= 1, false, \\r\\n    true \\r\\n  )\\r\\n| join kind = innerunique( //Tag filter\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId=id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n    )\\r\\n    on id\\r\\n| distinct id,name,zoneRedundant,resourceGroup,subscriptionId,location\",\"size\":0,\"title\":\"Azure Net App Files\",\"noDataMessage\":\"All Azure Net App Files volumes have availability zones configured\",\"noDataMessageStyle\":3,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"zoneRedundant\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"failed\",\"text\":\"{0}{1}\"}]}}],\"rowLimit\":1000}},\"name\":\"query-net-app-zone-details\"}]},\"name\":\"group - NetAppFiles\"}]},\"conditionalVisibility\":{\"parameterName\":\"selectedDetailsTab\",\"comparison\":\"isEqualTo\",\"value\":\"storage\"},\"name\":\"group - storageAccounts\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Compute Services Availability Zone Coverage\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"{Subscription}\"],\"parameters\":[{\"id\":\"a46fa23b-8d13-496d-be3d-6c0228e4c5d7\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"CheckforDisk\",\"type\":1,\"query\":\"// Count query for Managed Disks needing zone redundancy\\r\\nresources\\r\\n| where type == 'microsoft.compute/disks'\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend skuName = tostring(sku.name)\\r\\n| extend supportsZoneRedundancy = case(\\r\\n    skuName in ('Premium_LRS', 'StandardSSD_LRS', 'Premium_ZRS', 'StandardSSD_ZRS'), true,\\r\\n    false\\r\\n)\\r\\n| extend currentlyZoneRedundant = skuName in ('Premium_ZRS', 'StandardSSD_ZRS')\\r\\n//| where supportsZoneRedundancy == false or currentlyZoneRedundant == false\\r\\n| join kind = innerunique (\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n)\\r\\n    on id\\r\\n| summarize DiskCount = count()\\r\\n| extend HasNonZonalDisk = iff(DiskCount > 0, \\\"Yes\\\", \\\"No\\\")\\r\\n| project HasNonZonalDisk\",\"crossComponentResources\":[\"{Subscription}\"],\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"version\":\"KqlParameterItem/1.0\",\"name\":\"CheckforVMs\",\"type\":1,\"query\":\"// Count query for VMs needing zone redundancy\\r\\nresources\\r\\n| where type =~ 'microsoft.compute/virtualmachines'\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend pinnedZone = case(\\r\\n    isnull(zones) or array_length(zones) == 0, false, \\r\\n    true \\r\\n)\\r\\n//| where pinnedZone == false  // Only VMs not pinned to zones\\r\\n| join kind = innerunique (\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n)\\r\\n    on id\\r\\n| summarize VMCount = count()\\r\\n| extend HasNonZonalVM = iff(VMCount > 0, \\\"Yes\\\", \\\"No\\\")\\r\\n| project HasNonZonalVM\",\"crossComponentResources\":[\"{Subscription}\"],\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"id\":\"c411b05c-16b1-4630-a3b9-0a6a4f1f4f29\"},{\"version\":\"KqlParameterItem/1.0\",\"name\":\"CheckforVMSS\",\"type\":1,\"query\":\"// Count query for standalone VMSS needing zone redundancy\\r\\nresources\\r\\n| where type =~ 'microsoft.compute/virtualmachinescalesets'\\r\\n//| where resourceGroup in ({ResourceGroup})\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend isAKSManaged = case(\\r\\n    tags has \\\"aks-managed-orchestrator\\\" or name startswith \\\"aks-\\\", true,\\r\\n    false\\r\\n)\\r\\n| where isAKSManaged == false  // Only standalone (non-AKS) VMSS\\r\\n| extend currentZoneRedundant = case(\\r\\n    isnull(zones) or array_length(zones) <= 1, false,\\r\\n    true\\r\\n)\\r\\n//| where currentZoneRedundant == false  // Only non-zone-redundant VMSS\\r\\n| join kind = innerunique (\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}'])\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n    | distinct id\\r\\n) on id\\r\\n| summarize StandaloneVMSSCount = count()\\r\\n| extend HasNonZonalStandaloneVMSS = iff(StandaloneVMSSCount > 0, \\\"Yes\\\", \\\"No\\\")\\r\\n| project HasNonZonalStandaloneVMSS\",\"crossComponentResources\":[\"{Subscription}\"],\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"id\":\"a1a9502e-3247-4d9d-b31a-0ca0d1e360e1\"}],\"style\":\"pills\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},\"conditionalVisibility\":{\"parameterName\":\"AlwaysHidden\",\"comparison\":\"isEqualTo\",\"value\":\"true\"},\"name\":\"paramCheckResourceIntegrationService\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Azure Disk StorageðŸŸ¢ [Cost Est.]\",\"items\":[{\"type\":1,\"content\":{\"json\":\"Note: Cost based on East US rates (Sep 2025). Disk storage cost only â€” excludes IOPS, throughput, and snapshot costs. For detailed pricing, see [Azure Pricing Calculator](https://azure.microsoft.com/en-us/pricing/calculator/).\",\"style\":\"upsell\"},\"name\":\"textDiskFootnote\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"understand-cost-calc-yesno\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"understandCostCalculations\",\"label\":\"Show Diskcost calculation details?\",\"type\":2,\"isRequired\":true,\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"jsonData\":\"[\\r\\n    {\\r\\n    \\\"value\\\" : \\\"Yes\\\",\\r\\n    \\\"label\\\" : \\\"Yes\\\"\\r\\n    },\\r\\n    {\\r\\n    \\\"value\\\" : \\\"No\\\",\\r\\n    \\\"label\\\" : \\\"No\\\",\\r\\n    \\\"selected\\\" : true\\r\\n    }\\r\\n]\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"Show Cost Calculation Details\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"standardHddPricePerGB\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"standardHddPricePerGB\",\"label\":\"Standard HDD Price per GB/month\",\"type\":1,\"description\":\"Monthly cost per GB for Standard_LRS disks\",\"value\":\"0.0048\",\"labelWidth\":200,\"constraints\":{\"validationMessage\":\"Must be a valid decimal number\"}},{\"id\":\"standardSsdPricePerGB\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"standardSsdPricePerGB\",\"label\":\"Standard SSD Price per GB/month\",\"type\":1,\"description\":\"Monthly cost per GB for StandardSSD_LRS disks\",\"value\":\"0.0730\",\"labelWidth\":200,\"constraints\":{\"validationMessage\":\"Must be a valid decimal number\"}},{\"id\":\"premiumSsdPricePerGB\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"premiumSsdPricePerGB\",\"label\":\"Premium SSD Price per GB/month\",\"type\":1,\"description\":\"Monthly cost per GB for Premium_LRS disks\",\"value\":\"0.1460\",\"labelWidth\":200,\"constraints\":{\"validationMessage\":\"Must be a valid decimal number\"}},{\"id\":\"standardSsdZrsPricePerGB\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"standardSsdZrsPricePerGB\",\"label\":\"Standard SSD ZRS Price per GB/month\",\"type\":1,\"description\":\"Monthly cost per GB for StandardSSD_ZRS disks\",\"value\":\"0.0876\",\"labelWidth\":200,\"constraints\":{\"validationMessage\":\"Must be a valid decimal number\"}},{\"id\":\"premiumZrsPricePerGB\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"premiumZrsPricePerGB\",\"label\":\"Premium SSD ZRS Price per GB/month\",\"type\":1,\"description\":\"Monthly cost per GB for Premium_ZRS disks\",\"value\":\"0.1752\",\"labelWidth\":200,\"constraints\":{\"validationMessage\":\"Must be a valid decimal number\"}}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"understandCostCalculations\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"parameters - DiskPricing\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"// Managed Disks Zone Redundancy Analysis\\r\\nresources\\r\\n| where type == 'microsoft.compute/disks'\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/', subscriptionId, '/resourceGroups/', resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/', subscriptionId)\\r\\n| extend skuName = tostring(sku.name)\\r\\n| extend diskSizeGB = toint(properties.diskSizeGB)\\r\\n| extend supportsZoneRedundancy = case(\\r\\n    skuName in ('Premium_LRS', 'StandardSSD_LRS'), true,  // Can upgrade to Premium_ZRS, StandardSSD_ZRS\\r\\n    skuName in ('Premium_ZRS', 'StandardSSD_ZRS'), true,  // Already zone redundant capable\\r\\n    false  // Ultra, Premium SSD v2, Standard_LRS don't support ZRS\\r\\n)\\r\\n| extend currentlyZoneRedundant = skuName in ('Premium_ZRS', 'StandardSSD_ZRS')\\r\\n| where supportsZoneRedundancy == false or currentlyZoneRedundant == false  // Need action\\r\\n| extend recommendedSku = case(\\r\\n    skuName == \\\"Premium_LRS\\\", \\\"Premium_ZRS\\\",\\r\\n    skuName == \\\"StandardSSD_LRS\\\", \\\"StandardSSD_ZRS\\\", \\r\\n    skuName == \\\"Standard_LRS\\\", \\\"StandardSSD_ZRS\\\",  // Upgrade Standard to StandardSSD_ZRS\\r\\n    skuName in ('UltraSSD_LRS', 'PremiumV2_LRS'), \\\"Migrate to Premium_ZRS\\\",  // These don't support ZRS\\r\\n    \\\"StandardSSD_ZRS\\\"  // Default fallback\\r\\n)\\r\\n| extend currentMonthlyCost = case(\\r\\n    skuName == \\\"Premium_LRS\\\", todouble({premiumSsdPricePerGB}) * diskSizeGB,\\r\\n    skuName == \\\"StandardSSD_LRS\\\", todouble({standardSsdPricePerGB}) * diskSizeGB,\\r\\n    skuName == \\\"Standard_LRS\\\", todouble({standardHddPricePerGB}) * diskSizeGB,\\r\\n    skuName == \\\"UltraSSD_LRS\\\", 0.0,  // Complex pricing, not calculated\\r\\n    skuName == \\\"PremiumV2_LRS\\\", 0.0,  // Complex pricing, not calculated\\r\\n    0.0\\r\\n)\\r\\n| extend targetMonthlyCost = case(\\r\\n    recommendedSku == \\\"Premium_ZRS\\\", todouble({premiumZrsPricePerGB}) * diskSizeGB,\\r\\n    recommendedSku == \\\"StandardSSD_ZRS\\\", todouble({standardSsdZrsPricePerGB}) * diskSizeGB,\\r\\n    0.0  // For migration scenarios\\r\\n)\\r\\n| extend additionalMonthlyCost = targetMonthlyCost - currentMonthlyCost\\r\\n| extend \\r\\n    Recommendation = case(\\r\\n        skuName in ('UltraSSD_LRS', 'PremiumV2_LRS'), \\\"Migrate to zone-redundant disk type (ZRS not supported for Ultra/Premium v2)\\\",\\r\\n        currentlyZoneRedundant == false and supportsZoneRedundancy == true, strcat(\\\"Upgrade to \\\", recommendedSku),\\r\\n        \\\"Enable zone redundancy\\\"\\r\\n    ),\\r\\n    ImplementationImpact = case(\\r\\n        additionalMonthlyCost == 0.0, \\\"High\\\",  // Migration required\\r\\n        additionalMonthlyCost <= 10.0, \\\"Low\\\",\\r\\n        additionalMonthlyCost <= 50.0, \\\"High\\\",\\r\\n        \\\"High\\\"\\r\\n    ),\\r\\n    ImplementationComplexity = case(\\r\\n        skuName in ('UltraSSD_LRS', 'PremiumV2_LRS'), \\\"High\\\",  // Migration required\\r\\n        \\\"Medium\\\"  // Disk type change\\r\\n    )\\r\\n| join kind = innerunique (\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n)\\r\\n    on id\\r\\n| project \\r\\n    name,\\r\\n    skuName,\\r\\n    recommendedSku,\\r\\n    diskSizeGB,\\r\\n    currentMonthlyCost = round(currentMonthlyCost, 2),\\r\\n    resourceGroup,\\r\\n    Recommendation,\\r\\n    ImplementationImpact,\\r\\n    ImplementationComplexity,\\r\\n    targetMonthlyCost = round(targetMonthlyCost, 2),\\r\\n    additionalMonthlyCost = round(additionalMonthlyCost, 2),\\r\\n    location,\\r\\n    subscriptionId\\r\\n| sort by additionalMonthlyCost desc\",\"size\":0,\"noDataMessage\":\"All disks have availability zones configured\",\"noDataMessageStyle\":3,\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"resiliencyLevel\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"Zone-Redudant\",\"representation\":\"success\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Zonal\",\"representation\":\"2\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Regional\",\"representation\":\"4\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"success\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"resourceGroup\",\"formatter\":14,\"formatOptions\":{\"linkTarget\":null,\"showIcon\":true}},{\"columnMatch\":\"subscriptionId\",\"formatter\":15,\"formatOptions\":{\"linkTarget\":null,\"showIcon\":true}},{\"columnMatch\":\"zoneRedundant\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"failed\",\"text\":\"\"}]}}],\"rowLimit\":1000,\"filter\":true,\"sortBy\":[{\"itemKey\":\"skuName\",\"sortOrder\":1}]},\"sortBy\":[{\"itemKey\":\"skuName\",\"sortOrder\":1}]},\"name\":\"query-disks-zones-details\"},{\"type\":1,\"content\":{\"json\":\"**ðŸŸ¢ [Cost Est.] How Managed Disk Zone Redundancy Cost is Calculated**\\r\\n\\r\\n**Monthly Cost Formula:**\\r\\nâ€¢ **Disk Cost**: {Disk Size GB} Ã— {Price per GB per month}\\r\\n\\r\\n**SKU Upgrade Mapping:**\\r\\nâ€¢ Standard_LRS â†’ StandardSSD_ZRS\\r\\nâ€¢ StandardSSD_LRS â†’ StandardSSD_ZRS  \\r\\nâ€¢ Premium_LRS â†’ Premium_ZRS\\r\\nâ€¢ Ultra/Premium v2 â†’ Migration required (ZRS not supported)\\r\\n\\r\\n**Price per GB (East US):**\\r\\nâ€¢ Standard_LRS: ${standardHddPricePerGB}/GB/month\\r\\nâ€¢ StandardSSD_LRS: ${standardSsdPricePerGB}/GB/month\\r\\nâ€¢ Premium_LRS: ${premiumSsdPricePerGB}/GB/month\\r\\nâ€¢ StandardSSD_ZRS: ${standardSsdZrsPricePerGB}/GB/month\\r\\nâ€¢ Premium_ZRS: ${premiumZrsPricePerGB}/GB/month\\r\\n\\r\\n**Calculation Example:**\\r\\nâ€¢ 127GB Standard_LRS disk: 127 Ã— ${standardHddPricePerGB} = ${currentCost}/month\\r\\nâ€¢ Upgrade to StandardSSD_ZRS: 127 Ã— ${standardSsdZrsPricePerGB} = ${targetCost}/month\\r\\nâ€¢ Additional cost: ${additionalCost}/month\\r\\n\\r\\n**Default Assumptions:**\\r\\nâ€¢ Disk size from resource properties\\r\\nâ€¢ East US pricing (September 2025)\",\"style\":\"info\"},\"conditionalVisibility\":{\"parameterName\":\"understandCostCalculations\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"textDiskCostCalculation\"}]},\"conditionalVisibility\":{\"parameterName\":\"CheckforDisk\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"groupDisk\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Azure Virtual MachinesðŸŸ¡ [Cost Impact]\",\"items\":[{\"type\":1,\"content\":{\"json\":\"Note: Cost based on East US rates (Sep 2025). VM compute cost multipliers only â€” excludes storage, networking, and licensing costs. For detailed pricing, see [Azure Pricing Calculator](https://azure.microsoft.com/en-us/pricing/calculator/).\",\"style\":\"upsell\"},\"name\":\"text - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"// Virtual Machines Zone Redundancy Analysis\\r\\nresources\\r\\n| where type =~ 'microsoft.compute/virtualmachines'\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/', subscriptionId, '/resourceGroups/', resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/', subscriptionId)\\r\\n| extend vmSize = tostring(properties.hardwareProfile.vmSize)\\r\\n| extend pinnedZone = case(\\r\\n    isnull(zones) or array_length(zones) == 0, false, \\r\\n    true \\r\\n)\\r\\n| where pinnedZone == false  // Only VMs not pinned to zones\\r\\n| extend \\r\\n    Recommendation = \\\"Deploy additional VM instances across multiple availability zones\\\",\\r\\n    CostImpactGuidance = \\\"100-200% increase: Deploy 2-3 instances across zones instead of single instance\\\",\\r\\n    ImplementationImpact = \\\"High\\\",     // Significant cost increase\\r\\n    ImplementationComplexity = \\\"Medium\\\"  // Requires architecture changes\\r\\n| join kind = innerunique (\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n)\\r\\n    on id\\r\\n| project \\r\\n    name,\\r\\n    vmSize,\\r\\n    pinnedZone,\\r\\n    zones = tostring(zones),\\r\\n    CostImpactGuidance,\\r\\n    resourceGroup,\\r\\n    Recommendation,\\r\\n    ImplementationImpact,\\r\\n    ImplementationComplexity,\\r\\n    location,\\r\\n    subscriptionId\\r\\n| sort by name asc\",\"size\":0,\"noDataMessage\":\"All Virtual Machines have availability zones configured\",\"noDataMessageStyle\":3,\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"pinnedZone\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"4\",\"text\":\"\"}]}},{\"columnMatch\":\"zoneRedundant\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"4\",\"text\":\"\"}]}}],\"rowLimit\":1000},\"sortBy\":[]},\"name\":\"query-vms-zones-details\"}]},\"conditionalVisibility\":{\"parameterName\":\"CheckforVMs\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"groupVM\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Azure Virtual Machines Scale SetsðŸŸ¢ [No additional cost.]\",\"items\":[{\"type\":1,\"content\":{\"json\":\"Note: Cost estimates based on instance scaling requirements for zone redundancy. Single instance VMSS require additional VM for minimum zone coverage. Multi-instance VMSS can rebalance existing VMs across zones at no additional compute cost. For detailed pricing, see [Azure Pricing Calculator](https://azure.microsoft.com/en-us/pricing/calculator/).\",\"style\":\"upsell\"},\"name\":\"textVMSS note\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"// Standalone VM Scale Sets - Corrected Cost Impact Logic\\r\\nresources\\r\\n| where type =~ 'microsoft.compute/virtualmachinescalesets'\\r\\n//| where resourceGroup in ({ResourceGroup})\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/', subscriptionId, '/resourceGroups/', resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/', subscriptionId)\\r\\n| extend isAKSManaged = case(\\r\\n    tags has \\\"aks-managed-orchestrator\\\" or name startswith \\\"aks-\\\", true,\\r\\n    false\\r\\n)\\r\\n| where isAKSManaged == false\\r\\n| extend currentZoneRedundant = case(\\r\\n    isnull(zones) or array_length(zones) <= 1, false,\\r\\n    true\\r\\n)\\r\\n| where currentZoneRedundant == false\\r\\n| extend skuName = tostring(sku.name)\\r\\n| extend currentCapacity = toint(sku.capacity)\\r\\n| extend orchestrationMode = tostring(properties.orchestrationMode)\\r\\n| extend \\r\\n    targetCapacity = case(\\r\\n        currentCapacity <= 1, 2,  // Need minimum 2 for zone redundancy\\r\\n        currentCapacity  // Keep existing capacity, just rebalance\\r\\n    ),\\r\\n    hasCapacityIncrease = case(\\r\\n        currentCapacity <= 1, true,\\r\\n        false\\r\\n    )\\r\\n| extend \\r\\n    Recommendation = case(\\r\\n        hasCapacityIncrease, strcat(\\\"Deploy \\\", name, \\\" across multiple availability zones with \\\", tostring(targetCapacity), \\\" instances\\\"),\\r\\n        strcat(\\\"Rebalance \\\", name, \\\" existing \\\", tostring(currentCapacity), \\\" instances across multiple availability zones\\\")\\r\\n    ),\\r\\n    CostImpact = case(\\r\\n        hasCapacityIncrease, \\\"ðŸŸ¡ 100% compute cost increase - minimum 2 instances required for zone redundancy\\\",\\r\\n        \\\"ðŸŸ¢ No cost impact - rebalance existing VMs across availability zones\\\"\\r\\n    ),\\r\\n    ImplementationImpact = case(\\r\\n        hasCapacityIncrease, \\\"High\\\",  // Additional instances\\r\\n        \\\"Low\\\"  // Just rebalancing\\r\\n    ),\\r\\n    ImplementationComplexity = \\\"Medium\\\"  // Requires VMSS reconfiguration\\r\\n| join kind = innerunique (\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}'])\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n    | distinct id\\r\\n) on id\\r\\n| project \\r\\n    VMSSName = name,\\r\\n    Location = location,\\r\\n    SKU = skuName,\\r\\n    CurrentCapacity = currentCapacity,\\r\\n    TargetCapacity = targetCapacity,\\r\\n    OrchestrationMode = orchestrationMode,\\r\\n    CurrentZones = zones,\\r\\n    Recommendation,\\r\\n    CostImpact,\\r\\n    ImplementationImpact,\\r\\n    ImplementationComplexity,\\r\\n    ResourceGroup = split(resourceGroup, '/')[4],\\r\\n    SubscriptionId = split(subscriptionId, '/')[2]\\r\\n| sort by VMSSName asc\",\"size\":0,\"noDataMessage\":\"All Virtual Machines Scale Sets have availability zones configured\",\"noDataMessageStyle\":3,\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"pinnedZone\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"4\",\"text\":\"\"}]}},{\"columnMatch\":\"zoneRedundant\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"4\",\"text\":\"\"}]}}],\"rowLimit\":1000},\"sortBy\":[]},\"name\":\"query-vmss-zones-details\"}]},\"conditionalVisibility\":{\"parameterName\":\"CheckforVMSS\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"groupVMSS\"}]},\"conditionalVisibility\":{\"parameterName\":\"selectedDetailsTab\",\"comparison\":\"isEqualTo\",\"value\":\"compute\"},\"name\":\"group - Details-Compute\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Integration Services Availability Zone Coverage\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"{Subscription}\"],\"parameters\":[{\"id\":\"14bb128f-5b3f-421a-9cf7-b9ad71ece3f6\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"CheckforEventHub\",\"type\":1,\"isRequired\":true,\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'microsoft.eventhub/namespaces'\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend skuTier = tostring(sku.tier)\\r\\n| extend \\r\\n    currentZoneRedundant = case(\\r\\n        skuTier in ('Standard', 'Premium', 'Dedicated'), true,  // Zone redundancy automatic for these tiers\\r\\n        false  // Basic tier doesn't support zone redundancy\\r\\n    )\\r\\n//| where currentZoneRedundant == false  // Only non-zone-redundant instances\\r\\n| join kind = innerunique (\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n)\\r\\n    on id\\r\\n| summarize EventHubCount = count()\\r\\n| extend HasNonZonalEventHub = iff(EventHubCount > 0, \\\"Yes\\\", \\\"No\\\")\\r\\n| project HasNonZonalEventHub\",\"crossComponentResources\":[\"{Subscription}\"],\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"version\":\"KqlParameterItem/1.0\",\"name\":\"CheckforServicesHub\",\"type\":1,\"isRequired\":true,\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'microsoft.servicebus/namespaces'\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend \\r\\n    currentZoneRedundant = true  // Always true in zonal regions per Microsoft's behavior\\r\\n//| where currentZoneRedundant == false  // This will return no results since all are zone redundant\\r\\n| join kind = innerunique (\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n)\\r\\n    on id\\r\\n| summarize ServiceBusCount = count()\\r\\n| extend HasNonZonalServiceBus = iff(ServiceBusCount > 0, \\\"Yes\\\", \\\"No\\\")\\r\\n| project HasNonZonalServiceBus\",\"crossComponentResources\":[\"{Subscription}\"],\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"id\":\"73706ec8-5601-4f6a-af08-fb632ffb1270\"},{\"version\":\"KqlParameterItem/1.0\",\"name\":\"CheckforAPIM\",\"type\":1,\"isRequired\":true,\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'microsoft.apimanagement/service'\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend zoneRedundant = case(\\r\\n    isnull(zones) or array_length(zones) <= 1, false, \\r\\n    true \\r\\n)\\r\\n| where zoneRedundant == false\\r\\n| join kind = innerunique (\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n)\\r\\n    on id\\r\\n| summarize ApimCount = count()\\r\\n| extend HasNonZonalApim = iff(ApimCount > 0, \\\"Yes\\\", \\\"No\\\")\\r\\n| project HasNonZonalApim\",\"crossComponentResources\":[\"{Subscription}\"],\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"id\":\"79132112-c465-4831-ab10-90b33b47f8b5\"}],\"style\":\"pills\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},\"conditionalVisibility\":{\"parameterName\":\"AlwaysHidden\",\"comparison\":\"isEqualTo\",\"value\":\"yes\"},\"name\":\"paramCheckAPIMAzResources\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Azure API Management ðŸŸ¢ [Cost Est.]\",\"items\":[{\"type\":1,\"content\":{\"json\":\"**Note:** Cost based on East US rates (Sep 2025). Includes tier upgrade costs for zone redundancy support. For detailed pricing, see [Azure Pricing Calculator](https://azure.microsoft.com/pricing/calculator/).\",\"style\":\"upsell\"},\"name\":\"APIM Footer\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"understand-cost-calc-yesno\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"understandCostCalculations\",\"label\":\"Show APIM cost calculation details?\",\"type\":2,\"isRequired\":true,\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"jsonData\":\"[\\r\\n    {\\r\\n    \\\"value\\\" : \\\"Yes\\\",\\r\\n    \\\"label\\\" : \\\"Yes\\\"\\r\\n    },\\r\\n    {\\r\\n    \\\"value\\\" : \\\"No\\\",\\r\\n    \\\"label\\\" : \\\"No\\\",\\r\\n    \\\"selected\\\" : true\\r\\n    }\\r\\n]\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"Show Cost Calculation Details\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"apim-developer-price\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"apimDeveloperPrice\",\"label\":\"APIM Developer Tier Price ($/hour)\",\"type\":1,\"description\":\"Hourly rate for APIM Developer tier\",\"value\":\"0.065\",\"typeSettings\":{\"isRequired\":true,\"resourceTypeFilter\":[]},\"timeContext\":{\"durationMs\":86400000}},{\"id\":\"apim-basic-unit-price\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"apimBasicUnitPrice\",\"label\":\"APIM Basic Unit Price ($/hour)\",\"type\":1,\"description\":\"Hourly rate per unit for APIM Basic tier\",\"value\":\"0.275\",\"typeSettings\":{\"isRequired\":true,\"resourceTypeFilter\":[]},\"timeContext\":{\"durationMs\":86400000}},{\"id\":\"apim-standard-unit-price\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"apimStandardUnitPrice\",\"label\":\"APIM Standard Unit Price ($/hour)\",\"type\":1,\"description\":\"Hourly rate per unit for APIM Standard tier\",\"value\":\"1.10\",\"typeSettings\":{\"isRequired\":true,\"resourceTypeFilter\":[]},\"timeContext\":{\"durationMs\":86400000}},{\"id\":\"apim-premium-unit-price\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"apimPremiumUnitPrice\",\"label\":\"APIM Premium Unit Price ($/hour)\",\"type\":1,\"description\":\"Hourly rate per unit for APIM Premium tier\",\"value\":\"4.40\",\"typeSettings\":{\"isRequired\":true,\"resourceTypeFilter\":[]},\"timeContext\":{\"durationMs\":86400000}}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"understandCostCalculations\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"parameters-apim-pricing\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'microsoft.apimanagement/service'\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend zoneRedundant = case(\\r\\n    isnull(zones) or array_length(zones) <= 1, false, \\r\\n    true \\r\\n)\\r\\n| extend skuName = tostring(sku.name)\\r\\n| extend skuCapacity = toint(sku.capacity)\\r\\n| where zoneRedundant == false  // Only non-zone-redundant instances\\r\\n| join kind = innerunique (\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n)\\r\\n    on id\\r\\n| extend \\r\\n    canEnableZoneRedundancy = case(\\r\\n        skuName == 'Premium', true,\\r\\n        false\\r\\n    ),\\r\\n    upgradeRequired = case(\\r\\n        skuName == 'Developer' or skuName == 'Basic' or skuName == 'Standard', true,\\r\\n        false\\r\\n    ),\\r\\n    premiumUnits = case(\\r\\n        skuName == 'Developer' or skuName == 'Basic' or skuName == 'Standard', max_of(1, skuCapacity),\\r\\n        skuCapacity\\r\\n    )\\r\\n| extend \\r\\n    monthlyPremiumCost = todouble(premiumUnits) * todouble({apimPremiumUnitPrice}) * 730.0,\\r\\n    currentMonthlyCost = case(\\r\\n        skuName == 'Developer', todouble({apimDeveloperPrice}) * 730.0,\\r\\n        skuName == 'Basic', todouble(skuCapacity) * todouble({apimBasicUnitPrice}) * 730.0,\\r\\n        skuName == 'Standard', todouble(skuCapacity) * todouble({apimStandardUnitPrice}) * 730.0,\\r\\n        skuName == 'Premium', todouble(skuCapacity) * todouble({apimPremiumUnitPrice}) * 730.0,\\r\\n        0.0\\r\\n    )\\r\\n| extend \\r\\n    estimatedAdditionalMonthlyCost = case(\\r\\n        upgradeRequired, monthlyPremiumCost - currentMonthlyCost,\\r\\n        0.0\\r\\n    )\\r\\n| extend \\r\\n    Recommendation = case(\\r\\n        not(canEnableZoneRedundancy) and upgradeRequired, \\\"Upgrade to Premium tier and enable zone redundancy\\\",\\r\\n        canEnableZoneRedundancy, \\\"Enable zone redundancy (requires redeployment)\\\",\\r\\n        \\\"Zone redundancy not supported for this tier\\\"\\r\\n    ),\\r\\n    ImplementationImpact = case(\\r\\n        upgradeRequired, \\\"High\\\",\\r\\n        \\\"Medium\\\"\\r\\n    ),\\r\\n    ImplementationComplexity = case(\\r\\n        upgradeRequired, \\\"High\\\",\\r\\n        \\\"Medium\\\"\\r\\n    ),\\r\\n    CostImpact = case(\\r\\n        upgradeRequired, \\\"High\\\",\\r\\n        \\\"None\\\"\\r\\n    )\\r\\n| project \\r\\n    name, \\r\\n    skuName, \\r\\n    skuCapacity,\\r\\n    canEnableZoneRedundancy,\\r\\n    upgradeRequired,\\r\\n    resourceGroup, \\r\\n        Recommendation, \\r\\n    ImplementationImpact, \\r\\n    ImplementationComplexity, \\r\\n        estimatedAdditionalMonthlyCost,\\r\\n    location, \\r\\n    subscriptionId\",\"size\":0,\"noDataMessage\":\"All Azure API Management services have availability zones configured\",\"noDataMessageStyle\":3,\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"canEnableZoneRedundancy\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"3\",\"text\":\"No\"}]}},{\"columnMatch\":\"pinnedZone\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"4\",\"text\":\"\"}]}},{\"columnMatch\":\"zoneRedundant\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"4\",\"text\":\"\"}]}}],\"rowLimit\":1000},\"sortBy\":[]},\"name\":\"query-apiManagement-zones-details\"}]},\"conditionalVisibility\":{\"parameterName\":\"CheckforAPIM\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"groupAPIM\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Azure Service BusðŸŸ¢ [Cost Est.] No additional cost\",\"items\":[{\"type\":1,\"content\":{\"json\":\"**Note:** Cost based on East US rates (Sep 2025). No additional infrastructure cost for zone redundancy â€” automatic feature in supported regions. For detailed pricing, see [Azure Pricing Calculator](https://azure.microsoft.com/en-us/pricing/calculator/).\",\"style\":\"upsell\"},\"name\":\"text - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'microsoft.servicebus/namespaces'\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend skuName = tostring(sku.name)\\r\\n| extend skuTier = tostring(sku.tier)\\r\\n| extend zoneRedundantProperty = tobool(properties.zoneRedundant)\\r\\n| extend zoneRedundant = iff(zoneRedundantProperty == true, true, false)\\r\\n| where zoneRedundant == \\\"false\\\"\\r\\n| extend migrationStatus = case(\\r\\n    zoneRedundant == true, 'Zone redundancy enabled',\\r\\n    zoneRedundant == false, 'Zone redundancy not enabled - May be eligible for automatic migration',\\r\\n    'Zone redundancy status unknown'\\r\\n)\\r\\n| join kind = innerunique( //Tag filter\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}'])\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n    | project id\\r\\n    )\\r\\n    on id\\r\\n| extend EstimatedMonthlyCost = 0.0  // No additional cost for zone redundancy\\r\\n| extend \\r\\n    Recommendation = case(\\r\\n        zoneRedundant == true, 'No action needed - Zone redundancy already enabled',\\r\\n        zoneRedundant == false, 'Zone redundancy not enabled - May be automatically migrated by Microsoft',\\r\\n        'Review Service Bus zone redundancy status'\\r\\n    ),\\r\\n    ImplementationImpact = case(\\r\\n        zoneRedundant == true, 'None',\\r\\n        'High'  // Automatic migration by Microsoft\\r\\n    ),\\r\\n    ImplementationComplexity = case(\\r\\n        zoneRedundant == true, 'None',\\r\\n        'Low'  // Automatic migration by Microsoft\\r\\n    ),\\r\\n    CostEstimation = 'ðŸŸ¢ [Cost Est.] No additional cost - Automatic feature'\\r\\n| project \\r\\n    Resource=name,\\r\\n    SKU=skuName,\\r\\n    Tier=skuTier,\\r\\n    ZoneConfigured=zoneRedundant,\\r\\n        ResourceGroup=resourceGroup,\\r\\n    ZoneRedundantProperty=zoneRedundantProperty,\\r\\n        Recommendation,\\r\\n            ImplementationImpact,\\r\\n    ImplementationComplexity,\\r\\n    CostEstimation,\\r\\n    SubscriptionId=subscriptionId,\\r\\n    Location=location\\r\\n| order by Resource asc\",\"size\":0,\"noDataMessage\":\"All Azure Service Bus namespaces have availability zones configured\",\"noDataMessageStyle\":3,\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"pinnedZone\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"4\",\"text\":\"\"}]}},{\"columnMatch\":\"zoneRedundant\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"4\",\"text\":\"\"}]}}],\"rowLimit\":1000},\"sortBy\":[]},\"name\":\"query-servicebus-zones-details\"}]},\"name\":\"groupServicesHub\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Azure Event Hubs [ðŸŸ¢ No cost change]\",\"items\":[{\"type\":1,\"content\":{\"json\":\"**ðŸ’¡ Event Hub Zone Redundancy Cost Information:**\\r\\nEvent Hub zone redundancy is automatically enabled for Standard, Premium, and Dedicated tiers at no additional cost. Basic tier does not support zone redundancy and would require an upgrade to a higher tier.\",\"style\":\"upsell\"},\"name\":\"text - 3\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type == \\\"microsoft.eventhub/namespaces\\\"\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend locations=properties.locations\\r\\n| extend skuTier = tostring(sku.tier)\\r\\n| extend zoneRedundant = tostring(properties.zoneRedundant)\\r\\n| extend autoZoneRedundancy = iff(skuTier in ('Standard', 'Premium', 'Dedicated'), 'Enabled automatically', 'Not supported')\\r\\n| join kind = innerunique( //Tag filter\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}'])\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n    | distinct id  // This ensures we only get unique resource IDs\\r\\n    )\\r\\n    on id\\r\\n| extend \\r\\n    Recommendation = iff(\\r\\n        skuTier in ('Standard', 'Premium', 'Dedicated'),\\r\\n        'No action needed - Zone redundancy enabled automatically',\\r\\n        'Upgrade to Standard, Premium, or Dedicated tier for zone redundancy'\\r\\n    ),\\r\\n    ImplementationImpact = iff(\\r\\n        skuTier in ('Standard', 'Premium', 'Dedicated'),\\r\\n        'None',\\r\\n        'Medium'\\r\\n    ),\\r\\n    ImplementationComplexity = iff(\\r\\n        skuTier in ('Standard', 'Premium', 'Dedicated'),\\r\\n        'None',\\r\\n        'Medium'\\r\\n    ),\\r\\n    CostEstimation = 'ðŸ” [No Cost Est.] No cost change'\\r\\n| where zoneRedundant == \\\"false\\\"\\r\\n| distinct id, Recommendation, name, skuTier, autoZoneRedundancy, zoneRedundant, CostEstimation, ImplementationImpact, ImplementationComplexity, resourceGroup, subscriptionId, location, tostring(tags)  // Ensure final uniqueness\\r\\n| project \\r\\n    Recommendation,\\r\\n    Resource=name,\\r\\n    SKU=skuTier,\\r\\n    ZoneRedundancy=autoZoneRedundancy,\\r\\n    ZoneConfigured=zoneRedundant,\\r\\n    CostEstimation,\\r\\n    ImplementationImpact,\\r\\n    ImplementationComplexity,\\r\\n    ResourceGroup=resourceGroup,\\r\\n    SubscriptionId=subscriptionId,\\r\\n    Location=location,\\r\\n    ResourceId=id,\\r\\n    Tags=tostring(tags)\\r\\n| order by Resource asc\",\"size\":0,\"noDataMessage\":\"All Azure Event Hub have availability zones configured\",\"noDataMessageStyle\":3,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"]},\"conditionalVisibility\":{\"parameterName\":\"CheckforEventHub\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"query-eventHub-zones-details\"}]},\"name\":\"groupEventHub\"}]},\"conditionalVisibility\":{\"parameterName\":\"selectedDetailsTab\",\"comparison\":\"isEqualTo\",\"value\":\"integrationServices\"},\"name\":\"group - Details-APIManagement\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"App Services Availability Zone Coverage ðŸŸ¢ [Cost Est.]\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"{Subscription}\"],\"parameters\":[{\"id\":\"a46fa23b-8d13-496d-be3d-6c0228e4c5d7\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"CheckforAppService\",\"type\":1,\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'microsoft.web/serverfarms'  \\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend zoneRedundant = tobool(properties.zoneRedundant)\\r\\n//| where zoneRedundant == false\\r\\n| join kind = innerunique (\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n)\\r\\n    on id\\r\\n| summarize AppServiceCount = count()\\r\\n| extend HasNonZonalAppService = iff(AppServiceCount > 0, \\\"Yes\\\", \\\"No\\\")\\r\\n| project HasNonZonalAppService\",\"crossComponentResources\":[\"{Subscription}\"],\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"}],\"style\":\"pills\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},\"conditionalVisibility\":{\"parameterName\":\"AlwaysHidden\",\"comparison\":\"isEqualTo\",\"value\":\"true\"},\"name\":\"paramCheckResourceIntegrationService\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"App Service Zone Redundancy ðŸŸ¢ [Cost Est.]\",\"items\":[{\"type\":1,\"content\":{\"json\":\"**Note:** Cost based on East US rates (Sep 2025). Includes tier upgrades and minimum instance requirements. For detailed pricing, see [Azure Pricing Calculator](https://azure.microsoft.com/pricing/calculator/).\",\"style\":\"upsell\"},\"name\":\"text - 3\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"understand-cost-calc-yesno\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"understandCostCalculations\",\"label\":\"Show App Service cost calculation details?\",\"type\":2,\"isRequired\":true,\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"jsonData\":\"[\\r\\n    {\\r\\n    \\\"value\\\" : \\\"Yes\\\",\\r\\n    \\\"label\\\" : \\\"Yes\\\"\\r\\n    },\\r\\n    {\\r\\n    \\\"value\\\" : \\\"No\\\",\\r\\n    \\\"label\\\" : \\\"No\\\",\\r\\n    \\\"selected\\\" : true\\r\\n    }\\r\\n]\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"Show Cost Calculation Details\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"basic-b1-price\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"basicB1Price\",\"label\":\"Basic B1 Price ($/hour)\",\"type\":1,\"description\":\"Hourly rate for Basic B1 tier\",\"value\":\"0.018\",\"typeSettings\":{\"isRequired\":true,\"resourceTypeFilter\":[]}},{\"id\":\"basic-b2-price\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"basicB2Price\",\"label\":\"Basic B2 Price ($/hour)\",\"type\":1,\"description\":\"Hourly rate for Basic B2 tier\",\"value\":\"0.035\",\"typeSettings\":{\"isRequired\":true,\"resourceTypeFilter\":[]}},{\"id\":\"basic-b3-price\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"basicB3Price\",\"label\":\"Basic B3 Price ($/hour)\",\"type\":1,\"description\":\"Hourly rate for Basic B3 tier\",\"value\":\"0.07\",\"typeSettings\":{\"isRequired\":true,\"resourceTypeFilter\":[]}},{\"id\":\"standard-s1-price\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"standardS1Price\",\"label\":\"Standard S1 Price ($/hour)\",\"type\":1,\"description\":\"Hourly rate for Standard S1 tier\",\"value\":\"0.10\",\"typeSettings\":{\"isRequired\":true,\"resourceTypeFilter\":[]}},{\"id\":\"standard-s2-price\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"standardS2Price\",\"label\":\"Standard S2 Price ($/hour)\",\"type\":1,\"description\":\"Hourly rate for Standard S2 tier\",\"value\":\"0.20\",\"typeSettings\":{\"isRequired\":true,\"resourceTypeFilter\":[]}},{\"id\":\"standard-s3-price\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"standardS3Price\",\"label\":\"Standard S3 Price ($/hour)\",\"type\":1,\"description\":\"Hourly rate for Standard S3 tier\",\"value\":\"0.40\",\"typeSettings\":{\"isRequired\":true,\"resourceTypeFilter\":[]}},{\"id\":\"premium-p1-price\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"premiumP1Price\",\"label\":\"Premium P1 Price ($/hour)\",\"type\":1,\"description\":\"Hourly rate for Premium P1 tier\",\"value\":\"0.214\",\"typeSettings\":{\"isRequired\":true,\"resourceTypeFilter\":[]}},{\"id\":\"premium-p2-price\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"premiumP2Price\",\"label\":\"Premium P2 Price ($/hour)\",\"type\":1,\"description\":\"Hourly rate for Premium P2 tier\",\"value\":\"0.428\",\"typeSettings\":{\"isRequired\":true,\"resourceTypeFilter\":[]}},{\"id\":\"premium-p3-price\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"premiumP3Price\",\"label\":\"Premium P3 Price ($/hour)\",\"type\":1,\"description\":\"Hourly rate for Premium P3 tier\",\"value\":\"0.856\",\"typeSettings\":{\"isRequired\":true,\"resourceTypeFilter\":[]}},{\"id\":\"p0v4-price\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"p0v4Price\",\"label\":\"Premium P0v4 Price ($/month)\",\"type\":1,\"description\":\"Monthly rate for Premium P0v4 tier\",\"value\":\"53.29\",\"typeSettings\":{\"isRequired\":true,\"resourceTypeFilter\":[]}},{\"id\":\"p1v4-price\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"p1v4Price\",\"label\":\"Premium P1v4 Price ($/month)\",\"type\":1,\"description\":\"Monthly rate for Premium P1v4 tier\",\"value\":\"106.58\",\"typeSettings\":{\"isRequired\":true,\"resourceTypeFilter\":[]}},{\"id\":\"p1mv4-price\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"p1mv4Price\",\"label\":\"Premium P1mv4 Price ($/month)\",\"type\":1,\"description\":\"Monthly rate for Premium P1mv4 tier\",\"value\":\"135.78\",\"typeSettings\":{\"isRequired\":true,\"resourceTypeFilter\":[]}},{\"id\":\"p2v4-price\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"p2v4Price\",\"label\":\"Premium P2v4 Price ($/month)\",\"type\":1,\"description\":\"Monthly rate for Premium P2v4 tier\",\"value\":\"213.16\",\"typeSettings\":{\"isRequired\":true,\"resourceTypeFilter\":[]}},{\"id\":\"p2mv4-price\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"p2mv4Price\",\"label\":\"Premium P2mv4 Price ($/month)\",\"type\":1,\"description\":\"Monthly rate for Premium P2mv4 tier\",\"value\":\"270.83\",\"typeSettings\":{\"isRequired\":true,\"resourceTypeFilter\":[]}},{\"id\":\"p3v4-price\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"p3v4Price\",\"label\":\"Premium P3v4 Price ($/month)\",\"type\":1,\"description\":\"Monthly rate for Premium P3v4 tier\",\"value\":\"426.32\",\"typeSettings\":{\"isRequired\":true,\"resourceTypeFilter\":[]}},{\"id\":\"p3mv4-price\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"p3mv4Price\",\"label\":\"Premium P3mv4 Price ($/month)\",\"type\":1,\"description\":\"Monthly rate for Premium P3mv4 tier\",\"value\":\"542.39\",\"typeSettings\":{\"isRequired\":true,\"resourceTypeFilter\":[]}},{\"id\":\"p4mv4-price\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"p4mv4Price\",\"label\":\"Premium P4mv4 Price ($/month)\",\"type\":1,\"description\":\"Monthly rate for Premium P4mv4 tier\",\"value\":\"1084.78\",\"typeSettings\":{\"isRequired\":true,\"resourceTypeFilter\":[]}},{\"id\":\"p5mv4-price\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"p5mv4Price\",\"label\":\"Premium P5mv4 Price ($/month)\",\"type\":1,\"description\":\"Monthly rate for Premium P5mv4 tier\",\"value\":\"2168.83\",\"typeSettings\":{\"isRequired\":true,\"resourceTypeFilter\":[]}}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"understandCostCalculations\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"parameters-appservice-pricing\"},{\"type\":1,\"content\":{\"json\":\"**How App Service Zone Redundancy Cost is Calculated** ðŸŸ¢ [Cost Est.]\\r\\n\\r\\n**Monthly Cost Formula:**\\r\\n- **Tier Upgrade Cost**: Upgrade to Premium v4 (cheapest zone-redundant option)\\r\\n- **Instance Minimum**: Minimum 2 instances required for zone redundancy\\r\\n- **No Additional AZ Cost**: Zone redundancy included in Premium v4 pricing\\r\\n\\r\\n**Upgrade Path (to Premium v4):**\\r\\n- Basic/Standard â†’ P0v4: $53.29/month per instance\\r\\n- Premium v1 â†’ Equivalent v4: Cost varies by tier\\r\\n- Premium v2/v3 â†’ Equivalent v4: Usually cost reduction\\r\\n- Existing v4: No upgrade needed, just enable AZ\\r\\n\\r\\n**Instance Requirements:**\\r\\n- **Minimum 2 instances** enforced for zone redundancy\\r\\n- If current plan has 1 instance â†’ 2x cost impact\\r\\n- Zone balancing across 3 availability zones\\r\\n- Auto-scaling maintains zone distribution\\r\\n\\r\\n**Cost Impact Examples:**\\r\\n- Basic B1 (1 instance) â†’ P0v4 (2 instances): ~$106.58/month\\r\\n- Standard S1 (1 instance) â†’ P0v4 (2 instances): ~$106.58/month  \\r\\n- Premium P1 (1 instance) â†’ P1v4 (2 instances): ~$213.16/month\\r\\n- Premium P1v4 (1 instance) â†’ P1v4 (2 instances): +$106.58/month\\r\\n\\r\\n**Implementation Notes:**\\r\\n- Requires App Service plan recreation or migration\\r\\n- Brief downtime during plan migration\\r\\n- All apps automatically inherit zone redundancy\\r\\n- Performance improvements with v4 generation\\r\\n\\r\\n**Default Assumptions:**\\r\\n- East US pricing (September 2025)\\r\\n- Pay-as-you-go pricing (no reservations)\\r\\n- Minimum 2-instance configuration\\r\\n- Linux pricing model\"},\"conditionalVisibility\":{\"parameterName\":\"understandCostCalculations\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"textCostAppService\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'microsoft.web/serverfarms'\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend zoneRedundant = tobool(properties.zoneRedundant)\\r\\n| extend skuName = tostring(sku.name)\\r\\n| extend skuTier = tostring(sku.tier)\\r\\n| extend skuSize = tostring(sku.size)\\r\\n| extend currentCapacity = toint(sku.capacity)\\r\\n| extend numberOfWorkers = toint(properties.numberOfWorkers)\\r\\n| extend maximumNumberOfZones = toint(properties.maximumNumberOfZones)\\r\\n| where skuName != \\\"Y1\\\"\\r\\n| where zoneRedundant == false  // Only non-zone-redundant instances\\r\\n| join kind = innerunique (\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n)\\r\\n    on id\\r\\n| extend \\r\\n    supportsZoneRedundancy = case(\\r\\n        skuTier == \\\"Premium\\\" and (skuName startswith \\\"P\\\" and (skuName contains \\\"v2\\\" or skuName contains \\\"v3\\\" or skuName contains \\\"v4\\\")), true,\\r\\n        skuTier == \\\"PremiumV2\\\", true,\\r\\n        skuTier == \\\"PremiumV3\\\", true, \\r\\n        skuTier == \\\"PremiumV4\\\", true,\\r\\n        skuTier == \\\"Isolated\\\", true,\\r\\n        skuTier == \\\"IsolatedV2\\\", true,\\r\\n        false\\r\\n    ),\\r\\n    requiresUpgrade = case(\\r\\n        skuTier in (\\\"Free\\\", \\\"Shared\\\", \\\"Basic\\\", \\\"Standard\\\") or (skuTier == \\\"Premium\\\" and not(skuName contains \\\"v\\\")), true,\\r\\n        false\\r\\n    )\\r\\n| extend\\r\\n    recommendedSku = case(\\r\\n        // If already supports zone redundancy, keep same SKU\\r\\n        supportsZoneRedundancy, skuName,\\r\\n        // Otherwise map to v4 equivalent\\r\\n        skuTier in (\\\"Free\\\", \\\"Shared\\\") or skuName in (\\\"F1\\\", \\\"D1\\\"), \\\"P0v4\\\",\\r\\n        skuTier == \\\"Basic\\\" or skuName startswith \\\"B\\\", \\\"P0v4\\\", \\r\\n        skuTier == \\\"Standard\\\" or skuName startswith \\\"S\\\", \\\"P0v4\\\",\\r\\n        skuName == \\\"P1\\\" or skuName == \\\"P1v2\\\", \\\"P1v4\\\",\\r\\n        skuName == \\\"P2\\\" or skuName == \\\"P2v2\\\", \\\"P2v4\\\", \\r\\n        skuName == \\\"P3\\\" or skuName == \\\"P3v2\\\", \\\"P3v4\\\",\\r\\n        skuName == \\\"P1v3\\\", \\\"P1v4\\\",\\r\\n        skuName == \\\"P1mv3\\\", \\\"P1mv4\\\", \\r\\n        skuName == \\\"P2v3\\\", \\\"P2v4\\\",\\r\\n        skuName == \\\"P2mv3\\\", \\\"P2mv4\\\",\\r\\n        skuName == \\\"P3v3\\\", \\\"P3v4\\\",\\r\\n        skuName == \\\"P3mv3\\\", \\\"P3mv4\\\",\\r\\n        skuName == \\\"P4mv3\\\", \\\"P4mv4\\\", \\r\\n        skuName == \\\"P5mv3\\\", \\\"P5mv4\\\",\\r\\n        skuName\\r\\n    ),\\r\\n    recommendedCapacity = case(\\r\\n        currentCapacity < 2, 2,\\r\\n        currentCapacity\\r\\n    ),\\r\\n    requiresInstanceIncrease = case(\\r\\n        currentCapacity < 2, true,\\r\\n        false\\r\\n    )\\r\\n| extend\\r\\n    // Current monthly cost calculation\\r\\n    currentMonthlyCost = case(\\r\\n        skuTier == \\\"Free\\\" or skuName == \\\"F1\\\", 0.0,\\r\\n        skuTier == \\\"Shared\\\" or skuName == \\\"D1\\\", 0.0,\\r\\n        skuName == \\\"B1\\\", todouble({basicB1Price}) * 730.0 * todouble(currentCapacity),\\r\\n        skuName == \\\"B2\\\", todouble({basicB2Price}) * 730.0 * todouble(currentCapacity),\\r\\n        skuName == \\\"B3\\\", todouble({basicB3Price}) * 730.0 * todouble(currentCapacity),\\r\\n        skuName == \\\"S1\\\", todouble({standardS1Price}) * 730.0 * todouble(currentCapacity),\\r\\n        skuName == \\\"S2\\\", todouble({standardS2Price}) * 730.0 * todouble(currentCapacity), \\r\\n        skuName == \\\"S3\\\", todouble({standardS3Price}) * 730.0 * todouble(currentCapacity),\\r\\n        skuName == \\\"P1\\\", todouble({premiumP1Price}) * 730.0 * todouble(currentCapacity),\\r\\n        skuName == \\\"P2\\\", todouble({premiumP2Price}) * 730.0 * todouble(currentCapacity),\\r\\n        skuName == \\\"P3\\\", todouble({premiumP3Price}) * 730.0 * todouble(currentCapacity),\\r\\n        skuName == \\\"P0v4\\\", todouble({p0v4Price}) * todouble(currentCapacity),\\r\\n        skuName == \\\"P1v4\\\", todouble({p1v4Price}) * todouble(currentCapacity),\\r\\n        skuName == \\\"P1mv4\\\", todouble({p1mv4Price}) * todouble(currentCapacity),\\r\\n        skuName == \\\"P2v4\\\", todouble({p2v4Price}) * todouble(currentCapacity),\\r\\n        skuName == \\\"P2mv4\\\", todouble({p2mv4Price}) * todouble(currentCapacity),\\r\\n        skuName == \\\"P3v4\\\", todouble({p3v4Price}) * todouble(currentCapacity),\\r\\n        skuName == \\\"P3mv4\\\", todouble({p3mv4Price}) * todouble(currentCapacity),\\r\\n        skuName == \\\"P4mv4\\\", todouble({p4mv4Price}) * todouble(currentCapacity),\\r\\n        skuName == \\\"P5mv4\\\", todouble({p5mv4Price}) * todouble(currentCapacity),\\r\\n        0.0\\r\\n    )\\r\\n| extend\\r\\n    // Target monthly cost calculation\\r\\n    targetMonthlyCost = case(\\r\\n        recommendedSku == \\\"P0v4\\\", todouble({p0v4Price}) * todouble(recommendedCapacity),\\r\\n        recommendedSku == \\\"P1v4\\\", todouble({p1v4Price}) * todouble(recommendedCapacity),\\r\\n        recommendedSku == \\\"P1mv4\\\", todouble({p1mv4Price}) * todouble(recommendedCapacity),\\r\\n        recommendedSku == \\\"P2v4\\\", todouble({p2v4Price}) * todouble(recommendedCapacity),\\r\\n        recommendedSku == \\\"P2mv4\\\", todouble({p2mv4Price}) * todouble(recommendedCapacity),\\r\\n        recommendedSku == \\\"P3v4\\\", todouble({p3v4Price}) * todouble(recommendedCapacity),\\r\\n        recommendedSku == \\\"P3mv4\\\", todouble({p3mv4Price}) * todouble(recommendedCapacity),\\r\\n        recommendedSku == \\\"P4mv4\\\", todouble({p4mv4Price}) * todouble(recommendedCapacity),\\r\\n        recommendedSku == \\\"P5mv4\\\", todouble({p5mv4Price}) * todouble(recommendedCapacity),\\r\\n        currentMonthlyCost\\r\\n    )\\r\\n| extend \\r\\n    additionalMonthlyCost = targetMonthlyCost - currentMonthlyCost\\r\\n| extend\\r\\n    Recommendation = case(\\r\\n        requiresUpgrade, strcat(\\\"Upgrade to \\\", recommendedSku, \\\" and enable zone redundancy\\\"),\\r\\n        requiresInstanceIncrease, strcat(\\\"Enable zone redundancy (minimum 2 instances required)\\\"),\\r\\n        \\\"Enable zone redundancy on current plan\\\"\\r\\n    ),\\r\\n    ImplementationImpact = case(\\r\\n        requiresUpgrade, \\\"High\\\",\\r\\n        requiresInstanceIncrease, \\\"Medium\\\", \\r\\n        \\\"Medium\\\"\\r\\n    ),\\r\\n    ImplementationComplexity = case(\\r\\n        requiresUpgrade, \\\"High\\\",\\r\\n        \\\"Medium\\\"\\r\\n    ),\\r\\n    CostImpact = case(\\r\\n        additionalMonthlyCost > 100.0, \\\"High\\\",\\r\\n        additionalMonthlyCost > 0.0, \\\"Medium\\\",\\r\\n        \\\"None\\\"\\r\\n    )\\r\\n| project \\r\\n\\r\\n    name,\\r\\n    skuName,\\r\\n    skuTier,\\r\\n    currentCapacity,\\r\\n    recommendedSku,\\r\\n    recommendedCapacity,\\r\\n    requiresUpgrade,\\r\\n    requiresInstanceIncrease,\\r\\n    targetMonthlyCost,\\r\\n    additionalMonthlyCost,\\r\\n    resourceGroup,\\r\\n    Recommendation,\\r\\n    ImplementationImpact,\\r\\n    ImplementationComplexity, \\r\\n    CostImpact,\\r\\n    location,\\r\\n    subscriptionId\",\"size\":0,\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"zoneRedundant\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"true\",\"representation\":\"success\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"failed\",\"text\":\"{0}{1}\"}]}}]}},\"name\":\"queryAppService\"}]},\"conditionalVisibility\":{\"parameterName\":\"CheckforAppService\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"groupAppService\"}]},\"conditionalVisibility\":{\"parameterName\":\"selectedDetailsTab\",\"comparison\":\"isEqualTo\",\"value\":\"app\"},\"name\":\"group - Details-App\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Azure Container Services Availability Zone Coverage\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"{Subscription}\"],\"parameters\":[{\"id\":\"a46fa23b-8d13-496d-be3d-6c0228e4c5d7\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"CheckforACR\",\"type\":1,\"query\":\"// Count query for Container Registries needing zone redundancy\\r\\nresources\\r\\n| where type =~ 'microsoft.containerregistry/registries'\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| extend isInZonalRegion = location in~ ({ZonalRegions:value})\\r\\n//| where isInZonalRegion == false  // Only registries NOT in zonal regions\\r\\n| join kind = innerunique (\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n)\\r\\n    on id\\r\\n| summarize ContainerRegistryCount = count()\\r\\n| extend HasNonZonalContainerRegistry = iff(ContainerRegistryCount > 0, \\\"Yes\\\", \\\"No\\\")\\r\\n| project HasNonZonalContainerRegistry\",\"crossComponentResources\":[\"{Subscription}\"],\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"version\":\"KqlParameterItem/1.0\",\"name\":\"CheckforACA\",\"type\":1,\"query\":\"// Count query for Container Apps needing zone redundancy\\r\\nresources\\r\\n| where type =~ 'microsoft.app/managedenvironments'\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend zoneRedundant = tobool(properties.zoneRedundant)\\r\\n//| where zoneRedundant == false\\r\\n| join kind = innerunique (\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n)\\r\\n    on id\\r\\n| summarize ContainerAppsCount = count()\\r\\n| extend HasNonZonalContainerApps = iff(ContainerAppsCount > 0, \\\"Yes\\\", \\\"No\\\")\\r\\n| project HasNonZonalContainerApps\",\"crossComponentResources\":[\"{Subscription}\"],\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"id\":\"9861b662-41d8-4a66-a34c-4031c01b917a\"},{\"version\":\"KqlParameterItem/1.0\",\"name\":\"CheckforAKS\",\"type\":1,\"query\":\"// Count query for AKS VMSS needing zone redundancy\\r\\nresources\\r\\n| where type =~ 'microsoft.compute/virtualmachinescalesets'\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend isAKSManaged = case(\\r\\n    tags has \\\"aks-managed-orchestrator\\\" or name startswith \\\"aks-\\\", true,\\r\\n    false\\r\\n)\\r\\n| where isAKSManaged == true  // Only AKS-managed VMSS\\r\\n| extend currentZoneRedundant = case(\\r\\n    isnull(zones) or array_length(zones) <= 1, false,\\r\\n    true\\r\\n)\\r\\n//| where currentZoneRedundant == false  // Only non-zone-redundant VMSS\\r\\n| join kind = innerunique (\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}'])\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n    | distinct id\\r\\n) on id\\r\\n| summarize AKSVMSSCount = count()\\r\\n| extend HasNonZonalAKSVMSS = iff(AKSVMSSCount > 0, \\\"Yes\\\", \\\"No\\\")\\r\\n| project HasNonZonalAKSVMSS\",\"crossComponentResources\":[\"{Subscription}\"],\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"id\":\"d13b21b0-23e8-4e22-8803-fb18118edda3\"}],\"style\":\"pills\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},\"conditionalVisibility\":{\"parameterName\":\"AlwaysHidden\",\"comparison\":\"isEqualTo\",\"value\":\"true\"},\"name\":\"paramCheckResourceIntegrationService\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Azure Container Service (AKS) [ðŸŸ¢No additional cost.]\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where type =~ 'microsoft.compute/virtualmachinescalesets'\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/', subscriptionId, '/resourceGroups/', resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/', subscriptionId)\\r\\n| extend isAKSManaged = case(\\r\\n    tags has \\\"aks-managed-orchestrator\\\" or name startswith \\\"aks-\\\", true,\\r\\n    false\\r\\n)\\r\\n| where isAKSManaged == true  // Only AKS-managed VMSS\\r\\n| extend currentZoneRedundant = case(\\r\\n    isnull(zones) or array_length(zones) <= 1, false,\\r\\n    true\\r\\n)\\r\\n| where currentZoneRedundant == false  // Only non-zone-redundant VMSS\\r\\n| extend skuName = tostring(sku.name)\\r\\n| extend currentCapacity = toint(sku.capacity)\\r\\n| extend vmssResourceGroup = resourceGroup\\r\\n// Join with parent AKS cluster information\\r\\n| join kind=leftouter (\\r\\n    resources\\r\\n    | where type =~ 'microsoft.containerservice/managedclusters'\\r\\n    | extend nodeResourceGroup = strcat('/subscriptions/', subscriptionId, '/resourceGroups/', tostring(properties.nodeResourceGroup))\\r\\n    | extend clusterName = name\\r\\n    | extend clusterLocation = location\\r\\n    | project aksClusterId = id, clusterName, clusterLocation, nodeResourceGroup\\r\\n) on $left.vmssResourceGroup == $right.nodeResourceGroup\\r\\n| extend \\r\\n    Recommendation = strcat(\\\"Configure '\\\", coalesce(clusterName, \\\"Standalone\\\"), \\\"' node pools across multiple availability zones\\\"),\\r\\n    CostImpact = \\\"ðŸŸ¡ Minimal network cost increase only - no compute cost change\\\",\\r\\n    ImplementationImpact = \\\"Low\\\",\\r\\n    ImplementationComplexity = \\\"Medium\\\"  // Requires node pool recreation\\r\\n// Tag filtering\\r\\n| join kind = innerunique (\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}'])\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n    | distinct id\\r\\n) on id\\r\\n// Final deduplication by VMSS ID\\r\\n| summarize \\r\\n    take_any(name, clusterName, location, skuName, currentCapacity, zones, Recommendation, CostImpact, ImplementationImpact, ImplementationComplexity, vmssResourceGroup, subscriptionId) \\r\\n    by id\\r\\n| project \\r\\n    VMSSName = name,\\r\\n    AKSCluster = coalesce(clusterName, \\\"Standalone VMSS\\\"),\\r\\n    Location = location,\\r\\n    SKU = skuName,\\r\\n    CurrentCapacity = currentCapacity,\\r\\n    CurrentZones = zones,\\r\\n    Recommendation,\\r\\n    //CostImpact,\\r\\n    ImplementationImpact,\\r\\n    ImplementationComplexity,\\r\\n    ResourceGroup = split(vmssResourceGroup, '/')[4],\\r\\n    SubscriptionId = split(subscriptionId, '/')[2]\\r\\n| sort by VMSSName asc\",\"size\":0,\"noDataMessage\":\"All Azure Container Services (AKS) have availability zones configured\",\"noDataMessageStyle\":3,\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"zoneRedundant\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"0\",\"representation\":\"4\",\"text\":\"\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"success\",\"text\":\"\"}]}}]}},\"name\":\"query-containerService-zones-details\"}]},\"conditionalVisibility\":{\"parameterName\":\"CheckforAKS\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"groupAKS\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Azure Container Apps environmentsðŸ”´ [No Cost Est.]\",\"items\":[{\"type\":1,\"content\":{\"json\":\"Note: Cost based on East US rates (Sep 2025). Zone redundancy feature is free, but additional replicas for zone benefits will increase compute costs. For detailed pricing, see [Azure Pricing Calculator](https://azure.microsoft.com/en-us/pricing/calculator/).\",\"style\":\"upsell\"},\"name\":\"text - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"// Container Apps Zone Redundancy Analysis\\r\\nresources\\r\\n| where type =~ 'microsoft.app/managedenvironments'\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/', subscriptionId, '/resourceGroups/', resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/', subscriptionId)\\r\\n| extend zoneRedundant = tobool(properties.zoneRedundant)\\r\\n| where zoneRedundant == false  // Only non-zone-redundant environments\\r\\n| extend \\r\\n    Recommendation = \\\"Enable zone redundancy and ensure minimum 3 replicas per app\\\",\\r\\n    currentMonthlyCost = 0.0,  // Environment itself has no direct cost\\r\\n    targetMonthlyCost = 0.0,   // Zone redundancy is free\\r\\n    additionalMonthlyCost = 0.0,  // No additional cost for zone redundancy feature\\r\\n    ImplementationImpact = \\\"High\\\",     // No direct cost impact\\r\\n    ImplementationComplexity = \\\"Low\\\"  // Simple property change\\r\\n| join kind = innerunique (\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n)\\r\\n    on id\\r\\n| project \\r\\n    name,\\r\\n    zoneRedundant,\\r\\n    resourceGroup,\\r\\n    Recommendation,\\r\\n    ImplementationImpact,\\r\\n    ImplementationComplexity,\\r\\n    location,\\r\\n    subscriptionId\\r\\n| sort by name asc\",\"size\":0,\"noDataMessage\":\"All Azure Container Apps environments have availability zones configured\",\"noDataMessageStyle\":3,\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"pinnedZone\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"4\",\"text\":\"\"}]}},{\"columnMatch\":\"zoneRedundant\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"4\",\"text\":\"\"}]}}],\"rowLimit\":1000},\"sortBy\":[]},\"name\":\"query-app-zones-details\"}]},\"name\":\"groupACA\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Azure Container RegistryðŸŸ¢ [Cost Est.] \",\"items\":[{\"type\":1,\"content\":{\"json\":\"Note: Cost based on East US rates (Sep 2025). Zone redundancy enabled automatically at no additional cost for all tiers. For detailed pricing, see [Azure Pricing Calculator](https://azure.microsoft.com/en-us/pricing/calculator/).\",\"style\":\"upsell\"},\"name\":\"footnote-ACR\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"// Container Registry Zone Redundancy Analysis\\r\\nresources\\r\\n| where type =~ 'microsoft.containerregistry/registries'\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| extend resourceGroup = strcat('/subscriptions/', subscriptionId, '/resourceGroups/', resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/', subscriptionId)\\r\\n| extend skuTier = tostring(sku.tier)\\r\\n| extend isInZonalRegion = location in~ ({ZonalRegions:value})\\r\\n//| where isInZonalRegion == false  // Only registries NOT in zonal regions need action\\r\\n| extend \\r\\n    Recommendation = \\\"Redeploy to availability zone-supported region\\\",\\r\\n    ImplementationImpact = \\\"High\\\",  // No additional cost\\r\\n    ImplementationComplexity = \\\"High\\\"  // Requires redeployment\\r\\n| join kind = innerunique (\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n)\\r\\n    on id\\r\\n| project \\r\\n    name,\\r\\n    skuTier,\\r\\n    location,\\r\\n    isInZonalRegion,\\r\\n    resourceGroup,\\r\\n        Recommendation,\\r\\n    ImplementationImpact,\\r\\n    ImplementationComplexity,\\r\\n    subscriptionId\\r\\n| sort by name asc\",\"size\":0,\"noDataMessage\":\"All Azure Container Registries have availability zones configured\",\"noDataMessageStyle\":3,\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"zoneRedundant\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"Enabled\",\"representation\":\"success\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"failed\",\"text\":\"{0}{1}\"}]}}],\"rowLimit\":1000}},\"name\":\"query-containerRegistry-zones-details\"}]},\"conditionalVisibility\":{\"parameterName\":\"CheckforACR\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"groupACR\"}]},\"conditionalVisibility\":{\"parameterName\":\"selectedDetailsTab\",\"comparison\":\"isEqualTo\",\"value\":\"containerServices\"},\"name\":\"group - Details-ContainerService\"}]},\"conditionalVisibility\":{\"parameterName\":\"SelectedSubTab\",\"comparison\":\"isEqualTo\",\"value\":\"Details\"},\"name\":\"details-group\"}]},\"conditionalVisibility\":{\"parameterName\":\"SelectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"zoneAdoption\"},\"name\":\"groupZoneAdoption\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"BCDR\",\"items\":[{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"tabs\",\"links\":[{\"id\":\"ca40468d-4518-43bf-ac6e-0a11d7331e12\",\"cellValue\":\"SelectedSubTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Overview\",\"subTarget\":\"Overview\",\"style\":\"link\"},{\"id\":\"f280fc2a-f42a-42a4-ad4b-be37ab3e8b48\",\"cellValue\":\"SelectedSubTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Details\",\"subTarget\":\"Details\",\"style\":\"link\"}]},\"name\":\"links - bcdrSubTab\"},{\"type\":1,\"content\":{\"json\":\"# Business Continuity and Disaster Recovery (BCDR)\\r\\n## BCDR Best Practice Checks\\r\\nThis section reviews your Azure resources for alignment with BCDR best practices. Recommendations focus on ensuring that your workloads are resilient to outages, have appropriate backup and recovery strategies, and are configured for high availability. Addressing these findings helps minimize downtime and data loss in the event of failures or disasters.\",\"style\":\"upsell\"},\"conditionalVisibility\":{\"parameterName\":\"SelectedSubTab\",\"comparison\":\"isEqualTo\",\"value\":\"Overview\"},\"name\":\"text - BCDR\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"// VM Backup Recommendation\\r\\nresources\\r\\n| where type =~ 'microsoft.compute/virtualmachines'\\r\\n    and resourceGroup in ({ResourceGroup})\\r\\n| project vmId = tolower(id), vmName = name, subscriptionId, resourceGroup, location, type\\r\\n| join kind=leftouter (\\r\\n    recoveryservicesresources\\r\\n    | where type =~ 'microsoft.recoveryservices/vaults/backupfabrics/protectioncontainers/protecteditems'\\r\\n    | where properties.protectedItemType =~ 'Microsoft.Compute/virtualMachines'\\r\\n    | extend sourceResourceId = tolower(tostring(properties.sourceResourceId))\\r\\n    | where isnotempty(sourceResourceId)\\r\\n    | distinct sourceResourceId\\r\\n) on $left.vmId == $right.sourceResourceId\\r\\n| extend hasBackup = iff(isempty(sourceResourceId), false, true)\\r\\n| extend\\r\\n    Recommendation = iff(hasBackup, \\\"VM has backup configured\\\", \\\"Enable VM Backup\\\"),\\r\\n    RecommendationId = iff(hasBackup, \\\"backup-vm-001-protected\\\", \\\"backup-vm-001-unprotected\\\"),\\r\\n    ImplementationImpact = \\\"High\\\",\\r\\n    ImplementationComplexity = \\\"Low\\\",\\r\\n    type = \\\"microsoft.compute/virtualmachines\\\"\\r\\n| where hasBackup == false\\r\\n| join kind=leftouter (\\r\\n    resources\\r\\n    | where type =~ 'microsoft.compute/virtualmachines'\\r\\n       and resourceGroup in ({ResourceGroup})\\r\\n    | summarize Total = count()\\r\\n    | extend type = \\\"microsoft.compute/virtualmachines\\\"\\r\\n) on type\\r\\n| summarize ImpactedCount = count() by RecommendationId, type, Recommendation, ImplementationImpact, ImplementationComplexity, Total\\r\\n| extend ImpactedResources = strcat(ImpactedCount, '/', Total)\\r\\n| project Recommendation, type, ImpactedResources, ImplementationImpact, ImplementationComplexity\\r\\n\\r\\n// Recovery Services Vault Recommendations\\r\\n| union (\\r\\n    resources\\r\\n    | where type =~ 'microsoft.recoveryservices/vaults'\\r\\n    | extend bcdrSecurityLevel = tostring(properties.bcdrSecurityLevel)\\r\\n    | where bcdrSecurityLevel =~ \\\"Poor\\\"\\r\\n    | summarize ImpactedCount = count(), Total = count() by type, bcdrSecurityLevel\\r\\n    | extend\\r\\n        Recommendation = \\\"BCDR Security Level is poor\\\",\\r\\n        RecommendationId = \\\"5388f93e-bde1-49e7-a166-6c24e90b2daf\\\",\\r\\n        ImplementationImpact = \\\"High\\\",\\r\\n        ImplementationComplexity = \\\"Medium\\\",\\r\\n        ImpactedResources = strcat(ImpactedCount, '/', Total)\\r\\n    | project Recommendation, type, ImpactedResources, ImplementationImpact, ImplementationComplexity\\r\\n)\\r\\n| union (\\r\\n    resources\\r\\n    | where type =~ 'microsoft.recoveryservices/vaults'\\r\\n    | extend standardTierStorageRedundancy = tostring(properties.redundancySettings.standardTierStorageRedundancy)\\r\\n    | where standardTierStorageRedundancy =~ \\\"ZoneRedundant\\\"\\r\\n    | summarize ImpactedCount = count(), Total = count() by type, standardTierStorageRedundancy\\r\\n    | extend\\r\\n        Recommendation = \\\"Standard Tier Storage Redundancy is ZoneRedundant\\\",\\r\\n        RecommendationId = \\\"d20ca2a6-1aea-40ea-93cb-bc31fa5a1eda\\\",\\r\\n        ImplementationImpact = \\\"High\\\",\\r\\n        ImplementationComplexity = \\\"Low\\\",\\r\\n        ImpactedResources = strcat(ImpactedCount, '/', Total)\\r\\n    | project Recommendation, type, ImpactedResources, ImplementationImpact, ImplementationComplexity\\r\\n)\\r\\n| union (\\r\\n    resources\\r\\n    | where type =~ 'microsoft.recoveryservices/vaults'\\r\\n    | extend crossRegionRestore = tostring(properties.redundancySettings.crossRegionRestore)\\r\\n    | where crossRegionRestore =~ \\\"Disabled\\\"\\r\\n    | summarize ImpactedCount = count(), Total = count() by type, crossRegionRestore\\r\\n    | extend\\r\\n        Recommendation = \\\"Cross Region Restore is disabled\\\",\\r\\n        RecommendationId = \\\"44296813-ef2e-4a0b-8c87-01c9e84858d4\\\",\\r\\n        ImplementationImpact = \\\"High\\\",\\r\\n        ImplementationComplexity = \\\"Low\\\",\\r\\n        ImpactedResources = strcat(ImpactedCount, '/', Total)\\r\\n    | project Recommendation, type, ImpactedResources, ImplementationImpact, ImplementationComplexity\\r\\n)\\r\\n| union (\\r\\n    resources\\r\\n    | where type =~ 'microsoft.recoveryservices/vaults'\\r\\n    | extend softDeleteState = tostring(properties.securitySettings.softDeleteSettings.softDeleteState)\\r\\n    | where softDeleteState =~ \\\"Disabled\\\"\\r\\n    | summarize ImpactedCount = count(), Total = count() by type, softDeleteState\\r\\n    | extend\\r\\n        Recommendation = \\\"Soft Delete is disabled\\\",\\r\\n        RecommendationId = \\\"578a900c-b349-4dfa-9049-3af5d2961764\\\",\\r\\n        ImplementationImpact = \\\"High\\\",\\r\\n        ImplementationComplexity = \\\"Low\\\",\\r\\n        ImpactedResources = strcat(ImpactedCount, '/', Total)\\r\\n    | project Recommendation, type, ImpactedResources, ImplementationImpact, ImplementationComplexity\\r\\n)\",\"size\":0,\"title\":\"Recommendation by Impact\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"visualization\":\"tiles\",\"sortBy\":[],\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"Recommendation\"},\"subtitleContent\":{\"columnMatch\":\"type\"},\"leftContent\":{\"columnMatch\":\"ImpactedResources\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"tooltipFormat\":{\"tooltip\":\"Number of impacted resources / Total resources\"}},\"secondaryContent\":{\"columnMatch\":\"RecommendationId\"},\"showBorder\":true,\"size\":\"auto\",\"styleSettings\":{\"borderStyle\":\"rounded\"}}},\"name\":\"visualImplementationImpact-BCDR\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"// VM Backup Recommendation\\r\\nresources\\r\\n| where type =~ 'microsoft.compute/virtualmachines'\\r\\n    and resourceGroup in ({ResourceGroup})\\r\\n| project vmId = tolower(id), vmName = name, subscriptionId, resourceGroup, location, type\\r\\n| join kind=leftouter (\\r\\n    recoveryservicesresources\\r\\n    | where type =~ 'microsoft.recoveryservices/vaults/backupfabrics/protectioncontainers/protecteditems'\\r\\n    | where properties.protectedItemType =~ 'Microsoft.Compute/virtualMachines'\\r\\n    | extend sourceResourceId = tolower(tostring(properties.sourceResourceId))\\r\\n    | where isnotempty(sourceResourceId)\\r\\n    | distinct sourceResourceId\\r\\n) on $left.vmId == $right.sourceResourceId\\r\\n| extend hasBackup = iff(isempty(sourceResourceId), false, true)\\r\\n| extend\\r\\n    Recommendation = iff(hasBackup, \\\"VM has backup configured\\\", \\\"Enable VM Backup\\\"),\\r\\n    RecommendationId = iff(hasBackup, \\\"backup-vm-001-protected\\\", \\\"backup-vm-001-unprotected\\\"),\\r\\n    ImplementationImpact = \\\"High\\\",\\r\\n    ImplementationComplexity = \\\"Low\\\",\\r\\n    type = \\\"microsoft.compute/virtualmachines\\\"\\r\\n| where hasBackup == false\\r\\n| join kind=leftouter (\\r\\n    resources\\r\\n    | where type =~ 'microsoft.compute/virtualmachines'\\r\\n       and resourceGroup in ({ResourceGroup})\\r\\n    | summarize Total = count()\\r\\n    | extend type = \\\"microsoft.compute/virtualmachines\\\"\\r\\n) on type\\r\\n| summarize ImpactedCount = count() by RecommendationId, type, Recommendation, ImplementationImpact, ImplementationComplexity, Total\\r\\n| extend ImpactedResources = strcat(ImpactedCount, '/', Total)\\r\\n| project Recommendation, type, ImpactedResources, ImplementationImpact, ImplementationComplexity\\r\\n\\r\\n// Recovery Services Vault Recommendations\\r\\n| union (\\r\\n    resources\\r\\n    | where type =~ 'microsoft.recoveryservices/vaults'\\r\\n    | extend bcdrSecurityLevel = tostring(properties.bcdrSecurityLevel)\\r\\n    | where bcdrSecurityLevel =~ \\\"Poor\\\"\\r\\n    | summarize ImpactedCount = count(), Total = count() by type, bcdrSecurityLevel\\r\\n    | extend\\r\\n        Recommendation = \\\"BCDR Security Level is poor\\\",\\r\\n        RecommendationId = \\\"5388f93e-bde1-49e7-a166-6c24e90b2daf\\\",\\r\\n        ImplementationImpact = \\\"High\\\",\\r\\n        ImplementationComplexity = \\\"Medium\\\",\\r\\n        ImpactedResources = strcat(ImpactedCount, '/', Total)\\r\\n    | project Recommendation, type, ImpactedResources, ImplementationImpact, ImplementationComplexity\\r\\n)\\r\\n| union (\\r\\n    resources\\r\\n    | where type =~ 'microsoft.recoveryservices/vaults'\\r\\n    | extend standardTierStorageRedundancy = tostring(properties.redundancySettings.standardTierStorageRedundancy)\\r\\n    | where standardTierStorageRedundancy =~ \\\"ZoneRedundant\\\"\\r\\n    | summarize ImpactedCount = count(), Total = count() by type, standardTierStorageRedundancy\\r\\n    | extend\\r\\n        Recommendation = \\\"Standard Tier Storage Redundancy is ZoneRedundant\\\",\\r\\n        RecommendationId = \\\"d20ca2a6-1aea-40ea-93cb-bc31fa5a1eda\\\",\\r\\n        ImplementationImpact = \\\"High\\\",\\r\\n        ImplementationComplexity = \\\"Low\\\",\\r\\n        ImpactedResources = strcat(ImpactedCount, '/', Total)\\r\\n    | project Recommendation, type, ImpactedResources, ImplementationImpact, ImplementationComplexity\\r\\n)\\r\\n| union (\\r\\n    resources\\r\\n    | where type =~ 'microsoft.recoveryservices/vaults'\\r\\n    | extend crossRegionRestore = tostring(properties.redundancySettings.crossRegionRestore)\\r\\n    | where crossRegionRestore =~ \\\"Disabled\\\"\\r\\n    | summarize ImpactedCount = count(), Total = count() by type, crossRegionRestore\\r\\n    | extend\\r\\n        Recommendation = \\\"Cross Region Restore is disabled\\\",\\r\\n        RecommendationId = \\\"44296813-ef2e-4a0b-8c87-01c9e84858d4\\\",\\r\\n        ImplementationImpact = \\\"High\\\",\\r\\n        ImplementationComplexity = \\\"Low\\\",\\r\\n        ImpactedResources = strcat(ImpactedCount, '/', Total)\\r\\n    | project Recommendation, type, ImpactedResources, ImplementationImpact, ImplementationComplexity\\r\\n)\\r\\n| union (\\r\\n    resources\\r\\n    | where type =~ 'microsoft.recoveryservices/vaults'\\r\\n    | extend softDeleteState = tostring(properties.securitySettings.softDeleteSettings.softDeleteState)\\r\\n    | where softDeleteState =~ \\\"Disabled\\\"\\r\\n    | summarize ImpactedCount = count(), Total = count() by type, softDeleteState\\r\\n    | extend\\r\\n        Recommendation = \\\"Soft Delete is disabled\\\",\\r\\n        RecommendationId = \\\"578a900c-b349-4dfa-9049-3af5d2961764\\\",\\r\\n        ImplementationImpact = \\\"High\\\",\\r\\n        ImplementationComplexity = \\\"Low\\\",\\r\\n        ImpactedResources = strcat(ImpactedCount, '/', Total)\\r\\n    | project Recommendation, type, ImpactedResources, ImplementationImpact, ImplementationComplexity\\r\\n)\",\"size\":0,\"showAnalytics\":true,\"title\":\"Backup recommendations\",\"showRefreshButton\":true,\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"sortBy\":[{\"itemKey\":\"ImplementationComplexity\",\"sortOrder\":1}]},\"sortBy\":[{\"itemKey\":\"ImplementationComplexity\",\"sortOrder\":1}]},\"name\":\"Executive insights-BCDR\"}]},\"conditionalVisibility\":{\"parameterName\":\"SelectedSubTab\",\"comparison\":\"isEqualTo\",\"value\":\"Overview\"},\"name\":\"groupOverviewBackup\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"understand-cost-calc-yesno\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"understandCostCalculations\",\"label\":\"Show backup cost calculation details?\",\"type\":2,\"isRequired\":true,\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"jsonData\":\"[\\r\\n    {\\r\\n    \\\"value\\\" : \\\"Yes\\\",\\r\\n    \\\"label\\\" : \\\"Yes\\\"\\r\\n    },\\r\\n    {\\r\\n    \\\"value\\\" : \\\"No\\\",\\r\\n    \\\"label\\\" : \\\"No\\\",\\r\\n    \\\"selected\\\" : true\\r\\n    }\\r\\n]\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"Show Cost Calculation Details\"},{\"type\":1,\"content\":{\"json\":\"### How Backup Cost Is Calculated  \\r\\n\\r\\nThis section estimates the monthly backup cost for each unprotected VM using the following formula:  \\r\\n\\r\\n- **Total Disk Size (GB):** The size of the VM's managed disk(s).  \\r\\n- **Data Change Rate:** The estimated daily percentage of data that changes (as a fraction).  \\r\\n- **Backup Agent Cost:** Fixed monthly cost for the backup agent.  \\r\\n- **Storage Price per GB/Month:** The cost to store 1 GB of backup data for a month.  \\r\\n- **Snapshot Retention:** Number of days snapshots are retained.  \\r\\n- **Snapshot Price:** Cost per GB for snapshot storage.  \\r\\n\\r\\n#### Calculation Steps  \\r\\n1. **Monthly Data Churn:**  \\r\\n   - `storageUsedGb = totalDiskGb + totalDiskGb * (changeRateDaily * 30)`  \\r\\n   - Accounts for original disk size plus new/changed data over the month.  \\r\\n\\r\\n2. **Snapshot Storage:**  \\r\\n   - `SnapshotStorageGb = (totalDiskGb * changeRateDaily) * snapshotRetention`  \\r\\n   - Estimates additional storage needed for retained snapshots.  \\r\\n\\r\\n3. **Cost Components:**  \\r\\n   - `CostperBackup = storageUsedGb * storagePricePerGbMonth`  \\r\\n   - `CostperSnapshot = SnapshotStorageGb * snapshotPrice`  \\r\\n   - `EstimatedMonthlyBackupCost = CostperBackup + CostperSnapshot + backupAgentCost`  \\r\\n\\r\\n#### Assumed Values  \\r\\n- **Storage Price per GB/Month:** Default is $0.05 (editable)  \\r\\n- **Daily Data Change Rate:** Default is 10% (editable)  \\r\\n- **Backup Agent Cost:** Default is $10/month (editable)  \\r\\n- **Data Retention:** Default is 30 days (editable)  \\r\\n- **Snapshot Retention:** Default is 3 days (editable)  \\r\\n- **Snapshot Price:** Default is $0.144/GB (editable)  \\r\\n\\r\\nYou can adjust these parameters above to reflect your environment or pricing model.  \\r\\n\"},\"conditionalVisibility\":{\"parameterName\":\"understandCostCalculations\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"Backup Cost Calculation Explanation\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"b2e4c0f5-4d3b-4f7a-8b9f-222222222222\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"storagePricePerGbMonth\",\"label\":\"Storage price per GB / month (USD)\",\"type\":1,\"defaultValue\":\"0.05\",\"timeContext\":{\"durationMs\":86400000},\"value\":\"0.028\"},{\"id\":\"d4e6a217-6f5d-4b9c-abdf-444444444444\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"changeRateDaily\",\"label\":\"Estimated daily % data change rate (fraction)\",\"type\":1,\"defaultValue\":\"0.10\",\"timeContext\":{\"durationMs\":86400000},\"value\":\"1\"},{\"version\":\"KqlParameterItem/1.0\",\"name\":\"backupAgentCost\",\"label\":\"Backup agent cost\",\"type\":1,\"timeContext\":{\"durationMs\":86400000},\"defaultValue\":\"10\",\"value\":\"10\",\"id\":\"0e2f4a2a-3e09-4c65-9b90-c551c5fadb91\"},{\"id\":\"00376c71-e8d8-48b4-bee3-d99d8d3f5857\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"dailyRetention\",\"label\":\"Data retentation (days)\",\"type\":1,\"value\":\"30\"},{\"version\":\"KqlParameterItem/1.0\",\"name\":\"snapshotRetention\",\"label\":\"Snapshot retention time\",\"type\":1,\"value\":\"3\",\"id\":\"2ef0a5f3-0e05-414f-a859-7ac9e69cf12f\"},{\"version\":\"KqlParameterItem/1.0\",\"name\":\"snapshotPrice\",\"label\":\"Snapshot storage price\",\"type\":1,\"value\":\"0.144\",\"id\":\"00f8da7f-e675-4846-bb88-c396faa32581\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"understandCostCalculations\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"parameters - BackupPricing\"},{\"type\":1,\"content\":{\"json\":\"Note: Cost based on East US rates (Sep 2025). Backup costs include storage, snapshots, and agent fees. Estimates assume default retention policies and change rates. Actual costs vary by backup frequency, retention settings, and data change patterns. For detailed pricing, see [Azure Pricing Calculator](https://azure.microsoft.com/en-us/pricing/calculator/).\",\"style\":\"upsell\"},\"name\":\"text - 4\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where type =~ 'microsoft.compute/virtualmachines'\\r\\n    and resourceGroup in ({ResourceGroup})\\r\\n| project \\r\\n    VMName = name, \\r\\n    ResourceGroup = resourceGroup, \\r\\n    Location = location, \\r\\n    VMId = tolower(id), \\r\\n    subscriptionId\\r\\n// Join with managed disks to get disk size\\r\\n| join kind=leftouter (\\r\\n    resources\\r\\n    | where type =~ 'microsoft.compute/disks'\\r\\n    | project DiskId = id, VMId = tolower(managedBy), DiskSizeGB = tostring(properties.diskSizeGB)\\r\\n) on $left.VMId == $right.VMId\\r\\n// Join with Recovery Services to check backup status\\r\\n| join kind=leftouter (\\r\\n    recoveryservicesresources\\r\\n    | where type =~ 'microsoft.recoveryservices/vaults/backupfabrics/protectioncontainers/protecteditems'\\r\\n    | where properties.protectedItemType =~ 'Microsoft.Compute/virtualMachines'\\r\\n    | extend sourceResourceId = tolower(tostring(properties.sourceResourceId))\\r\\n    | where isnotempty(sourceResourceId)\\r\\n    | distinct sourceResourceId\\r\\n) on $left.VMId == $right.sourceResourceId\\r\\n| extend BackupStatus = iff(isempty(sourceResourceId), \\\"Not Protected\\\", \\\"Protected\\\")\\r\\n| where BackupStatus == \\\"Not Protected\\\"\\r\\n// Cost calculation\\r\\n| extend totalDiskGb       = todouble(DiskSizeGB),\\r\\n         changeRateMonthly = todouble({changeRateDaily}) / 100.0,   // % of data change per day\\r\\n         agentCost         = todouble({backupAgentCost})      // fixed backup agent cost\\r\\n| extend storageUsedGb     = totalDiskGb + totalDiskGb * (changeRateMonthly * 30)  // monthly churn\\r\\n| extend SnapshotStorageGb = (totalDiskGb * changeRateMonthly) * {snapshotRetention}\\r\\n| extend CostPerGB         = todouble({storagePricePerGbMonth})\\r\\n| extend SnapshotCostPerGB = todouble({snapshotPrice})\\r\\n// Cost components\\r\\n| extend CostperBackup     = storageUsedGb * CostPerGB\\r\\n| extend CostperSnapshot   = SnapshotStorageGb * SnapshotCostPerGB\\r\\n| extend EstimatedMonthlyBackupCost = CostperBackup + CostperSnapshot + agentCost\\r\\n// Final output\\r\\n| extend Recommendation           = \\\"Enable VM Backup\\\",\\r\\n         ImplementationImpact     = \\\"High\\\",\\r\\n         ImplementationComplexity = \\\"Low\\\"\\r\\n| project Recommendation, VMName, DiskSizeGB, Location, EstimatedMonthlyBackupCost, ResourceGroup, \\r\\n         ImplementationImpact, ImplementationComplexity, subscriptionId\\r\\n| sort by VMName asc\\r\\n\",\"size\":0,\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"EstimatedMonthlyBackupCost\",\"formatter\":0,\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"New estimated montlhy backup costs\",\"formatter\":0,\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\"}}}],\"labelSettings\":[{\"columnId\":\"EstimatedMonthlyBackupCost\",\"label\":\"New estimated monthly backup cost\"}]}},\"name\":\"querybackupwithcosts\"}]},\"name\":\"groupBackupwithCost\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where type =~ 'microsoft.recoveryservices/vaults'\\r\\n| extend standardTierStorageRedundancy = tostring(properties.redundancySettings.standardTierStorageRedundancy)\\r\\n| extend hasIssue = iff(standardTierStorageRedundancy =~ \\\"ZoneRedundant\\\", true, false)\\r\\n| extend\\r\\n    Recommendation = iff(hasIssue, \\\"Recovery Services Vault storage redundancy is Zone Redundant, consider moving to Geo Redundant.\\\", \\\"Storage Redundancy is not ZoneRedundant\\\"),\\r\\n    RecommendationId = iff(hasIssue, \\\"d20ca2a6-1aea-40ea-93cb-bc31fa5a1eda\\\", \\\"\\\"),\\r\\n    ImplementationImpact = \\\"Medium\\\",\\r\\n    ImplementationComplexity = \\\"Low\\\",\\r\\n    type = \\\"microsoft.recoveryservices/vaults\\\"\\r\\n| where hasIssue\\r\\n| project   Recommendation, name,  resourceGroup,  ImplementationImpact, ImplementationComplexity, location, subscriptionId \",\"size\":0,\"title\":\"Recovery Services Vault security level\",\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"resourceGroup\",\"formatter\":14,\"formatOptions\":{\"linkTarget\":null,\"showIcon\":true}},{\"columnMatch\":\"subscriptionId\",\"formatter\":15,\"formatOptions\":{\"linkTarget\":null,\"showIcon\":true}}]}},\"name\":\"queryCheckVaultSecurity\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where type =~ 'microsoft.recoveryservices/vaults'\\r\\n| extend standardTierStorageRedundancy = tostring(properties.redundancySettings.standardTierStorageRedundancy)\\r\\n| extend hasIssue = iff(standardTierStorageRedundancy =~ \\\"ZoneRedundant\\\", true, false)\\r\\n| extend\\r\\n    Recommendation = iff(hasIssue, \\\"Recovery Services Vault storage redundancy is Zone Redundant, consider moving to Geo Redundant.\\\", \\\"Storage Redundancy is not ZoneRedundant\\\"),\\r\\n    RecommendationId = iff(hasIssue, \\\"d20ca2a6-1aea-40ea-93cb-bc31fa5a1eda\\\", \\\"\\\"),\\r\\n    ImplementationImpact = \\\"Medium\\\",\\r\\n    ImplementationComplexity = \\\"Low\\\",\\r\\n    type = \\\"microsoft.recoveryservices/vaults\\\"\\r\\n| where hasIssue\\r\\n| project   Recommendation, name,  resourceGroup,  ImplementationImpact, ImplementationComplexity, location, subscriptionId \",\"size\":0,\"title\":\"Recovery Services Vault storage settings\",\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"resourceGroup\",\"formatter\":14,\"formatOptions\":{\"linkTarget\":null,\"showIcon\":true}},{\"columnMatch\":\"subscriptionId\",\"formatter\":15,\"formatOptions\":{\"linkTarget\":null,\"showIcon\":true}}]}},\"name\":\"queryCheckVaultRedundancy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where type =~ 'microsoft.recoveryservices/vaults'\\r\\n| extend softDeleteState = tostring(properties.securitySettings.softDeleteSettings.softDeleteState)\\r\\n| extend hasIssue = iff(softDeleteState =~ \\\"Disabled\\\", true, false)\\r\\n| extend\\r\\n    Recommendation = iff(hasIssue, \\\"Soft Delete is disabled\\\", \\\"Soft Delete is enabled\\\"),\\r\\n    RecommendationId = iff(hasIssue, \\\"578a900c-b349-4dfa-9049-3af5d2961764\\\", \\\"\\\"),\\r\\n    ImplementationImpact = \\\"High\\\",\\r\\n    ImplementationComplexity = \\\"Low\\\",\\r\\n    type = \\\"microsoft.recoveryservices/vaults\\\"\\r\\n| where hasIssue\\r\\n//| summarize ImpactedCount = count() by RecommendationId, type, Recommendation, ImplementationImpact, ImplementationComplexity\\r\\n| project   Recommendation, name,  resourceGroup,  ImplementationImpact, ImplementationComplexity, location, subscriptionId \",\"size\":0,\"title\":\"Recovery Services Vault delete protection status\",\"noDataMessage\":\"All of your Recovery Services Vault have soft delete enabled.\",\"noDataMessageStyle\":3,\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"resourceGroup\",\"formatter\":14,\"formatOptions\":{\"linkTarget\":null,\"showIcon\":true}},{\"columnMatch\":\"subscriptionId\",\"formatter\":15,\"formatOptions\":{\"linkTarget\":null,\"showIcon\":true}}]}},\"name\":\"queryCheckSoftDelete\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where type =~ 'microsoft.recoveryservices/vaults'\\r\\n| extend crossRegionRestore = tostring(properties.redundancySettings.crossRegionRestore)\\r\\n| extend hasIssue = iff(crossRegionRestore =~ \\\"Disabled\\\", true, false)\\r\\n| extend\\r\\n    Recommendation = iff(hasIssue, \\\"Cross Region Restore is disabled\\\", \\\"Cross Region Restore is enabled\\\"),\\r\\n    RecommendationId = iff(hasIssue, \\\"44296813-ef2e-4a0b-8c87-01c9e84858d4\\\", \\\"\\\"),\\r\\n    ImplementationImpact = \\\"High\\\",\\r\\n    ImplementationComplexity = \\\"Low\\\",\\r\\n    type = \\\"microsoft.recoveryservices/vaults\\\"\\r\\n| where hasIssue\\r\\n//| summarize ImpactedCount = count() by RecommendationId, type, Recommendation, ImplementationImpact, ImplementationComplexity\\r\\n| project   Recommendation, name,  resourceGroup,  ImplementationImpact, ImplementationComplexity, location, subscriptionId \",\"size\":0,\"title\":\"Recovery Services Vault cross region restore\",\"noDataMessage\":\"All of your Recovery Services Vault cross region restore enabled.\",\"noDataMessageStyle\":3,\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"resourceGroup\",\"formatter\":14,\"formatOptions\":{\"linkTarget\":null,\"showIcon\":true}},{\"columnMatch\":\"subscriptionId\",\"formatter\":15,\"formatOptions\":{\"linkTarget\":null,\"showIcon\":true}}]}},\"name\":\"queryCheckCrossRegion\"}]},\"conditionalVisibility\":{\"parameterName\":\"SelectedSubTab\",\"comparison\":\"isEqualTo\",\"value\":\"Details\"},\"name\":\"groupBCDR-Details\"}]},\"conditionalVisibility\":{\"parameterName\":\"SelectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"BCDR\"},\"name\":\"groupBCDR\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Security\",\"items\":[{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"tabs\",\"links\":[{\"id\":\"ca40468d-4518-43bf-ac6e-0a11d7331e12\",\"cellValue\":\"SelectedSubTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Overview\",\"subTarget\":\"Overview\",\"style\":\"link\"},{\"id\":\"f280fc2a-f42a-42a4-ad4b-be37ab3e8b48\",\"cellValue\":\"SelectedSubTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Details\",\"subTarget\":\"Details\",\"style\":\"link\"}]},\"name\":\"links - defenderSubTab\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"# Security\\r\\n## Security Best Practice Checks\\r\\nThis section evaluates your Azure resources against security best practices. Recommendations focus on protecting your environment from threats, ensuring proper access controls, and maintaining compliance with security standards. Addressing these findings helps safeguard your data, applications, and infrastructure from vulnerabilities and unauthorized access.\",\"style\":\"upsell\"},\"name\":\"text - Security\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"securityresources\\n| where type =~ \\\"microsoft.security/pricings\\\"\\n| extend pricingTier = properties.pricingTier, subPlan = properties.subPlan\\n| extend planSet = pack(name, level = case(isnotempty(subPlan),subPlan,pricingTier))\\n| summarize defenderPlans = make_bag(planSet) by subscriptionId\\n| project subscriptionId,\\n    CloudPosture = defenderPlans.CloudPosture,\\n    VirtualMachines = defenderPlans.VirtualMachines,\\n    AppServices = defenderPlans.AppServices,\\n    SqlServers = defenderPlans.SqlServers,\\n    SqlServerVirtualMachines = defenderPlans.SqlServerVirtualMachines,\\n    OpenSourceRelationalDatabases = defenderPlans.OpenSourceRelationalDatabases,\\n    CosmosDB = defenderPlans.CosmosDbs,\\n    StorageAccounts = defenderPlans.StorageAccounts,\\n    Containers = defenderPlans.Containers,\\n    KeyVaults = defenderPlans.KeyVaults,\\n    Arm = defenderPlans.Arm,\\n    DNS = defenderPlans.Dns,\\n    KubernetesService = defenderPlans.KubernetesService,\\n    ContainerRegistry = defenderPlans.ContainerRegistry\",\"size\":1,\"showAnalytics\":true,\"title\":\"Absolute coverage across Azure subscriptions\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"subscriptionId\",\"formatter\":15,\"formatOptions\":{\"linkTarget\":\"Resource\",\"showIcon\":true,\"customColumnWidthSetting\":\"50ch\"}},{\"columnMatch\":\"CloudPosture\",\"formatter\":18,\"formatOptions\":{\"linkColumn\":\"subscriptionId\",\"linkTarget\":\"OpenBlade\",\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"Standard\",\"representation\":\"lightBlue\",\"text\":\"on\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"blueDark\",\"text\":\"off\"}],\"bladeOpenContext\":{\"bladeName\":\"PolicyPricingWithBundlesBlade\",\"extensionName\":\"Microsoft_Azure_Security\",\"bladeParameters\":[{\"name\":\"subscriptionId\",\"source\":\"column\",\"value\":\"subscriptionId\"}]},\"customColumnWidthSetting\":\"20ch\"}},{\"columnMatch\":\"VirtualMachines\",\"formatter\":18,\"formatOptions\":{\"linkColumn\":\"subscriptionId\",\"linkTarget\":\"OpenBlade\",\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"P1\",\"representation\":\"lightBlue\",\"text\":\"Plan 1 on\"},{\"operator\":\"==\",\"thresholdValue\":\"P2\",\"representation\":\"lightBlue\",\"text\":\"Plan 2 on\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"blueDark\",\"text\":\"off\"}],\"bladeOpenContext\":{\"bladeName\":\"PolicyPricingWithBundlesBlade\",\"extensionName\":\"Microsoft_Azure_Security\",\"bladeParameters\":[{\"name\":\"subscriptionId\",\"source\":\"column\",\"value\":\"subscriptionId\"}]},\"customColumnWidthSetting\":\"12.5ch\"}},{\"columnMatch\":\"AppServices\",\"formatter\":18,\"formatOptions\":{\"linkColumn\":\"subscriptionId\",\"linkTarget\":\"OpenBlade\",\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"Standard\",\"representation\":\"lightBlue\",\"text\":\"on\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"blueDark\",\"text\":\"off\"}],\"bladeOpenContext\":{\"bladeName\":\"PolicyPricingWithBundlesBlade\",\"extensionName\":\"Microsoft_Azure_Security\",\"bladeParameters\":[{\"name\":\"subscriptionId\",\"source\":\"column\",\"value\":\"subscriptionId\"}]},\"customColumnWidthSetting\":\"16ch\"}},{\"columnMatch\":\"SqlServers\",\"formatter\":18,\"formatOptions\":{\"linkColumn\":\"subscriptionId\",\"linkTarget\":\"OpenBlade\",\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"Standard\",\"representation\":\"lightBlue\",\"text\":\"on\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"blueDark\",\"text\":\"off\"}],\"bladeOpenContext\":{\"bladeName\":\"PolicyPricingWithBundlesBlade\",\"extensionName\":\"Microsoft_Azure_Security\",\"bladeParameters\":[{\"name\":\"subscriptionId\",\"source\":\"column\",\"value\":\"subscriptionId\"}]},\"customColumnWidthSetting\":\"10ch\"}},{\"columnMatch\":\"SqlServerVirtualMachines\",\"formatter\":18,\"formatOptions\":{\"linkColumn\":\"subscriptionId\",\"linkTarget\":\"OpenBlade\",\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"Standard\",\"representation\":\"lightBlue\",\"text\":\"on\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"blueDark\",\"text\":\"off\"}],\"bladeOpenContext\":{\"bladeName\":\"PolicyPricingWithBundlesBlade\",\"extensionName\":\"Microsoft_Azure_Security\",\"bladeParameters\":[{\"name\":\"subscriptionId\",\"source\":\"column\",\"value\":\"subscriptionId\"}]},\"customColumnWidthSetting\":\"26ch\"}},{\"columnMatch\":\"OpenSourceRelationalDatabases\",\"formatter\":18,\"formatOptions\":{\"linkColumn\":\"subscriptionId\",\"linkTarget\":\"OpenBlade\",\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"Standard\",\"representation\":\"lightBlue\",\"text\":\"on\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"blueDark\",\"text\":\"off\"}],\"bladeOpenContext\":{\"bladeName\":\"PolicyPricingWithBundlesBlade\",\"extensionName\":\"Microsoft_Azure_Security\",\"bladeParameters\":[{\"name\":\"subscriptionId\",\"source\":\"column\",\"value\":\"subscriptionId\"}]},\"customColumnWidthSetting\":\"29ch\"}},{\"columnMatch\":\"CosmosDB\",\"formatter\":18,\"formatOptions\":{\"linkColumn\":\"subscriptionId\",\"linkTarget\":\"OpenBlade\",\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"Standard\",\"representation\":\"lightBlue\",\"text\":\"on\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"blueDark\",\"text\":\"off\"}],\"bladeOpenContext\":{\"bladeName\":\"PolicyPricingWithBundlesBlade\",\"extensionName\":\"Microsoft_Azure_Security\",\"bladeParameters\":[{\"name\":\"subscriptionId\",\"source\":\"column\",\"value\":\"subscriptionId\"}]},\"customColumnWidthSetting\":\"15.5ch\"}},{\"columnMatch\":\"StorageAccounts\",\"formatter\":18,\"formatOptions\":{\"linkColumn\":\"subscriptionId\",\"linkTarget\":\"OpenBlade\",\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"DefenderForStorageV2\",\"representation\":\"lightBlue\",\"text\":\"on (Defender for Storage V2)\"},{\"operator\":\"==\",\"thresholdValue\":\"PerStorageAccount\",\"representation\":\"lightBlue\",\"text\":\"on (per storage account)\"},{\"operator\":\"==\",\"thresholdValue\":\"PerTransaction\",\"representation\":\"lightBlue\",\"text\":\"on (per transaction)\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"blueDark\",\"text\":\"off\"}],\"bladeOpenContext\":{\"bladeName\":\"PolicyPricingWithBundlesBlade\",\"extensionName\":\"Microsoft_Azure_Security\",\"bladeParameters\":[{\"name\":\"subscriptionId\",\"source\":\"column\",\"value\":\"subscriptionId\"}]},\"customColumnWidthSetting\":\"27ch\"}},{\"columnMatch\":\"Containers\",\"formatter\":18,\"formatOptions\":{\"linkColumn\":\"subscriptionId\",\"linkTarget\":\"OpenBlade\",\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"Standard\",\"representation\":\"lightBlue\",\"text\":\"on\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"blueDark\",\"text\":\"off\"}],\"bladeOpenContext\":{\"bladeName\":\"PolicyPricingWithBundlesBlade\",\"extensionName\":\"Microsoft_Azure_Security\",\"bladeParameters\":[{\"name\":\"subscriptionId\",\"source\":\"column\",\"value\":\"subscriptionId\"}]},\"customColumnWidthSetting\":\"15ch\"}},{\"columnMatch\":\"KeyVaults\",\"formatter\":18,\"formatOptions\":{\"linkColumn\":\"subscriptionId\",\"linkTarget\":\"OpenBlade\",\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"PerKeyVault\",\"representation\":\"lightBlue\",\"text\":\"on (per resource)\"},{\"operator\":\"==\",\"thresholdValue\":\"PerTransaction\",\"representation\":\"lightBlue\",\"text\":\"on (per transaction)\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"blueDark\",\"text\":\"off\"}],\"bladeOpenContext\":{\"bladeName\":\"PolicyPricingWithBundlesBlade\",\"extensionName\":\"Microsoft_Azure_Security\",\"bladeParameters\":[{\"name\":\"subscriptionId\",\"source\":\"column\",\"value\":\"subscriptionId\"}]},\"customColumnWidthSetting\":\"17ch\"}},{\"columnMatch\":\"Arm\",\"formatter\":18,\"formatOptions\":{\"linkColumn\":\"subscriptionId\",\"linkTarget\":\"OpenBlade\",\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"PerSubscription\",\"representation\":\"lightBlue\",\"text\":\"on (per subscription)\"},{\"operator\":\"==\",\"thresholdValue\":\"PerApiCall\",\"representation\":\"lightBlue\",\"text\":\"on (per API call)\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"blueDark\",\"text\":\"off\"}],\"bladeOpenContext\":{\"bladeName\":\"PolicyPricingWithBundlesBlade\",\"extensionName\":\"Microsoft_Azure_Security\",\"bladeParameters\":[{\"name\":\"subscriptionId\",\"source\":\"column\",\"value\":\"subscriptionId\"}]},\"customColumnWidthSetting\":\"21ch\"}},{\"columnMatch\":\"DNS\",\"formatter\":18,\"formatOptions\":{\"linkColumn\":\"subscriptionId\",\"linkTarget\":\"OpenBlade\",\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"Standard\",\"representation\":\"lightBlue\",\"text\":\"on\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"blueDark\",\"text\":\"off\"}],\"bladeOpenContext\":{\"bladeName\":\"PolicyPricingWithBundlesBlade\",\"extensionName\":\"Microsoft_Azure_Security\",\"bladeParameters\":[{\"name\":\"subscriptionId\",\"source\":\"column\",\"value\":\"subscriptionId\"}]},\"customColumnWidthSetting\":\"10.7ch\"}},{\"columnMatch\":\"KubernetesService\",\"formatter\":18,\"formatOptions\":{\"linkColumn\":\"subscriptionId\",\"linkTarget\":\"OpenBlade\",\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"Standard\",\"representation\":\"lightBlue\",\"text\":\"on\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"blueDark\",\"text\":\"off\"}],\"bladeOpenContext\":{\"bladeName\":\"PolicyPricingWithBundlesBlade\",\"extensionName\":\"Microsoft_Azure_Security\",\"bladeParameters\":[{\"name\":\"subscriptionId\",\"source\":\"column\",\"value\":\"subscriptionId\"}]},\"customColumnWidthSetting\":\"19.7ch\"}},{\"columnMatch\":\"ContainerRegistry\",\"formatter\":18,\"formatOptions\":{\"linkColumn\":\"subscriptionId\",\"linkTarget\":\"OpenBlade\",\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"Standard\",\"representation\":\"lightBlue\",\"text\":\"on\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"blueDark\",\"text\":\"off\"}],\"bladeOpenContext\":{\"bladeName\":\"PolicyPricingWithBundlesBlade\",\"extensionName\":\"Microsoft_Azure_Security\",\"bladeParameters\":[{\"name\":\"subscriptionId\",\"source\":\"column\",\"value\":\"subscriptionId\"}]},\"customColumnWidthSetting\":\"32ch\"}},{\"columnMatch\":\"subscriptionName\",\"formatter\":5,\"formatOptions\":{\"linkTarget\":\"Resource\"}}],\"rowLimit\":10000,\"filter\":true,\"labelSettings\":[{\"columnId\":\"subscriptionId\",\"label\":\"Subscription Name\"},{\"columnId\":\"CloudPosture\",\"label\":\"Defender CSPM\"},{\"columnId\":\"VirtualMachines\",\"label\":\"Servers\"},{\"columnId\":\"AppServices\",\"label\":\"App Services\"},{\"columnId\":\"SqlServers\",\"label\":\"SQL\"},{\"columnId\":\"SqlServerVirtualMachines\",\"label\":\"SQL Server on machines\"},{\"columnId\":\"OpenSourceRelationalDatabases\",\"label\":\"Open-source relational DBs\"},{\"columnId\":\"CosmosDB\",\"label\":\"Cosmos DB\"},{\"columnId\":\"StorageAccounts\",\"label\":\"Storage\"},{\"columnId\":\"Containers\",\"label\":\"Containers\"},{\"columnId\":\"KeyVaults\",\"label\":\"Key Vaults\"},{\"columnId\":\"Arm\",\"label\":\"Resource Manager\"},{\"columnId\":\"DNS\",\"label\":\"DNS (deprecated)\"},{\"columnId\":\"KubernetesService\",\"label\":\"K8s (deprecated)\"},{\"columnId\":\"ContainerRegistry\",\"label\":\"Container Registry (deprecated)\"}]},\"sortBy\":[]},\"name\":\"queryAzure\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"// Query to show VMs without Defender for Server protection (no security assessments)\\r\\nresources\\r\\n| where type =~ \\\"microsoft.compute/virtualmachines\\\"\\r\\n    and resourceGroup in ({ResourceGroup})\\r\\n| extend vmId = tolower(id)\\r\\n| join kind=leftouter (\\r\\n    securityresources\\r\\n    | where type == \\\"microsoft.security/assessments\\\"\\r\\n    | where properties.resourceDetails.ResourceType =~ \\\"microsoft.compute/virtualmachines\\\"\\r\\n    | extend vmId = tolower(tostring(properties.resourceDetails.Id))\\r\\n    | summarize hasAssessments = count() by vmId\\r\\n) on vmId\\r\\n| where isempty(hasAssessments)\\r\\n| extend\\r\\n    Recommendation = \\\"Enable Defender for Server\\\",\\r\\n    RecommendationId = \\\"defender-server-001\\\",\\r\\n    ImplementationImpact = \\\"High\\\",\\r\\n    ImplementationComplexity = \\\"Low\\\",\\r\\n    type = \\\"microsoft.compute/virtualmachines\\\"\\r\\n| project id = vmId, type, Recommendation, RecommendationId, ImplementationImpact, ImplementationComplexity\\r\\n| join kind=leftouter (\\r\\n    resources\\r\\n    | where type =~ \\\"microsoft.compute/virtualmachines\\\"\\r\\n        and resourceGroup in ({ResourceGroup})\\r\\n    | summarize Total = count()\\r\\n    | extend type = \\\"microsoft.compute/virtualmachines\\\"\\r\\n) on type\\r\\n| summarize ImpactedCount = count() by RecommendationId, type, Recommendation, ImplementationImpact, ImplementationComplexity, Total\\r\\n| extend ImpactedResources = strcat(ImpactedCount, '/', Total)\\r\\n| project Recommendation, type, ImpactedResources, ImplementationImpact, ImplementationComplexity\",\"size\":0,\"title\":\"Recommendation by Impact\",\"noDataMessage\":\"All of your VMs are protected with Defender for Servers\",\"noDataMessageStyle\":3,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"visualization\":\"tiles\",\"sortBy\":[],\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"Recommendation\"},\"subtitleContent\":{\"columnMatch\":\"type\"},\"leftContent\":{\"columnMatch\":\"ImpactedResources\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"tooltipFormat\":{\"tooltip\":\"Number of impacted resources / Total resources\"}},\"secondaryContent\":{\"columnMatch\":\"RecommendationId\"},\"showBorder\":true,\"size\":\"auto\",\"styleSettings\":{\"borderStyle\":\"rounded\"}}},\"name\":\"visualImplementationImpact-Defender\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"// Query to show VMs without Defender for Server protection (no security assessments)\\r\\n// Get total VM count first\\r\\nresources\\r\\n| where type =~ \\\"microsoft.compute/virtualmachines\\\"\\r\\n    and resourceGroup in ({ResourceGroup})\\r\\n| summarize TotalVMs = count()\\r\\n| extend type = \\\"microsoft.compute/virtualmachines\\\"\\r\\n| join kind=leftouter (\\r\\n    // Get unprotected VMs (no security assessments)\\r\\n    resources\\r\\n    | where type =~ \\\"microsoft.compute/virtualmachines\\\"\\r\\n        and resourceGroup in ({ResourceGroup})\\r\\n    | extend vmId = tolower(id)\\r\\n    | join kind=leftouter (\\r\\n        securityresources\\r\\n        | where type == \\\"microsoft.security/assessments\\\"\\r\\n        | where properties.resourceDetails.ResourceType =~ \\\"microsoft.compute/virtualmachines\\\"\\r\\n        | extend vmId = tolower(tostring(properties.resourceDetails.Id))\\r\\n        | summarize hasAssessments = count() by vmId\\r\\n    ) on vmId\\r\\n    | where isempty(hasAssessments)\\r\\n    | summarize UnprotectedCount = count()\\r\\n    | extend type = \\\"microsoft.compute/virtualmachines\\\"\\r\\n) on type\\r\\n| extend \\r\\n    ImpactedCount = coalesce(toint(UnprotectedCount), 0),\\r\\n    Recommendation = iff(coalesce(toint(UnprotectedCount), 0) == 0, \\r\\n        strcat(\\\"âœ“ All \\\", TotalVMs, \\\" VMs in scope are protected\\\"),\\r\\n        \\\"Enable Defender for Server\\\"),\\r\\n    RecommendationId = \\\"defender-server-001\\\",\\r\\n    ImplementationImpact = iff(coalesce(toint(UnprotectedCount), 0) == 0, \\\"N/A\\\", \\\"High\\\"),\\r\\n    ImplementationComplexity = iff(coalesce(toint(UnprotectedCount), 0) == 0, \\\"N/A\\\", \\\"Low\\\"),\\r\\n    ImpactedResources = iff(coalesce(toint(UnprotectedCount), 0) == 0,\\r\\n        strcat(\\\"0/\\\", TotalVMs, \\\" (All Protected)\\\"),\\r\\n        strcat(coalesce(toint(UnprotectedCount), 0), '/', TotalVMs))\\r\\n| project Recommendation, type, ImpactedResources, ImplementationImpact, ImplementationComplexity\",\"size\":0,\"showAnalytics\":true,\"title\":\"Defender for Cloud recommendations\",\"showRefreshButton\":true,\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"sortBy\":[{\"itemKey\":\"ImplementationComplexity\",\"sortOrder\":1}]},\"sortBy\":[{\"itemKey\":\"ImplementationComplexity\",\"sortOrder\":1}]},\"name\":\"Executive insights-Defender\"}]},\"conditionalVisibility\":{\"parameterName\":\"SelectedSubTab\",\"comparison\":\"isEqualTo\",\"value\":\"Overview\"},\"name\":\"groupOverviewDefender\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"> **Note:** Cost estimation is based on Defender for Cloud Server Plan 2, using pay-as-you-go pricing for East US as of September 2025.\",\"style\":\"upsell\"},\"name\":\"text - 2\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"understand-cost-calc-yesno\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"understandCostCalculations\",\"label\":\"Show Defender cost calculation details?\",\"type\":2,\"isRequired\":true,\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"jsonData\":\"[\\r\\n    {\\r\\n    \\\"value\\\" : \\\"Yes\\\",\\r\\n    \\\"label\\\" : \\\"Yes\\\"\\r\\n    },\\r\\n    {\\r\\n    \\\"value\\\" : \\\"No\\\",\\r\\n    \\\"label\\\" : \\\"No\\\",\\r\\n    \\\"selected\\\" : true\\r\\n    }\\r\\n]\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"Show Cost Calculation Details\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"a1a1ed79-dd3e-4c78-bde6-2427b0606874\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"defenderforServeragent\",\"label\":\"Defender for  Server agent cost\",\"type\":1,\"timeContext\":{\"durationMs\":86400000},\"value\":\"14.6\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"understandCostCalculations\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"param-DefenderPrice\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"// Query to list NOT protected VMs (VMs without security assessments)\\r\\nresources\\r\\n| where type =~ \\\"microsoft.compute/virtualmachines\\\"\\r\\n| extend vmId = tolower(id)\\r\\n| join kind=leftouter (\\r\\n    securityresources\\r\\n    | where type == \\\"microsoft.security/assessments\\\"\\r\\n    | where properties.resourceDetails.ResourceType =~ \\\"microsoft.compute/virtualmachines\\\"\\r\\n    | extend vmId = tolower(tostring(properties.resourceDetails.Id))\\r\\n    | summarize hasAssessments = count() by vmId\\r\\n) on vmId\\r\\n| where isempty(hasAssessments)\\r\\n| project \\r\\n    vmName = name,\\r\\n    resourceGroup,\\r\\n    location,\\r\\n    subscriptionId,\\r\\n    protectionStatus = \\\"Not Protected\\\"\\r\\n| order by vmName asc\\r\\n// Cost calculation\\r\\n| extend AgentCost       = todouble({defenderforServeragent})\\r\\n| project vmName, subscriptionId, resourceGroup, location, AgentCost\\r\\n| order by subscriptionId, resourceGroup, vmName\",\"size\":0,\"title\":\"VMs without Defender for Cloud\",\"noDataMessage\":\"All of your VMs are protected.\",\"noDataMessageStyle\":3,\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"AgentCost\",\"formatter\":0,\"tooltipFormat\":{\"tooltip\":\"Estimate based on Defender for Cloud Plan 2, East US pay-as-you-go (Sep 2025).\"}}],\"sortBy\":[{\"itemKey\":\"resourceGroup\",\"sortOrder\":1}]},\"sortBy\":[{\"itemKey\":\"resourceGroup\",\"sortOrder\":1}]},\"name\":\"queryVMDefender\"}]},\"conditionalVisibility\":{\"parameterName\":\"SelectedSubTab\",\"comparison\":\"isEqualTo\",\"value\":\"Details\"},\"name\":\"groupDefenderforCloudDetails\"}]},\"conditionalVisibility\":{\"parameterName\":\"SelectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Security\"},\"name\":\"groupSecurity\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Monitor\",\"items\":[{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"tabs\",\"links\":[{\"id\":\"ca40468d-4518-43bf-ac6e-0a11d7331e12\",\"cellValue\":\"SelectedSubTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Overview\",\"subTarget\":\"Overview\",\"style\":\"link\"},{\"id\":\"f280fc2a-f42a-42a4-ad4b-be37ab3e8b48\",\"cellValue\":\"SelectedSubTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Details\",\"subTarget\":\"Details\",\"style\":\"link\"}]},\"name\":\"links - defenderSubTab\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"# Monitoring\\r\\n## Monitoring Best Practice Checks\\r\\nThis section assesses your Azure resources for adherence to monitoring best practices. Recommendations focus on ensuring that logging, alerting, and observability are properly configured, enabling proactive detection and response to issues. Implementing these recommendations helps maintain visibility into your environment and supports operational excellence.\",\"style\":\"upsell\"},\"name\":\"text - Monitoring\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where type =~ 'microsoft.compute/virtualmachines'\\r\\n    and resourceGroup in ({ResourceGroup})\\r\\n| project vmId = tolower(id), vmName = name, subscriptionId, resourceGroup, location, type\\r\\n| join kind=leftouter (\\r\\n    resources\\r\\n    | where type =~ 'microsoft.compute/virtualmachines/extensions'\\r\\n    | where name =~ 'AzureMonitorWindowsAgent' or name =~ 'AzureMonitorLinuxAgent'\\r\\n    | extend vmId = tolower(split(id, '/extensions/')[0])\\r\\n    | project vmId, hasAMA = true\\r\\n) on vmId\\r\\n| extend hasAMA = iff(isnull(hasAMA), false, true)\\r\\n| extend\\r\\n    Recommendation = iff(hasAMA, \\\"VM has Azure Monitor Agent installed\\\", \\\"Install Azure Monitor Agent\\\"),\\r\\n    RecommendationId = \\\"f25343b5-b3c1-406c-a362-38dd97239733\\\",\\r\\n    ImplementationImpact = \\\"High\\\",\\r\\n    ImplementationComplexity = \\\"Low\\\",\\r\\n    type = \\\"microsoft.compute/virtualmachines\\\"\\r\\n| where hasAMA == false\\r\\n| join kind=leftouter (\\r\\n    resources\\r\\n    | where type =~ 'microsoft.compute/virtualmachines'\\r\\n       and resourceGroup in ({ResourceGroup})\\r\\n    | summarize Total = count()\\r\\n    | extend type = \\\"microsoft.compute/virtualmachines\\\"\\r\\n) on type\\r\\n| summarize ImpactedCount = count() by RecommendationId, type, Recommendation, ImplementationImpact, ImplementationComplexity, Total\\r\\n| extend ImpactedResources = strcat(ImpactedCount, '/', Total)\\r\\n| project Recommendation, type, ImpactedResources, ImplementationImpact, ImplementationComplexity\",\"size\":0,\"title\":\"Recommendation by Impact\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"visualization\":\"tiles\",\"sortBy\":[],\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"Recommendation\"},\"subtitleContent\":{\"columnMatch\":\"type\"},\"leftContent\":{\"columnMatch\":\"ImpactedResources\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"tooltipFormat\":{\"tooltip\":\"Number of impacted resources / Total resources\"}},\"secondaryContent\":{\"columnMatch\":\"RecommendationId\"},\"showBorder\":true,\"size\":\"auto\",\"styleSettings\":{\"borderStyle\":\"rounded\"}}},\"name\":\"visualImplementationImpact-Defender\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where type =~ 'microsoft.compute/virtualmachines'\\r\\n    and resourceGroup in ({ResourceGroup})\\r\\n| project vmId = tolower(id), vmName = name, subscriptionId, resourceGroup, location, type\\r\\n| join kind=leftouter (\\r\\n    resources\\r\\n    | where type =~ 'microsoft.compute/virtualmachines/extensions'\\r\\n    | where name =~ 'AzureMonitorWindowsAgent' or name =~ 'AzureMonitorLinuxAgent'\\r\\n    | extend vmId = tolower(split(id, '/extensions/')[0])\\r\\n    | project vmId, hasAMA = true\\r\\n) on vmId\\r\\n| extend hasAMA = iff(isnull(hasAMA), false, true)\\r\\n| extend\\r\\n    Recommendation = iff(hasAMA, \\\"VM has Azure Monitor Agent installed\\\", \\\"Install Azure Monitor Agent\\\"),\\r\\n    RecommendationId = \\\"f25343b5-b3c1-406c-a362-38dd97239733\\\",\\r\\n    ImplementationImpact = \\\"High\\\",\\r\\n    ImplementationComplexity = \\\"Low\\\",\\r\\n    type = \\\"microsoft.compute/virtualmachines\\\"\\r\\n| where hasAMA == false\\r\\n| join kind=leftouter (\\r\\n    resources\\r\\n    | where type =~ 'microsoft.compute/virtualmachines'\\r\\n       and resourceGroup in ({ResourceGroup})\\r\\n    | summarize Total = count()\\r\\n    | extend type = \\\"microsoft.compute/virtualmachines\\\"\\r\\n) on type\\r\\n| summarize ImpactedCount = count() by RecommendationId, type, Recommendation, ImplementationImpact, ImplementationComplexity, Total\\r\\n| extend ImpactedResources = strcat(ImpactedCount, '/', Total)\\r\\n| project Recommendation, type, ImpactedResources, ImplementationImpact, ImplementationComplexity\",\"size\":0,\"showAnalytics\":true,\"title\":\"Azure Monitor recommendations\",\"showRefreshButton\":true,\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"sortBy\":[{\"itemKey\":\"ImplementationComplexity\",\"sortOrder\":1}]},\"sortBy\":[{\"itemKey\":\"ImplementationComplexity\",\"sortOrder\":1}]},\"name\":\"Executive insights-Azure Monitor\"}]},\"conditionalVisibility\":{\"parameterName\":\"SelectedSubTab\",\"comparison\":\"isEqualTo\",\"value\":\"Overview\"},\"name\":\"groupOverviewDefender\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"Note: Azure Monitor Agent installation is free. Costs depend on data collection configuration, Log Analytics workspace usage, data ingestion volume, and retention settings. Monitoring costs vary significantly based on workload and compliance requirements. For detailed pricing, see [Azure Pricing Calculator](https://azure.microsoft.com/en-us/pricing/calculator/).\",\"style\":\"upsell\"},\"name\":\"text - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where type =~ 'microsoft.compute/virtualmachines'\\r\\n    and resourceGroup in ({ResourceGroup})\\r\\n| project vmId = tolower(id), vmName = name, subscriptionId, resourceGroup, location, type\\r\\n| join kind=leftouter (\\r\\n    resources\\r\\n    | where type =~ 'microsoft.compute/virtualmachines/extensions'\\r\\n    | where name =~ 'AzureMonitorWindowsAgent' or name =~ 'AzureMonitorLinuxAgent'\\r\\n    | extend vmId = tolower(split(id, '/extensions/')[0])\\r\\n    | project vmId, hasAMA = true\\r\\n) on vmId\\r\\n| extend hasAMA = iff(isnull(hasAMA), false, true)\\r\\n| extend\\r\\n    Recommendation = iff(hasAMA, \\\"VM has Azure Monitor Agent installed\\\", \\\"Install Azure Monitor Agent\\\"),\\r\\n    RecommendationId = \\\"f25343b5-b3c1-406c-a362-38dd97239733\\\",\\r\\n    ImplementationImpact = \\\"High\\\",\\r\\n    ImplementationComplexity = \\\"Low\\\",\\r\\n    type = \\\"microsoft.compute/virtualmachines\\\"\\r\\n| where hasAMA == false\\r\\n| join kind=leftouter (\\r\\n    resources\\r\\n    | where type =~ 'microsoft.compute/virtualmachines'\\r\\n       and resourceGroup in ({ResourceGroup})\\r\\n    | summarize Total = count()\\r\\n    | extend type = \\\"microsoft.compute/virtualmachines\\\"\\r\\n) on type\\r\\n//| summarize ImpactedCount = count() by RecommendationId, type, Recommendation, ImplementationImpact, ImplementationComplexity, Total\\r\\n//| extend ImpactedResources = strcat(ImpactedCount, '/', Total)\\r\\n| project vmName, Recommendation,resourceGroup,subscriptionId, ImplementationImpact, ImplementationComplexity\",\"size\":0,\"title\":\"VMs without Azure Monitor AgentðŸ”´ [No Cost Est.] \",\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"vmName\",\"formatter\":13,\"formatOptions\":{\"linkTarget\":null,\"showIcon\":true}},{\"columnMatch\":\"resourceGroup\",\"formatter\":14,\"formatOptions\":{\"linkTarget\":null,\"showIcon\":true}},{\"columnMatch\":\"subscriptionId\",\"formatter\":15,\"formatOptions\":{\"linkTarget\":null,\"showIcon\":true}}]}},\"name\":\"queryAMA\"}]},\"conditionalVisibility\":{\"parameterName\":\"SelectedSubTab\",\"comparison\":\"isEqualTo\",\"value\":\"Details\"},\"name\":\"groupMonitorDetails\"}]},\"conditionalVisibility\":{\"parameterName\":\"SelectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Monitor\"},\"name\":\"groupMonitor\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"# Workload Availability Zones Coverage Details\\r\\n\\r\\n>NOTE: You will find detailed insights into your scoped workloads specific configuration relating to Availability Zones. \",\"style\":\"upsell\"},\"name\":\"text - 6\"},{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"tabs\",\"links\":[{\"id\":\"b95af288-2738-4afa-87b9-eed0f729f3fe\",\"cellValue\":\"selectedDetailsTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Network Services\",\"subTarget\":\"network\",\"style\":\"link\"},{\"id\":\"847aefe6-be4a-4033-85e0-c74ab570ad1e\",\"cellValue\":\"selectedDetailsTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Data Services\",\"subTarget\":\"Data\",\"style\":\"link\"},{\"id\":\"499fa94f-a180-4cbb-8a77-79a43a965d0e\",\"cellValue\":\"selectedDetailsTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Storage Services\",\"subTarget\":\"storage\",\"style\":\"link\"},{\"id\":\"866bc76f-c9f2-4bec-a5a1-7893fd298179\",\"cellValue\":\"selectedDetailsTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Compute Services\",\"subTarget\":\"compute\",\"preText\":\"Compute\",\"style\":\"link\"},{\"id\":\"ac71eb6a-a601-4d10-a6ae-7a5a0cecc4da\",\"cellValue\":\"selectedDetailsTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Integration Services\",\"subTarget\":\"integrationServices\",\"style\":\"link\"},{\"id\":\"f7fe5554-b6cd-41e1-ba69-6b480ea4db15\",\"cellValue\":\"selectedDetailsTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"App Services\",\"subTarget\":\"app\",\"style\":\"link\"},{\"id\":\"6bb1d5e2-1063-49c5-943a-f61f94e98271\",\"cellValue\":\"selectedDetailsTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Container Services\",\"subTarget\":\"containerServices\",\"style\":\"link\"}]},\"name\":\"links - 4\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Azure Networking Services Availability Zone Coverage\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"{Subscription}\"],\"parameters\":[{\"id\":\"14bb128f-5b3f-421a-9cf7-b9ad71ece3f6\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"CheckforPublicIPs\",\"type\":1,\"isRequired\":true,\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'Microsoft.Network/publicIPAddresses'\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend locations = properties.locations\\r\\n| extend zones = zones\\r\\n| extend zoneRedundant = iif(array_length(zones) >= 2, true, false)\\r\\n//| where zoneRedundant == false\\r\\n| join kind = innerunique (\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n)\\r\\n    on id\\r\\n| summarize PublicIPCount = count()\\r\\n| extend HasNonZonalPublicIPs = iff(PublicIPCount > 0, \\\"Yes\\\", \\\"No\\\")\\r\\n| project HasNonZonalPublicIPs\",\"crossComponentResources\":[\"{Subscription}\"],\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"version\":\"KqlParameterItem/1.0\",\"name\":\"CheckForAppG\",\"type\":1,\"isRequired\":true,\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ \\\"microsoft.network/applicationGateways\\\"\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend locations=properties.locations\\r\\n| extend zoneRedundant = iif(array_length(zones) >= 2, \\\"true\\\", \\\"false\\\")\\r\\n//| where zoneRedundant == \\\"false\\\"\\r\\n| join kind = innerunique( //Tag filter\\r\\nresources\\r\\n| extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n| extend replaced_tags = parse_json(replaced_tags)\\r\\n| mv-expand replaced_tags\\r\\n| extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n| extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId=id\\r\\n| where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n)\\r\\non id\\r\\n| summarize AppGWCount = count()\\r\\n| extend HasNonZonalAppGW = iff(AppGWCount > 0, \\\"Yes\\\", \\\"No\\\")\\r\\n| project HasNonZonalAppGW\",\"crossComponentResources\":[\"{Subscription}\"],\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"id\":\"e3840b2b-7a2c-4f62-82d4-9fd03c2593b6\"},{\"version\":\"KqlParameterItem/1.0\",\"name\":\"CheckforLB\",\"type\":1,\"isRequired\":true,\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ \\\"microsoft.network/loadbalancers\\\" and tolower(sku.name) != 'basic'\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend locations = properties.locations\\r\\n| extend zones = zones\\r\\n| extend zoneRedundant = iif(array_length(zones) >= 2, \\\"true\\\", \\\"false\\\")\\r\\n//| where zoneRedundant == \\\"false\\\"\\r\\n| join kind = innerunique( //Tag filter\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId=id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n    | distinct id  // Add this line to deduplicate before join\\r\\n    )\\r\\n    on id\\r\\n| summarize LBCount = count()\\r\\n| extend HasNonZonalAppGW = iff(LBCount > 0, \\\"Yes\\\", \\\"No\\\")\\r\\n| project HasNonZonalAppGW\",\"crossComponentResources\":[\"{Subscription}\"],\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"id\":\"254e8fad-3f80-4164-8d2c-4733d9d03f75\"},{\"version\":\"KqlParameterItem/1.0\",\"name\":\"CheckforVPNGW\",\"type\":1,\"isRequired\":true,\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'Microsoft.Network/virtualNetworkGateways'\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend skuName = tostring(properties.sku.name)\\r\\n| extend skuTier = tostring(properties.sku.tier)\\r\\n| extend gatewayType = tostring(properties.gatewayType)\\r\\n| extend zoneRedundant = iif(skuName contains 'AZ' or skuTier contains 'AZ', true, false)\\r\\n//| where zoneRedundant == false\\r\\n| join kind = innerunique (\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n    | distinct id\\r\\n)\\r\\n    on id\\r\\n| summarize VPNGWCount = count()\\r\\n| extend HasNonZonalVPNGateways = iff(VPNGWCount > 0, \\\"Yes\\\", \\\"No\\\")\\r\\n| project HasNonZonalVPNGateways\",\"crossComponentResources\":[\"{Subscription}\"],\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"id\":\"50b153e7-f61d-42ff-b35e-5abd5f531097\"},{\"version\":\"KqlParameterItem/1.0\",\"name\":\"CheckforFirewall\",\"type\":1,\"isRequired\":true,\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type == 'microsoft.network/azurefirewalls'\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend \\r\\n    currentZoneRedundant = case(\\r\\n        array_length(zones) >= 2, true,\\r\\n        false  // Single zone or no zones\\r\\n    )\\r\\n//| where currentZoneRedundant == false  // Only non-zone-redundant instances\\r\\n| join kind = innerunique (\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n)\\r\\n    on id\\r\\n| summarize AzureFirewallCount = count()\\r\\n| extend HasNonZonalAzureFirewall = iff(AzureFirewallCount > 0, \\\"Yes\\\", \\\"No\\\")\\r\\n| project HasNonZonalAzureFirewall\",\"crossComponentResources\":[\"{Subscription}\"],\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"id\":\"a0c4f959-bcd0-4437-b6f2-137a59eafac3\"},{\"version\":\"KqlParameterItem/1.0\",\"name\":\"CheckforBastion\",\"type\":1,\"isRequired\":true,\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ \\\"microsoft.network/bastionhosts\\\"\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend \\r\\n    currentZoneRedundant = case(\\r\\n        array_length(zones) >= 2, true,  // Only 2+ zones are truly redundant\\r\\n        false  // Single zone or no zones are not redundant\\r\\n    )\\r\\n//| where currentZoneRedundant == false  // Only non-zone-redundant instances\\r\\n| join kind = innerunique (\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n)\\r\\n    on id\\r\\n| summarize BastionCount = count()\\r\\n| extend HasNonZonalBastion = iff(BastionCount > 0, \\\"Yes\\\", \\\"No\\\")\\r\\n| project HasNonZonalBastion\",\"crossComponentResources\":[\"{Subscription}\"],\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"id\":\"65162e53-e132-42c5-bdcf-4ee62ff97f2d\"}],\"style\":\"pills\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},\"conditionalVisibility\":{\"parameterName\":\"AlwaysHidden\",\"comparison\":\"isEqualTo\",\"value\":\"yes\"},\"name\":\"paramCheckNetworkAzResources\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type == 'microsoft.network/azurefirewalls'\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend locations=properties.locations\\r\\n| extend skuTier = tostring(sku.tier)\\r\\n| extend skuName = tostring(sku.name)\\r\\n| extend zonesConfigured = tostring(zones)\\r\\n| extend zoneCount = array_length(zones)\\r\\n| extend zoneRedundant = iff(zoneCount >= 2, true, false)  // Must have 2+ zones for redundancy\\r\\n| where zoneRedundant ==\\\"false\\\"\\r\\n| join kind = innerunique( //Tag filter\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}'])\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n    | project id\\r\\n    )\\r\\n    on id\\r\\n| extend EstimatedMonthlyCost = 0.0  // No additional cost for zone redundancy\\r\\n| extend \\r\\n    Recommendation = case(\\r\\n        zoneRedundant, 'No action needed - Zone redundancy configured (99.99% SLA)',\\r\\n        zoneCount == 1, 'Redeploy firewall with multi-zone configuration for 99.99% SLA',\\r\\n        zoneCount == 0 or isnull(zones), 'Redeploy firewall with zone redundancy for 99.99% SLA',\\r\\n        'Review firewall zone configuration'\\r\\n    ),\\r\\n    ImplementationImpact = case(\\r\\n        zoneRedundant, 'None',\\r\\n        'High'  // All non-redundant cases require redeployment\\r\\n    ),\\r\\n    ImplementationComplexity = case(\\r\\n        zoneRedundant, 'None',\\r\\n        'High'  // All non-redundant cases require full redeployment\\r\\n    ),\\r\\n    CostEstimation = 'ðŸŸ¢ [Cost Est.] No additional cost - Redeployment required'\\r\\n| project \\r\\n    Resource=name,\\r\\n    ZoneCount=zoneCount,\\r\\n    ZoneConfigured=zoneRedundant,\\r\\n    AvailabilityZones=zonesConfigured,\\r\\n    ResourceGroup=resourceGroup,\\r\\n    CurrentSLA=iff(zoneRedundant, '99.99%', '99.95%'),\\r\\n    Recommendation,\\r\\n        ImplementationImpact,\\r\\n    ImplementationComplexity,\\r\\n    EstimatedMonthlyCost,\\r\\n    SubscriptionId=subscriptionId,\\r\\n    Location=location\\r\\n| order by Resource asc\",\"size\":0,\"title\":\"Azure FirewallsðŸŸ¢ [Cost Est.] No additional cost\",\"noDataMessage\":\"All Azure Firewalls have availabilty zones configured\",\"noDataMessageStyle\":3,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"zoneRedundant\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"true\",\"representation\":\"success\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"failed\",\"text\":\"{0}{1}\"}]}}]}},\"name\":\"query-azFW\"},{\"type\":1,\"content\":{\"json\":\"**Note:** Cost based on East US rates (Sep 2025). No additional infrastructure cost for zone redundancy â€” redeployment planning required. For detailed pricing, see [Azure Pricing Calculator](https://azure.microsoft.com/en-us/pricing/calculator/).\",\"style\":\"info\"},\"name\":\"text - 3\"}]},\"conditionalVisibility\":{\"parameterName\":\"CheckforFirewall\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"groupAzureFW\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"understand-cost-calc-yesno\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"understandCostCalculations\",\"label\":\"Show App GW cost calculation details?\",\"type\":2,\"defaultValue\":\"No\",\"values\":[{\"label\":\"Yes\",\"value\":\"Yes\"},{\"label\":\"No\",\"value\":\"No\"}]}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"Show Cost Calculation Details\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"a1a1ed79-dd3e-4c78-bde6-2427b0606874\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"AppGWperhour\",\"label\":\"App Gateway per hour\",\"type\":1,\"timeContext\":{\"durationMs\":86400000},\"value\":\"0.20\"},{\"version\":\"KqlParameterItem/1.0\",\"name\":\"CapacityUnitperhour\",\"type\":1,\"timeContext\":{\"durationMs\":86400000},\"label\":\"Capacity unit per hour\",\"id\":\"6c68dc7d-6b7e-4629-8595-978cf44a14fb\",\"value\":\"0.008\"},{\"version\":\"KqlParameterItem/1.0\",\"name\":\"OutboundDataTransferGb\",\"type\":1,\"timeContext\":{\"durationMs\":86400000},\"value\":\"101\",\"id\":\"865b9bac-a29a-49ab-816f-bcfbcc03456c\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"understandCostCalculations\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"param-AppGWPrice\"},{\"type\":1,\"content\":{\"json\":\"### How Application Gateway Cost is Calculated\\r\\n\\r\\n**Monthly Cost Formula:**\\r\\n- **Gateway Hours:** Application Gateway cost per hour Ã— 730 hours\\r\\n- **Capacity Units:** Capacity Unit cost per hour Ã— 730 hours  \\r\\n- **Data Transfer:** Tiered pricing based on monthly outbound data transfer\\r\\n\\r\\n**Data Transfer Pricing Tiers:**\\r\\n- First 100 GB: Free\\r\\n- Next 10 TB: $0.04 per GB\\r\\n- Next 40 TB: $0.08 per GB\\r\\n- Next 100 TB: $0.04 per GB\\r\\n- Next 350 TB: $0.065 per GB\\r\\n\\r\\n**Default Assumptions:**\\r\\n- Application Gateway: $0.125/hour\\r\\n- Capacity Unit: $0.008/hour\\r\\n- Outbound Data Transfer: 1,000 GB/month\\r\\n- Pricing based on North America/Europe regions (September 2025)\\r\\n\\r\\nYou can adjust these parameters above to match your specific usage patterns and get a more accurate cost estimate.\",\"style\":\"info\"},\"conditionalVisibility\":{\"parameterName\":\"UdnerstandCostCalculations\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"text-appgwcosts\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ \\\"microsoft.network/applicationGateways\\\"\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend locations = properties.locations\\r\\n| extend zoneRedundant = iif(array_length(zones) >= 2, \\\"true\\\", \\\"false\\\")\\r\\n| where zoneRedundant == \\\"false\\\"\\r\\n| join kind = innerunique( //Tag filter\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId=id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n    )\\r\\n    on id\\r\\n// Cost calculation for outbound data transfer with tiered pricing\\r\\n| extend outboundDataGB = todouble({OutboundDataTransferGb})\\r\\n| extend dataTransferCost = case(\\r\\n    outboundDataGB <= 100, 0.0,  // First 100 GB free\\r\\n    outboundDataGB <= 10340, (outboundDataGB - 100) * 0.04,  // Next 10 TB at $0.04/GB\\r\\n    outboundDataGB <= 51440, ((10340 - 100) * 0.04) + ((outboundDataGB - 10340) * 0.08),  // Next 40 TB at $0.08/GB\\r\\n    outboundDataGB <= 153840, ((10340 - 100) * 0.04) + ((51440 - 10340) * 0.08) + ((outboundDataGB - 51440) * 0.04),  // Next 100 TB at $0.04/GB\\r\\n    ((10340 - 100) * 0.04) + ((51440 - 10340) * 0.08) + ((153840 - 51440) * 0.04) + ((outboundDataGB - 153840) * 0.065)  // Next 350 TB at $0.065/GB\\r\\n)\\r\\n// Total cost calculation\\r\\n| extend EstimatedMonthlyCost = (todouble({AppGWperhour}) * 730) + (todouble({CapacityUnitperhour}) * 730) + dataTransferCost\\r\\n| extend \\r\\n    Recommendation = \\\"Enable Application Gateway Zone Redundancy\\\",\\r\\n    ImplementationImpact = \\\"High\\\",\\r\\n    ImplementationComplexity = \\\"Medium\\\"\\r\\n| project Recommendation, name, location, EstimatedMonthlyCost, dataTransferCost, resourceGroup, \\r\\n         ImplementationImpact, ImplementationComplexity, subscriptionId, zoneRedundant\\r\\n| sort by name asc\",\"size\":0,\"title\":\"Application Gateways\",\"noDataMessage\":\"All Application Gateways have availability zones configured\",\"noDataMessageStyle\":3,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"zoneRedundant\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"true\",\"representation\":\"success\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"failed\",\"text\":\"{0}{1}\"}]}}]}},\"name\":\"query-app-gateways\"},{\"type\":1,\"content\":{\"json\":\"**Cost Estimate:** Monthly Application Gateway cost (Gateway + Capacity Units + Data Transfer) based on East US pay-as-you-go rates, September 2025. Assumes $0.125/hr Gateway, $0.008/hr Capacity Units, 1TB/month data transfer. For precise costs, see the [Azure Pricing Calculator](https://azure.microsoft.com/en-us/pricing/calculator/).\",\"style\":\"info\"},\"name\":\"text - 3\"}]},\"name\":\"groupAppGateway\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"understand-cost-calc-yesno\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"understandCostCalculations\",\"label\":\"Show PublicIp cost calculation details?\",\"type\":2,\"isRequired\":true,\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"jsonData\":\"[\\r\\n    {\\r\\n    \\\"value\\\" : \\\"Yes\\\",\\r\\n    \\\"label\\\" : \\\"Yes\\\"\\r\\n    },\\r\\n    {\\r\\n    \\\"value\\\" : \\\"No\\\",\\r\\n    \\\"label\\\" : \\\"No\\\",\\r\\n    \\\"selected\\\" : true\\r\\n    }\\r\\n]\",\"value\":\"Yes\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"Show Cost Calculation Details\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"a1a1ed79-dd3e-4c78-bde6-2427b0606874\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"PIPPerHour\",\"label\":\"Price Public IP per hour\",\"type\":1,\"timeContext\":{\"durationMs\":86400000},\"value\":\"0.005\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"understandCostCalculations\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"param-PIPPrice\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ \\\"Microsoft.Network/publicIPAddresses\\\"\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend locations = properties.locations\\r\\n| extend zones = zones\\r\\n| extend zoneRedundant = iif(array_length(zones) >= 2, \\\"true\\\", \\\"false\\\")\\r\\n| where zoneRedundant == \\\"false\\\"\\r\\n| join kind = innerunique( //Tag filter\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId=id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n    )\\r\\n    on id\\r\\n| extend \\r\\n    ImplementationImpact = \\\"High\\\",\\r\\n    ImplementationComplexity = \\\"Low\\\",\\r\\n    EstimatedCost = todouble({PIPPerHour}) * 730\\r\\n| distinct id,name,zoneRedundant,ImplementationImpact,ImplementationComplexity,EstimatedCost,resourceGroup,subscriptionId,location\",\"size\":0,\"title\":\"Azure Public IPs\",\"noDataMessage\":\"All Azure Public IPs have availability zones configured\",\"noDataMessageStyle\":3,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"zoneRedundant\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"false\",\"representation\":\"failed\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"success\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"EstimatedCost\",\"formatter\":0,\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\"}}}]}},\"name\":\"query-publicIPs\"},{\"type\":1,\"content\":{\"json\":\"> **Note:** Cost estimation is based on a Standard Public IP address, using pay-as-you-go pricing for East US as of September 2025. For more precise estimates (including other SKUs and configurations), please visit the [Azure Pricing Calculator](https://azure.microsoft.com/pricing/calculator/).\",\"style\":\"info\"},\"name\":\"text - public-ip\"}]},\"conditionalVisibility\":{\"parameterName\":\"CheckforPublicIPs\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"groupPublicIp\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"understand-cost-calc-yesno\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"understandCostCalculations\",\"label\":\"Show VPN Gateway cost calculation details?\",\"type\":2,\"isRequired\":true,\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"jsonData\":\"[\\r\\n    {\\r\\n    \\\"value\\\" : \\\"Yes\\\",\\r\\n    \\\"label\\\" : \\\"Yes\\\"\\r\\n    },\\r\\n    {\\r\\n    \\\"value\\\" : \\\"No\\\",\\r\\n    \\\"label\\\" : \\\"No\\\",\\r\\n    \\\"selected\\\" : true\\r\\n    }\\r\\n]\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"Show Cost Calculation Details\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"265124d1-abff-4c14-ae87-56bae2ec3aaf\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"s2stunnels\",\"label\":\"Number of Site-to-Site Tunnels\",\"type\":1,\"timeContext\":{\"durationMs\":86400000},\"value\":\"5\"},{\"version\":\"KqlParameterItem/1.0\",\"name\":\"P2SConnections\",\"label\":\"Number of Point-to-Site Connections\",\"type\":1,\"timeContext\":{\"durationMs\":86400000},\"value\":\"50\",\"id\":\"eb065df2-ab87-43cb-a65b-8e354f861f3e\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"understandCostCalculations\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"parameters - 1\"},{\"type\":1,\"content\":{\"json\":\"### How VPN Gateway Cost is Calculated\\r\\n\\r\\n**Monthly Cost Formula:**\\r\\n- **Base Gateway Cost:** Fixed monthly cost based on AZ SKU tier\\r\\n- **Additional S2S Tunnels:** $0.015/hour for tunnels beyond included limit\\r\\n- **Additional P2S Connections:** $0.01/hour for connections beyond 128\\r\\n\\r\\n**SKU Mapping & Base Costs:**\\r\\n- Basic/Standard â†’ VpnGw1AZ: $153.30/month\\r\\n- VpnGw1 â†’ VpnGw1AZ: $153.30/month  \\r\\n- VpnGw2 â†’ VpnGw2AZ: $394.20/month\\r\\n- VpnGw3 â†’ VpnGw3AZ: $1,007.40/month\\r\\n- VpnGw4 â†’ VpnGw4AZ: $1,686.30/month\\r\\n- VpnGw5 â†’ VpnGw5AZ: $2,934.60/month\\r\\n\\r\\n**Included Limits:**\\r\\n- **S2S Tunnels:** First 10 included (VpnGw1-3AZ), first 10 included (VpnGw4-5AZ supports up to 100)\\r\\n- **P2S Connections:** First 128 included for all SKUs\\r\\n\\r\\n**Calculation Example:**\\r\\n- VpnGw2AZ base cost: $394.20/month\\r\\n- 5 S2S tunnels: Free (within 10 limit)\\r\\n- 50 P2S connections: Free (within 128 limit)  \\r\\n- Total monthly cost: $394.20\\r\\n\\r\\n**Default Assumptions:**\\r\\n- S2S Tunnels: 5 tunnels\\r\\n- P2S Connections: 50 connections\\r\\n- East US pricing (September 2025)\\r\\n\\r\\nYou can adjust these parameters above to match your specific gateway configuration.\",\"style\":\"info\"},\"conditionalVisibility\":{\"parameterName\":\"understandCostCalculations\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"text - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ \\\"microsoft.network/virtualnetworkgateways\\\"\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend skuName = tostring(properties.sku.name)\\r\\n| extend skuTier = tostring(properties.sku.tier)\\r\\n| extend skuCapacity = toint(properties.sku.capacity)\\r\\n| extend gatewayType = tostring(properties.gatewayType)\\r\\n| extend locations = properties.locations\\r\\n| extend zoneRedundant = iif(skuName contains 'AZ' or skuTier contains 'AZ', \\\"true\\\", \\\"false\\\")\\r\\n| where zoneRedundant == \\\"false\\\"\\r\\n| join kind = innerunique( //Tag filter\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId=id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n    | distinct id\\r\\n    )\\r\\n    on id\\r\\n// Map current SKU to equivalent AZ SKU and calculate costs\\r\\n| extend equivalentAZSku = case(\\r\\n    skuName =~ \\\"VpnGw1\\\" or skuTier =~ \\\"VpnGw1\\\", \\\"VpnGw1AZ\\\",\\r\\n    skuName =~ \\\"VpnGw2\\\" or skuTier =~ \\\"VpnGw2\\\", \\\"VpnGw2AZ\\\", \\r\\n    skuName =~ \\\"VpnGw3\\\" or skuTier =~ \\\"VpnGw3\\\", \\\"VpnGw3AZ\\\",\\r\\n    skuName =~ \\\"VpnGw4\\\" or skuTier =~ \\\"VpnGw4\\\", \\\"VpnGw4AZ\\\",\\r\\n    skuName =~ \\\"VpnGw5\\\" or skuTier =~ \\\"VpnGw5\\\", \\\"VpnGw5AZ\\\",\\r\\n    skuName =~ \\\"Standard\\\" or skuTier =~ \\\"Standard\\\", \\\"VpnGw1AZ\\\",  // Map Standard to VpnGw1AZ\\r\\n    skuName =~ \\\"Basic\\\" or skuTier =~ \\\"Basic\\\", \\\"VpnGw1AZ\\\",      // Map Basic to VpnGw1AZ\\r\\n    \\\"VpnGw1AZ\\\"  // Default fallback\\r\\n)\\r\\n// Base gateway monthly costs\\r\\n| extend baseGatewayCost = case(\\r\\n    equivalentAZSku =~ \\\"VpnGw1AZ\\\", 153.30,\\r\\n    equivalentAZSku =~ \\\"VpnGw2AZ\\\", 394.20,\\r\\n    equivalentAZSku =~ \\\"VpnGw3AZ\\\", 1007.40,\\r\\n    equivalentAZSku =~ \\\"VpnGw4AZ\\\", 1686.30,\\r\\n    equivalentAZSku =~ \\\"VpnGw5AZ\\\", 2934.60,\\r\\n    153.30  // Default to VpnGw1AZ cost\\r\\n)\\r\\n// Calculate additional tunnel costs (S2S)\\r\\n| extend s2sTunnels = todouble({s2stunnels})\\r\\n| extend s2sTunnelCost = case(\\r\\n    s2sTunnels <= 10, 0.0,  // First 10 included\\r\\n    equivalentAZSku in~ (\\\"VpnGw1AZ\\\", \\\"VpnGw2AZ\\\", \\\"VpnGw3AZ\\\") and s2sTunnels <= 30, (s2sTunnels - 10) * 0.015 * 730,  // 11-30 tunnels\\r\\n    equivalentAZSku in~ (\\\"VpnGw4AZ\\\", \\\"VpnGw5AZ\\\") and s2sTunnels <= 100, (s2sTunnels - 10) * 0.015 * 730,  // 11-100 tunnels\\r\\n    0.0  // Over limit or other cases\\r\\n)\\r\\n// Calculate additional connection costs (P2S)\\r\\n| extend p2sConnections = todouble({P2SConnections})\\r\\n| extend p2sConnectionCost = case(\\r\\n    p2sConnections <= 128, 0.0,  // First 128 included\\r\\n    (p2sConnections - 128) * 0.01 * 730  // Additional connections at $0.01/hour\\r\\n)\\r\\n// Total estimated monthly cost\\r\\n| extend EstimatedMonthlyCost = baseGatewayCost + s2sTunnelCost + p2sConnectionCost\\r\\n| extend \\r\\n    Recommendation = strcat(\\\"Upgrade to \\\", equivalentAZSku, \\\" for Zone Redundancy\\\"),\\r\\n    ImplementationImpact = \\\"High\\\",\\r\\n    ImplementationComplexity = \\\"High\\\"\\r\\n| project name,  resourceGroup,skuName, zoneRedundant,Recommendation, ImplementationImpact, ImplementationComplexity, equivalentAZSku, location, \\r\\n         EstimatedMonthlyCost, baseGatewayCost, s2sTunnelCost, p2sConnectionCost,\\r\\n         subscriptionId \\r\\n| sort by name asc\",\"size\":0,\"title\":\"Azure Virtual Network Gateways\",\"noDataMessage\":\"All Azure Virtual Network Gateways have availability zones configured\",\"noDataMessageStyle\":3,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"zoneRedundant\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"false\",\"representation\":\"failed\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"success\",\"text\":\"{0}{1}\"}]}}],\"rowLimit\":1000,\"filter\":true,\"labelSettings\":[{\"columnId\":\"skuName\",\"label\":\"Current SKU\"}]}},\"name\":\"query-virtual-network-gateway-zones\"},{\"type\":1,\"content\":{\"json\":\"**Cost Estimate:** Monthly VPN Gateway upgrade cost to equivalent AZ SKU based on East US rates, September 2025. Assumes 5 S2S tunnels, 50 P2S connections. For precise costs, see the [Azure Pricing Calculator](https://azure.microsoft.com/en-us/pricing/calculator/).\",\"style\":\"info\"},\"name\":\"text - 3\"}]},\"conditionalVisibility\":{\"parameterName\":\"CheckforVPNGW\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"groups2svpn\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ \\\"microsoft.network/bastionhosts\\\"\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend locations=properties.locations\\r\\n| extend skuName = tostring(sku.name)\\r\\n| extend skuTier = tostring(sku.tier)\\r\\n| extend zonesConfigured = tostring(zones)\\r\\n| extend zoneCount = array_length(zones)\\r\\n| extend zoneRedundant = iff(zoneCount >= 2, true, false)  // Must have 2+ zones for redundancy\\r\\n| join kind = innerunique( //Tag filter\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}'])\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n    | project id\\r\\n    )\\r\\n    on id\\r\\n| extend EstimatedMonthlyCost = 0.0  // No additional cost for zone redundancy\\r\\n| extend \\r\\n    Recommendation = case(\\r\\n        zoneRedundant, 'No action needed - Zone redundancy configured',\\r\\n        zoneCount == 1, 'Redeploy bastion with multi-zone configuration for better resiliency',\\r\\n        zoneCount == 0 or isnull(zones), 'Redeploy bastion with zone redundancy for improved resiliency',\\r\\n        'Review bastion zone configuration'\\r\\n    ),\\r\\n    ImplementationImpact = case(\\r\\n        zoneRedundant, 'None',\\r\\n        'High'  // All non-redundant cases require redeployment\\r\\n    ),\\r\\n    ImplementationComplexity = case(\\r\\n        zoneRedundant, 'None',\\r\\n        'Medium'  // All non-redundant cases require full redeployment\\r\\n    ),\\r\\n    CostEstimation = 'ðŸŸ¢ [Cost Est.] No additional cost - Redeployment required'\\r\\n| project \\r\\n\\r\\n    Resource=name,\\r\\n    SKU=skuName,\\r\\n    ZoneConfigured=zoneRedundant,\\r\\n    ZoneType=case(\\r\\n        zoneRedundant, 'Zone-redundant',\\r\\n        zoneCount == 1, 'Zonal (single zone)',\\r\\n        'No zones configured'\\r\\n    ),\\r\\n        ResourceGroup=resourceGroup,\\r\\n    Recommendation,\\r\\n        ImplementationImpact,\\r\\n    ImplementationComplexity,\\r\\n    CostEstimation,\\r\\n    SubscriptionId=subscriptionId,\\r\\n    Location=location\\r\\n| order by Resource asc\",\"size\":0,\"title\":\"Azure Bastion Hosts ðŸŸ¢ [Cost Est.] No additional cost\",\"noDataMessage\":\"All Azure Bastion Hosts have availability zones configured\",\"noDataMessageStyle\":3,\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"zoneRedundant\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"false\",\"representation\":\"failed\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"success\",\"text\":\"{0}{1}\"}]}}],\"rowLimit\":1000}},\"name\":\"query-bastion-zone-details\"},{\"type\":1,\"content\":{\"json\":\"**Note:** Cost based on East US rates (Sep 2025). No additional infrastructure cost for zone redundancy â€” redeployment planning required. For detailed pricing, see [Azure Pricing Calculator](https://azure.microsoft.com/en-us/pricing/calculator/).\",\"style\":\"info\"},\"name\":\"FooterBastion\"}]},\"conditionalVisibility\":{\"parameterName\":\"CheckforBastion\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"groupBastion\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"understand-cost-calc-yesno\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"understandCostCalculations\",\"label\":\"Show Load Balancer cost calculation details?\",\"type\":2,\"isRequired\":true,\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"jsonData\":\"[\\r\\n    {\\r\\n    \\\"value\\\" : \\\"Yes\\\",\\r\\n    \\\"label\\\" : \\\"Yes\\\"\\r\\n    },\\r\\n    {\\r\\n    \\\"value\\\" : \\\"No\\\",\\r\\n    \\\"label\\\" : \\\"No\\\",\\r\\n    \\\"selected\\\" : true\\r\\n    }\\r\\n]\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"Show Cost Calculation Details\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"a1a1ed79-dd3e-4c78-bde6-2427b0606874\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"NetworkRules\",\"label\":\"Number of rules configured\",\"type\":1,\"timeContext\":{\"durationMs\":86400000},\"value\":\"1\"},{\"version\":\"KqlParameterItem/1.0\",\"name\":\"DataProcessedGb\",\"type\":1,\"timeContext\":{\"durationMs\":86400000},\"value\":\"1000\",\"label\":\"Amount of data processed in GB\",\"id\":\"1816b0b4-55eb-4c0e-a855-143ad394a343\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"understandCostCalculations\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"param-LBPrice\"},{\"type\":1,\"content\":{\"json\":\"### How Load Balancer Cost is Calculated\\r\\n\\r\\n**Monthly Cost Formula:**\\r\\n- **Network Rules:** Tiered pricing based on number of rules\\r\\n- **Data Processing:** $0.005 per GB of processed data\\r\\n\\r\\n**Network Rules Pricing Tiers:**\\r\\n- First 5 rules: $0.025/hour each\\r\\n- Additional rules: $0.01/hour each\\r\\n- Inbound NAT rules: Free\\r\\n\\r\\n**Calculation Example:**\\r\\n- 8 rules = (5 Ã— $0.025 Ã— 730) + (3 Ã— $0.01 Ã— 730) = $91.25 + $21.90 = $113.15/month\\r\\n- 1,000 GB data processing = 1,000 Ã— $0.005 = $5.00/month\\r\\n- Total monthly cost = $113.15 + $5.00 = $118.15\\r\\n\\r\\n**Default Assumptions:**\\r\\n- Network Rules: 5 rules\\r\\n- Data Processed: 1,000 GB/month\\r\\n- Regional Tier pricing (East US, September 2025)\\r\\n\\r\\nYou can adjust these parameters above to match your specific load balancer configuration and get a more accurate cost estimate.\",\"style\":\"info\"},\"conditionalVisibility\":{\"parameterName\":\"understandCostCalculations\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"text - 3\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ \\\"microsoft.network/loadbalancers\\\" and tolower(sku.name) != 'basic'\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend locations = properties.locations\\r\\n| extend zones = zones\\r\\n| extend zoneRedundant = iif(array_length(zones) >= 2, \\\"true\\\", \\\"false\\\")\\r\\n| where zoneRedundant == \\\"false\\\"\\r\\n| join kind = innerunique( //Tag filter\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId=id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n    | distinct id  // Add this line to deduplicate before join\\r\\n    )\\r\\n    on id\\r\\n// Cost calculation for Load Balancer rules with tiered pricing\\r\\n| extend networkRules = todouble({NetworkRules})\\r\\n| extend dataProcessedGB = todouble({DataProcessedGb})\\r\\n| extend rulesCost = case(\\r\\n    networkRules <= 5, networkRules * 0.025 * 730,  // First 5 rules at $0.025/hour\\r\\n    (5 * 0.025 * 730) + ((networkRules - 5) * 0.01 * 730)  // First 5 + additional at $0.01/hour\\r\\n)\\r\\n| extend dataProcessingCost = dataProcessedGB * 0.005  // $0.005 per GB\\r\\n| extend EstimatedMonthlyCost = rulesCost + dataProcessingCost\\r\\n| extend \\r\\n    Recommendation = \\\"Enable Load Balancer Zone Redundancy\\\",\\r\\n    ImplementationImpact = \\\"High\\\",\\r\\n    ImplementationComplexity = \\\"Medium\\\"\\r\\n| project Recommendation, name, location, zoneRedundant, EstimatedMonthlyCost, rulesCost, dataProcessingCost, \\r\\n         resourceGroup, ImplementationImpact, ImplementationComplexity, subscriptionId\\r\\n| sort by name asc\",\"size\":0,\"title\":\"Azure Standard Load Balancer\",\"noDataMessage\":\"All Azure Standard Load Balanacers have availability zones configured\",\"noDataMessageStyle\":3,\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"zoneRedundant\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"false\",\"representation\":\"failed\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"success\",\"text\":\"{0}{1}\"}]}}],\"rowLimit\":1000}},\"name\":\"query-load-balancer-zone-details\"},{\"type\":1,\"content\":{\"json\":\"**Cost Estimate:** Monthly Load Balancer cost (Rules + Data Processing) based on East US Regional Tier rates, September 2025. Assumes 5 rules, 1TB/month data processing. For precise costs, see the [Azure Pricing Calculator](https://azure.microsoft.com/en-us/pricing/calculator/).\",\"style\":\"info\"},\"name\":\"text - 4\"}]},\"conditionalVisibility\":{\"parameterName\":\"CheckforLB\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"groupLoadBalancer\"}]},\"conditionalVisibility\":{\"parameterName\":\"selectedDetailsTab\",\"comparison\":\"isEqualTo\",\"value\":\"network\"},\"name\":\"group-networking-details\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Data Service Availability Zone Coverage\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"{Subscription}\"],\"parameters\":[{\"id\":\"14bb128f-5b3f-421a-9cf7-b9ad71ece3f6\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"CheckforSQLServer\",\"type\":1,\"isRequired\":true,\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'microsoft.sql/servers/databases'\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| where name != 'master'  // Exclude system databases\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend zoneRedundant = tobool(properties.zoneRedundant)\\r\\n//| where zoneRedundant == false  // Only non-zone-redundant databases\\r\\n| join kind = innerunique (\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n)\\r\\n    on id\\r\\n| summarize SQLDatabaseCount = count()\\r\\n| extend HasNonZonalSQLDatabases = iff(SQLDatabaseCount > 0, \\\"Yes\\\", \\\"No\\\")\\r\\n| project HasNonZonalSQLDatabases\",\"crossComponentResources\":[\"{Subscription}\"],\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"id\":\"8da6b29c-a9cd-4b1c-91e0-4402873a06bc\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"CheckforCosmosDB\",\"type\":1,\"isRequired\":true,\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'microsoft.documentdb/databaseaccounts'\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend locations=properties.locations\\r\\n| mv-expand cosmosLocation = locations\\r\\n| extend zones=cosmosLocation.isZoneRedundant\\r\\n| extend zoneRedundant = case(\\r\\n    not(zones), false, true \\r\\n  )\\r\\n//| where zoneRedundant == false  // Only non-zone-redundant accounts\\r\\n| join kind = innerunique (\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n)\\r\\n    on id\\r\\n| summarize CosmosDBCount = count()\\r\\n| extend HasNonZonalCosmosDB = iff(CosmosDBCount > 0, \\\"Yes\\\", \\\"No\\\")\\r\\n| project HasNonZonalCosmosDB\",\"crossComponentResources\":[\"{Subscription}\"],\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"id\":\"d9a47d4a-e881-4743-acb7-92f64005b4b2\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"CheckforMySQL\",\"type\":1,\"isRequired\":true,\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'microsoft.dbformysql/flexibleservers'\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend \\r\\n    highAvailabilityMode = tostring(properties.highAvailability.mode)\\r\\n| extend \\r\\n    zoneRedundant = case(\\r\\n        highAvailabilityMode != \\\"ZoneRedundant\\\", false, true \\r\\n    )\\r\\n//| where zoneRedundant == false  // Only non-zone-redundant servers\\r\\n| join kind = innerunique (\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n)\\r\\n    on id\\r\\n| summarize MySQLServerCount = count()\\r\\n| extend HasNonZonalMySQL = iff(MySQLServerCount > 0, \\\"Yes\\\", \\\"No\\\")\\r\\n| project HasNonZonalMySQL\",\"crossComponentResources\":[\"{Subscription}\"],\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"id\":\"c1d043fb-f5cb-4697-bade-f7292dfbdee2\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"CheckforRediss\",\"type\":1,\"isRequired\":true,\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'microsoft.cache/redis'\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend \\r\\n    currentZoneRedundant = case(\\r\\n        properties.zonalAllocationPolicy != \\\"Automatic\\\" and (array_length(zones) <= 1 or isnull(zones)), false, \\r\\n        true \\r\\n    )\\r\\n//| where currentZoneRedundant == false  // Only non-zone-redundant instances\\r\\n| join kind = innerunique (\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n)\\r\\n    on id\\r\\n| summarize RedisCacheCount = count()\\r\\n| extend HasNonZonalRedisCache = iff(RedisCacheCount > 0, \\\"Yes\\\", \\\"No\\\")\\r\\n| project HasNonZonalRedisCache\",\"crossComponentResources\":[\"{Subscription}\"],\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"version\":\"KqlParameterItem/1.0\",\"name\":\"CheckforPostgres\",\"type\":1,\"isRequired\":true,\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'microsoft.dbforpostgresql/flexibleservers'\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend \\r\\n    highAvailabilityMode = tostring(properties.highAvailability.mode)\\r\\n| extend \\r\\n    zoneRedundant = case(\\r\\n        highAvailabilityMode != \\\"ZoneRedundant\\\", false, true \\r\\n    )\\r\\n//| where zoneRedundant == false  // Only non-zone-redundant servers\\r\\n| join kind = innerunique (\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n)\\r\\n    on id\\r\\n| summarize PostgreSQLServerCount = count()\\r\\n| extend HasNonZonalPostgreSQL = iff(PostgreSQLServerCount > 0, \\\"Yes\\\", \\\"No\\\")\\r\\n| project HasNonZonalPostgreSQL\",\"crossComponentResources\":[\"{Subscription}\"],\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"id\":\"31f2a30a-a2ff-4cf5-a745-059057cf1d92\"}],\"style\":\"pills\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},\"conditionalVisibility\":{\"parameterName\":\"AlwaysHidden\",\"comparison\":\"isEqualTo\",\"value\":\"yes\"},\"name\":\"paramCheckDBAzResources\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Cost Estimation Disclaimer\\n\\n**Note:** Cost estimates for SQL Database tier upgrades are not included in this analysis due to the complexity and variability of pricing factors:\\n\\nâ€¢ **Variable Pricing Models**: SQL Database pricing varies significantly between DTU and vCore models, with different rates for compute, storage, and backup resources\\nâ€¢ **Regional Price Differences**: Costs vary substantially across Azure regions and may change based on your specific location\\nâ€¢ **Custom Configurations**: Actual costs depend on storage size, backup retention policies, read replicas, and other configuration options\\nâ€¢ **Promotional Pricing**: Microsoft frequently offers reserved instance discounts, hybrid benefits, and other cost optimization programs that affect final pricing\\nâ€¢ **Dynamic Scaling**: Many deployments use auto-scaling features that make cost prediction highly variable\\n\\n**For Accurate Cost Estimates:**\\n\\nUse the [Azure Pricing Calculator](https://azure.microsoft.com/en-us/pricing/calculator/) to estimate upgrade costs based on your specific requirements:\\n\\n1. Select **Databases** â†’ **Azure SQL Database**\\n2. Configure your current database specifications\\n3. Compare with the recommended zone-redundant tier\\n4. Factor in your region, storage needs, and backup requirements\\n\\n**Alternative:** Consider using [Azure Cost Management](https://portal.azure.com/#view/Microsoft_Azure_CostManagement) to analyze your current SQL Database spending patterns and project upgrade costs based on historical usage.\"},\"conditionalVisibility\":{\"parameterName\":\"Alwayshidden\",\"comparison\":\"isEqualTo\",\"value\":\"true\"},\"name\":\"text-sql-cost-disclaimer\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'microsoft.sql/servers/databases'\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| where name != 'master'  // Exclude system databases\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend zoneRedundant = tobool(properties.zoneRedundant)\\r\\n| where not(zoneRedundant)  // Only non-zone-redundant databases\\r\\n| extend \\r\\n    skuName = tostring(sku.name),\\r\\n    skuTier = tostring(sku.tier),\\r\\n    skuCapacity = toint(sku.capacity),\\r\\n    currentServiceObjective = tostring(properties.currentServiceObjectiveName)\\r\\n| extend \\r\\n    purchaseModel = case(\\r\\n        skuTier in~ ('Basic', 'Standard', 'Premium'), 'DTU',\\r\\n        skuTier in~ ('GeneralPurpose', 'BusinessCritical', 'Hyperscale'), 'vCore',\\r\\n        'Unknown'\\r\\n    )\\r\\n| extend \\r\\n    currentlySupportsZones = case(\\r\\n        // Based on official documentation\\r\\n        skuTier =~ 'Basic', false,\\r\\n        skuTier =~ 'Standard', false,  \\r\\n        skuTier =~ 'Premium', true,\\r\\n        skuTier =~ 'GeneralPurpose', true,\\r\\n        skuTier =~ 'BusinessCritical', true,\\r\\n        skuTier =~ 'Hyperscale', true,\\r\\n        false\\r\\n    )\\r\\n| extend \\r\\n    recommendedAction = case(\\r\\n        currentlySupportsZones, 'Enable zone redundancy on current tier',\\r\\n        skuTier =~ 'Basic', 'Upgrade to Premium P1 (DTU) or GP_Gen5_2 (vCore) for zone redundancy',\\r\\n        skuTier =~ 'Standard', 'Upgrade to Premium P1 (DTU) or GP_Gen5_2 (vCore) for zone redundancy',\\r\\n        'Enable zone redundancy'  // For tiers that already support it\\r\\n    ),\\r\\n    minimumUpgradeTarget = case(\\r\\n        currentlySupportsZones, 'Current tier with zone redundancy enabled',\\r\\n        skuTier =~ 'Basic', 'Premium P1 (DTU) or General Purpose 2 vCore',\\r\\n        skuTier =~ 'Standard', 'Premium P1 (DTU) or General Purpose 2 vCore', \\r\\n        'Current tier with zone redundancy'\\r\\n    )\\r\\n| join kind = innerunique( //Tag filter\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId=id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n    )\\r\\n    on id\\r\\n| extend \\r\\n    Recommendation = recommendedAction,\\r\\n    ImplementationImpact = case(\\r\\n        currentlySupportsZones, 'Medium',  // Just enabling zone redundancy\\r\\n        'High'  // Requires tier upgrade\\r\\n    ),\\r\\n    ImplementationComplexity = case(\\r\\n        currentlySupportsZones, 'Low',   // Simple configuration change\\r\\n        'Medium'  // Requires tier change and potential downtime\\r\\n    )\\r\\n| extend estimatedCost=\\\"NaN\\\"\\r\\n| project \\r\\n    DatabaseName = name, \\r\\n    Recommendation, \\r\\n    ResourceGroup = resourceGroup, \\r\\n    ImplementationImpact, \\r\\n    ImplementationComplexity, \\r\\n    Location = location, \\r\\n    CurrentTier = skuTier,\\r\\n    CurrentSKU = skuName,\\r\\n    SKUCapacity = skuCapacity,\\r\\n    PurchaseModel = purchaseModel,\\r\\n    MinimumUpgradeTarget = minimumUpgradeTarget,\\r\\n    estimatedCost,    \\r\\n    SubscriptionId = subscriptionId  \\r\\n| sort by DatabaseName asc\",\"size\":0,\"title\":\"Azure SQL Server [ðŸ”´No Cost Est.]\",\"noDataMessage\":\"All Azure SQL Servers have availability zones configured\",\"noDataMessageStyle\":3,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"zoneRedundant\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"failed\",\"text\":\"{0}{1}\"}]}}]}},\"name\":\"query-az-sql-zones-details\"},{\"type\":1,\"content\":{\"json\":\"**Note:** Cost estimates for SQL Database tier upgrades are not provided due to variable pricing models and regional differences. Use the [Azure Pricing Calculator](https://azure.microsoft.com/en-us/pricing/calculator/) for accurate cost projections based on your specific configuration and location.\",\"style\":\"warning\"},\"name\":\"text-sql-cost-disclaimer\"}]},\"conditionalVisibility\":{\"parameterName\":\"CheckforSQLServer\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"groupSQLServer\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'microsoft.documentdb/databaseaccounts'\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend locations=properties.locations\\r\\n| mv-expand cosmosLocation = locations\\r\\n| extend zones=cosmosLocation.isZoneRedundant\\r\\n| extend zoneRedundant = case(\\r\\n    not(zones), false, true \\r\\n  )\\r\\n| where zoneRedundant == false  // Only non-zone-redundant accounts\\r\\n| extend \\r\\n    multiRegionWrites = tobool(properties.enableMultipleWriteLocations),\\r\\n    regionCount = array_length(properties.locations),\\r\\n    consistencyLevel = tostring(properties.consistencyPolicy.defaultConsistencyLevel),\\r\\n    // Extract SKU information\\r\\n    skuName = tostring(sku.name),\\r\\n    skuTier = tostring(sku.tier),\\r\\n    // Extract capabilities first\\r\\n    capabilities = tostring(properties.capabilities),\\r\\n    // Extract backup policy for additional context\\r\\n    backupPolicy = tostring(properties.backupPolicy.type)\\r\\n| extend \\r\\n    // Now use capabilities variable to detect modes\\r\\n    isServerless = capabilities contains \\\"EnableServerless\\\",\\r\\n    hasAutoscale = capabilities contains \\\"EnableAutoscale\\\" or capabilities contains \\\"autoscale\\\"\\r\\n| extend \\r\\n    capacityMode = case(\\r\\n        isServerless, \\\"Serverless\\\",\\r\\n        hasAutoscale, \\\"Provisioned (Autoscale)\\\",\\r\\n        \\\"Provisioned (Manual)\\\"\\r\\n    ),\\r\\n    accountType = case(\\r\\n        multiRegionWrites and regionCount > 1, \\\"Multi-region write\\\",\\r\\n        regionCount > 1, \\\"Multi-region read\\\",\\r\\n        \\\"Single-region\\\"\\r\\n    )\\r\\n| extend \\r\\n    costImpact = case(\\r\\n        multiRegionWrites, \\\"No additional cost - Multi-region write accounts have no billing impact\\\",\\r\\n        isServerless, \\\"25% increase in request units (RU) consumption\\\",\\r\\n        hasAutoscale, \\\"25% increase in provisioned RU/s - FREE for autoscale resources\\\",\\r\\n        \\\"25% increase in provisioned RU/s (1.25x multiplier)\\\"\\r\\n    ),\\r\\n    costMultiplier = case(\\r\\n        multiRegionWrites, \\\"1.0x (No impact)\\\",\\r\\n        isServerless, \\\"1.25x RU\\\",\\r\\n        hasAutoscale, \\\"1.0x (Free for autoscale)\\\",\\r\\n        \\\"1.25x RU/s\\\"\\r\\n    ),\\r\\n    recommendedAction = case(\\r\\n        multiRegionWrites, \\\"Enable availability zones (no cost impact)\\\",\\r\\n        isServerless, \\\"Enable availability zones (25% RU consumption increase)\\\",\\r\\n        hasAutoscale, \\\"Enable availability zones (FREE - no cost impact for autoscale)\\\",\\r\\n        \\\"Enable availability zones (25% RU/s increase) - Consider autoscale to avoid cost\\\"\\r\\n    )\\r\\n| join kind = innerunique( //Tag filter\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId=id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n    )\\r\\n    on id\\r\\n| extend \\r\\n    Recommendation = recommendedAction,\\r\\n    ImplementationImpact = case(\\r\\n        multiRegionWrites or hasAutoscale, 'High',  // No cost impact\\r\\n        isServerless, 'High',  // 25% RU increase\\r\\n        'High'  // 25% RU/s increase\\r\\n    ),\\r\\n    ImplementationComplexity = 'Low'  // Configuration change only\\r\\n| project \\r\\n    CosmosDBAccount = name,\\r\\n    AccountType = accountType,\\r\\n    ResourceGroup = resourceGroup,\\r\\n    CapacityMode = capacityMode,\\r\\n    Recommendation,\\r\\n    ImplementationImpact,\\r\\n    ImplementationComplexity,\\r\\n    MultiRegionWrites = multiRegionWrites,\\r\\n    RegionCount = regionCount,\\r\\n    CostMultiplier = costMultiplier,\\r\\n    CostImpactDescription = costImpact,\\r\\n    Location = location,\\r\\n    SubscriptionId = subscriptionId\\r\\n| distinct *\\r\\n| sort by CosmosDBAccount asc\",\"size\":0,\"title\":\"Azure Cosmos DB [ðŸŸ¡Cost Impact]\",\"noDataMessage\":\"All Azure Cosmos DB instances have availability zones configured\",\"noDataMessageStyle\":3,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"pinnedZone\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"4\",\"text\":\"\"}]}},{\"columnMatch\":\"zoneRedundant\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"4\",\"text\":\"\"}]}}],\"rowLimit\":1000},\"sortBy\":[]},\"name\":\"query-documentdb-zones-details\"},{\"type\":1,\"content\":{\"json\":\"**Note:** Cosmos DB availability zone costs: Multi-region write accounts have no additional cost. Single-region accounts have 1.25x RU/s multiplier (free for autoscale) or 1.25x RU consumption (serverless). Use [Azure Pricing Calculator](https://azure.microsoft.com/en-us/pricing/calculator/) for precise cost estimates.\",\"style\":\"info\"},\"name\":\"text-cosmos-cost-disclaimer\"}]},\"conditionalVisibility\":{\"parameterName\":\"CheckforCosmosDB\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"groupCosmosDB\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'microsoft.cache/redis'\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend \\r\\n    skuName = tostring(properties.sku.name),\\r\\n    skuFamily = tostring(properties.sku.family),\\r\\n    skuCapacity = toint(properties.sku.capacity),\\r\\n    redisVersion = tostring(properties.redisVersion)\\r\\n| extend \\r\\n    supportsZoneRedundancy = case(\\r\\n        skuName in~ ('Basic', 'Standard'), false,\\r\\n        skuName in~ ('Premium', 'Enterprise', 'EnterpriseFlash'), true,\\r\\n        false  // Default for unknown SKUs\\r\\n    )\\r\\n| extend \\r\\n    currentZoneRedundant = case(\\r\\n        properties.zonalAllocationPolicy != \\\"Automatic\\\" and (array_length(zones) <= 1 or isnull(zones)), false, \\r\\n        true \\r\\n    )\\r\\n| extend \\r\\n    recommendation = case(\\r\\n        not(supportsZoneRedundancy), strcat(\\\"Upgrade to Premium SKU or higher for zone redundancy support (Current: \\\", skuName, \\\" C\\\", skuCapacity, \\\")\\\"),\\r\\n        currentZoneRedundant, \\\"Already zone redundant\\\",\\r\\n        \\\"Enable zone redundancy on current SKU\\\"\\r\\n    ),\\r\\n    minimumUpgradeTarget = case(\\r\\n        not(supportsZoneRedundancy), \\\"Premium P1 (or higher)\\\",\\r\\n        \\\"Current SKU with zone redundancy enabled\\\"\\r\\n    )\\r\\n| where not(currentZoneRedundant)  // Only show non-zone-redundant instances\\r\\n| join kind = innerunique( //Tag filter\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId=id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n    )\\r\\n    on id\\r\\n| extend \\r\\n    Recommendation = recommendation,\\r\\n    ImplementationImpact = case(\\r\\n        not(supportsZoneRedundancy), 'High',  // Requires SKU upgrade\\r\\n        'High'  // Just enable zone redundancy\\r\\n    ),\\r\\n    ImplementationComplexity = case(\\r\\n        not(supportsZoneRedundancy), 'Medium',  // SKU upgrade complexity\\r\\n        'Low'  // Configuration change\\r\\n    )\\r\\n| project \\r\\n    RedisCacheName = name,\\r\\n    CurrentSKU = strcat(skuName, \\\" \\\", skuFamily, skuCapacity),\\r\\n    RedisVersion = redisVersion,\\r\\n    SupportsZoneRedundancy = supportsZoneRedundancy,\\r\\n    MinimumUpgradeTarget = minimumUpgradeTarget,\\r\\n    CurrentZones = tostring(zones),\\r\\n    ResourceGroup = resourceGroup,\\r\\n    Recommendation,\\r\\n    ImplementationImpact,\\r\\n    ImplementationComplexity,\\r\\n    Location = location,\\r\\n    SubscriptionId = subscriptionId\\r\\n| sort by RedisCacheName asc\",\"size\":0,\"title\":\"Azure Cache for Redis[ðŸ”´No Cost Est.]\",\"noDataMessage\":\"All Azure Cache for Redis instances have availability zones configured\",\"noDataMessageStyle\":3,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"SupportsZoneRedundancy\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"3\",\"text\":\"No\"}]}},{\"columnMatch\":\"pinnedZone\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"4\",\"text\":\"\"}]}},{\"columnMatch\":\"zoneRedundant\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"4\",\"text\":\"\"}]}}],\"rowLimit\":1000},\"sortBy\":[]},\"name\":\"query-cache-zones-details\"},{\"type\":1,\"content\":{\"json\":\"**Note:** Zone redundancy costs vary significantly based on replica configuration, data transfer usage, and clustering setup. Use [Azure Pricing Calculator](https://azure.microsoft.com/en-us/pricing/calculator/) for accurate cost projections based on your specific cache configuration.\",\"style\":\"info\"},\"name\":\"text-redis-cost-disclaimer\"}]},\"conditionalVisibility\":{\"parameterName\":\"CheckforRediss\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"groupCacheforRedis\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'microsoft.dbformysql/flexibleservers'\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend \\r\\n    highAvailabilityMode = tostring(properties.highAvailability.mode),\\r\\n    skuName = tostring(sku.name),\\r\\n    skuTier = tostring(sku.tier),\\r\\n    storageSizeGB = toint(properties.storage.storageSizeGB),\\r\\n    mysqlVersion = tostring(properties.version)\\r\\n| extend \\r\\n    zoneRedundant = case(\\r\\n        highAvailabilityMode != \\\"ZoneRedundant\\\", false, true \\r\\n    )\\r\\n| where zoneRedundant == false  // Only non-zone-redundant servers\\r\\n| extend \\r\\n    costImpact = \\\"100% increase (2x current cost) - Requires duplicate compute and storage for secondary replica\\\",\\r\\n    costMultiplier = \\\"2.0x (Double current cost)\\\",\\r\\n    recommendedAction = \\\"Enable zone-redundant high availability\\\"\\r\\n| join kind = innerunique( //Tag filter\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId=id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n    )\\r\\n    on id\\r\\n| extend \\r\\n    Recommendation = recommendedAction,\\r\\n    ImplementationImpact = 'High',  // 100% cost increase\\r\\n    ImplementationComplexity = 'High'  // Configuration change\\r\\n| project \\r\\n    MySQLServerName = name,\\r\\n    CurrentSKU = skuName,\\r\\n    SKUTier = skuTier,\\r\\n    StorageSizeGB = storageSizeGB,\\r\\n    CurrentHAMode = highAvailabilityMode,\\r\\n    ResourceGroup = resourceGroup,\\r\\n    Recommendation,\\r\\n    ImplementationImpact,\\r\\n    CostMultiplier = costMultiplier,\\r\\n    CostImpactDescription = costImpact,\\r\\n    ImplementationComplexity,\\r\\n    Location = location,\\r\\n    SubscriptionId = subscriptionId\\r\\n| sort by MySQLServerName asc\",\"size\":0,\"title\":\"Azure Database for MySQL - Flexible Server [ðŸŸ¡Cost Impact]\",\"noDataMessage\":\"All Azure Database for MySQL - Flexible Server instances have availability zones configured\",\"noDataMessageStyle\":3,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"pinnedZone\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"4\",\"text\":\"\"}]}},{\"columnMatch\":\"zoneRedundant\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"4\",\"text\":\"\"}]}}],\"rowLimit\":1000},\"sortBy\":[]},\"name\":\"query-dbformysql-zones-details\"},{\"type\":1,\"content\":{\"json\":\"**Note:** Zone-redundant HA doubles compute and storage costs (100% increase) plus potential backup storage. Use [Azure Pricing Calculator](https://azure.microsoft.com/en-us/pricing/calculator/) for precise cost estimates including backup storage.\",\"style\":\"info\"},\"name\":\"text-mysql-cost-disclaimer\"}]},\"name\":\"groupMySQL\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'microsoft.dbforpostgresql/flexibleservers'\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend \\r\\n    highAvailabilityMode = tostring(properties.highAvailability.mode),\\r\\n    skuName = tostring(sku.name),\\r\\n    skuTier = tostring(sku.tier),\\r\\n    storageSizeGB = toint(properties.storage.storageSizeGB),\\r\\n    postgresVersion = strcat(tostring(properties.version), \\\".\\\", tostring(properties.minorVersion))\\r\\n| extend \\r\\n    supportsZoneRedundancy = case(\\r\\n        skuTier =~ 'Burstable', false,  // Burstable tier doesn't support zone redundancy\\r\\n        true  // General Purpose and Memory Optimized support it\\r\\n    )\\r\\n| extend \\r\\n    zoneRedundant = case(\\r\\n        highAvailabilityMode != \\\"ZoneRedundant\\\", false, true \\r\\n    )\\r\\n| where zoneRedundant == false  // Only non-zone-redundant servers\\r\\n| extend \\r\\n    recommendation = case(\\r\\n        not(supportsZoneRedundancy), strcat(\\\"Upgrade from Burstable tier to General Purpose or Memory Optimized for zone redundancy support (Current: \\\", skuTier, \\\")\\\"),\\r\\n        \\\"Enable zone-redundant high availability\\\"\\r\\n    ),\\r\\n    minimumUpgradeTarget = case(\\r\\n        not(supportsZoneRedundancy), \\\"General Purpose or Memory Optimized tier\\\",\\r\\n        \\\"Current tier with zone redundancy enabled\\\"\\r\\n    )\\r\\n| join kind = innerunique( //Tag filter\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId=id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n    )\\r\\n    on id\\r\\n| extend \\r\\n    Recommendation = recommendation,\\r\\n    ImplementationImpact = case(\\r\\n        not(supportsZoneRedundancy), 'High',  // Requires tier upgrade\\r\\n        'High'  // Zone redundancy has performance/cost impact but unknown amount\\r\\n    ),\\r\\n    ImplementationComplexity = case(\\r\\n        not(supportsZoneRedundancy), 'Medium',  // Tier upgrade complexity\\r\\n        'Low'  // Configuration change\\r\\n    )\\r\\n| project \\r\\n    PostgreSQLServerName = name,\\r\\n    CurrentSKU = skuName,\\r\\n    SKUTier = skuTier,\\r\\n    StorageSizeGB = storageSizeGB,\\r\\n    SupportsZoneRedundancy = supportsZoneRedundancy,\\r\\n    ResourceGroup = resourceGroup,\\r\\n    Recommendation,\\r\\n    ImplementationImpact,\\r\\n    ImplementationComplexity,\\r\\n    PostgreSQLVersion = postgresVersion,\\r\\n    CurrentHAMode = highAvailabilityMode,\\r\\n    MinimumUpgradeTarget = minimumUpgradeTarget,\\r\\n    Location = location,\\r\\n    SubscriptionId = subscriptionId\\r\\n| sort by PostgreSQLServerName asc\",\"size\":0,\"title\":\"Azure Database for PostgreSQL - Flexible Server [ðŸ”´No Cost Est.]\",\"noDataMessage\":\"All Azure Database for PostgreSQL - Flexible Server instances have availability zones configured\",\"noDataMessageStyle\":3,\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"pinnedZone\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"4\",\"text\":\"\"}]}},{\"columnMatch\":\"zoneRedundant\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"4\",\"text\":\"\"}]}}],\"rowLimit\":1000},\"sortBy\":[]},\"name\":\"query-dbforpostgresql-zones-details\"},{\"type\":1,\"content\":{\"json\":\"**Note:** Zone redundancy costs vary by workload, SKU type, and region due to synchronous replication overhead. Use [Azure Pricing Calculator](https://azure.microsoft.com/en-us/pricing/calculator/) for accurate cost projections based on your specific configuration.\",\"style\":\"info\"},\"name\":\"text-postgresql-cost-disclaimer\"}]},\"conditionalVisibility\":{\"parameterName\":\"CheckforPostgres\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"groupPostgres\"}]},\"conditionalVisibility\":{\"parameterName\":\"selectedDetailsTab\",\"comparison\":\"isEqualTo\",\"value\":\"Data\"},\"name\":\"group - Details-Data\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Storage Availability Zone Coverage\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"{Subscription}\"],\"parameters\":[{\"id\":\"14bb128f-5b3f-421a-9cf7-b9ad71ece3f6\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"CheckforStorageV2\",\"type\":1,\"isRequired\":true,\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'Microsoft.Storage/StorageAccounts'\\r\\n| where kind == \\\"StorageV2\\\"\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend locations = properties.locations\\r\\n| extend skuName = tostring(sku.name)\\r\\n| extend zoneRedundant = case(sku.name endswith_cs 'ZRS', true, false)\\r\\n| join kind = innerunique (\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n)\\r\\n    on id\\r\\n| summarize StorageV2Count = count()\\r\\n| extend HasStorageV2 = iff(StorageV2Count > 0, \\\"Yes\\\", \\\"No\\\")\\r\\n| project HasStorageV2\",\"crossComponentResources\":[\"{Subscription}\"],\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"version\":\"KqlParameterItem/1.0\",\"name\":\"CheckforStorageV1\",\"type\":1,\"isRequired\":true,\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'Microsoft.Storage/StorageAccounts'\\r\\n| where kind == \\\"Storage\\\"\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend locations = properties.locations\\r\\n| extend skuName = tostring(sku.name)\\r\\n| extend zoneRedundant = case(sku.name endswith_cs 'ZRS', true, false)\\r\\n| join kind = innerunique (\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n)\\r\\n    on id\\r\\n| distinct id, name, skuName, kind, zoneRedundant, resourceGroup, subscriptionId, location\\r\\n| summarize StorageV2Count = count()\\r\\n| extend HasStorageV2 = iff(StorageV2Count > 0, \\\"Yes\\\", \\\"No\\\")\\r\\n| project HasStorageV2\",\"crossComponentResources\":[\"{Subscription}\"],\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"id\":\"0710d49d-1324-4f3f-877f-863dfe589858\"},{\"version\":\"KqlParameterItem/1.0\",\"name\":\"CheckforStorageBlock\",\"type\":1,\"isRequired\":true,\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'Microsoft.Storage/StorageAccounts'\\r\\n| where kind == \\\"BlockBlobStorage\\\"\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend locations = properties.locations\\r\\n| extend skuName = tostring(sku.name)\\r\\n| extend zoneRedundant = case(sku.name endswith_cs 'ZRS', true, false)\\r\\n| join kind = innerunique (\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n)\\r\\n    on id\\r\\n| distinct id, name, skuName, kind, zoneRedundant, resourceGroup, subscriptionId, location\\r\\n| summarize StorageV2Count = count()\\r\\n| extend HasStorageV2 = iff(StorageV2Count > 0, \\\"Yes\\\", \\\"No\\\")\\r\\n| project HasStorageV2\",\"crossComponentResources\":[\"{Subscription}\"],\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"id\":\"1f1b0e11-e018-441e-8266-be3d879aaa80\"},{\"version\":\"KqlParameterItem/1.0\",\"name\":\"CheckforStorageFiles\",\"type\":1,\"isRequired\":true,\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'Microsoft.Storage/StorageAccounts'\\r\\n| where kind == \\\"FileStorage\\\"\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend locations = properties.locations\\r\\n| extend skuName = tostring(sku.name)\\r\\n| extend zoneRedundant = case(sku.name endswith_cs 'ZRS', true, false)\\r\\n//| where zoneRedudant = false\\r\\n| join kind = innerunique (\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n)\\r\\n    on id\\r\\n| distinct id, name, skuName, kind, zoneRedundant, resourceGroup, subscriptionId, location\\r\\n| summarize StorageV2Count = count()\\r\\n| extend HasStorageV2 = iff(StorageV2Count > 0, \\\"Yes\\\", \\\"No\\\")\\r\\n| project HasStorageV2\",\"crossComponentResources\":[\"{Subscription}\"],\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"id\":\"e9e033a0-8071-42a5-8be6-4b4a884b02f9\"}],\"style\":\"pills\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},\"conditionalVisibility\":{\"parameterName\":\"AlwaysHidden\",\"comparison\":\"isEqualTo\",\"value\":\"yes\"},\"name\":\"paramCheckResourceType\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Storage Account v2\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"understand-cost-calc-yesno\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"understandCostCalculations\",\"label\":\"Show Storage cost calculation details?\",\"type\":2,\"isRequired\":true,\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"jsonData\":\"[\\r\\n    {\\r\\n    \\\"value\\\" : \\\"Yes\\\",\\r\\n    \\\"label\\\" : \\\"Yes\\\"\\r\\n    },\\r\\n    {\\r\\n    \\\"value\\\" : \\\"No\\\",\\r\\n    \\\"label\\\" : \\\"No\\\",\\r\\n    \\\"selected\\\" : true\\r\\n    }\\r\\n]\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"Show Cost Calculation Details\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"a1a1ed79-dd3e-4c78-bde6-2427b0606874\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"storageV2GBCost\",\"label\":\"StorageV2 cost per GB\",\"type\":1,\"timeContext\":{\"durationMs\":86400000},\"value\":\"0.026\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"understandCostCalculations\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"param-SAIncrease\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'Microsoft.Storage/StorageAccounts'\\r\\n| where kind == \\\"StorageV2\\\"\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend locations = properties.locations\\r\\n| extend skuName = tostring(sku.name)\\r\\n| extend zoneRedundant = case(sku.name endswith_cs 'ZRS', true, false)\\r\\n| join kind = innerunique (\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n)\\r\\n    on id\\r\\n| distinct id, name, skuName, kind, zoneRedundant, resourceGroup, subscriptionId, location\",\"size\":0,\"title\":\"Azure Storage Accounts\",\"noDataMessage\":\"All Azure Storage Accounts are zone redundant\",\"noDataMessageStyle\":3,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"zoneRedundant\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"failed\",\"text\":\"{0}{1}\"}]}}]}},\"conditionalVisibility\":{\"parameterName\":\"alwayshidden\",\"comparison\":\"isEqualTo\",\"value\":\"true\"},\"name\":\"query-storageaccounts-GenV2-zones-details\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"{Subscription}\"],\"parameters\":[{\"id\":\"e94aafa3-c5d9-4523-89f0-4e87aa754511\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Resources\",\"label\":\"Storage accounts\",\"type\":5,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"resources\\n| where resourceGroup in ({ResourceGroup})\\n| where type =~ 'Microsoft.Storage/StorageAccounts'\\n| where kind == \\\"StorageV2\\\"\\n| where location in~ ({ZonalRegions:value})\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\n| extend locations = properties.locations\\n| extend skuName = tostring(sku.name)\\n| extend zoneRedundant = case(sku.name endswith_cs 'ZRS', true, false)\\n| join kind = innerunique (\\n    resources\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\n    | extend replaced_tags = parse_json(replaced_tags)\\n    | mv-expand replaced_tags\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\n)\\n    on id\\n//| extend Rank = row_number()\\n//| project value = id, label = id, selected = Rank <= 5\\n| distinct id, name, skuName, kind, zoneRedundant, resourceGroup, subscriptionId, location\\n\",\"crossComponentResources\":[\"{Subscription}\"],\"typeSettings\":{\"resourceTypeFilter\":{\"microsoft.storage/storageaccounts\":true},\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"}],\"style\":\"above\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},\"conditionalVisibility\":{\"parameterName\":\"alwayshidden\",\"comparison\":\"isEqualTo\",\"value\":\"true\"},\"name\":\"paramSAGenV2\",\"styleSettings\":{\"margin\":\"15px 0 0 0\"}},{\"type\":10,\"content\":{\"chartId\":\"workbookdb19a8d8-91af-44ea-951d-5ffa133b2ebe\",\"version\":\"MetricsItem/2.0\",\"size\":3,\"chartType\":0,\"resourceType\":\"microsoft.storage/storageaccounts\",\"metricScope\":0,\"resourceParameter\":\"Resources\",\"resourceIds\":[\"{Resources}\"],\"timeContext\":{\"durationMs\":2592000000},\"metrics\":[{\"namespace\":\"microsoft.storage/storageaccounts\",\"metric\":\"microsoft.storage/storageaccounts-Capacity-UsedCapacity\",\"aggregation\":4}],\"title\":\"Storage Capacity\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"$gen_group\",\"formatter\":13,\"formatOptions\":{\"linkTarget\":\"Resource\",\"subTarget\":\"insights\",\"showIcon\":true}},{\"columnMatch\":\"Subscription\",\"formatter\":5},{\"columnMatch\":\"Name\",\"formatter\":5},{\"columnMatch\":\"microsoft.storage/storageaccounts-Capacity-UsedCapacity$|microsoft.storage/storageaccounts/blobservices-Capacity-BlobCapacity$|microsoft.storage/storageaccounts/fileservices-Capacity-FileCapacity$|microsoft.storage/storageaccounts/queueservices-Capacity-QueueCapacity$|microsoft.storage/storageaccounts/tableservices-Capacity-TableCapacity$\",\"formatter\":8,\"formatOptions\":{\"min\":0,\"palette\":\"blue\",\"linkTarget\":\"WorkbookTemplate\",\"workbookContext\":{\"componentIdSource\":\"column\",\"componentId\":\"Name\",\"resourceIdsSource\":\"column\",\"resourceIds\":\"Name\",\"templateIdSource\":\"static\",\"templateId\":\"Community-Workbooks/Individual Storage/Capacity\",\"typeSource\":\"static\",\"type\":\"workbook\",\"gallerySource\":\"static\",\"gallery\":\"microsoft.storage/storageaccounts\"}},\"numberFormat\":{\"unit\":2,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":1}}},{\"columnMatch\":\"microsoft.storage/storageaccounts-Capacity-UsedCapacity Timeline$|Account used capacity Timeline$\",\"formatter\":5},{\"columnMatch\":\"microsoft.storage/storageaccounts/blobservices-Capacity-BlobCapacity Timeline$|Blob capacity Timeline$\",\"formatter\":5},{\"columnMatch\":\"microsoft.storage/storageaccounts/fileservices-Capacity-FileCapacity Timeline$|File capacity Timeline$\",\"formatter\":5},{\"columnMatch\":\"microsoft.storage/storageaccounts/queueservices-Capacity-QueueCapacity Timeline$|Queue capacity Timeline$\",\"formatter\":5},{\"columnMatch\":\"microsoft.storage/storageaccounts/tableservices-Capacity-TableCapacity Timeline$|Table capacity Timeline$\",\"formatter\":5}],\"rowLimit\":10000,\"filter\":true,\"hierarchySettings\":{\"treeType\":1,\"groupBy\":[\"Subscription\"],\"expandTopLevel\":true,\"finalBy\":\"Name\"},\"sortBy\":[{\"itemKey\":\"$gen_heatmap_microsoft.storage/storageaccounts-Capacity-UsedCapacity$|microsoft.storage/storageaccounts/blobservices-Capacity-BlobCapacity$|microsoft.storage/storageaccounts/fileservices-Capacity-FileCapacity$|microsoft.storage/storageaccounts/queueservices-Capacity-QueueCapacity$|microsoft.storage/storageaccounts/tableservices-Capacity-TableCapacity$_3\",\"sortOrder\":2}],\"labelSettings\":[{\"columnId\":\"Subscription\",\"label\":\"Subscription\"},{\"columnId\":\"microsoft.storage/storageaccounts-Capacity-UsedCapacity\",\"label\":\"Account used capacity\"},{\"columnId\":\"microsoft.storage/storageaccounts-Capacity-UsedCapacity Timeline\",\"label\":\"Account used capacity timeline\"}]},\"sortBy\":[{\"itemKey\":\"$gen_heatmap_microsoft.storage/storageaccounts-Capacity-UsedCapacity$|microsoft.storage/storageaccounts/blobservices-Capacity-BlobCapacity$|microsoft.storage/storageaccounts/fileservices-Capacity-FileCapacity$|microsoft.storage/storageaccounts/queueservices-Capacity-QueueCapacity$|microsoft.storage/storageaccounts/tableservices-Capacity-TableCapacity$_3\",\"sortOrder\":2}],\"showExportToExcel\":true},\"conditionalVisibility\":{\"parameterName\":\"alwayshidden\",\"comparison\":\"isEqualTo\",\"value\":\"true\"},\"showPin\":true,\"name\":\"metricsGenV2-Capacity\",\"styleSettings\":{\"margin\":\"0 10px 0 10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"{\\\"version\\\":\\\"Merge/1.0\\\",\\\"merges\\\":[{\\\"id\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\",\\\"mergeType\\\":\\\"innerunique\\\",\\\"leftTable\\\":\\\"query-storageaccounts-GenV2-zones-details\\\",\\\"rightTable\\\":\\\"metricsGenV2-Capacity\\\",\\\"leftColumn\\\":\\\"id\\\",\\\"rightColumn\\\":\\\"Name\\\"}],\\\"projectRename\\\":[{\\\"originalName\\\":\\\"[query-storageaccounts-GenV2-zones-details].id\\\",\\\"mergedName\\\":\\\"id\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-GenV2-zones-details].name\\\",\\\"mergedName\\\":\\\"name\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-GenV2-zones-details].skuName\\\",\\\"mergedName\\\":\\\"skuName\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-GenV2-zones-details].kind\\\",\\\"mergedName\\\":\\\"kind\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-GenV2-zones-details].zoneRedundant\\\",\\\"mergedName\\\":\\\"zoneRedundant\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[metricsGenV2-Capacity].microsoft.storage/storageaccounts-Capacity-UsedCapacity\\\",\\\"mergedName\\\":\\\"Account used capacity(avg 30days)\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[Added column]\\\",\\\"mergedName\\\":\\\"Estimated capacity costs\\\",\\\"fromId\\\":null,\\\"isNewItem\\\":true,\\\"newItemData\\\":[{\\\"criteriaContext\\\":{\\\"leftOperand\\\":\\\"id\\\",\\\"operator\\\":\\\"isNotNull\\\",\\\"rightValType\\\":\\\"column\\\",\\\"resultValType\\\":\\\"expression\\\",\\\"resultVal\\\":\\\"(([\\\\\\\"Account used capacity(avg 30days)\\\\\\\"]/ (1024^3))*{storageV2GBCost})\\\"}},{\\\"criteriaContext\\\":{\\\"operator\\\":\\\"Default\\\",\\\"rightValType\\\":\\\"column\\\",\\\"resultValType\\\":\\\"column\\\"}}]},{\\\"originalName\\\":\\\"[query-storageaccounts-GenV2-zones-details].resourceGroup\\\",\\\"mergedName\\\":\\\"resourceGroup\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-GenV2-zones-details].subscriptionId\\\",\\\"mergedName\\\":\\\"subscriptionId\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[query - combinedMetrics].Name\\\"},{\\\"originalName\\\":\\\"[query - combinedMetrics].Subscription\\\"},{\\\"originalName\\\":\\\"[metricsGenV2-Capacity].microsoft.storage/storageaccounts-Capacity-UsedCapacity Timeline\\\"},{\\\"originalName\\\":\\\"[metricsGenV2-Capacity].Name\\\"},{\\\"originalName\\\":\\\"[metricsGenV2-Capacity].Subscription\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-GenV2-zones-details].location\\\"}]}\",\"size\":0,\"queryType\":7,\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"zoneRedundant\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"3\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"Account used capacity(avg 30days)\",\"formatter\":0,\"numberFormat\":{\"unit\":2,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Estimated capacity costs\",\"formatter\":0,\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Estimated Storage Cost\",\"formatter\":0,\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\"}}}]}},\"showPin\":false,\"name\":\"query-BlobStoragewithCosts\"},{\"type\":1,\"content\":{\"json\":\"> **Note:** Cost based on East US rates (Sep 2025). Storage cost only â€” excludes transactions/operations. For detailed pricing, see [Azure Pricing Calculator](https://azure.microsoft.com/pricing/calculator/).\\r\\n\",\"style\":\"info\"},\"name\":\"text - storage costs\"}]},\"conditionalVisibility\":{\"parameterName\":\"CheckforStorageV2\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"groupStorageAccount-v2\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Storage Account v1\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"understand-cost-calc-yesno\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"understandCostCalculations\",\"label\":\"Show Storage cost calculation details?\",\"type\":2,\"isRequired\":true,\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"jsonData\":\"[\\r\\n    {\\r\\n    \\\"value\\\" : \\\"Yes\\\",\\r\\n    \\\"label\\\" : \\\"Yes\\\"\\r\\n    },\\r\\n    {\\r\\n    \\\"value\\\" : \\\"No\\\",\\r\\n    \\\"label\\\" : \\\"No\\\",\\r\\n    \\\"selected\\\" : true\\r\\n    }\\r\\n]\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"Show Cost Calculation Details\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"a1a1ed79-dd3e-4c78-bde6-2427b0606874\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"storageV1GBCost\",\"label\":\"StorageV2 cost per GB\",\"type\":1,\"timeContext\":{\"durationMs\":86400000},\"value\":\"0.03\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"understandCostCalculations\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"param-SAIncrease\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'Microsoft.Storage/StorageAccounts'\\r\\n| where kind == \\\"Storage\\\"\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend locations = properties.locations\\r\\n| extend skuName = tostring(sku.name)\\r\\n| extend zoneRedundant = case(sku.name endswith_cs 'ZRS', true, false)\\r\\n| join kind = innerunique (\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n)\\r\\n    on id\\r\\n| distinct id, name, skuName, kind, zoneRedundant, resourceGroup, subscriptionId, location\",\"size\":0,\"title\":\"Azure Storage Accounts\",\"noDataMessage\":\"All Azure Storage Accounts are zone redundant\",\"noDataMessageStyle\":3,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"zoneRedundant\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"failed\",\"text\":\"{0}{1}\"}]}}]}},\"conditionalVisibility\":{\"parameterName\":\"alwayshidden\",\"comparison\":\"isEqualTo\",\"value\":\"true\"},\"name\":\"query-storageaccounts-GenV1-zones-details\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"{Subscription}\"],\"parameters\":[{\"id\":\"e94aafa3-c5d9-4523-89f0-4e87aa754511\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Resources\",\"label\":\"Storage accounts\",\"type\":5,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"resources\\n| where resourceGroup in ({ResourceGroup})\\n| where type =~ 'Microsoft.Storage/StorageAccounts'\\n| where kind == \\\"Storage\\\"\\n| where location in~ ({ZonalRegions:value})\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\n| extend locations = properties.locations\\n| extend skuName = tostring(sku.name)\\n| extend zoneRedundant = case(sku.name endswith_cs 'ZRS', true, false)\\n| join kind = innerunique (\\n    resources\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\n    | extend replaced_tags = parse_json(replaced_tags)\\n    | mv-expand replaced_tags\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\n)\\n    on id\\n| distinct id, name, skuName, kind, zoneRedundant, resourceGroup, subscriptionId, location\",\"crossComponentResources\":[\"{Subscription}\"],\"typeSettings\":{\"resourceTypeFilter\":{\"microsoft.storage/storageaccounts\":true},\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"}],\"style\":\"above\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},\"conditionalVisibility\":{\"parameterName\":\"alwayshidden\",\"comparison\":\"isEqualTo\",\"value\":\"true\"},\"name\":\"paramSAGenV1\",\"styleSettings\":{\"margin\":\"15px 0 0 0\"}},{\"type\":10,\"content\":{\"chartId\":\"workbookdb19a8d8-91af-44ea-951d-5ffa133b2ebe\",\"version\":\"MetricsItem/2.0\",\"size\":3,\"chartType\":0,\"resourceType\":\"microsoft.storage/storageaccounts\",\"metricScope\":0,\"resourceParameter\":\"Resources\",\"resourceIds\":[\"{Resources}\"],\"timeContext\":{\"durationMs\":2592000000},\"metrics\":[{\"namespace\":\"microsoft.storage/storageaccounts\",\"metric\":\"microsoft.storage/storageaccounts-Capacity-UsedCapacity\",\"aggregation\":4}],\"title\":\"Storage Capacity\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"$gen_group\",\"formatter\":13,\"formatOptions\":{\"linkTarget\":\"Resource\",\"subTarget\":\"insights\",\"showIcon\":true}},{\"columnMatch\":\"Subscription\",\"formatter\":5},{\"columnMatch\":\"Name\",\"formatter\":5},{\"columnMatch\":\"microsoft.storage/storageaccounts-Capacity-UsedCapacity$|microsoft.storage/storageaccounts/blobservices-Capacity-BlobCapacity$|microsoft.storage/storageaccounts/fileservices-Capacity-FileCapacity$|microsoft.storage/storageaccounts/queueservices-Capacity-QueueCapacity$|microsoft.storage/storageaccounts/tableservices-Capacity-TableCapacity$\",\"formatter\":8,\"formatOptions\":{\"min\":0,\"palette\":\"blue\",\"linkTarget\":\"WorkbookTemplate\",\"workbookContext\":{\"componentIdSource\":\"column\",\"componentId\":\"Name\",\"resourceIdsSource\":\"column\",\"resourceIds\":\"Name\",\"templateIdSource\":\"static\",\"templateId\":\"Community-Workbooks/Individual Storage/Capacity\",\"typeSource\":\"static\",\"type\":\"workbook\",\"gallerySource\":\"static\",\"gallery\":\"microsoft.storage/storageaccounts\"}},\"numberFormat\":{\"unit\":2,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":1}}},{\"columnMatch\":\"microsoft.storage/storageaccounts-Capacity-UsedCapacity Timeline$|Account used capacity Timeline$\",\"formatter\":5},{\"columnMatch\":\"microsoft.storage/storageaccounts/blobservices-Capacity-BlobCapacity Timeline$|Blob capacity Timeline$\",\"formatter\":5},{\"columnMatch\":\"microsoft.storage/storageaccounts/fileservices-Capacity-FileCapacity Timeline$|File capacity Timeline$\",\"formatter\":5},{\"columnMatch\":\"microsoft.storage/storageaccounts/queueservices-Capacity-QueueCapacity Timeline$|Queue capacity Timeline$\",\"formatter\":5},{\"columnMatch\":\"microsoft.storage/storageaccounts/tableservices-Capacity-TableCapacity Timeline$|Table capacity Timeline$\",\"formatter\":5}],\"rowLimit\":10000,\"filter\":true,\"hierarchySettings\":{\"treeType\":1,\"groupBy\":[\"Subscription\"],\"expandTopLevel\":true,\"finalBy\":\"Name\"},\"sortBy\":[{\"itemKey\":\"$gen_heatmap_microsoft.storage/storageaccounts-Capacity-UsedCapacity$|microsoft.storage/storageaccounts/blobservices-Capacity-BlobCapacity$|microsoft.storage/storageaccounts/fileservices-Capacity-FileCapacity$|microsoft.storage/storageaccounts/queueservices-Capacity-QueueCapacity$|microsoft.storage/storageaccounts/tableservices-Capacity-TableCapacity$_3\",\"sortOrder\":2}],\"labelSettings\":[{\"columnId\":\"Subscription\",\"label\":\"Subscription\"},{\"columnId\":\"microsoft.storage/storageaccounts-Capacity-UsedCapacity\",\"label\":\"Account used capacity\"},{\"columnId\":\"microsoft.storage/storageaccounts-Capacity-UsedCapacity Timeline\",\"label\":\"Account used capacity timeline\"}]},\"sortBy\":[{\"itemKey\":\"$gen_heatmap_microsoft.storage/storageaccounts-Capacity-UsedCapacity$|microsoft.storage/storageaccounts/blobservices-Capacity-BlobCapacity$|microsoft.storage/storageaccounts/fileservices-Capacity-FileCapacity$|microsoft.storage/storageaccounts/queueservices-Capacity-QueueCapacity$|microsoft.storage/storageaccounts/tableservices-Capacity-TableCapacity$_3\",\"sortOrder\":2}],\"showExportToExcel\":true},\"conditionalVisibility\":{\"parameterName\":\"alwayshidden\",\"comparison\":\"isEqualTo\",\"value\":\"true\"},\"showPin\":true,\"name\":\"metricsGenV1-Capacity\",\"styleSettings\":{\"margin\":\"0 10px 0 10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"{\\\"version\\\":\\\"Merge/1.0\\\",\\\"merges\\\":[{\\\"id\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\",\\\"mergeType\\\":\\\"innerunique\\\",\\\"leftTable\\\":\\\"query-storageaccounts-GenV1-zones-details\\\",\\\"rightTable\\\":\\\"metricsGenV1-Capacity\\\",\\\"leftColumn\\\":\\\"id\\\",\\\"rightColumn\\\":\\\"Name\\\"}],\\\"projectRename\\\":[{\\\"originalName\\\":\\\"[query-storageaccounts-GenV1-zones-details].id\\\",\\\"mergedName\\\":\\\"id\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-GenV1-zones-details].name\\\",\\\"mergedName\\\":\\\"name\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-GenV1-zones-details].skuName\\\",\\\"mergedName\\\":\\\"skuName\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-GenV1-zones-details].kind\\\",\\\"mergedName\\\":\\\"kind\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-GenV1-zones-details].zoneRedundant\\\",\\\"mergedName\\\":\\\"zoneRedundant\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[metricsGenV1-Capacity].microsoft.storage/storageaccounts-Capacity-UsedCapacity\\\",\\\"mergedName\\\":\\\"Account used capacity(avg 30 days)\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[Added column]\\\",\\\"mergedName\\\":\\\"New estimated capacity costs\\\",\\\"fromId\\\":null,\\\"isNewItem\\\":true,\\\"newItemData\\\":[{\\\"criteriaContext\\\":{\\\"leftOperand\\\":\\\"id\\\",\\\"operator\\\":\\\"isNotNull\\\",\\\"rightValType\\\":\\\"column\\\",\\\"resultValType\\\":\\\"expression\\\",\\\"resultVal\\\":\\\"(([\\\\\\\"Account used capacity(avg 30 days)\\\\\\\"]/ (1024^3))*{storageV1GBCost})\\\"}},{\\\"criteriaContext\\\":{\\\"operator\\\":\\\"Default\\\",\\\"rightValType\\\":\\\"column\\\",\\\"resultValType\\\":\\\"column\\\"}}]},{\\\"originalName\\\":\\\"[query-storageaccounts-GenV1-zones-details].resourceGroup\\\",\\\"mergedName\\\":\\\"resourceGroup\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-GenV1-zones-details].subscriptionId\\\",\\\"mergedName\\\":\\\"subscriptionId\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-GenV1-zones-details].location\\\",\\\"mergedName\\\":\\\"location\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[metricsGenV1-Capacity].Subscription\\\",\\\"mergedName\\\":\\\"Subscription\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[metricsGenV1-Capacity].Name\\\",\\\"mergedName\\\":\\\"Name\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[metricsGenV1-Capacity].microsoft.storage/storageaccounts-Capacity-UsedCapacity Timeline\\\",\\\"mergedName\\\":\\\"Account used capacity timeline\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[query - combinedMetrics].Name\\\"},{\\\"originalName\\\":\\\"[query - combinedMetrics].Subscription\\\"},{\\\"originalName\\\":\\\"[metricsGenV2-Capacity].microsoft.storage/storageaccounts-Capacity-UsedCapacity Timeline\\\"},{\\\"originalName\\\":\\\"[metricsGenV2-Capacity].Name\\\"},{\\\"originalName\\\":\\\"[metricsGenV2-Capacity].Subscription\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-GenV2-zones-details].location\\\"}]}\",\"size\":0,\"showExportToExcel\":true,\"queryType\":7,\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"zoneRedundant\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"3\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"Account used capacity(avg 30 days)\",\"formatter\":0,\"numberFormat\":{\"unit\":2,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"New estimated capacity costs\",\"formatter\":0,\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Estimated capacity costs\",\"formatter\":0,\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Account used capacity(avg 30days)\",\"formatter\":0,\"numberFormat\":{\"unit\":2,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Estimated Storage Cost\",\"formatter\":0,\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\"}}}]}},\"name\":\"query-Storagev1withCosts\"},{\"type\":1,\"content\":{\"json\":\"> **Note:** Cost based on East US rates (Sep 2025). Storage cost only â€” excludes transactions/operations. For detailed pricing, see [Azure Pricing Calculator](https://azure.microsoft.com/pricing/calculator/).\\r\\n\",\"style\":\"info\"},\"name\":\"text - storage costs\"}]},\"conditionalVisibility\":{\"parameterName\":\"CheckforStorageV1\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"groupStorageAccount-v1\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Storage Account - Block blob\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"understand-cost-calc-yesno\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"understandCostCalculations\",\"label\":\"Show Storage cost calculation details?\",\"type\":2,\"isRequired\":true,\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"jsonData\":\"[\\r\\n    {\\r\\n    \\\"value\\\" : \\\"Yes\\\",\\r\\n    \\\"label\\\" : \\\"Yes\\\"\\r\\n    },\\r\\n    {\\r\\n    \\\"value\\\" : \\\"No\\\",\\r\\n    \\\"label\\\" : \\\"No\\\",\\r\\n    \\\"selected\\\" : true\\r\\n    }\\r\\n]\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"Show Cost Calculation Details\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"a1a1ed79-dd3e-4c78-bde6-2427b0606874\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"storageBlockGBCost\",\"label\":\"Block Storage cost per GB\",\"type\":1,\"timeContext\":{\"durationMs\":86400000},\"value\":\"0.15\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"understandCostCalculations\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"param-SAIncrease\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'Microsoft.Storage/StorageAccounts'\\r\\n| where kind == \\\"BlockBlobStorage\\\"\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend locations = properties.locations\\r\\n| extend skuName = tostring(sku.name)\\r\\n| extend zoneRedundant = case(sku.name endswith_cs 'ZRS', true, false)\\r\\n| join kind = innerunique (\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n)\\r\\n    on id\\r\\n| distinct id, name, skuName, kind, zoneRedundant, resourceGroup, subscriptionId, location\",\"size\":0,\"title\":\"Azure Storage Accounts\",\"noDataMessage\":\"All Azure Storage Accounts are zone redundant\",\"noDataMessageStyle\":3,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"zoneRedundant\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"failed\",\"text\":\"{0}{1}\"}]}}]}},\"conditionalVisibility\":{\"parameterName\":\"alwayshidden\",\"comparison\":\"isEqualTo\",\"value\":\"true\"},\"name\":\"query-storageaccounts-Block-zones-details\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"{Subscription}\"],\"parameters\":[{\"id\":\"e94aafa3-c5d9-4523-89f0-4e87aa754511\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Resources\",\"label\":\"Storage accounts\",\"type\":5,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"resources\\n| where resourceGroup in ({ResourceGroup})\\n| where type =~ 'Microsoft.Storage/StorageAccounts'\\n| where kind == \\\"BlockBlobStorage\\\"\\n| where location in~ ({ZonalRegions:value})\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\n| extend locations = properties.locations\\n| extend skuName = tostring(sku.name)\\n| extend zoneRedundant = case(sku.name endswith_cs 'ZRS', true, false)\\n| join kind = innerunique (\\n    resources\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\n    | extend replaced_tags = parse_json(replaced_tags)\\n    | mv-expand replaced_tags\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\n)\\n    on id\\n| distinct id, name, skuName, kind, zoneRedundant, resourceGroup, subscriptionId, location\",\"crossComponentResources\":[\"{Subscription}\"],\"typeSettings\":{\"resourceTypeFilter\":{\"microsoft.storage/storageaccounts\":true},\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"}],\"style\":\"above\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},\"conditionalVisibility\":{\"parameterName\":\"alwayshidden\",\"comparison\":\"isEqualTo\",\"value\":\"true\"},\"name\":\"paramSAGenBlock\",\"styleSettings\":{\"margin\":\"15px 0 0 0\"}},{\"type\":10,\"content\":{\"chartId\":\"workbookdb19a8d8-91af-44ea-951d-5ffa133b2ebe\",\"version\":\"MetricsItem/2.0\",\"size\":3,\"chartType\":0,\"resourceType\":\"microsoft.storage/storageaccounts\",\"metricScope\":0,\"resourceParameter\":\"Resources\",\"resourceIds\":[\"{Resources}\"],\"timeContext\":{\"durationMs\":2592000000},\"metrics\":[{\"namespace\":\"microsoft.storage/storageaccounts\",\"metric\":\"microsoft.storage/storageaccounts-Capacity-UsedCapacity\",\"aggregation\":4}],\"title\":\"Storage Capacity\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"$gen_group\",\"formatter\":13,\"formatOptions\":{\"linkTarget\":\"Resource\",\"subTarget\":\"insights\",\"showIcon\":true}},{\"columnMatch\":\"Subscription\",\"formatter\":5},{\"columnMatch\":\"Name\",\"formatter\":5},{\"columnMatch\":\"microsoft.storage/storageaccounts-Capacity-UsedCapacity$|microsoft.storage/storageaccounts/blobservices-Capacity-BlobCapacity$|microsoft.storage/storageaccounts/fileservices-Capacity-FileCapacity$|microsoft.storage/storageaccounts/queueservices-Capacity-QueueCapacity$|microsoft.storage/storageaccounts/tableservices-Capacity-TableCapacity$\",\"formatter\":8,\"formatOptions\":{\"min\":0,\"palette\":\"blue\",\"linkTarget\":\"WorkbookTemplate\",\"workbookContext\":{\"componentIdSource\":\"column\",\"componentId\":\"Name\",\"resourceIdsSource\":\"column\",\"resourceIds\":\"Name\",\"templateIdSource\":\"static\",\"templateId\":\"Community-Workbooks/Individual Storage/Capacity\",\"typeSource\":\"static\",\"type\":\"workbook\",\"gallerySource\":\"static\",\"gallery\":\"microsoft.storage/storageaccounts\"}},\"numberFormat\":{\"unit\":2,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":1}}},{\"columnMatch\":\"microsoft.storage/storageaccounts-Capacity-UsedCapacity Timeline$|Account used capacity Timeline$\",\"formatter\":5},{\"columnMatch\":\"microsoft.storage/storageaccounts/blobservices-Capacity-BlobCapacity Timeline$|Blob capacity Timeline$\",\"formatter\":5},{\"columnMatch\":\"microsoft.storage/storageaccounts/fileservices-Capacity-FileCapacity Timeline$|File capacity Timeline$\",\"formatter\":5},{\"columnMatch\":\"microsoft.storage/storageaccounts/queueservices-Capacity-QueueCapacity Timeline$|Queue capacity Timeline$\",\"formatter\":5},{\"columnMatch\":\"microsoft.storage/storageaccounts/tableservices-Capacity-TableCapacity Timeline$|Table capacity Timeline$\",\"formatter\":5}],\"rowLimit\":10000,\"filter\":true,\"hierarchySettings\":{\"treeType\":1,\"groupBy\":[\"Subscription\"],\"expandTopLevel\":true,\"finalBy\":\"Name\"},\"sortBy\":[{\"itemKey\":\"$gen_heatmap_microsoft.storage/storageaccounts-Capacity-UsedCapacity$|microsoft.storage/storageaccounts/blobservices-Capacity-BlobCapacity$|microsoft.storage/storageaccounts/fileservices-Capacity-FileCapacity$|microsoft.storage/storageaccounts/queueservices-Capacity-QueueCapacity$|microsoft.storage/storageaccounts/tableservices-Capacity-TableCapacity$_3\",\"sortOrder\":2}],\"labelSettings\":[{\"columnId\":\"Subscription\",\"label\":\"Subscription\"},{\"columnId\":\"microsoft.storage/storageaccounts-Capacity-UsedCapacity\",\"label\":\"Account used capacity\"},{\"columnId\":\"microsoft.storage/storageaccounts-Capacity-UsedCapacity Timeline\",\"label\":\"Account used capacity timeline\"}]},\"sortBy\":[{\"itemKey\":\"$gen_heatmap_microsoft.storage/storageaccounts-Capacity-UsedCapacity$|microsoft.storage/storageaccounts/blobservices-Capacity-BlobCapacity$|microsoft.storage/storageaccounts/fileservices-Capacity-FileCapacity$|microsoft.storage/storageaccounts/queueservices-Capacity-QueueCapacity$|microsoft.storage/storageaccounts/tableservices-Capacity-TableCapacity$_3\",\"sortOrder\":2}],\"showExportToExcel\":true},\"conditionalVisibility\":{\"parameterName\":\"alwayshidden\",\"comparison\":\"isEqualTo\",\"value\":\"true\"},\"showPin\":true,\"name\":\"metricsBlock-Capacity\",\"styleSettings\":{\"margin\":\"0 10px 0 10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"{\\\"version\\\":\\\"Merge/1.0\\\",\\\"merges\\\":[{\\\"id\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\",\\\"mergeType\\\":\\\"innerunique\\\",\\\"leftTable\\\":\\\"query-storageaccounts-Block-zones-details\\\",\\\"rightTable\\\":\\\"metricsBlock-Capacity\\\",\\\"leftColumn\\\":\\\"id\\\",\\\"rightColumn\\\":\\\"Name\\\"}],\\\"projectRename\\\":[{\\\"originalName\\\":\\\"[query-storageaccounts-Block-zones-details].id\\\",\\\"mergedName\\\":\\\"id\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-Block-zones-details].name\\\",\\\"mergedName\\\":\\\"name\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-Block-zones-details].skuName\\\",\\\"mergedName\\\":\\\"skuName\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-Block-zones-details].kind\\\",\\\"mergedName\\\":\\\"kind\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[metricsBlock-Capacity].microsoft.storage/storageaccounts-Capacity-UsedCapacity\\\",\\\"mergedName\\\":\\\"Account used capacity(avg 30days)\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[Added column]\\\",\\\"mergedName\\\":\\\"New estimated cost\\\",\\\"fromId\\\":null,\\\"isNewItem\\\":true,\\\"newItemData\\\":[{\\\"criteriaContext\\\":{\\\"leftOperand\\\":\\\"id\\\",\\\"operator\\\":\\\"isNotNull\\\",\\\"rightValType\\\":\\\"column\\\",\\\"resultValType\\\":\\\"expression\\\",\\\"resultVal\\\":\\\"(([\\\\\\\"Account used capacity(avg 30days)\\\\\\\"]/ (1024^3))*{storageBlockGBCost})\\\"}},{\\\"criteriaContext\\\":{\\\"operator\\\":\\\"Default\\\",\\\"rightValType\\\":\\\"column\\\",\\\"resultValType\\\":\\\"column\\\"}}]},{\\\"originalName\\\":\\\"[query-storageaccounts-Block-zones-details].zoneRedundant\\\",\\\"mergedName\\\":\\\"zoneRedundant\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-Block-zones-details].resourceGroup\\\",\\\"mergedName\\\":\\\"resourceGroup\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-Block-zones-details].subscriptionId\\\",\\\"mergedName\\\":\\\"subscriptionId\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-Block-zones-details].location\\\",\\\"mergedName\\\":\\\"location\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[query - combinedMetrics].Name\\\"},{\\\"originalName\\\":\\\"[query - combinedMetrics].Subscription\\\"},{\\\"originalName\\\":\\\"[metricsGenV2-Capacity].microsoft.storage/storageaccounts-Capacity-UsedCapacity Timeline\\\"},{\\\"originalName\\\":\\\"[metricsGenV2-Capacity].Name\\\"},{\\\"originalName\\\":\\\"[metricsGenV2-Capacity].Subscription\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-GenV2-zones-details].location\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-GenV1-zones-details].id\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-GenV1-zones-details].name\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-GenV1-zones-details].skuName\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-GenV1-zones-details].kind\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-GenV1-zones-details].zoneRedundant\\\"},{\\\"originalName\\\":\\\"[metricsGenV1-Capacity].microsoft.storage/storageaccounts-Capacity-UsedCapacity\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-GenV1-zones-details].resourceGroup\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-GenV1-zones-details].subscriptionId\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-GenV1-zones-details].location\\\"},{\\\"originalName\\\":\\\"[metricsGenV1-Capacity].Subscription\\\"},{\\\"originalName\\\":\\\"[metricsGenV1-Capacity].Name\\\"},{\\\"originalName\\\":\\\"[metricsGenV1-Capacity].microsoft.storage/storageaccounts-Capacity-UsedCapacity Timeline\\\"},{\\\"originalName\\\":\\\"[metricsBlock-Capacity].microsoft.storage/storageaccounts-Capacity-UsedCapacity Timeline\\\"},{\\\"originalName\\\":\\\"[metricsBlock-Capacity].Subscription\\\"},{\\\"originalName\\\":\\\"[metricsBlock-Capacity].Name\\\"}]}\",\"size\":0,\"showExportToExcel\":true,\"queryType\":7,\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Account used capacity(avg 30days)\",\"formatter\":0,\"numberFormat\":{\"unit\":2,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"New estimated cost\",\"formatter\":0,\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"zoneRedundant\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"3\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"Account used capacity(avg 30 days)\",\"formatter\":0,\"numberFormat\":{\"unit\":2,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"New estimated capacity costs\",\"formatter\":0,\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Estimated capacity costs\",\"formatter\":0,\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Estimated Storage Cost\",\"formatter\":0,\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\"}}}]}},\"name\":\"query-StorageBlockwithCosts\"},{\"type\":1,\"content\":{\"json\":\"> **Note:** Cost based on East US rates (Sep 2025). Storage cost only â€” excludes transactions/operations. For detailed pricing, see [Azure Pricing Calculator](https://azure.microsoft.com/pricing/calculator/).\\r\\n\",\"style\":\"info\"},\"name\":\"text - storage costs\"}]},\"conditionalVisibility\":{\"parameterName\":\"CheckforStorageBlock\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"groupStorageAccount-Block\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Storage Account - Files\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"understand-cost-calc-yesno\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"understandCostCalculations\",\"label\":\"Show Storage cost calculation details?\",\"type\":2,\"isRequired\":true,\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"jsonData\":\"[\\r\\n    {\\r\\n    \\\"value\\\" : \\\"Yes\\\",\\r\\n    \\\"label\\\" : \\\"Yes\\\"\\r\\n    },\\r\\n    {\\r\\n    \\\"value\\\" : \\\"No\\\",\\r\\n    \\\"label\\\" : \\\"No\\\",\\r\\n    \\\"selected\\\" : true\\r\\n    }\\r\\n]\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"Show Cost Calculation Details\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"a1a1ed79-dd3e-4c78-bde6-2427b0606874\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"storageFilesGBCost\",\"label\":\"Storage Files cost per GB\",\"type\":1,\"timeContext\":{\"durationMs\":86400000},\"value\":\"0.15\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"understandCostCalculations\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"param-SAIncrease\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'Microsoft.Storage/StorageAccounts'\\r\\n| where kind == \\\"FileStorage\\\"\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend locations = properties.locations\\r\\n| extend skuName = tostring(sku.name)\\r\\n| extend zoneRedundant = case(sku.name endswith_cs 'ZRS', true, false)\\r\\n//| where zoneRedudant = false\\r\\n| join kind = innerunique (\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n)\\r\\n    on id\\r\\n| distinct id, name, skuName, kind, zoneRedundant, resourceGroup, subscriptionId, location\",\"size\":0,\"title\":\"Azure Storage Accounts\",\"noDataMessage\":\"All Azure Storage Accounts are zone redundant\",\"noDataMessageStyle\":3,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"zoneRedundant\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"failed\",\"text\":\"{0}{1}\"}]}}]}},\"conditionalVisibility\":{\"parameterName\":\"alwayshidden\",\"comparison\":\"isEqualTo\",\"value\":\"true\"},\"name\":\"query-storageaccounts-Files-zones-details\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"{Subscription}\"],\"parameters\":[{\"id\":\"e94aafa3-c5d9-4523-89f0-4e87aa754511\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Resources\",\"label\":\"Storage accounts\",\"type\":5,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"resources\\n| where resourceGroup in ({ResourceGroup})\\n| where type =~ 'Microsoft.Storage/StorageAccounts'\\n| where kind == \\\"FileStorage\\\"\\n| where location in~ ({ZonalRegions:value})\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\n| extend locations = properties.locations\\n| extend skuName = tostring(sku.name)\\n| extend zoneRedundant = case(sku.name endswith_cs 'ZRS', true, false)\\n//| where zoneRedudant = false\\n| join kind = innerunique (\\n    resources\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\n    | extend replaced_tags = parse_json(replaced_tags)\\n    | mv-expand replaced_tags\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\n)\\n    on id\\n| distinct id, name, skuName, kind, zoneRedundant, resourceGroup, subscriptionId, location\",\"crossComponentResources\":[\"{Subscription}\"],\"typeSettings\":{\"resourceTypeFilter\":{\"microsoft.storage/storageaccounts\":true},\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"}],\"style\":\"above\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},\"conditionalVisibility\":{\"parameterName\":\"alwayshidden\",\"comparison\":\"isEqualTo\",\"value\":\"true\"},\"name\":\"paramSAFiles\",\"styleSettings\":{\"margin\":\"15px 0 0 0\"}},{\"type\":10,\"content\":{\"chartId\":\"workbookdb19a8d8-91af-44ea-951d-5ffa133b2ebe\",\"version\":\"MetricsItem/2.0\",\"size\":3,\"chartType\":0,\"resourceType\":\"microsoft.storage/storageaccounts\",\"metricScope\":0,\"resourceParameter\":\"Resources\",\"resourceIds\":[\"{Resources}\"],\"timeContext\":{\"durationMs\":2592000000},\"metrics\":[{\"namespace\":\"microsoft.storage/storageaccounts\",\"metric\":\"microsoft.storage/storageaccounts-Capacity-UsedCapacity\",\"aggregation\":4}],\"title\":\"Storage Capacity\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"$gen_group\",\"formatter\":13,\"formatOptions\":{\"linkTarget\":\"Resource\",\"subTarget\":\"insights\",\"showIcon\":true}},{\"columnMatch\":\"Subscription\",\"formatter\":5},{\"columnMatch\":\"Name\",\"formatter\":5},{\"columnMatch\":\"microsoft.storage/storageaccounts-Capacity-UsedCapacity$|microsoft.storage/storageaccounts/blobservices-Capacity-BlobCapacity$|microsoft.storage/storageaccounts/fileservices-Capacity-FileCapacity$|microsoft.storage/storageaccounts/queueservices-Capacity-QueueCapacity$|microsoft.storage/storageaccounts/tableservices-Capacity-TableCapacity$\",\"formatter\":8,\"formatOptions\":{\"min\":0,\"palette\":\"blue\",\"linkTarget\":\"WorkbookTemplate\",\"workbookContext\":{\"componentIdSource\":\"column\",\"componentId\":\"Name\",\"resourceIdsSource\":\"column\",\"resourceIds\":\"Name\",\"templateIdSource\":\"static\",\"templateId\":\"Community-Workbooks/Individual Storage/Capacity\",\"typeSource\":\"static\",\"type\":\"workbook\",\"gallerySource\":\"static\",\"gallery\":\"microsoft.storage/storageaccounts\"}},\"numberFormat\":{\"unit\":2,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":1}}},{\"columnMatch\":\"microsoft.storage/storageaccounts-Capacity-UsedCapacity Timeline$|Account used capacity Timeline$\",\"formatter\":5},{\"columnMatch\":\"microsoft.storage/storageaccounts/blobservices-Capacity-BlobCapacity Timeline$|Blob capacity Timeline$\",\"formatter\":5},{\"columnMatch\":\"microsoft.storage/storageaccounts/fileservices-Capacity-FileCapacity Timeline$|File capacity Timeline$\",\"formatter\":5},{\"columnMatch\":\"microsoft.storage/storageaccounts/queueservices-Capacity-QueueCapacity Timeline$|Queue capacity Timeline$\",\"formatter\":5},{\"columnMatch\":\"microsoft.storage/storageaccounts/tableservices-Capacity-TableCapacity Timeline$|Table capacity Timeline$\",\"formatter\":5}],\"rowLimit\":10000,\"filter\":true,\"hierarchySettings\":{\"treeType\":1,\"groupBy\":[\"Subscription\"],\"expandTopLevel\":true,\"finalBy\":\"Name\"},\"sortBy\":[{\"itemKey\":\"$gen_heatmap_microsoft.storage/storageaccounts-Capacity-UsedCapacity$|microsoft.storage/storageaccounts/blobservices-Capacity-BlobCapacity$|microsoft.storage/storageaccounts/fileservices-Capacity-FileCapacity$|microsoft.storage/storageaccounts/queueservices-Capacity-QueueCapacity$|microsoft.storage/storageaccounts/tableservices-Capacity-TableCapacity$_3\",\"sortOrder\":2}],\"labelSettings\":[{\"columnId\":\"Subscription\",\"label\":\"Subscription\"},{\"columnId\":\"microsoft.storage/storageaccounts-Capacity-UsedCapacity\",\"label\":\"Account used capacity\"},{\"columnId\":\"microsoft.storage/storageaccounts-Capacity-UsedCapacity Timeline\",\"label\":\"Account used capacity timeline\"}]},\"sortBy\":[{\"itemKey\":\"$gen_heatmap_microsoft.storage/storageaccounts-Capacity-UsedCapacity$|microsoft.storage/storageaccounts/blobservices-Capacity-BlobCapacity$|microsoft.storage/storageaccounts/fileservices-Capacity-FileCapacity$|microsoft.storage/storageaccounts/queueservices-Capacity-QueueCapacity$|microsoft.storage/storageaccounts/tableservices-Capacity-TableCapacity$_3\",\"sortOrder\":2}],\"showExportToExcel\":true},\"conditionalVisibility\":{\"parameterName\":\"alwayshidden\",\"comparison\":\"isEqualTo\",\"value\":\"true\"},\"showPin\":true,\"name\":\"metricsFiles-Capacity\",\"styleSettings\":{\"margin\":\"0 10px 0 10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"{\\\"version\\\":\\\"Merge/1.0\\\",\\\"merges\\\":[{\\\"id\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\",\\\"mergeType\\\":\\\"innerunique\\\",\\\"leftTable\\\":\\\"query-storageaccounts-Files-zones-details\\\",\\\"rightTable\\\":\\\"metricsFiles-Capacity\\\",\\\"leftColumn\\\":\\\"id\\\",\\\"rightColumn\\\":\\\"Name\\\"}],\\\"projectRename\\\":[{\\\"originalName\\\":\\\"[query-storageaccounts-Files-zones-details].id\\\",\\\"mergedName\\\":\\\"id\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-Files-zones-details].name\\\",\\\"mergedName\\\":\\\"name\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-Files-zones-details].skuName\\\",\\\"mergedName\\\":\\\"skuName\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-Files-zones-details].kind\\\",\\\"mergedName\\\":\\\"kind\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-Files-zones-details].zoneRedundant\\\",\\\"mergedName\\\":\\\"zoneRedundant\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[metricsFiles-Capacity].microsoft.storage/storageaccounts-Capacity-UsedCapacity\\\",\\\"mergedName\\\":\\\"Account used capacity(avg 30days)\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[Added column]\\\",\\\"mergedName\\\":\\\"New estimated storage cost\\\",\\\"fromId\\\":null,\\\"isNewItem\\\":true,\\\"newItemData\\\":[{\\\"criteriaContext\\\":{\\\"leftOperand\\\":\\\"id\\\",\\\"operator\\\":\\\"isNotNull\\\",\\\"rightValType\\\":\\\"column\\\",\\\"resultValType\\\":\\\"expression\\\",\\\"resultVal\\\":\\\"(([\\\\\\\"Account used capacity(avg 30days)\\\\\\\"]/ (1024^3))*{storageFilesGBCost})\\\"}},{\\\"criteriaContext\\\":{\\\"operator\\\":\\\"Default\\\",\\\"rightValType\\\":\\\"column\\\",\\\"resultValType\\\":\\\"column\\\"}}]},{\\\"originalName\\\":\\\"[query-storageaccounts-Files-zones-details].resourceGroup\\\",\\\"mergedName\\\":\\\"resourceGroup\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-Files-zones-details].subscriptionId\\\",\\\"mergedName\\\":\\\"subscriptionId\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[query-storageaccounts-Files-zones-details].location\\\",\\\"mergedName\\\":\\\"location\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[metricsFiles-Capacity].Subscription\\\",\\\"mergedName\\\":\\\"Subscription\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[metricsFiles-Capacity].Name\\\",\\\"mergedName\\\":\\\"Name\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"},{\\\"originalName\\\":\\\"[metricsFiles-Capacity].microsoft.storage/storageaccounts-Capacity-UsedCapacity Timeline\\\",\\\"mergedName\\\":\\\"Account used capacity timeline\\\",\\\"fromId\\\":\\\"ff12ebfb-c913-4bb8-b395-75c433b491dc\\\"}]}\",\"size\":0,\"showExportToExcel\":true,\"queryType\":7,\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"zoneRedundant\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"3\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"Account used capacity(avg 30days)\",\"formatter\":0,\"numberFormat\":{\"unit\":2,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"New estimated storage cost\",\"formatter\":0,\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"New estimated cost\",\"formatter\":0,\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Account used capacity(avg 30 days)\",\"formatter\":0,\"numberFormat\":{\"unit\":2,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"New estimated capacity costs\",\"formatter\":0,\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Estimated capacity costs\",\"formatter\":0,\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Estimated Storage Cost\",\"formatter\":0,\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\"}}}]}},\"name\":\"query-StorageBlockwithCosts\"},{\"type\":1,\"content\":{\"json\":\"> **Note:** Cost based on East US rates (Sep 2025). Storage cost only â€” excludes transactions/operations. For detailed pricing, see [Azure Pricing Calculator](https://azure.microsoft.com/pricing/calculator/).\\r\\n\",\"style\":\"info\"},\"name\":\"text - storage costs\"}]},\"name\":\"groupStorageAccount-Files\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ \\\"Microsoft.NetApp/netAppAccounts/capacityPools/volumes\\\"\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend locations=properties.locations\\r\\n| extend zoneRedundant = case(\\r\\n    isnull(zones) or array_length(zones) <= 1, false, \\r\\n    true \\r\\n  )\\r\\n| join kind = innerunique( //Tag filter\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId=id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n    )\\r\\n    on id\\r\\n| distinct id,name,zoneRedundant,resourceGroup,subscriptionId,location,tostring(tags)\",\"size\":0,\"title\":\"Azure Net App Files\",\"noDataMessage\":\"All Azure Net App Files volumes have availability zones configured\",\"noDataMessageStyle\":3,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"zoneRedundant\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"failed\",\"text\":\"{0}{1}\"}]}}],\"rowLimit\":1000}},\"name\":\"query-net-app-zone-details\"}]},\"name\":\"group - NetAppFiles\"}]},\"conditionalVisibility\":{\"parameterName\":\"selectedDetailsTab\",\"comparison\":\"isEqualTo\",\"value\":\"storage\"},\"name\":\"group - storageAccounts\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Compute Services Availability Zone Coverage\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type == 'microsoft.compute/disks'\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resiliencyLevel = case(\\r\\n    sku.name in ('Premium_ZRS', 'Standard_ZRS'), \\\"Zone-Redundant\\\",    \\r\\n    isnotempty(zones) and array_length(zones) > 0, \\\"Zonal\\\",    \\r\\n    \\\"Regional\\\"\\r\\n  )\\r\\n| join kind = innerunique( //tag filter\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId=id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n    )\\r\\n    on id\\r\\n| project id,name,tostring(sku.name),resiliencyLevel,tostring(zones), resourceGroup,subscriptionId,location\",\"size\":0,\"title\":\"Azure Disk Storage\",\"noDataMessage\":\"All disks have availability zones configured\",\"noDataMessageStyle\":3,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"resiliencyLevel\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"Zone-Redudant\",\"representation\":\"success\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Zonal\",\"representation\":\"2\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Regional\",\"representation\":\"4\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"success\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"resourceGroup\",\"formatter\":14,\"formatOptions\":{\"linkTarget\":null,\"showIcon\":true}},{\"columnMatch\":\"subscriptionId\",\"formatter\":15,\"formatOptions\":{\"linkTarget\":null,\"showIcon\":true}},{\"columnMatch\":\"zoneRedundant\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"failed\",\"text\":\"\"}]}}],\"rowLimit\":1000,\"filter\":true,\"sortBy\":[{\"itemKey\":\"sku_name\",\"sortOrder\":1}]},\"sortBy\":[{\"itemKey\":\"sku_name\",\"sortOrder\":1}]},\"name\":\"query-disks-zones-details\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'microsoft.compute/virtualmachines'\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend pinnedZone = case(\\r\\n    isnull(zones), false, \\r\\n    true \\r\\n  )\\r\\n| extend size = properties.hardwareProfile.vmSize\\r\\n| join kind = innerunique( //Tag filter\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId=id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n    )\\r\\n    on id\\r\\n| project id,name,tostring(size),pinnedZone,tostring(zones),resourceGroup,subscriptionId,location\",\"size\":0,\"title\":\"Azure Virtual Machines\",\"noDataMessage\":\"All Virtual Machines have availability zones configured\",\"noDataMessageStyle\":3,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"pinnedZone\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"4\",\"text\":\"\"}]}},{\"columnMatch\":\"zoneRedundant\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"4\",\"text\":\"\"}]}}],\"rowLimit\":1000},\"sortBy\":[]},\"name\":\"query-vms-zones-details\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'microsoft.compute/virtualmachinescalesets'\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend zoneRedundant = case(\\r\\n    isnull(zones) or array_length(zones) <= 1, false, \\r\\n    true \\r\\n  )\\r\\n| extend sku = sku.name\\r\\n| join kind = innerunique( //Tag filter\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId=id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n    )\\r\\n    on id\\r\\n| project id,name,tostring(sku),zoneRedundant,tostring(zones),resourceGroup,subscriptionId,location\",\"size\":0,\"title\":\"Azure Virtual Machines Scale Sets\",\"noDataMessage\":\"All Virtual Machines Scale Sets have availability zones configured\",\"noDataMessageStyle\":3,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"pinnedZone\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"4\",\"text\":\"\"}]}},{\"columnMatch\":\"zoneRedundant\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"4\",\"text\":\"\"}]}}],\"rowLimit\":1000},\"sortBy\":[]},\"name\":\"query-vmss-zones-details\"}]},\"conditionalVisibility\":{\"parameterName\":\"selectedDetailsTab\",\"comparison\":\"isEqualTo\",\"value\":\"compute\"},\"name\":\"group - Details-Compute\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Integration Services Availability Zone Coverage\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"{Subscription}\"],\"parameters\":[{\"id\":\"14bb128f-5b3f-421a-9cf7-b9ad71ece3f6\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"CheckforEventHub\",\"type\":1,\"isRequired\":true,\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'microsoft.eventhub/namespaces'\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend skuTier = tostring(sku.tier)\\r\\n| extend \\r\\n    currentZoneRedundant = case(\\r\\n        skuTier in ('Standard', 'Premium', 'Dedicated'), true,  // Zone redundancy automatic for these tiers\\r\\n        false  // Basic tier doesn't support zone redundancy\\r\\n    )\\r\\n//| where currentZoneRedundant == false  // Only non-zone-redundant instances\\r\\n| join kind = innerunique (\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n)\\r\\n    on id\\r\\n| summarize EventHubCount = count()\\r\\n| extend HasNonZonalEventHub = iff(EventHubCount > 0, \\\"Yes\\\", \\\"No\\\")\\r\\n| project HasNonZonalEventHub\",\"crossComponentResources\":[\"{Subscription}\"],\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"id\":\"8da6b29c-a9cd-4b1c-91e0-4402873a06bc\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"CheckforAPIM\",\"type\":1,\"isRequired\":true,\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'microsoft.apimanagement/service'\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend skuName = tostring(sku.name)\\r\\n| extend \\r\\n    currentZoneRedundant = case(\\r\\n        skuName =~ 'Premium' and (not(isnull(zones)) and array_length(zones) > 1), true,\\r\\n        false  // All other tiers don't support zones\\r\\n    )\\r\\n//| where currentZoneRedundant == false  // Only non-zone-redundant instances\\r\\n| join kind = innerunique (\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n)\\r\\n    on id\\r\\n| summarize APIMCount = count()\\r\\n| extend HasNonZonalAPIM = iff(APIMCount > 0, \\\"Yes\\\", \\\"No\\\")\\r\\n| project HasNonZonalAPIM\",\"crossComponentResources\":[\"{Subscription}\"],\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"id\":\"d9a47d4a-e881-4743-acb7-92f64005b4b2\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"CheckforMySQL\",\"type\":1,\"isRequired\":true,\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'microsoft.dbformysql/flexibleservers'\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend \\r\\n    highAvailabilityMode = tostring(properties.highAvailability.mode)\\r\\n| extend \\r\\n    zoneRedundant = case(\\r\\n        highAvailabilityMode != \\\"ZoneRedundant\\\", false, true \\r\\n    )\\r\\n//| where zoneRedundant == false  // Only non-zone-redundant servers\\r\\n| join kind = innerunique (\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n)\\r\\n    on id\\r\\n| summarize MySQLServerCount = count()\\r\\n| extend HasNonZonalMySQL = iff(MySQLServerCount > 0, \\\"Yes\\\", \\\"No\\\")\\r\\n| project HasNonZonalMySQL\",\"crossComponentResources\":[\"{Subscription}\"],\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"id\":\"c1d043fb-f5cb-4697-bade-f7292dfbdee2\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"CheckforRediss\",\"type\":1,\"isRequired\":true,\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'microsoft.cache/redis'\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend \\r\\n    currentZoneRedundant = case(\\r\\n        properties.zonalAllocationPolicy != \\\"Automatic\\\" and (array_length(zones) <= 1 or isnull(zones)), false, \\r\\n        true \\r\\n    )\\r\\n//| where currentZoneRedundant == false  // Only non-zone-redundant instances\\r\\n| join kind = innerunique (\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n)\\r\\n    on id\\r\\n| summarize RedisCacheCount = count()\\r\\n| extend HasNonZonalRedisCache = iff(RedisCacheCount > 0, \\\"Yes\\\", \\\"No\\\")\\r\\n| project HasNonZonalRedisCache\",\"crossComponentResources\":[\"{Subscription}\"],\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"version\":\"KqlParameterItem/1.0\",\"name\":\"CheckforPostgres\",\"type\":1,\"isRequired\":true,\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'microsoft.dbforpostgresql/flexibleservers'\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend \\r\\n    highAvailabilityMode = tostring(properties.highAvailability.mode)\\r\\n| extend \\r\\n    zoneRedundant = case(\\r\\n        highAvailabilityMode != \\\"ZoneRedundant\\\", false, true \\r\\n    )\\r\\n//| where zoneRedundant == false  // Only non-zone-redundant servers\\r\\n| join kind = innerunique (\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n)\\r\\n    on id\\r\\n| summarize PostgreSQLServerCount = count()\\r\\n| extend HasNonZonalPostgreSQL = iff(PostgreSQLServerCount > 0, \\\"Yes\\\", \\\"No\\\")\\r\\n| project HasNonZonalPostgreSQL\",\"crossComponentResources\":[\"{Subscription}\"],\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"id\":\"cf7e0412-bdae-40eb-9132-33f456f43603\"},{\"id\":\"cf7e0412-bdae-40eb-9132-33f456f43603\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"CheckforServiceBus\",\"type\":1,\"isRequired\":true,\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'microsoft.servicebus/namespaces'\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend \\r\\n    currentZoneRedundant = true  // Always true in zonal regions per Microsoft's behavior\\r\\n//| where currentZoneRedundant == false  // This will return no results since all are zone redundant\\r\\n| join kind = innerunique (\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId = id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n)\\r\\n    on id\\r\\n| summarize ServiceBusCount = count()\\r\\n| extend HasNonZonalServiceBusCount = iff(ServiceBusCount > 0, \\\"Yes\\\", \\\"No\\\")\\r\\n| project HasNonZonalServiceBusCount\",\"crossComponentResources\":[\"{Subscription}\"],\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"}],\"style\":\"pills\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},\"conditionalVisibility\":{\"parameterName\":\"AlwaysHidden\",\"comparison\":\"isEqualTo\",\"value\":\"yes\"},\"name\":\"paramCheckAPIMAzResources\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"understand-cost-calc-yesno\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"understandCostCalculations\",\"label\":\"Show APIM cost calculation details?\",\"type\":2,\"isRequired\":true,\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"jsonData\":\"[\\r\\n    {\\r\\n    \\\"value\\\" : \\\"Yes\\\",\\r\\n    \\\"label\\\" : \\\"Yes\\\"\\r\\n    },\\r\\n    {\\r\\n    \\\"value\\\" : \\\"No\\\",\\r\\n    \\\"label\\\" : \\\"No\\\",\\r\\n    \\\"selected\\\" : true\\r\\n    }\\r\\n]\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"Show Cost Calculation Details\"},{\"type\":1,\"content\":{\"json\":\"How VPN Gateway Cost is Calculated\\r\\nMonthly Cost Formula:\\r\\n\\r\\nBase Gateway Cost: Fixed monthly cost based on AZ SKU tier\\r\\nAdditional S2S Tunnels: $0.015/hour for tunnels beyond included limit\\r\\nAdditional P2S Connections: $0.01/hour for connections beyond 128\\r\\nSKU Mapping & Base Costs:\\r\\n\\r\\nBasic/Standard â†’ VpnGw1AZ: $153.30/month\\r\\nVpnGw1 â†’ VpnGw1AZ: $153.30/month\\r\\nVpnGw2 â†’ VpnGw2AZ: $394.20/month\\r\\nVpnGw3 â†’ VpnGw3AZ: $1,007.40/month\\r\\nVpnGw4 â†’ VpnGw4AZ: $1,686.30/month\\r\\nVpnGw5 â†’ VpnGw5AZ: $2,934.60/month\\r\\nIncluded Limits:\\r\\n\\r\\nS2S Tunnels: First 10 included (VpnGw1-3AZ), first 10 included (VpnGw4-5AZ supports up to 100)\\r\\nP2S Connections: First 128 included for all SKUs\\r\\nCalculation Example:\\r\\n\\r\\nVpnGw2AZ base cost: $394.20/month\\r\\n5 S2S tunnels: Free (within 10 limit)\\r\\n50 P2S connections: Free (within 128 limit)\\r\\nTotal monthly cost: $394.20\\r\\nDefault Assumptions:\\r\\n\\r\\nS2S Tunnels: 5 tunnels\\r\\nP2S Connections: 50 connections\\r\\nEast US pricing (September 2025)\\r\\nYou can adjust these parameters above to match your specific gateway configuration.\",\"style\":\"info\"},\"conditionalVisibility\":{\"parameterName\":\"understandCostCalculations\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"texAPIMCost\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"953d5198-c688-447e-b6b0-b2d7af9a1920\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"baseUnit\",\"type\":1,\"timeContext\":{\"durationMs\":86400000},\"value\":\"1\"},{\"id\":\"eb56a996-f4b8-4253-af77-60119a5be04a\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"pricePerHour\",\"type\":1,\"timeContext\":{\"durationMs\":86400000},\"value\":\"3.84\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"understandCostCalculations\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"paramAPIMCosts\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'microsoft.apimanagement/service'\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend skuName = tostring(sku.name)\\r\\n| extend skuCapacity = toint(sku.capacity)\\r\\n| extend zoneRedundant = case(\\r\\n    skuName =~ 'Premium' and (not(isnull(zones)) and array_length(zones) > 1), true,\\r\\n    false \\r\\n  )\\r\\n| extend zoneSupported = iff(skuName =~ 'Premium', true, false)\\r\\n| join kind = innerunique( //Tag filter\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}'])\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n    | project id\\r\\n    )\\r\\n    on id\\r\\n| extend \\r\\n    baseUnit = toint({baseUnit}),\\r\\n    pricePerHour = todouble({pricePerHour}),\\r\\n    hoursPerMonth = 730\\r\\n| extend EstimatedMonthlyCost = case(\\r\\n    skuName =~ 'Premium' and zoneRedundant, 0.0, // No additional cost if already Premium with zones\\r\\n    skuName =~ 'Premium' and not(zoneRedundant), 0.0, // No cost to configure zones on existing Premium\\r\\n    baseUnit * pricePerHour * hoursPerMonth // Cost to upgrade to Premium tier\\r\\n)\\r\\n| extend \\r\\n    Recommendation = case(\\r\\n        skuName =~ 'Premium' and zoneRedundant, 'No action needed - Zone redundancy configured',\\r\\n        skuName =~ 'Premium' and not(zoneRedundant), 'Configure availability zones for Premium tier',\\r\\n        skuName in~ ('Developer', 'Basic', 'Standard', 'BasicV2', 'StandardV2', 'PremiumV2', 'Consumption'), 'Upgrade to Premium (classic) tier for zone redundancy support',\\r\\n        'Review APIM tier for zone redundancy capabilities'\\r\\n    ),\\r\\n    ImplementationImpact = case(\\r\\n        skuName =~ 'Premium' and zoneRedundant, 'None',\\r\\n        skuName =~ 'Premium' and not(zoneRedundant), 'Low',\\r\\n        skuName in~ ('Developer', 'Basic', 'Standard'), 'High',\\r\\n        skuName in~ ('BasicV2', 'StandardV2', 'PremiumV2', 'Consumption'), 'High',\\r\\n        'Medium'\\r\\n    ),\\r\\n    ImplementationComplexity = case(\\r\\n        skuName =~ 'Premium' and zoneRedundant, 'None',\\r\\n        skuName =~ 'Premium' and not(zoneRedundant), 'Low',\\r\\n        skuName in~ ('Developer', 'Basic', 'Standard'), 'High',\\r\\n        skuName in~ ('BasicV2', 'StandardV2', 'PremiumV2', 'Consumption'), 'High',\\r\\n        'Medium'\\r\\n    ),\\r\\n    CostEstimation = case(\\r\\n        EstimatedMonthlyCost > 0, strcat('[Cost Est.] $', round(EstimatedMonthlyCost, 2), ' per month'),\\r\\n        '[Cost Est.] No additional cost'\\r\\n    )\\r\\n| project \\r\\n\\r\\n    Resource=name,\\r\\n    SKU=skuName,\\r\\n    Capacity=skuCapacity,\\r\\n    ZoneSupported=zoneSupported,\\r\\n    ZoneConfigured=zoneRedundant,\\r\\n    AvailabilityZones=tostring(zones),\\r\\n        ResourceGroup=resourceGroup,\\r\\n     Recommendation,\\r\\n         ImplementationImpact,\\r\\n    ImplementationComplexity,\\r\\n    CostEstimation,\\r\\n    SubscriptionId=subscriptionId,\\r\\n    Location=location\\r\\n| order by Resource asc\",\"size\":0,\"title\":\"Azure API Management ðŸŸ¢ [Cost Est.]\",\"noDataMessage\":\"All Azure API Management services have availability zones configured\",\"noDataMessageStyle\":3,\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"pinnedZone\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"4\",\"text\":\"\"}]}},{\"columnMatch\":\"zoneRedundant\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"4\",\"text\":\"\"}]}}],\"rowLimit\":1000},\"sortBy\":[]},\"name\":\"query-apiManagement-zones-details\"},{\"type\":1,\"content\":{\"json\":\"**Note:** Cost based on East US rates (Sep 2025). Premium tier upgrade cost only â€” excludes existing tier costs and additional features. For detailed pricing, see Azure Pricing Calculator.\",\"style\":\"info\"},\"name\":\"text - 2\"}]},\"conditionalVisibility\":{\"parameterName\":\"CheckforAPIM\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"groupAPIM\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'microsoft.servicebus/namespaces'\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend skuName = tostring(sku.name)\\r\\n| extend skuTier = tostring(sku.tier)\\r\\n| extend zoneRedundantProperty = tobool(properties.zoneRedundant)\\r\\n| extend zoneRedundant = iff(zoneRedundantProperty == true, true, false)\\r\\n| where zoneRedundant == \\\"false\\\"\\r\\n| extend migrationStatus = case(\\r\\n    zoneRedundant == true, 'Zone redundancy enabled',\\r\\n    zoneRedundant == false, 'Zone redundancy not enabled - May be eligible for automatic migration',\\r\\n    'Zone redundancy status unknown'\\r\\n)\\r\\n| join kind = innerunique( //Tag filter\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}'])\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n    | project id\\r\\n    )\\r\\n    on id\\r\\n| extend EstimatedMonthlyCost = 0.0  // No additional cost for zone redundancy\\r\\n| extend \\r\\n    Recommendation = case(\\r\\n        zoneRedundant == true, 'No action needed - Zone redundancy already enabled',\\r\\n        zoneRedundant == false, 'Zone redundancy not enabled - May be automatically migrated by Microsoft',\\r\\n        'Review Service Bus zone redundancy status'\\r\\n    ),\\r\\n    ImplementationImpact = case(\\r\\n        zoneRedundant == true, 'None',\\r\\n        'High'  // Automatic migration by Microsoft\\r\\n    ),\\r\\n    ImplementationComplexity = case(\\r\\n        zoneRedundant == true, 'None',\\r\\n        'Low'  // Automatic migration by Microsoft\\r\\n    ),\\r\\n    CostEstimation = 'ðŸŸ¢ [Cost Est.] No additional cost - Automatic feature'\\r\\n| project \\r\\n\\r\\n    Resource=name,\\r\\n    SKU=skuName,\\r\\n    Tier=skuTier,\\r\\n    ZoneConfigured=zoneRedundant,\\r\\n    ZoneRedundantProperty=zoneRedundantProperty,\\r\\n        ResourceGroup=resourceGroup,\\r\\n        Recommendation,\\r\\n            ImplementationImpact,\\r\\n    ImplementationComplexity,\\r\\n    EstimatedMonthlyCost,\\r\\n    CostEstimation,\\r\\n    SubscriptionId=subscriptionId,\\r\\n    Location=location\\r\\n| order by Resource asc\",\"size\":0,\"title\":\"Azure Service BusðŸŸ¢ [Cost Est.] No additional cost\",\"noDataMessage\":\"All Azure Service Bus namespaces have availability zones configured\",\"noDataMessageStyle\":3,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"pinnedZone\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"4\",\"text\":\"\"}]}},{\"columnMatch\":\"zoneRedundant\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"4\",\"text\":\"\"}]}}],\"rowLimit\":1000},\"sortBy\":[]},\"name\":\"query-servicebus-zones-details\"},{\"type\":1,\"content\":{\"json\":\"**Note:** Cost based on East US rates (Sep 2025). No additional infrastructure cost for zone redundancy â€” automatic feature in supported regions. For detailed pricing, see [Azure Pricing Calculator](https://azure.microsoft.com/en-us/pricing/calculator/).\",\"style\":\"info\"},\"name\":\"text - 1\"}]},\"conditionalVisibility\":{\"parameterName\":\"CheckforServiceBus\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"groupServiceBus\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type == \\\"microsoft.eventhub/namespaces\\\"\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend locations=properties.locations\\r\\n| extend skuTier = tostring(sku.tier)\\r\\n| extend zoneRedundant = tostring(properties.zoneRedundant)\\r\\n| extend autoZoneRedundancy = iff(skuTier in ('Standard', 'Premium', 'Dedicated'), 'Enabled automatically', 'Not supported')\\r\\n| join kind = innerunique( //Tag filter\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}'])\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n    | distinct id  // This ensures we only get unique resource IDs\\r\\n    )\\r\\n    on id\\r\\n| extend \\r\\n    Recommendation = iff(\\r\\n        skuTier in ('Standard', 'Premium', 'Dedicated'),\\r\\n        'No action needed - Zone redundancy enabled automatically',\\r\\n        'Upgrade to Standard, Premium, or Dedicated tier for zone redundancy'\\r\\n    ),\\r\\n    ImplementationImpact = iff(\\r\\n        skuTier in ('Standard', 'Premium', 'Dedicated'),\\r\\n        'None',\\r\\n        'Medium'\\r\\n    ),\\r\\n    ImplementationComplexity = iff(\\r\\n        skuTier in ('Standard', 'Premium', 'Dedicated'),\\r\\n        'None',\\r\\n        'Medium'\\r\\n    ),\\r\\n    CostEstimation = 'ðŸ” [No Cost Est.] No cost change'\\r\\n| where zoneRedundant == \\\"false\\\"\\r\\n| distinct id, Recommendation, name, skuTier, autoZoneRedundancy, zoneRedundant, CostEstimation, ImplementationImpact, ImplementationComplexity, resourceGroup, subscriptionId, location, tostring(tags)  // Ensure final uniqueness\\r\\n| project \\r\\n    Recommendation,\\r\\n    Resource=name,\\r\\n    SKU=skuTier,\\r\\n    ZoneRedundancy=autoZoneRedundancy,\\r\\n    ZoneConfigured=zoneRedundant,\\r\\n    CostEstimation,\\r\\n    ImplementationImpact,\\r\\n    ImplementationComplexity,\\r\\n    ResourceGroup=resourceGroup,\\r\\n    SubscriptionId=subscriptionId,\\r\\n    Location=location,\\r\\n    ResourceId=id,\\r\\n    Tags=tostring(tags)\\r\\n| order by Resource asc\",\"size\":0,\"title\":\"Azure Event Hubs [ðŸŸ¢ No cost change]\",\"noDataMessage\":\"All Azure Event Hub have availability zones configured\",\"noDataMessageStyle\":3,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"]},\"conditionalVisibility\":{\"parameterName\":\"CheckforEventHub\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"query-eventHub-zones-details\"},{\"type\":1,\"content\":{\"json\":\"**ðŸ’¡ Event Hub Zone Redundancy Cost Information:**\\r\\nEvent Hub zone redundancy is automatically enabled for Standard, Premium, and Dedicated tiers at no additional cost. Basic tier does not support zone redundancy and would require an upgrade to a higher tier.\",\"style\":\"info\"},\"name\":\"text - 3\"}]},\"conditionalVisibility\":{\"parameterName\":\"selectedDetailsTab\",\"comparison\":\"isEqualTo\",\"value\":\"integrationServices\"},\"name\":\"group - Details-APIManagement\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"App Services Availability Zone Coverage\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'microsoft.web/serverfarms'\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend locations=properties.locations\\r\\n| extend zoneRedundant = tostring(properties.zoneRedundant)\\r\\n| extend skuName = tostring(sku.name)\\r\\n| extend skuTier = tostring(sku.tier)\\r\\n| join kind = innerunique( //Tag filter\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId=id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n    )\\r\\n    on id\\r\\n| distinct id,name,zoneRedundant,skuName,skuTier,resourceGroup,subscriptionId,location\",\"size\":0,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"zoneRedundant\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"true\",\"representation\":\"success\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"failed\",\"text\":\"{0}{1}\"}]}}]}},\"name\":\"query - 0\"}]},\"conditionalVisibility\":{\"parameterName\":\"selectedDetailsTab\",\"comparison\":\"isEqualTo\",\"value\":\"app\"},\"name\":\"group - Details-App\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Azure Container Services Availability Zone Coverage\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'microsoft.containerservice/managedclusters'\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend sku = sku.name\\r\\n| extend pools = properties.agentPoolProfiles\\r\\n| mv-expand pool = pools\\r\\n| extend NodePoolName = pool.name\\r\\n| extend NodePoolMode = pool.mode\\r\\n| extend zones = pool.availabilityZones\\r\\n| extend zoneRedundant = case(\\r\\n    isnull(zones) or array_length(zones) <= 1, false, \\r\\n    true \\r\\n  )\\r\\n| extend zones = pool.availabilityZones\\r\\n| join kind = innerunique( //Tag filter\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId=id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n    )\\r\\n    on id\\r\\n| distinct id,name,tostring(sku),zoneRedundant,tostring(zones),resourceGroup,subscriptionId,location\",\"size\":0,\"title\":\"Azure Container Service (AKS)\",\"noDataMessage\":\"All Azure Container Services (AKS) have availability zones configured\",\"noDataMessageStyle\":3,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"zoneRedundant\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"0\",\"representation\":\"4\",\"text\":\"\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"success\",\"text\":\"\"}]}}]}},\"name\":\"query-containerService-zones-details\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ \\\"microsoft.containerregistry/registries\\\"\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend locations=properties.locations\\r\\n| extend zoneRedundant = tostring(properties.zoneRedundancy)\\r\\n| join kind = innerunique( //Tag filter\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId=id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n    )\\r\\n    on id\\r\\n| distinct id,name,zoneRedundant,resourceGroup,subscriptionId,location\",\"size\":0,\"title\":\"Azure Container Registry\",\"noDataMessage\":\"All Azure Container Registries have availability zones configured\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"zoneRedundant\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"Enabled\",\"representation\":\"success\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"failed\",\"text\":\"{0}{1}\"}]}}]}},\"name\":\"query-containerRegistry-zones-details\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\r\\n| where resourceGroup in ({ResourceGroup})\\r\\n| where type =~ 'microsoft.app/managedenvironments'\\r\\n| where location in~ ({ZonalRegions:value})\\r\\n| extend resourceGroup = strcat('/subscriptions/',subscriptionId,'/resourceGroups/',resourceGroup)\\r\\n| extend subscriptionId = strcat('/subscriptions/',subscriptionId)\\r\\n| extend zoneRedundant = case(\\r\\n    properties.zoneRedundant == \\\"false\\\", false, \\r\\n    true \\r\\n  )\\r\\n| join kind = innerunique( //Tag filter\\r\\n    resources\\r\\n    | extend replaced_tags = replace('{}', 'null', tostring(tags))\\r\\n    | extend replaced_tags = parse_json(replaced_tags)\\r\\n    | mv-expand replaced_tags\\r\\n    | extend tagName = tostring(bag_keys(replaced_tags)[0])\\r\\n    | extend tagValue = tostring(replaced_tags['{TagName}']), WindowsId=id\\r\\n    | where tagName has '{TagName}' and tagValue has '{TagValue}'\\r\\n    )\\r\\n    on id\\r\\n| project id,name,zoneRedundant,tostring(zones),resourceGroup,subscriptionId,location\",\"size\":0,\"title\":\"Azure Container Apps environments\",\"noDataMessage\":\"All Azure Container Apps environments have availability zones configured\",\"noDataMessageStyle\":3,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"pinnedZone\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"4\",\"text\":\"\"}]}},{\"columnMatch\":\"zoneRedundant\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"4\",\"text\":\"\"}]}}],\"rowLimit\":1000},\"sortBy\":[]},\"name\":\"query-app-zones-details\"}]},\"conditionalVisibility\":{\"parameterName\":\"selectedDetailsTab\",\"comparison\":\"isEqualTo\",\"value\":\"containerServices\"},\"name\":\"group - Details-ContainerService\"}]},\"conditionalVisibility\":{\"parameterName\":\"SelectedSubTab\",\"comparison\":\"isEqualTo\",\"value\":\"Details\"},\"name\":\"details-group\"}]},\"name\":\"groupAppService\"}],\"isLocked\":false,\"fallbackResourceIds\":[\"Azure Monitor\"]}",
        "version": "1.0",
        "sourceId": "[parameters('workbookSourceId')]",
        "category": "[parameters('workbookType')]"
      }
    },
    {
      "condition": "[parameters('enableTelemetry')]",
      "name": "[concat('azvalidationworkbookj2factory-', substring(uniqueString(deployment().name), 0, 8))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "properties": {
        "mode": "Incremental",
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "resources": [],
          "outputs": {
            "workbookId": {
              "type": "string",
              "value": "[resourceId( 'microsoft.insights/workbooks', parameters('workbookId'))]"
            }
          }
        }
      }
    }
  ],
  "outputs": {
    "workbookId": {
      "type": "string",
      "value": "[resourceId( 'microsoft.insights/workbooks', parameters('workbookId'))]"
    }
  },
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#"
}
